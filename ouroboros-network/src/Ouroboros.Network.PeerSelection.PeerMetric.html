<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerMetric</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Peer metrics</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier">PeerMetrics</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier">PeerMetricsConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric"><span class="hs-identifier">newPeerMetric</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Metric calculations</span></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAt"><span class="hs-identifier">joinedPeerMetricAt</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamyness"><span class="hs-identifier">upstreamyness</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytes"><span class="hs-identifier">fetchynessBytes</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocks"><span class="hs-identifier">fetchynessBlocks</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Tracers</span></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetricTracer"><span class="hs-identifier">headerMetricTracer</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetricTracer"><span class="hs-identifier">fetchedMetricTracer</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Metrics reporters</span></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier">ReportPeerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#nullMetric"><span class="hs-identifier">nullMetric</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#reportMetric"><span class="hs-identifier">reportMetric</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Internals</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-comment">-- only exported for testing purposes</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier">SlotMetric</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric%27"><span class="hs-identifier">newPeerMetric'</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullTracer</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Bifunctor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Bifunctor</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.IntPSQ</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IntPSQ</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntPSQ</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IntPSQ</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Monoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Sum</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.OrdPSQ</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OrdPSQ</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.OrdPSQ</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OrdPSQ</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Slotting.Slot</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.DeltaQ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier">SizeInBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html"><span class="hs-identifier">Ouroboros.Network.NodeToNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">ConnectionId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerMetric.Type</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">newtype</span><span> </span><span id="PeerMetricsConfiguration"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-var">PeerMetricsConfiguration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeerMetricsConfiguration"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-var">PeerMetricsConfiguration</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-52"></span><span>      </span><span class="hs-comment">-- | The maximum numbers of slots we will store data for.  On some chains</span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-comment">-- sometimes this corresponds to 1h worth of metrics *sighs*.</span><span>
</span><span id="line-54"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-comment">-- this number MUST correspond to number of headers / blocks which are</span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-comment">-- produced in one hour.</span><span>
</span><span id="line-57"></span><span>      </span><span id="maxEntriesToTrack"><span class="annot"><span class="annottext">PeerMetricsConfiguration -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#maxEntriesToTrack"><span class="hs-identifier hs-var hs-var">maxEntriesToTrack</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | Integer based metric ordered by 'SlotNo' which holds the peer and time.</span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- The `p` parameter is truly polymorphic.  For `upstreamyness` and we use peer</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- address, and for `fetchyness` it is a pair of peer id and bytes downloaded.</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-keyword">type</span><span> </span><span id="SlotMetric"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-var">SlotMetric</span></a></span></span><span> </span><span id="local-6989586621679256962"><span class="annot"><a href="#local-6989586621679256962"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IntPSQ</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679256962"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- | Peer registry ordered by slot when a peer joined the peer metric.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-keyword">type</span><span> </span><span id="PeerRegistry"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerRegistry"><span class="hs-identifier hs-var">PeerRegistry</span></a></span></span><span> </span><span id="local-6989586621679256961"><span class="annot"><a href="#local-6989586621679256961"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OrdPSQ</span></span><span> </span><span class="annot"><a href="#local-6989586621679256961"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- | Peer registry ordered by slot when a peer was last seen.</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-keyword">type</span><span> </span><span id="LastSeenRegistry"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#LastSeenRegistry"><span class="hs-identifier hs-var">LastSeenRegistry</span></a></span></span><span> </span><span id="local-6989586621679256960"><span class="annot"><a href="#local-6989586621679256960"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OrdPSQ</span></span><span> </span><span class="annot"><a href="#local-6989586621679256960"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | Mutable peer metrics state accessible via 'STM'.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-keyword">newtype</span><span> </span><span id="PeerMetrics"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-var">PeerMetrics</span></a></span></span><span> </span><span id="local-6989586621679257147"><span class="annot"><a href="#local-6989586621679257147"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679257146"><span class="annot"><a href="#local-6989586621679257146"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeerMetrics"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-var">PeerMetrics</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-79"></span><span>    </span><span id="peerMetricsVar"><span class="annot"><span class="annottext">PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerMetricsVar"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257147"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257146"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Internal state</span><span>
</span><span id="line-83"></span><span class="hs-comment">--</span><span>
</span><span id="line-84"></span><span class="hs-keyword">data</span><span> </span><span id="PeerMetricsState"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-var">PeerMetricsState</span></a></span></span><span> </span><span id="local-6989586621679257140"><span class="annot"><a href="#local-6989586621679257140"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeerMetricsState"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-var">PeerMetricsState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- | Header metrics.</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span>    </span><span id="headerMetrics"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; SlotMetric p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetrics"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257140"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- | Fetch metrics.</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span>    </span><span id="fetchedMetrics"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetrics"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257140"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- | Registry recording when a peer joined the board of 'PeerMetrics'.  The</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- values are average header and fetched metrics.</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-97"></span><span>    </span><span id="peerRegistry"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; PeerRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistry"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerRegistry"><span class="hs-identifier hs-type">PeerRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257140"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- | A registry which indicates when the last time a peer was seen.</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- If a peer hasn't been seen since the oldest recorded slot number, it will</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- be removed.</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-104"></span><span>    </span><span id="lastSeenRegistry"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; LastSeenRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSeenRegistry"><span class="hs-identifier hs-var hs-var">lastSeenRegistry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#LastSeenRegistry"><span class="hs-identifier hs-type">LastSeenRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257140"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">-- | Latest slot registered in the leader board.</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>    </span><span id="lastSlotNo"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSlotNo"><span class="hs-identifier hs-var hs-var">lastSlotNo</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- | Metrics configuration.  Its kept here just for convenience.</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>    </span><span id="metricsConfig"><span class="annot"><span class="annottext">PeerMetricsState p -&gt; PeerMetricsConfiguration
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#metricsConfig"><span class="hs-identifier hs-var hs-var">metricsConfig</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Average results at a given slot.</span><span>
</span><span id="line-117"></span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span class="hs-keyword">data</span><span> </span><span id="AverageMetrics"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-var">AverageMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AverageMetrics"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-var">AverageMetrics</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-119"></span><span>    </span><span id="averageUpstreamyness"><span class="annot"><span class="annottext">AverageMetrics -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageUpstreamyness"><span class="hs-identifier hs-var hs-var">averageUpstreamyness</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>    </span><span id="averageFetchynessBlocks"><span class="annot"><span class="annottext">AverageMetrics -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageFetchynessBlocks"><span class="hs-identifier hs-var hs-var">averageFetchynessBlocks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>    </span><span id="averageFetchynessBytes"><span class="annot"><span class="annottext">AverageMetrics -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageFetchynessBytes"><span class="hs-identifier hs-var hs-var">averageFetchynessBytes</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679256941"><span id="local-6989586621679256943"><span id="local-6989586621679256945"><span class="annot"><span class="annottext">Int -&gt; AverageMetrics -&gt; ShowS
[AverageMetrics] -&gt; ShowS
AverageMetrics -&gt; String
(Int -&gt; AverageMetrics -&gt; ShowS)
-&gt; (AverageMetrics -&gt; String)
-&gt; ([AverageMetrics] -&gt; ShowS)
-&gt; Show AverageMetrics
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [AverageMetrics] -&gt; ShowS
$cshowList :: [AverageMetrics] -&gt; ShowS
show :: AverageMetrics -&gt; String
$cshow :: AverageMetrics -&gt; String
showsPrec :: Int -&gt; AverageMetrics -&gt; ShowS
$cshowsPrec :: Int -&gt; AverageMetrics -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span id="local-6989586621679256938"><span id="local-6989586621679256939"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric"><span class="hs-identifier hs-type">newPeerMetric</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256939"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256939"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256939"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256938"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-130"></span><span id="newPeerMetric"><span class="annot"><span class="annottext">newPeerMetric :: PeerMetricsConfiguration -&gt; m (PeerMetrics m p)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric"><span class="hs-identifier hs-var hs-var">newPeerMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotMetric p
-&gt; SlotMetric (p, SizeInBytes)
-&gt; PeerMetricsConfiguration
-&gt; m (PeerMetrics m p)
forall (m :: * -&gt; *) p.
MonadSTM m =&gt;
SlotMetric p
-&gt; SlotMetric (p, SizeInBytes)
-&gt; PeerMetricsConfiguration
-&gt; m (PeerMetrics m p)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric%27"><span class="hs-identifier hs-var">newPeerMetric'</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
forall p v. IntPSQ p v
</span><span class="hs-identifier hs-var">IntPSQ.empty</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
forall p v. IntPSQ p v
</span><span class="hs-identifier hs-var">IntPSQ.empty</span></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span id="local-6989586621679257153"><span id="local-6989586621679257155"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric%27"><span class="hs-identifier hs-type">newPeerMetric'</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257155"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257153"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257153"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257153"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-139"></span><span id="newPeerMetric%27"><span class="annot"><span class="annottext">newPeerMetric' :: SlotMetric p
-&gt; SlotMetric (p, SizeInBytes)
-&gt; PeerMetricsConfiguration
-&gt; m (PeerMetrics m p)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#newPeerMetric%27"><span class="hs-identifier hs-var hs-var">newPeerMetric'</span></a></span></span><span> </span><span id="local-6989586621679256936"><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256936"><span class="hs-identifier hs-var">headerMetrics</span></a></span></span><span> </span><span id="local-6989586621679256935"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256935"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span></span><span> </span><span id="local-6989586621679256934"><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256934"><span class="hs-identifier hs-var">metricsConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; PeerMetrics m p
forall (m :: * -&gt; *) p.
StrictTVar m (PeerMetricsState p) -&gt; PeerMetrics m p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-var">PeerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictTVar m (PeerMetricsState p) -&gt; PeerMetrics m p)
-&gt; m (StrictTVar m (PeerMetricsState p)) -&gt; m (PeerMetrics m p)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; m (StrictTVar m (PeerMetricsState p))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState :: forall p.
SlotMetric p
-&gt; SlotMetric (p, SizeInBytes)
-&gt; PeerRegistry p
-&gt; LastSeenRegistry p
-&gt; SlotNo
-&gt; PeerMetricsConfiguration
-&gt; PeerMetricsState p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-141"></span><span>                                </span><span class="annot"><span class="annottext">SlotMetric p
headerMetrics :: SlotMetric p
headerMetrics :: SlotMetric p
</span><a href="#local-6989586621679256936"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>                                </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256935"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>                                </span><span class="annot"><span class="annottext">peerRegistry :: PeerRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistry"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
forall k p v. OrdPSQ k p v
</span><span class="hs-identifier hs-var">OrdPSQ.empty</span></span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>                                </span><span class="annot"><span class="annottext">lastSeenRegistry :: LastSeenRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSeenRegistry"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LastSeenRegistry p
forall k p v. OrdPSQ k p v
</span><span class="hs-identifier hs-var">OrdPSQ.empty</span></span><span class="hs-special">,</span><span>
</span><span id="line-145"></span><span>                                </span><span class="annot"><span class="annottext">lastSlotNo :: SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSlotNo"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>                                </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
metricsConfig :: PeerMetricsConfiguration
metricsConfig :: PeerMetricsConfiguration
</span><a href="#local-6989586621679256934"><span class="hs-identifier hs-var hs-var">metricsConfig</span></a></span><span>
</span><span id="line-147"></span><span>                              </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span id="local-6989586621679257037"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#updateLastSlot"><span class="hs-identifier hs-type">updateLastSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257037"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257037"><span class="hs-identifier hs-type">p</span></a></span></span><span>
</span><span id="line-150"></span><span id="updateLastSlot"><span class="annot"><span class="annottext">updateLastSlot :: SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#updateLastSlot"><span class="hs-identifier hs-var hs-var">updateLastSlot</span></a></span></span><span> </span><span id="local-6989586621679256928"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256928"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679256927"><span class="annot"><span class="annottext">state :: PeerMetricsState p
</span><a href="#local-6989586621679256927"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256926"><span class="annot"><span class="annottext">SlotNo
lastSlotNo :: SlotNo
lastSlotNo :: forall p. PeerMetricsState p -&gt; SlotNo
</span><a href="#local-6989586621679256926"><span class="hs-identifier hs-var hs-var">lastSlotNo</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256928"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256926"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256927"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lastSlotNo :: SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSlotNo"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256928"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256927"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span id="local-6989586621679256989"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#firstSlotNo"><span class="hs-identifier hs-type">firstSlotNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256989"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span></span><span>
</span><span id="line-156"></span><span id="firstSlotNo"><span class="annot"><span class="annottext">firstSlotNo :: PeerMetricsState p -&gt; Maybe SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#firstSlotNo"><span class="hs-identifier hs-var hs-var">firstSlotNo</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679256923"><span class="annot"><span class="annottext">SlotMetric p
headerMetrics :: SlotMetric p
headerMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric p
</span><a href="#local-6989586621679256923"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256922"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256922"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256921"><span class="annot"><span class="annottext">(Int, SlotNo, (p, Time), SlotMetric p)
</span><a href="#local-6989586621679256921"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679256920"><span class="annot"><span class="annottext">(Int, SlotNo, ((p, SizeInBytes), Time),
 SlotMetric (p, SizeInBytes))
</span><a href="#local-6989586621679256920"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">min</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, SlotNo, (p, Time), SlotMetric p) -&gt; SlotNo
forall a b c. (a, SlotNo, b, c) -&gt; SlotNo
</span><a href="#local-6989586621679256918"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Int, SlotNo, (p, Time), SlotMetric p)
</span><a href="#local-6989586621679256921"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, SlotNo, ((p, SizeInBytes), Time),
 SlotMetric (p, SizeInBytes))
-&gt; SlotNo
forall a b c. (a, SlotNo, b, c) -&gt; SlotNo
</span><a href="#local-6989586621679256918"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Int, SlotNo, ((p, SizeInBytes), Time),
 SlotMetric (p, SizeInBytes))
</span><a href="#local-6989586621679256920"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">((Int, SlotNo, (p, Time), SlotMetric p)
 -&gt; (Int, SlotNo, ((p, SizeInBytes), Time),
     SlotMetric (p, SizeInBytes))
 -&gt; SlotNo)
-&gt; Maybe (Int, SlotNo, (p, Time), SlotMetric p)
-&gt; Maybe
     ((Int, SlotNo, ((p, SizeInBytes), Time),
       SlotMetric (p, SizeInBytes))
      -&gt; SlotNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p -&gt; Maybe (Int, SlotNo, (p, Time), SlotMetric p)
forall p v. Ord p =&gt; IntPSQ p v -&gt; Maybe (Int, p, v, IntPSQ p v)
</span><span class="hs-identifier hs-var">IntPSQ.minView</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256923"><span class="hs-identifier hs-var">headerMetrics</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">Maybe
  ((Int, SlotNo, ((p, SizeInBytes), Time),
    SlotMetric (p, SizeInBytes))
   -&gt; SlotNo)
-&gt; Maybe
     (Int, SlotNo, ((p, SizeInBytes), Time),
      SlotMetric (p, SizeInBytes))
-&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
-&gt; Maybe
     (Int, SlotNo, ((p, SizeInBytes), Time),
      SlotMetric (p, SizeInBytes))
forall p v. Ord p =&gt; IntPSQ p v -&gt; Maybe (Int, p, v, IntPSQ p v)
</span><span class="hs-identifier hs-var">IntPSQ.minView</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256922"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621679257129"><span id="local-6989586621679257130"><span id="local-6989586621679257131"><span class="annot"><a href="#local-6989586621679256918"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257131"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679257130"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679257129"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span></span></span></span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621679256918"><span class="annot"><span class="annottext">f :: (a, SlotNo, b, c) -&gt; SlotNo
</span><a href="#local-6989586621679256918"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256916"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256916"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256916"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#reportMetric"><span class="hs-identifier hs-type">reportMetric</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256915"><span class="annot"><a href="#local-6989586621679256915"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679256914"><span class="annot"><a href="#local-6989586621679256914"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-167"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256915"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-168"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256914"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-169"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-171"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256915"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256914"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-172"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">ReportPeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256915"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256914"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span id="reportMetric"><span class="annot"><span class="annottext">reportMetric :: PeerMetricsConfiguration
-&gt; PeerMetrics m p -&gt; ReportPeerMetrics m (ConnectionId p)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#reportMetric"><span class="hs-identifier hs-var hs-var">reportMetric</span></a></span></span><span> </span><span id="local-6989586621679256913"><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256913"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621679256912"><span class="annot"><span class="annottext">PeerMetrics m p
</span><a href="#local-6989586621679256912"><span class="hs-identifier hs-var">peerMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
-&gt; ReportPeerMetrics m (ConnectionId p)
forall (m :: * -&gt; *) peerAddr.
Tracer (STM m) (TraceLabelPeer peerAddr (SlotNo, Time))
-&gt; Tracer
     (STM m) (TraceLabelPeer peerAddr (SizeInBytes, SlotNo, Time))
-&gt; ReportPeerMetrics m peerAddr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-var">ReportPeerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
forall (m :: * -&gt; *) p.
(MonadSTM m, Ord p) =&gt;
PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetricTracer"><span class="hs-identifier hs-var">headerMetricTracer</span></a></span><span>  </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256913"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetrics m p
</span><a href="#local-6989586621679256912"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
forall (m :: * -&gt; *) p.
(MonadSTM m, Ord p) =&gt;
PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetricTracer"><span class="hs-identifier hs-var">fetchedMetricTracer</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256913"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetrics m p
</span><a href="#local-6989586621679256912"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span id="local-6989586621679256909"><span id="local-6989586621679256910"><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#nullMetric"><span class="hs-identifier hs-type">nullMetric</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256910"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">ReportPeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256910"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256909"><span class="hs-identifier hs-type">p</span></a></span></span></span><span>
</span><span id="line-180"></span><span id="nullMetric"><span class="annot"><span class="annottext">nullMetric :: ReportPeerMetrics m p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#nullMetric"><span class="hs-identifier hs-var hs-var">nullMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer p (SizeInBytes, SlotNo, Time))
-&gt; ReportPeerMetrics m p
forall (m :: * -&gt; *) peerAddr.
Tracer (STM m) (TraceLabelPeer peerAddr (SlotNo, Time))
-&gt; Tracer
     (STM m) (TraceLabelPeer peerAddr (SizeInBytes, SlotNo, Time))
-&gt; ReportPeerMetrics m peerAddr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-var">ReportPeerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span> </span><span class="annot"><span class="annottext">Tracer (STM m) (TraceLabelPeer p (SizeInBytes, SlotNo, Time))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-type">slotToInt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-185"></span><span id="slotToInt"><span class="annot"><span class="annottext">slotToInt :: SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var hs-var">slotToInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Int) -&gt; (SlotNo -&gt; Word64) -&gt; SlotNo -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">unSlotNo</span></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">-- | Tracer which updates header metrics (upstreameness) and inserts new peers</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- into 'peerRegistry'.</span><span>
</span><span id="line-190"></span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetricTracer"><span class="hs-identifier hs-type">headerMetricTracer</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257111"><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679257110"><span class="annot"><a href="#local-6989586621679257110"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-193"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-194"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257110"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-195"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257110"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257110"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span id="headerMetricTracer"><span class="annot"><span class="annottext">headerMetricTracer :: PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetricTracer"><span class="hs-identifier hs-var hs-var">headerMetricTracer</span></a></span></span><span> </span><span id="local-6989586621679256905"><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256905"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621679256904"><span class="annot"><span class="annottext">peerMetrics :: PeerMetrics m p
</span><a href="#local-6989586621679256904"><span class="hs-identifier hs-var">peerMetrics</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span class="hs-special">{</span><span id="local-6989586621679256903"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256903"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="annottext">(ConnectionId p -&gt; p)
-&gt; ((SlotNo, Time) -&gt; SlotNo)
-&gt; TraceLabelPeer (ConnectionId p) (SlotNo, Time)
-&gt; TraceLabelPeer p SlotNo
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">bimap</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId p -&gt; p
forall addr. ConnectionId addr -&gt; addr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo, Time) -&gt; SlotNo
forall a b. (a, b) -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer (ConnectionId p) (SlotNo, Time)
 -&gt; TraceLabelPeer p SlotNo)
-&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">PeerMetrics m p -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
forall p (m :: * -&gt; *).
(MonadSTM m, Ord p) =&gt;
PeerMetrics m p -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistryTracer"><span class="hs-identifier hs-var">peerRegistryTracer</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetrics m p
</span><a href="#local-6989586621679256904"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span>
</span><span id="line-203"></span><span> </span><span class="annot"><span class="annottext">Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnectionId p -&gt; p)
-&gt; TraceLabelPeer (ConnectionId p) (SlotNo, Time)
-&gt; TraceLabelPeer p (SlotNo, Time)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId p -&gt; p
forall addr. ConnectionId addr -&gt; addr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer (ConnectionId p) (SlotNo, Time)
 -&gt; TraceLabelPeer p (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer (ConnectionId p) (SlotNo, Time))
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">STM m (SlotMetric p)
-&gt; (SlotMetric p -&gt; STM m ())
-&gt; PeerMetricsConfiguration
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
forall (m :: * -&gt; *) p.
MonadSTM m =&gt;
STM m (SlotMetric p)
-&gt; (SlotMetric p -&gt; STM m ())
-&gt; PeerMetricsConfiguration
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#metricsTracer"><span class="hs-identifier hs-var">metricsTracer</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; SlotMetric p
forall p. PeerMetricsState p -&gt; SlotMetric p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#headerMetrics"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; SlotMetric p)
-&gt; STM m (PeerMetricsState p) -&gt; STM m (SlotMetric p)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256903"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256896"><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256896"><span class="hs-identifier hs-var">headerMetrics</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256903"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-208"></span><span>                                    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256894"><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256894"><span class="hs-identifier hs-var">metrics</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256894"><span class="hs-identifier hs-var">metrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">SlotMetric p
headerMetrics :: SlotMetric p
headerMetrics :: SlotMetric p
</span><a href="#local-6989586621679256896"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256905"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | Tracer which updates fetched metrics (fetchyness) and inserts new peers</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- into 'peerRegistry'.</span><span>
</span><span id="line-214"></span><span class="hs-comment">--</span><span>
</span><span id="line-215"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetricTracer"><span class="hs-identifier hs-type">fetchedMetricTracer</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257109"><span class="annot"><a href="#local-6989586621679257109"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679257108"><span class="annot"><a href="#local-6989586621679257108"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-217"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257109"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-218"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257108"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-219"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257109"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257108"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257109"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257108"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>                                      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span>
</span><span id="line-224"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-225"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span>
</span><span id="line-226"></span><span>                                      </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span id="fetchedMetricTracer"><span class="annot"><span class="annottext">fetchedMetricTracer :: PeerMetricsConfiguration
-&gt; PeerMetrics m p
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetricTracer"><span class="hs-identifier hs-var hs-var">fetchedMetricTracer</span></a></span></span><span> </span><span id="local-6989586621679256893"><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256893"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621679256892"><span class="annot"><span class="annottext">peerMetrics :: PeerMetrics m p
</span><a href="#local-6989586621679256892"><span class="hs-identifier hs-var">peerMetrics</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span class="hs-special">{</span><span id="local-6989586621679256891"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256891"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">(ConnectionId p -&gt; p)
-&gt; ((SizeInBytes, SlotNo, Time) -&gt; SlotNo)
-&gt; TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time)
-&gt; TraceLabelPeer p SlotNo
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">bimap</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId p -&gt; p
forall addr. ConnectionId addr -&gt; addr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SizeInBytes
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256890"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256890"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Time
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256890"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time)
 -&gt; TraceLabelPeer p SlotNo)
-&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><span class="annottext">PeerMetrics m p -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
forall p (m :: * -&gt; *).
(MonadSTM m, Ord p) =&gt;
PeerMetrics m p -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistryTracer"><span class="hs-identifier hs-var">peerRegistryTracer</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetrics m p
</span><a href="#local-6989586621679256892"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span>
</span><span id="line-231"></span><span> </span><span class="annot"><span class="annottext">Tracer
  (STM m)
  (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span id="local-6989586621679256888"><span class="annot"><span class="annottext">ConnectionId p
</span><a href="#local-6989586621679256888"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256887"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679256887"><span class="hs-identifier hs-var">bytes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256886"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256886"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256885"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256885"><span class="hs-identifier hs-var">time</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>       </span><span class="annot"><span class="annottext">(p, SizeInBytes)
-&gt; (SlotNo, Time) -&gt; TraceLabelPeer (p, SizeInBytes) (SlotNo, Time)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">TraceLabelPeer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId p -&gt; p
forall addr. ConnectionId addr -&gt; addr
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-framework-0.3.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId p
</span><a href="#local-6989586621679256888"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679256887"><span class="hs-identifier hs-var">bytes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256886"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256885"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time)
 -&gt; TraceLabelPeer (p, SizeInBytes) (SlotNo, Time))
-&gt; Tracer (STM m) (TraceLabelPeer (p, SizeInBytes) (SlotNo, Time))
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId p) (SizeInBytes, SlotNo, Time))
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span>
</span><span id="line-234"></span><span>     </span><span class="annot"><span class="annottext">STM m (SlotMetric (p, SizeInBytes))
-&gt; (SlotMetric (p, SizeInBytes) -&gt; STM m ())
-&gt; PeerMetricsConfiguration
-&gt; Tracer (STM m) (TraceLabelPeer (p, SizeInBytes) (SlotNo, Time))
forall (m :: * -&gt; *) p.
MonadSTM m =&gt;
STM m (SlotMetric p)
-&gt; (SlotMetric p -&gt; STM m ())
-&gt; PeerMetricsConfiguration
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#metricsTracer"><span class="hs-identifier hs-var">metricsTracer</span></a></span><span>
</span><span id="line-235"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
forall p. PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchedMetrics"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes))
-&gt; STM m (PeerMetricsState p)
-&gt; STM m (SlotMetric (p, SizeInBytes))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256891"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>       </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256884"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256884"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256891"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-237"></span><span>                                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256883"><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256883"><span class="hs-identifier hs-var">metrics</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256883"><span class="hs-identifier hs-var">metrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256884"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>       </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256893"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">--</span><span>
</span><span id="line-242"></span><span class="hs-comment">--  peer registry tracer which maintains 'peerRegistry' and 'lastSeenRegistry'</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">-- | Insert new peer into 'PeerMetricsState'.  If this peer hasn't been</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- recorded before, we compute the current average score and record it in</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- 'peerRegistry'.  Entries in `peerRegistry' are only kept if they are newer</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- than the oldest slot in the 'headerMetrics' and 'fetchedMetrics'.</span><span>
</span><span id="line-249"></span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- Implementation detail:</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- We need first check 'lastSeenRegistry' which checks if a peer is part of the</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- leader board.  If a peer has not contributed to 'PeerMetrics' in</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- `maxEntriesToTrack` slots, we will consider it as a new peer.  Without using</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- `lastSeenRegistry` we could consider a peer new while it exists in peer</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- metrics for a very long time.  Just using `peerRegistry` does not guarantee</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- that.</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#insertPeer"><span class="hs-identifier hs-type">insertPeer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257036"><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-259"></span><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-260"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-comment">-- ^ current slot</span><span>
</span><span id="line-261"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-262"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-263"></span><span id="insertPeer"><span class="annot"><span class="annottext">insertPeer :: p -&gt; SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#insertPeer"><span class="hs-identifier hs-var hs-var">insertPeer</span></a></span></span><span> </span><span id="local-6989586621679256881"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256881"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679256880"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256880"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span>
</span><span id="line-264"></span><span>           </span><span id="local-6989586621679256879"><span class="annot"><span class="annottext">peerMetricsState :: PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256878"><span class="annot"><span class="annottext">LastSeenRegistry p
lastSeenRegistry :: LastSeenRegistry p
lastSeenRegistry :: forall p. PeerMetricsState p -&gt; LastSeenRegistry p
</span><a href="#local-6989586621679256878"><span class="hs-identifier hs-var hs-var">lastSeenRegistry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256877"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256877"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256881"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">p -&gt; LastSeenRegistry p -&gt; Bool
forall k p v. Ord k =&gt; k -&gt; OrdPSQ k p v -&gt; Bool
</span><span class="hs-operator hs-var">`OrdPSQ.member`</span></span><span> </span><span class="annot"><span class="annottext">LastSeenRegistry p
</span><a href="#local-6989586621679256878"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Maybe (SlotNo, AverageMetrics)
 -&gt; (Bool, Maybe (SlotNo, AverageMetrics)))
-&gt; p -&gt; PeerRegistry p -&gt; (Bool, PeerRegistry p)
forall k p v b.
(Ord k, Ord p) =&gt;
(Maybe (p, v) -&gt; (b, Maybe (p, v)))
-&gt; k -&gt; OrdPSQ k p v -&gt; (b, OrdPSQ k p v)
</span><span class="hs-identifier hs-var">OrdPSQ.alter</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SlotNo, AverageMetrics)
-&gt; (Bool, Maybe (SlotNo, AverageMetrics))
</span><a href="#local-6989586621679256874"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256881"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256877"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-268"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679256873"><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256873"><span class="hs-identifier hs-var">peerRegistry'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">peerRegistry :: PeerRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistry"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256873"><span class="hs-identifier hs-var">peerRegistry'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-269"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679256872"><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256872"><span class="hs-identifier hs-var">_peerRegistry'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><a href="#local-6989586621679256874"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679256874"><span class="annot"><span class="annottext">f :: Maybe (SlotNo, AverageMetrics)
-&gt; (Bool, Maybe (SlotNo, AverageMetrics))
</span><a href="#local-6989586621679256874"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679256871"><span class="annot"><span class="annottext">a :: Maybe (SlotNo, AverageMetrics)
</span><a href="#local-6989586621679256871"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Maybe (SlotNo, AverageMetrics)
</span><a href="#local-6989586621679256871"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="#local-6989586621679256874"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SlotNo, AverageMetrics)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SlotNo, AverageMetrics) -&gt; Maybe (SlotNo, AverageMetrics)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256880"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-274"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AverageMetrics :: Int -&gt; Int -&gt; Int -&gt; AverageMetrics
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-275"></span><span>                                     </span><span class="annot"><span class="annottext">averageUpstreamyness :: Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageUpstreamyness"><span class="hs-identifier hs-var">averageUpstreamyness</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map p Int -&gt; Int
</span><a href="#local-6989586621679256870"><span class="hs-identifier hs-var">avg</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256869"><span class="hs-identifier hs-var">upstreamenessResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>                                     </span><span class="annot"><span class="annottext">averageFetchynessBytes :: Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageFetchynessBytes"><span class="hs-identifier hs-var">averageFetchynessBytes</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map p Int -&gt; Int
</span><a href="#local-6989586621679256870"><span class="hs-identifier hs-var">avg</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256868"><span class="hs-identifier hs-var">fetchynessBytesResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>                                     </span><span class="annot"><span class="annottext">averageFetchynessBlocks :: Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#averageFetchynessBlocks"><span class="hs-identifier hs-var">averageFetchynessBlocks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map p Int -&gt; Int
</span><a href="#local-6989586621679256870"><span class="hs-identifier hs-var">avg</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256867"><span class="hs-identifier hs-var">fetchynessBlocksResults</span></a></span><span>
</span><span id="line-278"></span><span>                                   </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>                               </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>        </span><span id="local-6989586621679256869"><span class="annot"><span class="annottext">upstreamenessResults :: Map p Int
</span><a href="#local-6989586621679256869"><span class="hs-identifier hs-var hs-var">upstreamenessResults</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamynessImpl"><span class="hs-identifier hs-var">upstreamynessImpl</span></a></span><span>    </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span id="local-6989586621679256868"><span class="annot"><span class="annottext">fetchynessBytesResults :: Map p Int
</span><a href="#local-6989586621679256868"><span class="hs-identifier hs-var hs-var">fetchynessBytesResults</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytesImpl"><span class="hs-identifier hs-var">fetchynessBytesImpl</span></a></span><span>  </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span>
</span><span id="line-283"></span><span>        </span><span id="local-6989586621679256867"><span class="annot"><span class="annottext">fetchynessBlocksResults :: Map p Int
</span><a href="#local-6989586621679256867"><span class="hs-identifier hs-var hs-var">fetchynessBlocksResults</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocksImpl"><span class="hs-identifier hs-var">fetchynessBlocksImpl</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">peerMetricsState</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><a href="#local-6989586621679256870"><span class="hs-identifier hs-type">avg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257036"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621679256870"><span class="annot"><span class="annottext">avg :: Map p Int -&gt; Int
</span><a href="#local-6989586621679256870"><span class="hs-identifier hs-var hs-var">avg</span></a></span></span><span> </span><span id="local-6989586621679256863"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256863"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Map p Int -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.null</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256863"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><a href="#local-6989586621679256870"><span class="hs-identifier hs-var">avg</span></a></span><span> </span><span id="local-6989586621679256861"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256861"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-comment">-- division truncated towards the plus infinity, rather then the minus</span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-comment">-- infinity</span><span>
</span><span id="line-290"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Sum Int -&gt; Int
forall a. Sum a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">getSum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Sum Int) -&gt; Map p Int -&gt; Sum Int
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Sum Int
forall a. a -&gt; Sum a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256861"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`divMod`</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int -&gt; Int
forall k a. Map k a -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.size</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256861"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679256855"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256855"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256855"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679256854"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256854"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256854"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="hs-comment">-- | A tracer which takes care about:</span><span>
</span><span id="line-296"></span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- * inserting new peers to 'peerRegistry'</span><span>
</span><span id="line-298"></span><span class="hs-comment">-- * removing old entries of 'peerRegistry'</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- * inserting new peers to 'lastSeenRegistry'</span><span>
</span><span id="line-301"></span><span class="hs-comment">-- * removing old entries of 'lastSeenRegistry'</span><span>
</span><span id="line-302"></span><span class="hs-comment">--</span><span>
</span><span id="line-303"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistryTracer"><span class="hs-identifier hs-type">peerRegistryTracer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257082"><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679257083"><span class="annot"><a href="#local-6989586621679257083"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-304"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257083"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-305"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-306"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257083"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-308"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257083"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span id="peerRegistryTracer"><span class="annot"><span class="annottext">peerRegistryTracer :: PeerMetrics m p -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistryTracer"><span class="hs-identifier hs-var hs-var">peerRegistryTracer</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256852"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256852"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer p SlotNo -&gt; STM m ())
-&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">((TraceLabelPeer p SlotNo -&gt; STM m ())
 -&gt; Tracer (STM m) (TraceLabelPeer p SlotNo))
-&gt; (TraceLabelPeer p SlotNo -&gt; STM m ())
-&gt; Tracer (STM m) (TraceLabelPeer p SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span id="local-6989586621679256850"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256850"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679256849"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256849"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-comment">-- order matters: 'insertPeer' must access the previous value of</span><span>
</span><span id="line-312"></span><span>      </span><span class="hs-comment">-- lastSeenRegistry</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256852"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span> </span><span class="annot"><span class="annottext">((PeerMetricsState p -&gt; PeerMetricsState p) -&gt; STM m ())
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
forall p. SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#updateLastSlot"><span class="hs-identifier hs-var">updateLastSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256849"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-314"></span><span>                                </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; PeerMetricsState p
-&gt; PeerMetricsState p
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">p -&gt; SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="#local-6989586621679256848"><span class="hs-identifier hs-var">witnessedPeer</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256850"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256849"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-315"></span><span>                                </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; PeerMetricsState p
-&gt; PeerMetricsState p
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">p -&gt; SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
forall p.
Ord p =&gt;
p -&gt; SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#insertPeer"><span class="hs-identifier hs-var">insertPeer</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256850"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256849"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-316"></span><span>                                </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; (PeerMetricsState p -&gt; PeerMetricsState p)
-&gt; PeerMetricsState p
-&gt; PeerMetricsState p
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="#local-6989586621679256847"><span class="hs-identifier hs-var">afterSlot</span></a></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679256846"><span class="annot"><span class="annottext">snd_ :: (a, b, c, d) -&gt; b
</span><a href="#local-6989586621679256846"><span class="hs-identifier hs-var hs-var">snd_</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256845"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256845"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256845"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- remove all entries which are older than the oldest slot in the</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- 'PeerMetrics'</span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="#local-6989586621679256847"><span class="hs-identifier hs-type">afterSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621679256847"><span class="annot"><span class="annottext">afterSlot :: PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="#local-6989586621679256847"><span class="hs-identifier hs-var hs-var">afterSlot</span></a></span></span><span> </span><span id="local-6989586621679256844"><span class="annot"><span class="annottext">peerMetrics :: PeerMetricsState p
</span><a href="#local-6989586621679256844"><span class="hs-identifier hs-var">peerMetrics</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256843"><span class="annot"><span class="annottext">SlotMetric p
headerMetrics :: SlotMetric p
headerMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric p
</span><a href="#local-6989586621679256843"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>                                             </span><span id="local-6989586621679256842"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256842"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>                                             </span><span id="local-6989586621679256841"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256841"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>                                             </span><span id="local-6989586621679256840"><span class="annot"><span class="annottext">LastSeenRegistry p
lastSeenRegistry :: LastSeenRegistry p
lastSeenRegistry :: forall p. PeerMetricsState p -&gt; LastSeenRegistry p
</span><a href="#local-6989586621679256840"><span class="hs-identifier hs-var hs-var">lastSeenRegistry</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- the oldest slot in the metrics leader board</span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><a href="#local-6989586621679256839"><span class="hs-identifier hs-type">slotNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-329"></span><span>          </span><span id="local-6989586621679256839"><span class="annot"><span class="annottext">slotNo :: SlotNo
</span><a href="#local-6989586621679256839"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Maybe SlotNo -&gt; SlotNo
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(Maybe SlotNo -&gt; SlotNo) -&gt; Maybe SlotNo -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-330"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, SlotNo, (p, Time), SlotMetric p) -&gt; SlotNo
forall a b c d. (a, b, c, d) -&gt; b
</span><a href="#local-6989586621679256846"><span class="hs-identifier hs-var">snd_</span></a></span><span> </span><span class="annot"><span class="annottext">((Int, SlotNo, (p, Time), SlotMetric p) -&gt; SlotNo)
-&gt; Maybe (Int, SlotNo, (p, Time), SlotMetric p) -&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p -&gt; Maybe (Int, SlotNo, (p, Time), SlotMetric p)
forall p v. Ord p =&gt; IntPSQ p v -&gt; Maybe (Int, p, v, IntPSQ p v)
</span><span class="hs-identifier hs-var">IntPSQ.minView</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256843"><span class="hs-identifier hs-var">headerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>            </span><span class="annot"><span class="annottext">Maybe SlotNo -&gt; Maybe SlotNo -&gt; Maybe SlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`min`</span></a></span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, SlotNo, ((p, SizeInBytes), Time),
 SlotMetric (p, SizeInBytes))
-&gt; SlotNo
forall a b c d. (a, b, c, d) -&gt; b
</span><a href="#local-6989586621679256846"><span class="hs-identifier hs-var">snd_</span></a></span><span> </span><span class="annot"><span class="annottext">((Int, SlotNo, ((p, SizeInBytes), Time),
  SlotMetric (p, SizeInBytes))
 -&gt; SlotNo)
-&gt; Maybe
     (Int, SlotNo, ((p, SizeInBytes), Time),
      SlotMetric (p, SizeInBytes))
-&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
-&gt; Maybe
     (Int, SlotNo, ((p, SizeInBytes), Time),
      SlotMetric (p, SizeInBytes))
forall p v. Ord p =&gt; IntPSQ p v -&gt; Maybe (Int, p, v, IntPSQ p v)
</span><span class="hs-identifier hs-var">IntPSQ.minView</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256842"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256844"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span>
</span><span id="line-335"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">peerRegistry :: PeerRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#peerRegistry"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([(p, SlotNo, AverageMetrics)], PeerRegistry p) -&gt; PeerRegistry p
forall a b. (a, b) -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
-&gt; PeerRegistry p
-&gt; ([(p, SlotNo, AverageMetrics)], PeerRegistry p)
forall k p v.
(Ord k, Ord p) =&gt;
p -&gt; OrdPSQ k p v -&gt; ([(k, p, v)], OrdPSQ k p v)
</span><span class="hs-identifier hs-var">OrdPSQ.atMostView</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256839"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256841"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-336"></span><span>             </span><span class="annot"><span class="annottext">lastSeenRegistry :: LastSeenRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSeenRegistry"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([(p, SlotNo, ())], LastSeenRegistry p) -&gt; LastSeenRegistry p
forall a b. (a, b) -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
-&gt; LastSeenRegistry p -&gt; ([(p, SlotNo, ())], LastSeenRegistry p)
forall k p v.
(Ord k, Ord p) =&gt;
p -&gt; OrdPSQ k p v -&gt; ([(k, p, v)], OrdPSQ k p v)
</span><span class="hs-identifier hs-var">OrdPSQ.atMostView</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256839"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">LastSeenRegistry p
</span><a href="#local-6989586621679256840"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><a href="#local-6989586621679256848"><span class="hs-identifier hs-type">witnessedPeer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-340"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257082"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-341"></span><span>    </span><span id="local-6989586621679256848"><span class="annot"><span class="annottext">witnessedPeer :: p -&gt; SlotNo -&gt; PeerMetricsState p -&gt; PeerMetricsState p
</span><a href="#local-6989586621679256848"><span class="hs-identifier hs-var hs-var">witnessedPeer</span></a></span></span><span> </span><span id="local-6989586621679256837"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256837"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679256836"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256836"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span>
</span><span id="line-342"></span><span>                  </span><span id="local-6989586621679256835"><span class="annot"><span class="annottext">peerMetrics :: PeerMetricsState p
</span><a href="#local-6989586621679256835"><span class="hs-identifier hs-var">peerMetrics</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256834"><span class="annot"><span class="annottext">LastSeenRegistry p
lastSeenRegistry :: LastSeenRegistry p
lastSeenRegistry :: forall p. PeerMetricsState p -&gt; LastSeenRegistry p
</span><a href="#local-6989586621679256834"><span class="hs-identifier hs-var hs-var">lastSeenRegistry</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-343"></span><span>                  </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256835"><span class="hs-identifier hs-var">peerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lastSeenRegistry :: LastSeenRegistry p
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#lastSeenRegistry"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>                                  </span><span class="annot"><span class="annottext">p -&gt; SlotNo -&gt; () -&gt; LastSeenRegistry p -&gt; LastSeenRegistry p
forall k p v.
(Ord k, Ord p) =&gt;
k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><span class="hs-identifier hs-var">OrdPSQ.insert</span></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256837"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256836"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LastSeenRegistry p
</span><a href="#local-6989586621679256834"><span class="hs-identifier hs-var">lastSeenRegistry</span></a></span><span>
</span><span id="line-345"></span><span>                              </span><span class="hs-special">}</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span class="hs-comment">--</span><span>
</span><span id="line-349"></span><span class="hs-comment">-- Metrics tracer</span><span>
</span><span id="line-350"></span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="hs-comment">-- | A metrics tracer which updates the metric.</span><span>
</span><span id="line-353"></span><span class="hs-comment">--</span><span>
</span><span id="line-354"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#metricsTracer"><span class="hs-identifier hs-type">metricsTracer</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257077"><span class="annot"><a href="#local-6989586621679257077"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679257076"><span class="annot"><a href="#local-6989586621679257076"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-356"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257077"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257077"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257076"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- ^ read metrics</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#SlotMetric"><span class="hs-identifier hs-type">SlotMetric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257076"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257077"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ update metrics</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257077"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257076"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span id="metricsTracer"><span class="annot"><span class="annottext">metricsTracer :: STM m (SlotMetric p)
-&gt; (SlotMetric p -&gt; STM m ())
-&gt; PeerMetricsConfiguration
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#metricsTracer"><span class="hs-identifier hs-var hs-var">metricsTracer</span></a></span></span><span> </span><span id="local-6989586621679256832"><span class="annot"><span class="annottext">STM m (SlotMetric p)
</span><a href="#local-6989586621679256832"><span class="hs-identifier hs-var">getMetrics</span></a></span></span><span> </span><span id="local-6989586621679256831"><span class="annot"><span class="annottext">SlotMetric p -&gt; STM m ()
</span><a href="#local-6989586621679256831"><span class="hs-identifier hs-var">writeMetrics</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256830"><span class="annot"><span class="annottext">Int
maxEntriesToTrack :: Int
maxEntriesToTrack :: PeerMetricsConfiguration -&gt; Int
</span><a href="#local-6989586621679256830"><span class="hs-identifier hs-var hs-var">maxEntriesToTrack</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">(TraceLabelPeer p (SlotNo, Time) -&gt; STM m ())
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">((TraceLabelPeer p (SlotNo, Time) -&gt; STM m ())
 -&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time)))
-&gt; (TraceLabelPeer p (SlotNo, Time) -&gt; STM m ())
-&gt; Tracer (STM m) (TraceLabelPeer p (SlotNo, Time))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679256829"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256829"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679256828"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679256827"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256827"><span class="hs-identifier hs-var">time</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>      </span><span id="local-6989586621679256826"><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256826"><span class="hs-identifier hs-var">metrics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (SlotMetric p)
</span><a href="#local-6989586621679256832"><span class="hs-identifier hs-var">getMetrics</span></a></span><span>
</span><span id="line-364"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SlotMetric p -&gt; Maybe (SlotNo, (p, Time))
forall p v. Int -&gt; IntPSQ p v -&gt; Maybe (p, v)
</span><span class="hs-identifier hs-var">IntPSQ.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256826"><span class="hs-identifier hs-var">metrics</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-365"></span><span>           </span><span class="annot"><span class="annottext">Maybe (SlotNo, (p, Time))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>             </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256824"><span class="annot"><span class="annottext">metrics' :: SlotMetric p
</span><a href="#local-6989586621679256824"><span class="hs-identifier hs-var hs-var">metrics'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SlotNo -&gt; (p, Time) -&gt; SlotMetric p -&gt; SlotMetric p
forall p v. Ord p =&gt; Int -&gt; p -&gt; v -&gt; IntPSQ p v -&gt; IntPSQ p v
</span><span class="hs-identifier hs-var">IntPSQ.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256829"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256827"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256826"><span class="hs-identifier hs-var">metrics</span></a></span><span>
</span><span id="line-367"></span><span>             </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SlotMetric p -&gt; Int
forall p v. IntPSQ p v -&gt; Int
</span><span class="hs-identifier hs-var">IntPSQ.size</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256824"><span class="hs-identifier hs-var">metrics'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256830"><span class="hs-identifier hs-var">maxEntriesToTrack</span></a></span><span>
</span><span id="line-368"></span><span>             </span><span class="hs-comment">-- drop last element if the metric board is too large</span><span>
</span><span id="line-369"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SlotMetric p -&gt; Maybe (Int, SlotNo, (p, Time), SlotMetric p)
forall p v. Ord p =&gt; IntPSQ p v -&gt; Maybe (Int, p, v, IntPSQ p v)
</span><span class="hs-identifier hs-var">IntPSQ.minView</span></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256824"><span class="hs-identifier hs-var">metrics'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-370"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Int, SlotNo, (p, Time), SlotMetric p)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible empty pq&quot;</span></span><span>
</span><span id="line-371"></span><span>                            </span><span class="hs-comment">-- We just inserted an element!</span><span>
</span><span id="line-372"></span><span>                    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256820"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256820"><span class="hs-identifier hs-var">minSlotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(p, Time)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256819"><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256819"><span class="hs-identifier hs-var">metrics''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-373"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; STM m () -&gt; STM m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256820"><span class="hs-identifier hs-var">minSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; STM m ()) -&gt; STM m () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-374"></span><span>                              </span><span class="annot"><span class="annottext">SlotMetric p -&gt; STM m ()
</span><a href="#local-6989586621679256831"><span class="hs-identifier hs-var">writeMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256819"><span class="hs-identifier hs-var">metrics''</span></a></span><span>
</span><span id="line-375"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SlotMetric p -&gt; STM m ()
</span><a href="#local-6989586621679256831"><span class="hs-identifier hs-var">writeMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256824"><span class="hs-identifier hs-var">metrics'</span></a></span><span>
</span><span id="line-376"></span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256817"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256817"><span class="hs-identifier hs-var">oldTime</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>               </span><span class="annot"><span class="annottext">Bool -&gt; STM m () -&gt; STM m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256817"><span class="hs-identifier hs-var">oldTime</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256827"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; STM m ()) -&gt; STM m () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-378"></span><span>                    </span><span class="annot"><span class="annottext">SlotMetric p -&gt; STM m ()
</span><a href="#local-6989586621679256831"><span class="hs-identifier hs-var">writeMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SlotNo -&gt; (p, Time) -&gt; SlotMetric p -&gt; SlotMetric p
forall p v. Ord p =&gt; Int -&gt; p -&gt; v -&gt; IntPSQ p v -&gt; IntPSQ p v
</span><span class="hs-identifier hs-var">IntPSQ.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-379"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256829"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256827"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256826"><span class="hs-identifier hs-var">metrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAt"><span class="hs-identifier hs-type">joinedPeerMetricAt</span></a></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256816"><span class="annot"><a href="#local-6989586621679256816"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679256815"><span class="annot"><a href="#local-6989586621679256815"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-384"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256815"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256816"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256815"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256816"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256815"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256816"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span id="joinedPeerMetricAt"><span class="annot"><span class="annottext">joinedPeerMetricAt :: PeerMetrics m p -&gt; STM m (Map p SlotNo)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAt"><span class="hs-identifier hs-var hs-var">joinedPeerMetricAt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679256814"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256814"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p SlotNo
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAtImpl"><span class="hs-identifier hs-var">joinedPeerMetricAtImpl</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; Map p SlotNo)
-&gt; STM m (PeerMetricsState p) -&gt; STM m (Map p SlotNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256814"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAtImpl"><span class="hs-identifier hs-type">joinedPeerMetricAtImpl</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257007"><span class="annot"><a href="#local-6989586621679257007"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-394"></span><span>       </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257007"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257007"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257007"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-397"></span><span id="joinedPeerMetricAtImpl"><span class="annot"><span class="annottext">joinedPeerMetricAtImpl :: PeerMetricsState p -&gt; Map p SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#joinedPeerMetricAtImpl"><span class="hs-identifier hs-var hs-var">joinedPeerMetricAtImpl</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256812"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256812"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">(p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p SlotNo -&gt; Map p SlotNo)
-&gt; Map p SlotNo -&gt; PeerRegistry p -&gt; Map p SlotNo
forall k p v a. (k -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; OrdPSQ k p v -&gt; a
</span><span class="hs-identifier hs-var">OrdPSQ.fold'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256810"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256810"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679256809"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256809"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="annot"><span class="annottext">AverageMetrics
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256808"><span class="annot"><span class="annottext">Map p SlotNo
</span><a href="#local-6989586621679256808"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">p -&gt; SlotNo -&gt; Map p SlotNo -&gt; Map p SlotNo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256810"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256809"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Map p SlotNo
</span><a href="#local-6989586621679256808"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map p SlotNo
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256812"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- Metrics</span><span>
</span><span id="line-402"></span><span class="hs-comment">--</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- * upstreameness</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- * fetchyness by blocks</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- * fetchyness by bytes</span><span>
</span><span id="line-406"></span><span class="hs-comment">--</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="hs-comment">-- | Returns a Map which counts the number of times a given peer was the first</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- to present us with a block/header.</span><span>
</span><span id="line-410"></span><span class="hs-comment">--</span><span>
</span><span id="line-411"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamyness"><span class="hs-identifier hs-type">upstreamyness</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256805"><span class="annot"><a href="#local-6989586621679256805"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679256804"><span class="annot"><a href="#local-6989586621679256804"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-413"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256804"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256805"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256804"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256805"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256804"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256805"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span id="upstreamyness"><span class="annot"><span class="annottext">upstreamyness :: PeerMetrics m p -&gt; STM m (Map p Int)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamyness"><span class="hs-identifier hs-var hs-var">upstreamyness</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679256803"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256803"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>    </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamynessImpl"><span class="hs-identifier hs-var">upstreamynessImpl</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; Map p Int)
-&gt; STM m (PeerMetricsState p) -&gt; STM m (Map p Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256803"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamynessImpl"><span class="hs-identifier hs-type">upstreamynessImpl</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257057"><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-423"></span><span>       </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-426"></span><span id="upstreamynessImpl"><span class="annot"><span class="annottext">upstreamynessImpl :: PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#upstreamynessImpl"><span class="hs-identifier hs-var hs-var">upstreamynessImpl</span></a></span></span><span> </span><span id="local-6989586621679256802"><span class="annot"><span class="annottext">state :: PeerMetricsState p
</span><a href="#local-6989586621679256802"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256801"><span class="annot"><span class="annottext">SlotMetric p
headerMetrics :: SlotMetric p
headerMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric p
</span><a href="#local-6989586621679256801"><span class="hs-identifier hs-var hs-var">headerMetrics</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-427"></span><span>                                           </span><span id="local-6989586621679256800"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256800"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-428"></span><span>                                           </span><span id="local-6989586621679256799"><span class="annot"><span class="annottext">SlotNo
lastSlotNo :: SlotNo
lastSlotNo :: forall p. PeerMetricsState p -&gt; SlotNo
</span><a href="#local-6989586621679256799"><span class="hs-identifier hs-var hs-var">lastSlotNo</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-429"></span><span>                                           </span><span id="local-6989586621679256798"><span class="annot"><span class="annottext">PeerMetricsConfiguration
metricsConfig :: PeerMetricsConfiguration
metricsConfig :: forall p. PeerMetricsState p -&gt; PeerMetricsConfiguration
</span><a href="#local-6989586621679256798"><span class="hs-identifier hs-var hs-var">metricsConfig</span></a></span></span><span>
</span><span id="line-430"></span><span>                                         </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; Map p Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; SlotNo -&gt; (p, Time) -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; SlotMetric p -&gt; Map p Int
forall p v a. (Int -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; IntPSQ p v -&gt; a
</span><span class="hs-identifier hs-var">IntPSQ.fold'</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SlotNo -&gt; (p, Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256795"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric p
</span><a href="#local-6989586621679256801"><span class="hs-identifier hs-var">headerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; PeerRegistry p -&gt; Map p Int
forall k p v a. (k -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; OrdPSQ k p v -&gt; a
</span><span class="hs-identifier hs-var">OrdPSQ.fold'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256794"><span class="hs-identifier hs-var">countCorrection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Maybe SlotNo
forall p. PeerMetricsState p -&gt; Maybe SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#firstSlotNo"><span class="hs-identifier hs-var">firstSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256802"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>                                    </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256800"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">count</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-436"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-437"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-439"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span id="local-6989586621679256795"><span class="annot"><span class="annottext">count :: Int -&gt; SlotNo -&gt; (p, Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256795"><span class="hs-identifier hs-var hs-var">count</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256793"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256793"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Time
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679256792"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256792"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-441"></span><span>        </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int) -&gt; p -&gt; Map p Int -&gt; Map p Int
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256790"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256793"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256792"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span id="local-6989586621679256790"><span class="annot"><span class="annottext">fn :: Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256790"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256789"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256789"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256789"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">countCorrection</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-448"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-449"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-450"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span>
</span><span id="line-451"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-452"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257057"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621679256794"><span class="annot"><span class="annottext">countCorrection :: Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256794"><span class="hs-identifier hs-var hs-var">countCorrection</span></a></span></span><span> </span><span id="local-6989586621679256787"><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">minSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256786"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256786"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679256785"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256785"><span class="hs-identifier hs-var">joinedAt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256784"><span class="annot"><span class="annottext">Int
averageUpstreamyness :: Int
averageUpstreamyness :: AverageMetrics -&gt; Int
</span><a href="#local-6989586621679256784"><span class="hs-identifier hs-var hs-var">averageUpstreamyness</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679256783"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256783"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">p -&gt; Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256786"><span class="hs-identifier hs-var">peer</span></a></span><span>
</span><span id="line-455"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsConfiguration
-&gt; Maybe SlotNo -&gt; SlotNo -&gt; SlotNo -&gt; Int -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#adjustAvg"><span class="hs-identifier hs-var">adjustAvg</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256798"><span class="hs-identifier hs-var">metricsConfig</span></a></span><span>
</span><span id="line-456"></span><span>                              </span><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">minSlotNo</span></a></span><span>
</span><span id="line-457"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256785"><span class="hs-identifier hs-var">joinedAt</span></a></span><span>
</span><span id="line-458"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256799"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span>
</span><span id="line-459"></span><span>                              </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256784"><span class="hs-identifier hs-var">averageUpstreamyness</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>                   </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256783"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="hs-comment">-- | Returns a Map which counts the number of bytes downloaded for a given</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- peer.</span><span>
</span><span id="line-465"></span><span class="hs-comment">--</span><span>
</span><span id="line-466"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytes"><span class="hs-identifier hs-type">fetchynessBytes</span></a></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256781"><span class="annot"><a href="#local-6989586621679256781"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679256780"><span class="annot"><a href="#local-6989586621679256780"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-468"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256780"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256781"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256780"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256781"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256780"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256781"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span id="fetchynessBytes"><span class="annot"><span class="annottext">fetchynessBytes :: PeerMetrics m p -&gt; STM m (Map p Int)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytes"><span class="hs-identifier hs-var hs-var">fetchynessBytes</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679256779"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256779"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytesImpl"><span class="hs-identifier hs-var">fetchynessBytesImpl</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; Map p Int)
-&gt; STM m (PeerMetricsState p) -&gt; STM m (Map p Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256779"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytesImpl"><span class="hs-identifier hs-type">fetchynessBytesImpl</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256778"><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-477"></span><span>       </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-480"></span><span id="fetchynessBytesImpl"><span class="annot"><span class="annottext">fetchynessBytesImpl :: PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBytesImpl"><span class="hs-identifier hs-var hs-var">fetchynessBytesImpl</span></a></span></span><span> </span><span id="local-6989586621679256777"><span class="annot"><span class="annottext">state :: PeerMetricsState p
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256776"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256776"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-481"></span><span>                                             </span><span id="local-6989586621679256775"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>                                             </span><span id="local-6989586621679256774"><span class="annot"><span class="annottext">SlotNo
lastSlotNo :: SlotNo
lastSlotNo :: forall p. PeerMetricsState p -&gt; SlotNo
</span><a href="#local-6989586621679256774"><span class="hs-identifier hs-var hs-var">lastSlotNo</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-483"></span><span>                                             </span><span id="local-6989586621679256773"><span class="annot"><span class="annottext">PeerMetricsConfiguration
metricsConfig :: PeerMetricsConfiguration
metricsConfig :: forall p. PeerMetricsState p -&gt; PeerMetricsConfiguration
</span><a href="#local-6989586621679256773"><span class="hs-identifier hs-var hs-var">metricsConfig</span></a></span></span><span>
</span><span id="line-484"></span><span>                                           </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-485"></span><span>    </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; Map p Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int
 -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; SlotMetric (p, SizeInBytes) -&gt; Map p Int
forall p v a. (Int -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; IntPSQ p v -&gt; a
</span><span class="hs-identifier hs-var">IntPSQ.fold'</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256772"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256776"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; PeerRegistry p -&gt; Map p Int
forall k p v a. (k -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; OrdPSQ k p v -&gt; a
</span><span class="hs-identifier hs-var">OrdPSQ.fold'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256771"><span class="hs-identifier hs-var">countCorrection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Maybe SlotNo
forall p. PeerMetricsState p -&gt; Maybe SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#firstSlotNo"><span class="hs-identifier hs-var">firstSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>                                     </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><a href="#local-6989586621679256772"><span class="hs-identifier hs-type">count</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-490"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-491"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-494"></span><span>    </span><span id="local-6989586621679256772"><span class="annot"><span class="annottext">count :: Int -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256772"><span class="hs-identifier hs-var hs-var">count</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679256770"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256770"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256769"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679256769"><span class="hs-identifier hs-var">bytes</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">Time
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679256768"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int) -&gt; p -&gt; Map p Int -&gt; Map p Int
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256770"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-496"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>        </span><span class="annot"><a href="#local-6989586621679256767"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-498"></span><span>        </span><span id="local-6989586621679256767"><span class="annot"><span class="annottext">fn :: Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679256769"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-499"></span><span>        </span><span class="annot"><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256766"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256766"><span class="hs-identifier hs-var">oldBytes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256766"><span class="hs-identifier hs-var">oldBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679256769"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>    </span><span class="annot"><a href="#local-6989586621679256771"><span class="hs-identifier hs-type">countCorrection</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-502"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-503"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-504"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span>
</span><span id="line-505"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-506"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256778"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-507"></span><span>    </span><span id="local-6989586621679256771"><span class="annot"><span class="annottext">countCorrection :: Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256771"><span class="hs-identifier hs-var hs-var">countCorrection</span></a></span></span><span> </span><span id="local-6989586621679256765"><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">minSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256764"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256764"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679256763"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256763"><span class="hs-identifier hs-var">joinedAt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256762"><span class="annot"><span class="annottext">Int
averageFetchynessBytes :: Int
averageFetchynessBytes :: AverageMetrics -&gt; Int
</span><a href="#local-6989586621679256762"><span class="hs-identifier hs-var hs-var">averageFetchynessBytes</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679256761"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256761"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="annottext">p -&gt; Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256764"><span class="hs-identifier hs-var">peer</span></a></span><span>
</span><span id="line-509"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsConfiguration
-&gt; Maybe SlotNo -&gt; SlotNo -&gt; SlotNo -&gt; Int -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#adjustAvg"><span class="hs-identifier hs-var">adjustAvg</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256773"><span class="hs-identifier hs-var">metricsConfig</span></a></span><span>
</span><span id="line-510"></span><span>                              </span><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">minSlotNo</span></a></span><span>
</span><span id="line-511"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256763"><span class="hs-identifier hs-var">joinedAt</span></a></span><span>
</span><span id="line-512"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256774"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span>
</span><span id="line-513"></span><span>                              </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256762"><span class="hs-identifier hs-var">averageFetchynessBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>                   </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256761"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">-- | Returns a Map which counts the number of times a given peer was the first</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- we downloaded a block from.</span><span>
</span><span id="line-519"></span><span class="hs-comment">--</span><span>
</span><span id="line-520"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocks"><span class="hs-identifier hs-type">fetchynessBlocks</span></a></span><span>
</span><span id="line-521"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256760"><span class="annot"><a href="#local-6989586621679256760"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679256759"><span class="annot"><a href="#local-6989586621679256759"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-522"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256759"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-523"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256760"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256759"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256760"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256759"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256760"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span id="fetchynessBlocks"><span class="annot"><span class="annottext">fetchynessBlocks :: PeerMetrics m p -&gt; STM m (Map p Int)
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocks"><span class="hs-identifier hs-var hs-var">fetchynessBlocks</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679256758"><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
peerMetricsVar :: StrictTVar m (PeerMetricsState p)
peerMetricsVar :: forall (m :: * -&gt; *) p.
PeerMetrics m p -&gt; StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256758"><span class="hs-identifier hs-var hs-var">peerMetricsVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-527"></span><span>    </span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Map p Int
forall p. Ord p =&gt; PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocksImpl"><span class="hs-identifier hs-var">fetchynessBlocksImpl</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerMetricsState p -&gt; Map p Int)
-&gt; STM m (PeerMetricsState p) -&gt; STM m (Map p Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p) -&gt; STM m (PeerMetricsState p)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PeerMetricsState p)
</span><a href="#local-6989586621679256758"><span class="hs-identifier hs-var">peerMetricsVar</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocksImpl"><span class="hs-identifier hs-type">fetchynessBlocksImpl</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679256757"><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-531"></span><span>       </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-532"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-534"></span><span id="fetchynessBlocksImpl"><span class="annot"><span class="annottext">fetchynessBlocksImpl :: PeerMetricsState p -&gt; Map p Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#fetchynessBlocksImpl"><span class="hs-identifier hs-var hs-var">fetchynessBlocksImpl</span></a></span></span><span> </span><span id="local-6989586621679256756"><span class="annot"><span class="annottext">state :: PeerMetricsState p
</span><a href="#local-6989586621679256756"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsState"><span class="hs-identifier hs-type">PeerMetricsState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256755"><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
fetchedMetrics :: SlotMetric (p, SizeInBytes)
fetchedMetrics :: forall p. PeerMetricsState p -&gt; SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256755"><span class="hs-identifier hs-var hs-var">fetchedMetrics</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-535"></span><span>                                              </span><span id="local-6989586621679256754"><span class="annot"><span class="annottext">PeerRegistry p
peerRegistry :: PeerRegistry p
peerRegistry :: forall p. PeerMetricsState p -&gt; PeerRegistry p
</span><a href="#local-6989586621679256754"><span class="hs-identifier hs-var hs-var">peerRegistry</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-536"></span><span>                                              </span><span id="local-6989586621679256753"><span class="annot"><span class="annottext">SlotNo
lastSlotNo :: SlotNo
lastSlotNo :: forall p. PeerMetricsState p -&gt; SlotNo
</span><a href="#local-6989586621679256753"><span class="hs-identifier hs-var hs-var">lastSlotNo</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-537"></span><span>                                              </span><span id="local-6989586621679256752"><span class="annot"><span class="annottext">PeerMetricsConfiguration
metricsConfig :: PeerMetricsConfiguration
metricsConfig :: forall p. PeerMetricsState p -&gt; PeerMetricsConfiguration
</span><a href="#local-6989586621679256752"><span class="hs-identifier hs-var hs-var">metricsConfig</span></a></span></span><span>
</span><span id="line-538"></span><span>                                            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-539"></span><span>    </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; Map p Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int
 -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; SlotMetric (p, SizeInBytes) -&gt; Map p Int
forall p v a. (Int -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; IntPSQ p v -&gt; a
</span><span class="hs-identifier hs-var">IntPSQ.fold'</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256751"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">SlotMetric (p, SizeInBytes)
</span><a href="#local-6989586621679256755"><span class="hs-identifier hs-var">fetchedMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int)
-&gt; Map p Int -&gt; PeerRegistry p -&gt; Map p Int
forall k p v a. (k -&gt; p -&gt; v -&gt; a -&gt; a) -&gt; a -&gt; OrdPSQ k p v -&gt; a
</span><span class="hs-identifier hs-var">OrdPSQ.fold'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256750"><span class="hs-identifier hs-var">countCorrection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsState p -&gt; Maybe SlotNo
forall p. PeerMetricsState p -&gt; Maybe SlotNo
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#firstSlotNo"><span class="hs-identifier hs-var">firstSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsState p
</span><a href="#local-6989586621679256756"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>                                    </span><span class="annot"><span class="annottext">Map p Int
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">PeerRegistry p
</span><a href="#local-6989586621679256754"><span class="hs-identifier hs-var">peerRegistry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><a href="#local-6989586621679256751"><span class="hs-identifier hs-type">count</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-544"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-545"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Time</span></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-547"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-548"></span><span>    </span><span id="local-6989586621679256751"><span class="annot"><span class="annottext">count :: Int -&gt; SlotNo -&gt; ((p, SizeInBytes), Time) -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256751"><span class="hs-identifier hs-var hs-var">count</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679256749"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256749"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">Time
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679256748"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256748"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-549"></span><span>        </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int) -&gt; p -&gt; Map p Int -&gt; Map p Int
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256747"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256749"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256748"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-550"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-551"></span><span>        </span><span class="annot"><a href="#local-6989586621679256747"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-552"></span><span>        </span><span id="local-6989586621679256747"><span class="annot"><span class="annottext">fn :: Maybe Int -&gt; Maybe Int
</span><a href="#local-6989586621679256747"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-553"></span><span>        </span><span class="annot"><a href="#local-6989586621679256747"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256746"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256746"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256746"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>    </span><span class="annot"><a href="#local-6989586621679256750"><span class="hs-identifier hs-type">countCorrection</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-556"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-557"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-558"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span>
</span><span id="line-559"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-560"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256757"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621679256750"><span class="annot"><span class="annottext">countCorrection :: Maybe SlotNo
-&gt; p -&gt; SlotNo -&gt; AverageMetrics -&gt; Map p Int -&gt; Map p Int
</span><a href="#local-6989586621679256750"><span class="hs-identifier hs-var hs-var">countCorrection</span></a></span></span><span> </span><span id="local-6989586621679256745"><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256745"><span class="hs-identifier hs-var">minSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256744"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256744"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679256743"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256743"><span class="hs-identifier hs-var">joinedAt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#AverageMetrics"><span class="hs-identifier hs-type">AverageMetrics</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256742"><span class="annot"><span class="annottext">Int
averageFetchynessBlocks :: Int
averageFetchynessBlocks :: AverageMetrics -&gt; Int
</span><a href="#local-6989586621679256742"><span class="hs-identifier hs-var hs-var">averageFetchynessBlocks</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679256741"><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256741"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-562"></span><span>        </span><span class="annot"><span class="annottext">p -&gt; Int -&gt; Map p Int -&gt; Map p Int
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679256744"><span class="hs-identifier hs-var">peer</span></a></span><span>
</span><span id="line-563"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerMetricsConfiguration
-&gt; Maybe SlotNo -&gt; SlotNo -&gt; SlotNo -&gt; Int -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#adjustAvg"><span class="hs-identifier hs-var">adjustAvg</span></a></span><span> </span><span class="annot"><span class="annottext">PeerMetricsConfiguration
</span><a href="#local-6989586621679256752"><span class="hs-identifier hs-var">metricsConfig</span></a></span><span>
</span><span id="line-564"></span><span>                              </span><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256745"><span class="hs-identifier hs-var">minSlotNo</span></a></span><span>
</span><span id="line-565"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256743"><span class="hs-identifier hs-var">joinedAt</span></a></span><span>
</span><span id="line-566"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256753"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span>
</span><span id="line-567"></span><span>                              </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256742"><span class="hs-identifier hs-var">averageFetchynessBlocks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>                   </span><span class="annot"><span class="annottext">Map p Int
</span><a href="#local-6989586621679256741"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span class="hs-comment">--</span><span>
</span><span id="line-572"></span><span class="hs-comment">-- Utils</span><span>
</span><span id="line-573"></span><span class="hs-comment">--</span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#adjustAvg"><span class="hs-identifier hs-type">adjustAvg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span>
</span><span id="line-577"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-comment">-- ^ smallest slot number</span><span>
</span><span id="line-578"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>       </span><span class="hs-comment">-- ^ slot when joined the leader board</span><span>
</span><span id="line-579"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>       </span><span class="hs-comment">-- ^ current slot</span><span>
</span><span id="line-580"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-581"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-582"></span><span id="adjustAvg"><span class="annot"><span class="annottext">adjustAvg :: PeerMetricsConfiguration
-&gt; Maybe SlotNo -&gt; SlotNo -&gt; SlotNo -&gt; Int -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#adjustAvg"><span class="hs-identifier hs-var hs-var">adjustAvg</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetricsConfiguration"><span class="hs-identifier hs-type">PeerMetricsConfiguration</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256740"><span class="annot"><span class="annottext">Int
maxEntriesToTrack :: Int
maxEntriesToTrack :: PeerMetricsConfiguration -&gt; Int
</span><a href="#local-6989586621679256740"><span class="hs-identifier hs-var hs-var">maxEntriesToTrack</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679256739"><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256739"><span class="hs-identifier hs-var">minSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256738"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256738"><span class="hs-identifier hs-var">joinedSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256737"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256737"><span class="hs-identifier hs-var">lastSlotNo</span></a></span></span><span> </span><span id="local-6989586621679256736"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256736"><span class="hs-identifier hs-var">avg</span></a></span></span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-comment">-- when there are only a few results in the 'PeerMetricsState' we don't</span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-comment">-- take into account the average.  This allows the system to start, without</span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-comment">-- penalising the peers which we connected to early.</span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var">lastSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256734"><span class="hs-identifier hs-var">minSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256740"><span class="hs-identifier hs-var">maxEntriesToTrack</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-comment">-- the peer is too old to take the correction into account.</span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var">lastSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var">joinedSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256740"><span class="hs-identifier hs-var">maxEntriesToTrack</span></a></span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-594"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256740"><span class="hs-identifier hs-var">maxEntriesToTrack</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var">joinedSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var">lastSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256736"><span class="hs-identifier hs-var">avg</span></a></span><span>
</span><span id="line-595"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256740"><span class="hs-identifier hs-var">maxEntriesToTrack</span></a></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-597"></span><span>    </span><span class="annot"><a href="#local-6989586621679256734"><span class="hs-identifier hs-type">minSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679256735"><span class="hs-identifier hs-type">lastSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679256731"><span class="hs-identifier hs-type">joinedSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-598"></span><span>    </span><span id="local-6989586621679256734"><span class="annot"><span class="annottext">minSlot :: Int
</span><a href="#local-6989586621679256734"><span class="hs-identifier hs-var hs-var">minSlot</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (SlotNo -&gt; Int) -&gt; Maybe SlotNo -&gt; Int
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679256739"><span class="hs-identifier hs-var">minSlotNo</span></a></span><span>
</span><span id="line-599"></span><span>    </span><span id="local-6989586621679256735"><span class="annot"><span class="annottext">lastSlot :: Int
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var hs-var">lastSlot</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256737"><span class="hs-identifier hs-var">lastSlotNo</span></a></span><span>
</span><span id="line-600"></span><span>    </span><span id="local-6989586621679256731"><span class="annot"><span class="annottext">joinedSlot :: Int
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var hs-var">joinedSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Int
</span><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#slotToInt"><span class="hs-identifier hs-var">slotToInt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679256738"><span class="hs-identifier hs-var">joinedSlotNo</span></a></span><span>
</span><span id="line-601"></span></pre></body></html>