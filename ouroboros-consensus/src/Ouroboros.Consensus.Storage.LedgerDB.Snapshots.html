<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveGeneric          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase             #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses  #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf             #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns         #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes             #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards        #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables    #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications       #-}</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Snapshots</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier">DiskSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Read from disk</span></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier">SnapshotFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsTemporary"><span class="hs-identifier">diskSnapshotIsTemporary</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier">listSnapshots</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#readSnapshot"><span class="hs-identifier">readSnapshot</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Write to disk</span></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#takeSnapshot"><span class="hs-identifier">takeSnapshot</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#trimSnapshots"><span class="hs-identifier">trimSnapshots</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#writeSnapshot"><span class="hs-identifier">writeSnapshot</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Low-level API (primarily exposed for testing)</span></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#decodeSnapshotBackwardsCompatible"><span class="hs-identifier">decodeSnapshotBackwardsCompatible</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#deleteSnapshot"><span class="hs-identifier">deleteSnapshot</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#encodeSnapshot"><span class="hs-identifier">encodeSnapshot</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToFileName"><span class="hs-identifier">snapshotToFileName</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier">snapshotToPath</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace</span></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TraceSnapshotEvent"><span class="hs-identifier">TraceSnapshotEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Write</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.Serialise.Decoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decoder</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Serialise.Decoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Dec</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.Serialise.Encoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Encoding</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/mtl-2.2.2/src"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API.Types</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Text.Read</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">readMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html"><span class="hs-identifier">Ouroboros.Consensus.Util.CBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html#ReadIncrementalErr"><span class="hs-identifier">ReadIncrementalErr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html#decodeWithOrigin"><span class="hs-identifier">decodeWithOrigin</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html#readIncremental"><span class="hs-identifier">readIncremental</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Versioned.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Versioned</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Write to disk
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621680040714"><span id="local-6989586621680040715"></span></span><span class="hs-keyword">data</span><span> </span><span id="SnapshotFailure"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier hs-var">SnapshotFailure</span></a></span></span><span> </span><span id="local-6989586621680040713"><span class="annot"><a href="#local-6989586621680040713"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- | We failed to deserialise the snapshot</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- This can happen due to data corruption in the ledger DB.</span><span>
</span><span id="line-72"></span><span>    </span><span id="InitFailureRead"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureRead"><span class="hs-identifier hs-var">InitFailureRead</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html#ReadIncrementalErr"><span class="hs-identifier hs-type">ReadIncrementalErr</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- | This snapshot is too recent (ahead of the tip of the chain)</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InitFailureTooRecent"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureTooRecent"><span class="hs-identifier hs-var">InitFailureTooRecent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040713"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- | This snapshot was of the ledger state at genesis, even though we never</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- take snapshots at genesis, so this is unexpected.</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InitFailureGenesis"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureGenesis"><span class="hs-identifier hs-var">InitFailureGenesis</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040704"><span id="local-6989586621680040706"><span id="local-6989586621680040708"><span class="annot"><span class="annottext">Int -&gt; SnapshotFailure blk -&gt; ShowS
[SnapshotFailure blk] -&gt; ShowS
SnapshotFailure blk -&gt; String
(Int -&gt; SnapshotFailure blk -&gt; ShowS)
-&gt; (SnapshotFailure blk -&gt; String)
-&gt; ([SnapshotFailure blk] -&gt; ShowS)
-&gt; Show (SnapshotFailure blk)
forall blk. StandardHash blk =&gt; Int -&gt; SnapshotFailure blk -&gt; ShowS
forall blk. StandardHash blk =&gt; [SnapshotFailure blk] -&gt; ShowS
forall blk. StandardHash blk =&gt; SnapshotFailure blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SnapshotFailure blk] -&gt; ShowS
$cshowList :: forall blk. StandardHash blk =&gt; [SnapshotFailure blk] -&gt; ShowS
show :: SnapshotFailure blk -&gt; String
$cshow :: forall blk. StandardHash blk =&gt; SnapshotFailure blk -&gt; String
showsPrec :: Int -&gt; SnapshotFailure blk -&gt; ShowS
$cshowsPrec :: forall blk. StandardHash blk =&gt; Int -&gt; SnapshotFailure blk -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040699"><span id="local-6989586621680040701"><span class="annot"><span class="annottext">SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
(SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool)
-&gt; (SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool)
-&gt; Eq (SnapshotFailure blk)
forall blk.
StandardHash blk =&gt;
SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
$c/= :: forall blk.
StandardHash blk =&gt;
SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
== :: SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
$c== :: forall blk.
StandardHash blk =&gt;
SnapshotFailure blk -&gt; SnapshotFailure blk -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. SnapshotFailure blk -&gt; Rep (SnapshotFailure blk) x)
-&gt; (forall x. Rep (SnapshotFailure blk) x -&gt; SnapshotFailure blk)
-&gt; Generic (SnapshotFailure blk)
forall x. Rep (SnapshotFailure blk) x -&gt; SnapshotFailure blk
forall x. SnapshotFailure blk -&gt; Rep (SnapshotFailure blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x. Rep (SnapshotFailure blk) x -&gt; SnapshotFailure blk
forall blk x. SnapshotFailure blk -&gt; Rep (SnapshotFailure blk) x
$cto :: forall blk x. Rep (SnapshotFailure blk) x -&gt; SnapshotFailure blk
$cfrom :: forall blk x. SnapshotFailure blk -&gt; Rep (SnapshotFailure blk) x
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span id="local-6989586621680040693"><span id="local-6989586621680040694"></span></span><span class="hs-keyword">data</span><span> </span><span id="TraceSnapshotEvent"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TraceSnapshotEvent"><span class="hs-identifier hs-var">TraceSnapshotEvent</span></a></span></span><span> </span><span id="local-6989586621680040866"><span class="annot"><a href="#local-6989586621680040866"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="InvalidSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InvalidSnapshot"><span class="hs-identifier hs-var">InvalidSnapshot</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier hs-type">SnapshotFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040866"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- ^ An on disk snapshot was skipped because it was invalid.</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TookSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TookSnapshot"><span class="hs-identifier hs-var">TookSnapshot</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040866"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- ^ A snapshot was written to disk.</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DeletedSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DeletedSnapshot"><span class="hs-identifier hs-var">DeletedSnapshot</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- ^ An old or invalid on-disk snapshot was deleted</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 TraceSnapshotEvent blk -&gt; Rep (TraceSnapshotEvent blk) x)
-&gt; (forall x.
    Rep (TraceSnapshotEvent blk) x -&gt; TraceSnapshotEvent blk)
-&gt; Generic (TraceSnapshotEvent blk)
forall x. Rep (TraceSnapshotEvent blk) x -&gt; TraceSnapshotEvent blk
forall x. TraceSnapshotEvent blk -&gt; Rep (TraceSnapshotEvent blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x.
Rep (TraceSnapshotEvent blk) x -&gt; TraceSnapshotEvent blk
forall blk x.
TraceSnapshotEvent blk -&gt; Rep (TraceSnapshotEvent blk) x
$cto :: forall blk x.
Rep (TraceSnapshotEvent blk) x -&gt; TraceSnapshotEvent blk
$cfrom :: forall blk x.
TraceSnapshotEvent blk -&gt; Rep (TraceSnapshotEvent blk) x
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040684"><span id="local-6989586621680040686"><span class="annot"><span class="annottext">TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
(TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool)
-&gt; (TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool)
-&gt; Eq (TraceSnapshotEvent blk)
forall blk.
StandardHash blk =&gt;
TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
$c/= :: forall blk.
StandardHash blk =&gt;
TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
== :: TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
$c== :: forall blk.
StandardHash blk =&gt;
TraceSnapshotEvent blk -&gt; TraceSnapshotEvent blk -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040678"><span id="local-6989586621680040680"><span id="local-6989586621680040682"><span class="annot"><span class="annottext">Int -&gt; TraceSnapshotEvent blk -&gt; ShowS
[TraceSnapshotEvent blk] -&gt; ShowS
TraceSnapshotEvent blk -&gt; String
(Int -&gt; TraceSnapshotEvent blk -&gt; ShowS)
-&gt; (TraceSnapshotEvent blk -&gt; String)
-&gt; ([TraceSnapshotEvent blk] -&gt; ShowS)
-&gt; Show (TraceSnapshotEvent blk)
forall blk.
StandardHash blk =&gt;
Int -&gt; TraceSnapshotEvent blk -&gt; ShowS
forall blk. StandardHash blk =&gt; [TraceSnapshotEvent blk] -&gt; ShowS
forall blk. StandardHash blk =&gt; TraceSnapshotEvent blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TraceSnapshotEvent blk] -&gt; ShowS
$cshowList :: forall blk. StandardHash blk =&gt; [TraceSnapshotEvent blk] -&gt; ShowS
show :: TraceSnapshotEvent blk -&gt; String
$cshow :: forall blk. StandardHash blk =&gt; TraceSnapshotEvent blk -&gt; String
showsPrec :: Int -&gt; TraceSnapshotEvent blk -&gt; ShowS
$cshowsPrec :: forall blk.
StandardHash blk =&gt;
Int -&gt; TraceSnapshotEvent blk -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- | Take a snapshot of the /oldest ledger state/ in the ledger DB</span><span>
</span><span id="line-92"></span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- We write the /oldest/ ledger state to disk because the intention is to only</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- write ledger states to disk that we know to be immutable. Primarily for</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- testing purposes, 'takeSnapshot' returns the block reference corresponding</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- to the snapshot that we wrote.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- If a snapshot with the same number already exists on disk or if the tip is at</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- genesis, no snapshot is taken.</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- Note that an EBB can have the same slot number and thus snapshot number as</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- the block after it. This doesn't matter. The one block difference in the</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- ledger state doesn't warrant an additional snapshot. The number in the name</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- of the snapshot is only indicative, we don't rely on it being correct.</span><span>
</span><span id="line-105"></span><span class="hs-comment">--</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- NOTE: This is a lower-level API that takes a snapshot independent from</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- whether this snapshot corresponds to a state that is more than @k@ back.</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- TODO: Should we delete the file if an error occurs during writing?</span><span>
</span><span id="line-110"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#takeSnapshot"><span class="hs-identifier hs-type">takeSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-111"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040677"><span class="annot"><a href="#local-6989586621680040677"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680040676"><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621680040677"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#IsLedger"><span class="hs-identifier hs-type">IsLedger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680040677"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TraceSnapshotEvent"><span class="hs-identifier hs-type">TraceSnapshotEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040677"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040677"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040676"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span id="takeSnapshot"><span class="annot"><span class="annottext">takeSnapshot :: Tracer m (TraceSnapshotEvent blk)
-&gt; SomeHasFS m
-&gt; (ExtLedgerState blk -&gt; Encoding)
-&gt; ExtLedgerState blk
-&gt; m (Maybe (DiskSnapshot, RealPoint blk))
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#takeSnapshot"><span class="hs-identifier hs-var hs-var">takeSnapshot</span></a></span></span><span> </span><span id="local-6989586621680040673"><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk)
</span><a href="#local-6989586621680040673"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680040672"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040672"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621680040671"><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040671"><span class="hs-identifier hs-var">encLedger</span></a></span></span><span> </span><span id="local-6989586621680040670"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680040670"><span class="hs-identifier hs-var">oldest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin (RealPoint blk)
forall blk. Point blk -&gt; WithOrigin (RealPoint blk)
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#pointToWithOriginRealPoint"><span class="hs-identifier hs-var">pointToWithOriginRealPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (ExtLedgerState blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Point (ExtLedgerState blk)
forall l. GetTip l =&gt; l -&gt; Point l
</span><a href="Ouroboros.Consensus.Ledger.Basics.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680040670"><span class="hs-identifier hs-var">oldest</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">Maybe (DiskSnapshot, RealPoint blk)
-&gt; m (Maybe (DiskSnapshot, RealPoint blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiskSnapshot, RealPoint blk)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621680040664"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680040664"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680040663"><span class="annot"><span class="annottext">number :: Word64
</span><a href="#local-6989586621680040663"><span class="hs-identifier hs-var hs-var">number</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">unSlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; SlotNo
forall blk. RealPoint blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointSlot"><span class="hs-identifier hs-var">realPointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680040664"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>            </span><span id="local-6989586621680040660"><span class="annot"><span class="annottext">snapshot :: DiskSnapshot
</span><a href="#local-6989586621680040660"><span class="hs-identifier hs-var hs-var">snapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Maybe String -&gt; DiskSnapshot
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-var">DiskSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680040663"><span class="hs-identifier hs-var">number</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621680040658"><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621680040658"><span class="hs-identifier hs-var">snapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeHasFS m -&gt; m [DiskSnapshot]
forall (m :: * -&gt; *). Monad m =&gt; SomeHasFS m -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier hs-var">listSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040672"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(DiskSnapshot -&gt; Bool) -&gt; [DiskSnapshot] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.any</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680040663"><span class="hs-identifier hs-var">number</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Bool)
-&gt; (DiskSnapshot -&gt; Word64) -&gt; DiskSnapshot -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#dsNumber"><span class="hs-identifier hs-var hs-var">dsNumber</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621680040658"><span class="hs-identifier hs-var">snapshots</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="annottext">Maybe (DiskSnapshot, RealPoint blk)
-&gt; m (Maybe (DiskSnapshot, RealPoint blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiskSnapshot, RealPoint blk)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>          </span><span class="annot"><span class="annottext">SomeHasFS m
-&gt; (ExtLedgerState blk -&gt; Encoding)
-&gt; DiskSnapshot
-&gt; ExtLedgerState blk
-&gt; m ()
forall (m :: * -&gt; *) blk.
MonadThrow m =&gt;
SomeHasFS m
-&gt; (ExtLedgerState blk -&gt; Encoding)
-&gt; DiskSnapshot
-&gt; ExtLedgerState blk
-&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#writeSnapshot"><span class="hs-identifier hs-var">writeSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040672"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040671"><span class="hs-identifier hs-var">encLedger</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040660"><span class="hs-identifier hs-var">snapshot</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680040670"><span class="hs-identifier hs-var">oldest</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk) -&gt; TraceSnapshotEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk)
</span><a href="#local-6989586621680040673"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceSnapshotEvent blk -&gt; m ()) -&gt; TraceSnapshotEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; RealPoint blk -&gt; TraceSnapshotEvent blk
forall blk. DiskSnapshot -&gt; RealPoint blk -&gt; TraceSnapshotEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TookSnapshot"><span class="hs-identifier hs-var">TookSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040660"><span class="hs-identifier hs-var">snapshot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680040664"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><span class="annottext">Maybe (DiskSnapshot, RealPoint blk)
-&gt; m (Maybe (DiskSnapshot, RealPoint blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (DiskSnapshot, RealPoint blk)
 -&gt; m (Maybe (DiskSnapshot, RealPoint blk)))
-&gt; Maybe (DiskSnapshot, RealPoint blk)
-&gt; m (Maybe (DiskSnapshot, RealPoint blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(DiskSnapshot, RealPoint blk)
-&gt; Maybe (DiskSnapshot, RealPoint blk)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040660"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680040664"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Trim the number of on disk snapshots so that at most 'onDiskNumSnapshots'</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- snapshots are stored on disk. The oldest snapshots are deleted.</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- The deleted snapshots are returned.</span><span>
</span><span id="line-135"></span><span id="local-6989586621680040652"><span id="local-6989586621680040653"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#trimSnapshots"><span class="hs-identifier hs-type">trimSnapshots</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-136"></span><span>     </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040653"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680040653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TraceSnapshotEvent"><span class="hs-identifier hs-type">TraceSnapshotEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040652"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040653"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#DiskPolicy"><span class="hs-identifier hs-type">DiskPolicy</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-141"></span><span id="trimSnapshots"><span class="annot"><span class="annottext">trimSnapshots :: Tracer m (TraceSnapshotEvent r)
-&gt; SomeHasFS m -&gt; DiskPolicy -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#trimSnapshots"><span class="hs-identifier hs-var hs-var">trimSnapshots</span></a></span></span><span> </span><span id="local-6989586621680040651"><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent r)
</span><a href="#local-6989586621680040651"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680040650"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040650"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#DiskPolicy"><span class="hs-identifier hs-type">DiskPolicy</span></a></span><span class="hs-special">{</span><span id="local-6989586621680040647"><span id="local-6989586621680040648"><span class="annot"><span class="annottext">Word
TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
onDiskShouldTakeSnapshot :: DiskPolicy -&gt; TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
onDiskNumSnapshots :: DiskPolicy -&gt; Word
onDiskShouldTakeSnapshot :: TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
onDiskNumSnapshots :: Word
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#onDiskShouldTakeSnapshot"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- We only trim temporary snapshots</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621680040644"><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621680040644"><span class="hs-identifier hs-var">snapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DiskSnapshot -&gt; Bool) -&gt; [DiskSnapshot] -&gt; [DiskSnapshot]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsTemporary"><span class="hs-identifier hs-var">diskSnapshotIsTemporary</span></a></span><span> </span><span class="annot"><span class="annottext">([DiskSnapshot] -&gt; [DiskSnapshot])
-&gt; m [DiskSnapshot] -&gt; m [DiskSnapshot]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m -&gt; m [DiskSnapshot]
forall (m :: * -&gt; *). Monad m =&gt; SomeHasFS m -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier hs-var">listSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040650"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- The snapshot are most recent first, so we can simply drop from the</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- front to get the snapshots that are &quot;too&quot; old.</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><span class="annottext">[DiskSnapshot]
-&gt; (DiskSnapshot -&gt; m DiskSnapshot) -&gt; m [DiskSnapshot]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [DiskSnapshot] -&gt; [DiskSnapshot]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">drop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621680040648"><span class="hs-identifier hs-var">onDiskNumSnapshots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621680040644"><span class="hs-identifier hs-var">snapshots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((DiskSnapshot -&gt; m DiskSnapshot) -&gt; m [DiskSnapshot])
-&gt; (DiskSnapshot -&gt; m DiskSnapshot) -&gt; m [DiskSnapshot]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040640"><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040640"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">SomeHasFS m -&gt; DiskSnapshot -&gt; m ()
forall (m :: * -&gt; *).
HasCallStack =&gt;
SomeHasFS m -&gt; DiskSnapshot -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#deleteSnapshot"><span class="hs-identifier hs-var">deleteSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040650"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040640"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent r) -&gt; TraceSnapshotEvent r -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent r)
</span><a href="#local-6989586621680040651"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceSnapshotEvent r -&gt; m ()) -&gt; TraceSnapshotEvent r -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; TraceSnapshotEvent r
forall blk. DiskSnapshot -&gt; TraceSnapshotEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DeletedSnapshot"><span class="hs-identifier hs-var">DeletedSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040640"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; m DiskSnapshot
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040640"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: reading from disk
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span id="local-6989586621680040638"><span id="local-6989586621680040639"></span></span><span class="hs-keyword">data</span><span> </span><span id="DiskSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-var">DiskSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DiskSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-var">DiskSnapshot</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-comment">-- | Snapshots are numbered. We will try the snapshots with the highest</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- number first.</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-comment">-- When creating a snapshot, we use the slot number of the ledger state it</span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-comment">-- corresponds to as the snapshot number. This gives an indication of how</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-comment">-- recent the snapshot is.</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-comment">-- Note that the snapshot names are only indicative, we don't rely on the</span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-comment">-- snapshot number matching the slot number of the corresponding ledger</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-comment">-- state. We only use the snapshots numbers to determine the order in</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-comment">-- which we try them.</span><span>
</span><span id="line-167"></span><span>      </span><span id="dsNumber"><span class="annot"><span class="annottext">DiskSnapshot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#dsNumber"><span class="hs-identifier hs-var hs-var">dsNumber</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-comment">-- | Snapshots can optionally have a suffix, separated by the snapshot</span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-comment">-- number with an underscore, e.g., @4492799_last_Byron@. This suffix acts</span><span>
</span><span id="line-171"></span><span>      </span><span class="hs-comment">-- as metadata for the operator of the node. Snapshots with a suffix will</span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-comment">-- /not be trimmed/.</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dsSuffix"><span class="annot"><span class="annottext">DiskSnapshot -&gt; Maybe String
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#dsSuffix"><span class="hs-identifier hs-var hs-var">dsSuffix</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680040631"><span id="local-6989586621680040633"><span id="local-6989586621680040635"><span class="annot"><span class="annottext">Int -&gt; DiskSnapshot -&gt; ShowS
[DiskSnapshot] -&gt; ShowS
DiskSnapshot -&gt; String
(Int -&gt; DiskSnapshot -&gt; ShowS)
-&gt; (DiskSnapshot -&gt; String)
-&gt; ([DiskSnapshot] -&gt; ShowS)
-&gt; Show DiskSnapshot
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DiskSnapshot] -&gt; ShowS
$cshowList :: [DiskSnapshot] -&gt; ShowS
show :: DiskSnapshot -&gt; String
$cshow :: DiskSnapshot -&gt; String
showsPrec :: Int -&gt; DiskSnapshot -&gt; ShowS
$cshowsPrec :: Int -&gt; DiskSnapshot -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040627"><span id="local-6989586621680040629"><span class="annot"><span class="annottext">DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
(DiskSnapshot -&gt; DiskSnapshot -&gt; Bool)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Bool) -&gt; Eq DiskSnapshot
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c/= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
== :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c== :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040612"><span id="local-6989586621680040614"><span id="local-6989586621680040616"><span id="local-6989586621680040618"><span id="local-6989586621680040620"><span id="local-6989586621680040622"><span id="local-6989586621680040624"><span class="annot"><span class="annottext">Eq DiskSnapshot
Eq DiskSnapshot
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Ordering)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Bool)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Bool)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Bool)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; Bool)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot)
-&gt; (DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot)
-&gt; Ord DiskSnapshot
DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
DiskSnapshot -&gt; DiskSnapshot -&gt; Ordering
DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot
$cmin :: DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot
max :: DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot
$cmax :: DiskSnapshot -&gt; DiskSnapshot -&gt; DiskSnapshot
&gt;= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c&gt;= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
&gt; :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c&gt; :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
&lt;= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c&lt;= :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
&lt; :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
$c&lt; :: DiskSnapshot -&gt; DiskSnapshot -&gt; Bool
compare :: DiskSnapshot -&gt; DiskSnapshot -&gt; Ordering
$ccompare :: DiskSnapshot -&gt; DiskSnapshot -&gt; Ordering
$cp1Ord :: Eq DiskSnapshot
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. DiskSnapshot -&gt; Rep DiskSnapshot x)
-&gt; (forall x. Rep DiskSnapshot x -&gt; DiskSnapshot)
-&gt; Generic DiskSnapshot
forall x. Rep DiskSnapshot x -&gt; DiskSnapshot
forall x. DiskSnapshot -&gt; Rep DiskSnapshot x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep DiskSnapshot x -&gt; DiskSnapshot
$cfrom :: forall x. DiskSnapshot -&gt; Rep DiskSnapshot x
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">-- | Named snapshot are permanent, they will never be deleted when trimming.</span><span>
</span><span id="line-178"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsPermanent"><span class="hs-identifier hs-type">diskSnapshotIsPermanent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-179"></span><span id="diskSnapshotIsPermanent"><span class="annot"><span class="annottext">diskSnapshotIsPermanent :: DiskSnapshot -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsPermanent"><span class="hs-identifier hs-var hs-var">diskSnapshotIsPermanent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Bool)
-&gt; (DiskSnapshot -&gt; Maybe String) -&gt; DiskSnapshot -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Maybe String
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#dsSuffix"><span class="hs-identifier hs-var hs-var">dsSuffix</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="hs-comment">-- | The snapshots that are periodically created are temporary, they will be</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- deleted when trimming</span><span>
</span><span id="line-183"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsTemporary"><span class="hs-identifier hs-type">diskSnapshotIsTemporary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-184"></span><span id="diskSnapshotIsTemporary"><span class="annot"><span class="annottext">diskSnapshotIsTemporary :: DiskSnapshot -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsTemporary"><span class="hs-identifier hs-var hs-var">diskSnapshotIsTemporary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (DiskSnapshot -&gt; Bool) -&gt; DiskSnapshot -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsPermanent"><span class="hs-identifier hs-var">diskSnapshotIsPermanent</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Read snapshot from disk</span><span>
</span><span id="line-187"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#readSnapshot"><span class="hs-identifier hs-type">readSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-188"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040606"><span class="annot"><a href="#local-6989586621680040606"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680040605"><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040606"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040606"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040842"><span class="annot"><a href="#local-6989586621680040842"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040842"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040839"><span class="annot"><a href="#local-6989586621680040839"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040839"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CBOR.html#ReadIncrementalErr"><span class="hs-identifier hs-type">ReadIncrementalErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span id="readSnapshot"><span class="annot"><span class="annottext">readSnapshot :: SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; DiskSnapshot
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#readSnapshot"><span class="hs-identifier hs-var hs-var">readSnapshot</span></a></span></span><span> </span><span id="local-6989586621680040604"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040604"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621680040603"><span class="annot"><span class="annottext">forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621680040603"><span class="hs-identifier hs-var">decLedger</span></a></span></span><span> </span><span id="local-6989586621680040602"><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621680040602"><span class="hs-identifier hs-var">decHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">m (Either ReadIncrementalErr (ExtLedgerState blk))
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">(m (Either ReadIncrementalErr (ExtLedgerState blk))
 -&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk))
-&gt; (DiskSnapshot
    -&gt; m (Either ReadIncrementalErr (ExtLedgerState blk)))
-&gt; DiskSnapshot
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; FsPath
-&gt; m (Either ReadIncrementalErr (ExtLedgerState blk))
forall (m :: * -&gt; *) a.
IOLike m =&gt;
SomeHasFS m
-&gt; (forall s. Decoder s a)
-&gt; FsPath
-&gt; m (Either ReadIncrementalErr a)
</span><a href="Ouroboros.Consensus.Util.CBOR.html#readIncremental"><span class="hs-identifier hs-var">readIncremental</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621680040604"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621680040600"><span class="hs-identifier hs-var">decoder</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="annottext">(FsPath -&gt; m (Either ReadIncrementalErr (ExtLedgerState blk)))
-&gt; (DiskSnapshot -&gt; FsPath)
-&gt; DiskSnapshot
-&gt; m (Either ReadIncrementalErr (ExtLedgerState blk))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier hs-var">snapshotToPath</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621680040599"><span class="annot"><a href="#local-6989586621680040600"><span class="hs-identifier hs-type">decoder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040599"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621680040600"><span class="annot"><span class="annottext">decoder :: Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621680040600"><span class="hs-identifier hs-var hs-var">decoder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (ExtLedgerState blk)
forall l blk.
Proxy blk
-&gt; (forall s. Decoder s l)
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#decodeSnapshotBackwardsCompatible"><span class="hs-identifier hs-var">decodeSnapshotBackwardsCompatible</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk
forall k (t :: k). Proxy t
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680040605"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621680040603"><span class="hs-identifier hs-var">decLedger</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621680040602"><span class="hs-identifier hs-var">decHash</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | Write snapshot to disk</span><span>
</span><span id="line-203"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#writeSnapshot"><span class="hs-identifier hs-type">writeSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-204"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040874"><span class="annot"><a href="#local-6989586621680040874"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680040872"><span class="annot"><a href="#local-6989586621680040872"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621680040874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040872"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040872"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span id="writeSnapshot"><span class="annot"><span class="annottext">writeSnapshot :: SomeHasFS m
-&gt; (ExtLedgerState blk -&gt; Encoding)
-&gt; DiskSnapshot
-&gt; ExtLedgerState blk
-&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#writeSnapshot"><span class="hs-identifier hs-var hs-var">writeSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span id="local-6989586621680040596"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621680040596"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680040595"><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040595"><span class="hs-identifier hs-var">encLedger</span></a></span></span><span> </span><span id="local-6989586621680040594"><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040594"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621680040593"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680040593"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621680040596"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiskSnapshot -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier hs-var">snapshotToPath</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621680040594"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AllowExisting -&gt; OpenMode
</span><span class="hs-identifier hs-var">WriteMode</span></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">MustBeNew</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m ()) -&gt; m ()) -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680040589"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621680040589"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">m Word64 -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m Word64 -&gt; m ()) -&gt; m Word64 -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Builder -&gt; m Word64
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; Builder -&gt; m Word64
</span><span class="hs-identifier hs-var">hPut</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621680040596"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621680040589"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; m Word64) -&gt; Builder -&gt; m Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Builder
</span><span class="hs-identifier hs-var">CBOR.toBuilder</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040585"><span class="hs-identifier hs-var">encode</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680040593"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><a href="#local-6989586621680040585"><span class="hs-identifier hs-type">encode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040872"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621680040585"><span class="annot"><span class="annottext">encode :: ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040585"><span class="hs-identifier hs-var hs-var">encode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; Encoding) -&gt; ExtLedgerState blk -&gt; Encoding
forall l. (l -&gt; Encoding) -&gt; l -&gt; Encoding
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#encodeSnapshot"><span class="hs-identifier hs-var">encodeSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Encoding
</span><a href="#local-6989586621680040595"><span class="hs-identifier hs-var">encLedger</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-comment">-- | Delete snapshot from disk</span><span>
</span><span id="line-217"></span><span id="local-6989586621680040848"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#deleteSnapshot"><span class="hs-identifier hs-type">deleteSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040848"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040848"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-218"></span><span id="deleteSnapshot"><span class="annot"><span class="annottext">deleteSnapshot :: SomeHasFS m -&gt; DiskSnapshot -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#deleteSnapshot"><span class="hs-identifier hs-var hs-var">deleteSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span class="hs-special">{</span><span id="local-6989586621680040566"><span id="local-6989586621680040567"><span id="local-6989586621680040568"><span id="local-6989586621680040569"><span id="local-6989586621680040570"><span id="local-6989586621680040571"><span id="local-6989586621680040572"><span id="local-6989586621680040573"><span id="local-6989586621680040574"><span id="local-6989586621680040575"><span id="local-6989586621680040576"><span id="local-6989586621680040577"><span id="local-6989586621680040578"><span id="local-6989586621680040579"><span id="local-6989586621680040580"><span id="local-6989586621680040581"><span id="local-6989586621680040582"><span id="local-6989586621680040583"><span class="annot"><span class="annottext">m String
HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
HasCallStack =&gt; Handle h -&gt; m Bool
HasCallStack =&gt; Handle h -&gt; m Word64
HasCallStack =&gt; Handle h -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
HasCallStack =&gt; FsPath -&gt; m Bool
HasCallStack =&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; m (Set String)
HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; FsErrorPath
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
mkFsErrorPath :: forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hSeek :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hPutSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
hGetSomeAt :: forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
dumpState :: forall (m :: * -&gt; *) h. HasFS m h -&gt; m String
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
createDirectoryIfMissing :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
mkFsErrorPath :: FsPath -&gt; FsErrorPath
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: m String
</span><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m ()
FsPath -&gt; m ()
</span><a href="#local-6989586621680040568"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FsPath -&gt; m ())
-&gt; (DiskSnapshot -&gt; FsPath) -&gt; DiskSnapshot -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier hs-var">snapshotToPath</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | List on-disk snapshots, highest number first.</span><span>
</span><span id="line-221"></span><span id="local-6989586621680040880"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier hs-type">listSnapshots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040880"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621680040880"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040880"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-222"></span><span id="listSnapshots"><span class="annot"><span class="annottext">listSnapshots :: SomeHasFS m -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier hs-var hs-var">listSnapshots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span class="hs-special">{</span><span id="local-6989586621680040530"><span id="local-6989586621680040531"><span id="local-6989586621680040532"><span id="local-6989586621680040533"><span id="local-6989586621680040534"><span id="local-6989586621680040535"><span id="local-6989586621680040536"><span id="local-6989586621680040537"><span id="local-6989586621680040538"><span id="local-6989586621680040539"><span id="local-6989586621680040540"><span id="local-6989586621680040541"><span id="local-6989586621680040542"><span id="local-6989586621680040543"><span id="local-6989586621680040544"><span id="local-6989586621680040545"><span id="local-6989586621680040546"><span id="local-6989586621680040547"><span class="annot"><span class="annottext">m String
HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
HasCallStack =&gt; Handle h -&gt; m Bool
HasCallStack =&gt; Handle h -&gt; m Word64
HasCallStack =&gt; Handle h -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
HasCallStack =&gt; FsPath -&gt; m Bool
HasCallStack =&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; m (Set String)
HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; FsErrorPath
mkFsErrorPath :: FsPath -&gt; FsErrorPath
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: m String
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
mkFsErrorPath :: forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hSeek :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hPutSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
hGetSomeAt :: forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
dumpState :: forall (m :: * -&gt; *) h. HasFS m h -&gt; m String
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
createDirectoryIfMissing :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
</span><a href="#local-6989586621680040530"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">Set String -&gt; [DiskSnapshot]
</span><a href="#local-6989586621680040529"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Set String -&gt; [DiskSnapshot])
-&gt; m (Set String) -&gt; m [DiskSnapshot]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m (Set String)
FsPath -&gt; m (Set String)
</span><a href="#local-6989586621680040535"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="#local-6989586621680040529"><span class="hs-identifier hs-type">aux</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621680040529"><span class="annot"><span class="annottext">aux :: Set String -&gt; [DiskSnapshot]
</span><a href="#local-6989586621680040529"><span class="hs-identifier hs-var hs-var">aux</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DiskSnapshot -&gt; Down Word64) -&gt; [DiskSnapshot] -&gt; [DiskSnapshot]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.sortOn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Down Word64
forall a. a -&gt; Down a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Down Word64)
-&gt; (DiskSnapshot -&gt; Word64) -&gt; DiskSnapshot -&gt; Down Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#dsNumber"><span class="hs-identifier hs-var hs-var">dsNumber</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([DiskSnapshot] -&gt; [DiskSnapshot])
-&gt; (Set String -&gt; [DiskSnapshot]) -&gt; Set String -&gt; [DiskSnapshot]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Maybe DiskSnapshot) -&gt; [String] -&gt; [DiskSnapshot]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe DiskSnapshot
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotFromPath"><span class="hs-identifier hs-var">snapshotFromPath</span></a></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [DiskSnapshot])
-&gt; (Set String -&gt; [String]) -&gt; Set String -&gt; [DiskSnapshot]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Set String -&gt; [String]
forall a. Set a -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToFileName"><span class="hs-identifier hs-type">snapshotToFileName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-229"></span><span id="snapshotToFileName"><span class="annot"><span class="annottext">snapshotToFileName :: DiskSnapshot -&gt; String
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToFileName"><span class="hs-identifier hs-var hs-var">snapshotToFileName</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680040523"><span class="annot"><span class="annottext">Word64
dsNumber :: Word64
dsNumber :: DiskSnapshot -&gt; Word64
</span><a href="#local-6989586621680040523"><span class="hs-identifier hs-var hs-var">dsNumber</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040522"><span class="annot"><span class="annottext">Maybe String
dsSuffix :: Maybe String
dsSuffix :: DiskSnapshot -&gt; Maybe String
</span><a href="#local-6989586621680040522"><span class="hs-identifier hs-var hs-var">dsSuffix</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680040523"><span class="hs-identifier hs-var">dsNumber</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040520"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621680040520"><span class="annot"><span class="annottext">suffix :: String
</span><a href="#local-6989586621680040520"><span class="hs-identifier hs-var hs-var">suffix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680040522"><span class="hs-identifier hs-var">dsSuffix</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="annottext">Maybe String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680040519"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040519"><span class="hs-identifier hs-var">s</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040519"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier hs-type">snapshotToPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FsPath</span></span><span>
</span><span id="line-237"></span><span id="snapshotToPath"><span class="annot"><span class="annottext">snapshotToPath :: DiskSnapshot -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToPath"><span class="hs-identifier hs-var hs-var">snapshotToPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; FsPath)
-&gt; (DiskSnapshot -&gt; [String]) -&gt; DiskSnapshot -&gt; FsPath
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; [String])
-&gt; (DiskSnapshot -&gt; String) -&gt; DiskSnapshot -&gt; [String]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; String
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotToFileName"><span class="hs-identifier hs-var">snapshotToFileName</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotFromPath"><span class="hs-identifier hs-type">snapshotFromPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-240"></span><span id="snapshotFromPath"><span class="annot"><span class="annottext">snapshotFromPath :: String -&gt; Maybe DiskSnapshot
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotFromPath"><span class="hs-identifier hs-var hs-var">snapshotFromPath</span></a></span></span><span> </span><span id="local-6989586621680040518"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040518"><span class="hs-identifier hs-var">fileName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621680040517"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680040517"><span class="hs-identifier hs-var">number</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Word64
forall a. Read a =&gt; String -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040516"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Maybe DiskSnapshot
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(DiskSnapshot -&gt; Maybe DiskSnapshot)
-&gt; DiskSnapshot -&gt; Maybe DiskSnapshot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Maybe String -&gt; DiskSnapshot
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-var">DiskSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680040517"><span class="hs-identifier hs-var">number</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680040515"><span class="hs-identifier hs-var">suffix'</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680040516"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040516"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680040514"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040514"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">break</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040518"><span class="hs-identifier hs-var">fileName</span></a></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="#local-6989586621680040515"><span class="hs-identifier hs-type">suffix'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621680040515"><span class="annot"><span class="annottext">suffix' :: Maybe String
</span><a href="#local-6989586621680040515"><span class="hs-identifier hs-var hs-var">suffix'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040514"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621680040512"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040512"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680040512"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Serialisation
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | Version 1: uses versioning ('Ouroboros.Consensus.Util.Versioned') and only</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- encodes the ledger state @l@.</span><span>
</span><span id="line-257"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotEncodingVersion1"><span class="hs-identifier hs-type">snapshotEncodingVersion1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Versioned.html#VersionNumber"><span class="hs-identifier hs-type">VersionNumber</span></a></span><span>
</span><span id="line-258"></span><span id="snapshotEncodingVersion1"><span class="annot"><span class="annottext">snapshotEncodingVersion1 :: VersionNumber
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotEncodingVersion1"><span class="hs-identifier hs-var hs-var">snapshotEncodingVersion1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionNumber
</span><span class="hs-number">1</span></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-comment">-- | Encoder to be used in combination with 'decodeSnapshotBackwardsCompatible'.</span><span>
</span><span id="line-261"></span><span id="local-6989586621680040805"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#encodeSnapshot"><span class="hs-identifier hs-type">encodeSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680040805"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680040805"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span></span><span>
</span><span id="line-262"></span><span id="encodeSnapshot"><span class="annot"><span class="annottext">encodeSnapshot :: (l -&gt; Encoding) -&gt; l -&gt; Encoding
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#encodeSnapshot"><span class="hs-identifier hs-var hs-var">encodeSnapshot</span></a></span></span><span> </span><span id="local-6989586621680040510"><span class="annot"><span class="annottext">l -&gt; Encoding
</span><a href="#local-6989586621680040510"><span class="hs-identifier hs-var">encodeLedger</span></a></span></span><span> </span><span id="local-6989586621680040509"><span class="annot"><span class="annottext">l
</span><a href="#local-6989586621680040509"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="annottext">VersionNumber -&gt; Encoding -&gt; Encoding
</span><a href="Ouroboros.Consensus.Util.Versioned.html#encodeVersion"><span class="hs-identifier hs-var">encodeVersion</span></a></span><span> </span><span class="annot"><span class="annottext">VersionNumber
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotEncodingVersion1"><span class="hs-identifier hs-var">snapshotEncodingVersion1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">l -&gt; Encoding
</span><a href="#local-6989586621680040510"><span class="hs-identifier hs-var">encodeLedger</span></a></span><span> </span><span class="annot"><span class="annottext">l
</span><a href="#local-6989586621680040509"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | To remain backwards compatible with existing snapshots stored on disk, we</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- must accept the old format as well as the new format.</span><span>
</span><span id="line-267"></span><span class="hs-comment">--</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- The old format:</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- * The tip: @WithOrigin (RealPoint blk)@</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- * The chain length: @Word64@</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- * The ledger state: @l@</span><span>
</span><span id="line-272"></span><span class="hs-comment">--</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- The new format is described by 'snapshotEncodingVersion1'.</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- This decoder will accept and ignore them. The encoder ('encodeSnapshot') will</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- no longer encode them.</span><span>
</span><span id="line-277"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#decodeSnapshotBackwardsCompatible"><span class="hs-identifier hs-type">decodeSnapshotBackwardsCompatible</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-278"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040824"><span class="annot"><a href="#local-6989586621680040824"><span class="hs-identifier hs-type">l</span></a></span></span><span> </span><span id="local-6989586621680040826"><span class="annot"><a href="#local-6989586621680040826"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-279"></span><span>     </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040826"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040825"><span class="annot"><a href="#local-6989586621680040825"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040825"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040824"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040823"><span class="annot"><a href="#local-6989586621680040823"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040823"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040826"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040507"><span class="annot"><a href="#local-6989586621680040507"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040507"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040824"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-283"></span><span id="decodeSnapshotBackwardsCompatible"><span class="annot"><span class="annottext">decodeSnapshotBackwardsCompatible :: Proxy blk
-&gt; (forall s. Decoder s l)
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#decodeSnapshotBackwardsCompatible"><span class="hs-identifier hs-var hs-var">decodeSnapshotBackwardsCompatible</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680040506"><span class="annot"><span class="annottext">forall s. Decoder s l
</span><a href="#local-6989586621680040506"><span class="hs-identifier hs-var">decodeLedger</span></a></span></span><span> </span><span id="local-6989586621680040505"><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621680040505"><span class="hs-identifier hs-var">decodeHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">(forall s. Maybe Int -&gt; Decoder s l)
-&gt; [(VersionNumber, VersionDecoder l)] -&gt; forall s. Decoder s l
forall a.
(forall s. Maybe Int -&gt; Decoder s a)
-&gt; [(VersionNumber, VersionDecoder a)] -&gt; forall s. Decoder s a
</span><a href="Ouroboros.Consensus.Util.Versioned.html#decodeVersionWithHook"><span class="hs-identifier hs-var">decodeVersionWithHook</span></a></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Maybe Int -&gt; forall s. Decoder s l
forall s. Maybe Int -&gt; Decoder s l
</span><a href="#local-6989586621680040503"><span class="hs-identifier hs-var">decodeOldFormat</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VersionNumber
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#snapshotEncodingVersion1"><span class="hs-identifier hs-var">snapshotEncodingVersion1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall s. Decoder s l) -&gt; VersionDecoder l
forall a. (forall s. Decoder s a) -&gt; VersionDecoder a
</span><a href="Ouroboros.Consensus.Util.Versioned.html#Decode"><span class="hs-identifier hs-var">Decode</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. Decoder s l
</span><a href="#local-6989586621680040501"><span class="hs-identifier hs-var">decodeVersion1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-288"></span><span>    </span><span class="annot"><a href="#local-6989586621680040501"><span class="hs-identifier hs-type">decodeVersion1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040500"><span class="annot"><a href="#local-6989586621680040500"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040500"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040824"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621680040501"><span class="annot"><span class="annottext">decodeVersion1 :: Decoder s l
</span><a href="#local-6989586621680040501"><span class="hs-identifier hs-var hs-var">decodeVersion1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Decoder s l
forall s. Decoder s l
</span><a href="#local-6989586621680040506"><span class="hs-identifier hs-var">decodeLedger</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><a href="#local-6989586621680040503"><span class="hs-identifier hs-type">decodeOldFormat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680040499"><span class="annot"><a href="#local-6989586621680040499"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621680040499"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680040824"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span id="local-6989586621680040503"><span class="annot"><span class="annottext">decodeOldFormat :: Maybe Int -&gt; forall s. Decoder s l
</span><a href="#local-6989586621680040503"><span class="hs-identifier hs-var hs-var">decodeOldFormat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Point blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk) -&gt; Point blk
forall blk. WithOrigin (RealPoint blk) -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#withOriginRealPointToPoint"><span class="hs-identifier hs-var">withOriginRealPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithOrigin (RealPoint blk) -&gt; Point blk)
-&gt; Decoder s (WithOrigin (RealPoint blk)) -&gt; Decoder s (Point blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-294"></span><span>               </span><span class="annot"><span class="annottext">Decoder s (RealPoint blk) -&gt; Decoder s (WithOrigin (RealPoint blk))
forall s a. Decoder s a -&gt; Decoder s (WithOrigin a)
</span><a href="Ouroboros.Consensus.Util.CBOR.html#decodeWithOrigin"><span class="hs-identifier hs-var">decodeWithOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (RealPoint blk)
forall blk.
(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (RealPoint blk)
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#decodeRealPoint"><span class="hs-identifier hs-var">decodeRealPoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680040826"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621680040505"><span class="hs-identifier hs-var">decodeHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Word64
forall s. Decoder s Word64
</span><span class="hs-identifier hs-var">Dec.decodeWord64</span></span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">Decoder s l
forall s. Decoder s l
</span><a href="#local-6989586621680040506"><span class="hs-identifier hs-var">decodeLedger</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><a href="#local-6989586621680040503"><span class="hs-identifier hs-var">decodeOldFormat</span></a></span><span> </span><span id="local-6989586621680040495"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680040495"><span class="hs-identifier hs-var">mbListLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Decoder s l
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fail</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Decoder s l) -&gt; String -&gt; Decoder s l
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;decodeSnapshotBackwardsCompatible: invalid start &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-300"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680040495"><span class="hs-identifier hs-var">mbListLen</span></a></span><span>
</span><span id="line-301"></span></pre></body></html>