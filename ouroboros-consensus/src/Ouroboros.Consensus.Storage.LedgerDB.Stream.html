<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Stream</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NextBlock"><span class="hs-identifier">NextBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier">StreamAPI</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#streamAll"><span class="hs-identifier">streamAll</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/mtl-2.2.2/src"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Abstraction over the streaming API provided by the Chain DB
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">-- | Next block returned during streaming</span><span>
</span><span id="line-22"></span><span class="hs-keyword">data</span><span> </span><span id="NextBlock"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NextBlock"><span class="hs-identifier hs-var">NextBlock</span></a></span></span><span> </span><span id="local-6989586621680016222"><span class="annot"><a href="#local-6989586621680016222"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoMoreBlocks"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NoMoreBlocks"><span class="hs-identifier hs-var">NoMoreBlocks</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="NextBlock"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NextBlock"><span class="hs-identifier hs-var">NextBlock</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680016222"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-comment">-- | Stream blocks from the immutable DB</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- When we initialize the ledger DB, we try to find a snapshot close to the</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- tip of the immutable DB, and then stream blocks from the immutable DB to its</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- tip to bring the ledger up to date with the tip of the immutable DB.</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- In CPS form to enable the use of 'withXYZ' style iterator init functions.</span><span>
</span><span id="line-31"></span><span class="hs-keyword">data</span><span> </span><span id="StreamAPI"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-var">StreamAPI</span></a></span></span><span> </span><span id="local-6989586621680016241"><span class="annot"><a href="#local-6989586621680016241"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680016240"><span class="annot"><a href="#local-6989586621680016240"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StreamAPI"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-var">StreamAPI</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-32"></span><span>      </span><span class="hs-comment">-- | Start streaming after the specified block</span><span>
</span><span id="line-33"></span><span>      </span><span id="streamAfter"><span class="annot"><span class="annottext">StreamAPI m blk
-&gt; forall a.
   HasCallStack =&gt;
   Point blk
   -&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m a) -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#streamAfter"><span class="hs-identifier hs-var hs-var">streamAfter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680016247"><span class="annot"><a href="#local-6989586621680016247"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-34"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016240"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-35"></span><span>        </span><span class="hs-comment">-- Reference to the block corresponding to the snapshot we found</span><span>
</span><span id="line-36"></span><span>        </span><span class="hs-comment">-- (or 'GenesisPoint' if we didn't find any)</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680016241"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NextBlock"><span class="hs-identifier hs-type">NextBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016241"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016247"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>        </span><span class="hs-comment">-- Get the next block (by value)</span><span>
</span><span id="line-40"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span>        </span><span class="hs-comment">-- Should be @Left pt@ if the snapshot we found is more recent than the</span><span>
</span><span id="line-42"></span><span>        </span><span class="hs-comment">-- tip of the immutable DB. Since we only store snapshots to disk for</span><span>
</span><span id="line-43"></span><span>        </span><span class="hs-comment">-- blocks in the immutable DB, this can only happen if the immutable DB</span><span>
</span><span id="line-44"></span><span>        </span><span class="hs-comment">-- got truncated due to disk corruption. The returned @pt@ is a</span><span>
</span><span id="line-45"></span><span>        </span><span class="hs-comment">-- 'RealPoint', not a 'Point', since it must always be possible to</span><span>
</span><span id="line-46"></span><span>        </span><span class="hs-comment">-- stream after genesis.</span><span>
</span><span id="line-47"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016241"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016247"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | Stream all blocks</span><span>
</span><span id="line-51"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#streamAll"><span class="hs-identifier hs-type">streamAll</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-52"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680016217"><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680016216"><span class="annot"><a href="#local-6989586621680016216"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680016215"><span class="annot"><a href="#local-6989586621680016215"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680016214"><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-type">StreamAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016216"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/ouroboros-network-api-0.1.0.0/noopt/doc/html/ouroboros-network-api/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016216"><span class="hs-identifier hs-type">blk</span></a></span><span>             </span><span class="hs-comment">-- ^ Starting point for streaming</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016216"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016215"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Error when tip not found</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span>                     </span><span class="hs-comment">-- ^ Starting point when tip /is/ found</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680016216"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ^ Update function for each block</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016215"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-59"></span><span id="streamAll"><span class="annot"><span class="annottext">streamAll :: StreamAPI m blk
-&gt; Point blk
-&gt; (RealPoint blk -&gt; e)
-&gt; a
-&gt; (blk -&gt; a -&gt; m a)
-&gt; ExceptT e m a
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#streamAll"><span class="hs-identifier hs-var hs-var">streamAll</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-type">StreamAPI</span></a></span><span class="hs-special">{</span><span id="local-6989586621680016213"><span class="annot"><span class="annottext">forall a.
HasCallStack =&gt;
Point blk
-&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m a) -&gt; m a
streamAfter :: forall a.
HasCallStack =&gt;
Point blk
-&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m a) -&gt; m a
streamAfter :: forall (m :: * -&gt; *) blk.
StreamAPI m blk
-&gt; forall a.
   HasCallStack =&gt;
   Point blk
   -&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m a) -&gt; m a
</span><a href="#local-6989586621680016213"><span class="hs-glyph hs-var hs-var">..</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680016212"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680016212"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span id="local-6989586621680016211"><span class="annot"><span class="annottext">RealPoint blk -&gt; e
</span><a href="#local-6989586621680016211"><span class="hs-identifier hs-var">notFound</span></a></span></span><span> </span><span id="local-6989586621680016210"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680016210"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621680016209"><span class="annot"><span class="annottext">blk -&gt; a -&gt; m a
</span><a href="#local-6989586621680016209"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either e a) -&gt; ExceptT e m a
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/transformers-0.5.6.2/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either e a) -&gt; ExceptT e m a)
-&gt; m (Either e a) -&gt; ExceptT e m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="annottext">Point blk
-&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m (Either e a))
-&gt; m (Either e a)
forall a.
HasCallStack =&gt;
Point blk
-&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m a) -&gt; m a
</span><a href="#local-6989586621680016213"><span class="hs-identifier hs-var">streamAfter</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680016212"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">((Either (RealPoint blk) (m (NextBlock blk)) -&gt; m (Either e a))
 -&gt; m (Either e a))
-&gt; (Either (RealPoint blk) (m (NextBlock blk)) -&gt; m (Either e a))
-&gt; m (Either e a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-61"></span><span>      </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680016207"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680016207"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either e a -&gt; m (Either e a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either e a -&gt; m (Either e a)) -&gt; Either e a -&gt; m (Either e a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; Either e a
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; e
</span><a href="#local-6989586621680016211"><span class="hs-identifier hs-var">notFound</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680016207"><span class="hs-identifier hs-var">tip'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span>      </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680016206"><span class="annot"><span class="annottext">m (NextBlock blk)
</span><a href="#local-6989586621680016206"><span class="hs-identifier hs-var">getNext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-64"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680016205"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680016217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680016214"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-65"></span><span>            </span><span id="local-6989586621680016205"><span class="annot"><span class="annottext">go :: a -&gt; m a
</span><a href="#local-6989586621680016205"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680016204"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680016204"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621680016203"><span class="annot"><span class="annottext">NextBlock blk
</span><a href="#local-6989586621680016203"><span class="hs-identifier hs-var">mNext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (NextBlock blk)
</span><a href="#local-6989586621680016206"><span class="hs-identifier hs-var">getNext</span></a></span><span>
</span><span id="line-66"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NextBlock blk
</span><a href="#local-6989586621680016203"><span class="hs-identifier hs-var">mNext</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-67"></span><span>                        </span><span class="annot"><span class="annottext">NextBlock blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NoMoreBlocks"><span class="hs-identifier hs-var">NoMoreBlocks</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680016204"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-68"></span><span>                        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#NextBlock"><span class="hs-identifier hs-type">NextBlock</span></a></span><span> </span><span id="local-6989586621680016202"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680016202"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621680016205"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">blk -&gt; a -&gt; m a
</span><a href="#local-6989586621680016209"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680016202"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680016204"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-69"></span><span>        </span><span class="annot"><span class="annottext">a -&gt; Either e a
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Either e a) -&gt; m a -&gt; m (Either e a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621680016205"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680016210"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-70"></span></pre></body></html>