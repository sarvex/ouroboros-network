<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns               #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | Support for CRC</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.CRC</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Wrap digest functionality</span></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier">CRC</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#computeCRC"><span class="hs-identifier">computeCRC</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#initCRC"><span class="hs-identifier">initCRC</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#updateCRC"><span class="hs-identifier">updateCRC</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><span class="hs-comment">-- * File system functions with CRC functionality</span></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetAllAtCRC"><span class="hs-identifier">hGetAllAtCRC</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetExactlyAtCRC"><span class="hs-identifier">hGetExactlyAtCRC</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hPutAllCRC"><span class="hs-identifier">hPutAllCRC</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Coerce</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Digest.CRC32</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Digest</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Foreign.Storable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Storable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier">AbsOffset</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Wrap functionality from digest
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span id="local-6989586621679958224"><span id="local-6989586621679958225"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="CRC"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-var">CRC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CRC"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-var">CRC</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="getCRC"><span class="annot"><span class="annottext">CRC -&gt; Word32
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#getCRC"><span class="hs-identifier hs-var hs-var">getCRC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679958218"><span id="local-6989586621679958220"><span class="annot"><span class="annottext">CRC -&gt; CRC -&gt; Bool
(CRC -&gt; CRC -&gt; Bool) -&gt; (CRC -&gt; CRC -&gt; Bool) -&gt; Eq CRC
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CRC -&gt; CRC -&gt; Bool
$c/= :: CRC -&gt; CRC -&gt; Bool
== :: CRC -&gt; CRC -&gt; Bool
$c== :: CRC -&gt; CRC -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679958211"><span id="local-6989586621679958213"><span id="local-6989586621679958215"><span class="annot"><span class="annottext">Int -&gt; CRC -&gt; ShowS
[CRC] -&gt; ShowS
CRC -&gt; String
(Int -&gt; CRC -&gt; ShowS)
-&gt; (CRC -&gt; String) -&gt; ([CRC] -&gt; ShowS) -&gt; Show CRC
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CRC] -&gt; ShowS
$cshowList :: [CRC] -&gt; ShowS
show :: CRC -&gt; String
$cshow :: CRC -&gt; String
showsPrec :: Int -&gt; CRC -&gt; ShowS
$cshowsPrec :: Int -&gt; CRC -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. CRC -&gt; Rep CRC x)
-&gt; (forall x. Rep CRC x -&gt; CRC) -&gt; Generic CRC
forall x. Rep CRC x -&gt; CRC
forall x. CRC -&gt; Rep CRC x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep CRC x -&gt; CRC
$cfrom :: forall x. CRC -&gt; Rep CRC x
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679958201"><span id="local-6989586621679958203"><span id="local-6989586621679958205"><span class="annot"><span class="annottext">Context -&gt; CRC -&gt; IO (Maybe ThunkInfo)
Proxy CRC -&gt; String
(Context -&gt; CRC -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; CRC -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy CRC -&gt; String)
-&gt; NoThunks CRC
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy CRC -&gt; String
$cshowTypeOf :: Proxy CRC -&gt; String
wNoThunks :: Context -&gt; CRC -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; CRC -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; CRC -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; CRC -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679958184"><span id="local-6989586621679958186"><span id="local-6989586621679958188"><span id="local-6989586621679958190"><span id="local-6989586621679958192"><span id="local-6989586621679958194"><span id="local-6989586621679958196"><span id="local-6989586621679958198"><span class="annot"><span class="annottext">Ptr b -&gt; Int -&gt; IO CRC
Ptr b -&gt; Int -&gt; CRC -&gt; IO ()
Ptr CRC -&gt; IO CRC
Ptr CRC -&gt; Int -&gt; IO CRC
Ptr CRC -&gt; Int -&gt; CRC -&gt; IO ()
Ptr CRC -&gt; CRC -&gt; IO ()
CRC -&gt; Int
(CRC -&gt; Int)
-&gt; (CRC -&gt; Int)
-&gt; (Ptr CRC -&gt; Int -&gt; IO CRC)
-&gt; (Ptr CRC -&gt; Int -&gt; CRC -&gt; IO ())
-&gt; (forall b. Ptr b -&gt; Int -&gt; IO CRC)
-&gt; (forall b. Ptr b -&gt; Int -&gt; CRC -&gt; IO ())
-&gt; (Ptr CRC -&gt; IO CRC)
-&gt; (Ptr CRC -&gt; CRC -&gt; IO ())
-&gt; Storable CRC
forall b. Ptr b -&gt; Int -&gt; IO CRC
forall b. Ptr b -&gt; Int -&gt; CRC -&gt; IO ()
forall a.
(a -&gt; Int)
-&gt; (a -&gt; Int)
-&gt; (Ptr a -&gt; Int -&gt; IO a)
-&gt; (Ptr a -&gt; Int -&gt; a -&gt; IO ())
-&gt; (forall b. Ptr b -&gt; Int -&gt; IO a)
-&gt; (forall b. Ptr b -&gt; Int -&gt; a -&gt; IO ())
-&gt; (Ptr a -&gt; IO a)
-&gt; (Ptr a -&gt; a -&gt; IO ())
-&gt; Storable a
poke :: Ptr CRC -&gt; CRC -&gt; IO ()
$cpoke :: Ptr CRC -&gt; CRC -&gt; IO ()
peek :: Ptr CRC -&gt; IO CRC
$cpeek :: Ptr CRC -&gt; IO CRC
pokeByteOff :: Ptr b -&gt; Int -&gt; CRC -&gt; IO ()
$cpokeByteOff :: forall b. Ptr b -&gt; Int -&gt; CRC -&gt; IO ()
peekByteOff :: Ptr b -&gt; Int -&gt; IO CRC
$cpeekByteOff :: forall b. Ptr b -&gt; Int -&gt; IO CRC
pokeElemOff :: Ptr CRC -&gt; Int -&gt; CRC -&gt; IO ()
$cpokeElemOff :: Ptr CRC -&gt; Int -&gt; CRC -&gt; IO ()
peekElemOff :: Ptr CRC -&gt; Int -&gt; IO CRC
$cpeekElemOff :: Ptr CRC -&gt; Int -&gt; IO CRC
alignment :: CRC -&gt; Int
$calignment :: CRC -&gt; Int
sizeOf :: CRC -&gt; Int
$csizeOf :: CRC -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Storable</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#initCRC"><span class="hs-identifier hs-type">initCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span>
</span><span id="line-44"></span><span id="initCRC"><span class="annot"><span class="annottext">initCRC :: CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#initCRC"><span class="hs-identifier hs-var hs-var">initCRC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-var">CRC</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; CRC) -&gt; Word32 -&gt; CRC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; Word32
forall a. CRC32 a =&gt; a -&gt; Word32
</span><span class="hs-identifier hs-var">Digest.crc32</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#updateCRC"><span class="hs-identifier hs-type">updateCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679958246"><span class="annot"><a href="#local-6989586621679958246"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Digest.CRC32</span></span><span> </span><span class="annot"><a href="#local-6989586621679958246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span>
</span><span id="line-47"></span><span id="updateCRC"><span class="annot"><span class="annottext">updateCRC :: a -&gt; CRC -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#updateCRC"><span class="hs-identifier hs-var hs-var">updateCRC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Word32 -&gt; Word32) -&gt; a -&gt; CRC -&gt; CRC
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Word32 -&gt; a -&gt; Word32) -&gt; a -&gt; Word32 -&gt; Word32
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; a -&gt; Word32
forall a. CRC32 a =&gt; Word32 -&gt; a -&gt; Word32
</span><span class="hs-identifier hs-var">Digest.crc32Update</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#computeCRC"><span class="hs-identifier hs-type">computeCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679958237"><span class="annot"><a href="#local-6989586621679958237"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Digest.CRC32</span></span><span> </span><span class="annot"><a href="#local-6989586621679958237"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958237"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span>
</span><span id="line-50"></span><span id="computeCRC"><span class="annot"><span class="annottext">computeCRC :: a -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#computeCRC"><span class="hs-identifier hs-var hs-var">computeCRC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Word32) -&gt; a -&gt; CRC
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Word32
forall a. CRC32 a =&gt; a -&gt; Word32
</span><span class="hs-identifier hs-var">Digest.crc32</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679958237"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  File system functions that compute CRCs
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- | Variation on 'hPutAll' that also computes a CRC</span><span>
</span><span id="line-57"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hPutAllCRC"><span class="hs-identifier hs-type">hPutAllCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679958179"><span class="annot"><a href="#local-6989586621679958179"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679958178"><span class="annot"><a href="#local-6989586621679958178"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958179"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958179"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958178"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-59"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958178"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-60"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">BL.ByteString</span></a></span><span>
</span><span id="line-61"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958179"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span id="hPutAllCRC"><span class="annot"><span class="annottext">hPutAllCRC :: HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m (Word64, CRC)
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hPutAllCRC"><span class="hs-identifier hs-var hs-var">hPutAllCRC</span></a></span></span><span> </span><span id="local-6989586621679958177"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958177"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679958176"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958176"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Word64, CRC) -&gt; ByteString -&gt; m (Word64, CRC))
-&gt; (Word64, CRC) -&gt; [ByteString] -&gt; m (Word64, CRC)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldM</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64, CRC) -&gt; ByteString -&gt; m (Word64, CRC)
</span><a href="#local-6989586621679958175"><span class="hs-identifier hs-var">putChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#initCRC"><span class="hs-identifier hs-var">initCRC</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; m (Word64, CRC))
-&gt; (ByteString -&gt; [ByteString]) -&gt; ByteString -&gt; m (Word64, CRC)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-var">BL.toChunks</span></a></span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="#local-6989586621679958175"><span class="hs-identifier hs-type">putChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">BS.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958179"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span id="local-6989586621679958175"><span class="annot"><span class="annottext">putChunk :: (Word64, CRC) -&gt; ByteString -&gt; m (Word64, CRC)
</span><a href="#local-6989586621679958175"><span class="hs-identifier hs-var hs-var">putChunk</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679958172"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958172"><span class="hs-identifier hs-var">written</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679958171"><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679958171"><span class="hs-identifier hs-var">crc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679958170"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958170"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>      </span><span id="local-6989586621679958169"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958169"><span class="hs-identifier hs-var">chunkSize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAllStrict"><span class="hs-identifier hs-var">hPutAllStrict</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958177"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958176"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958170"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679958167"><span class="annot"><span class="annottext">written' :: Word64
</span><a href="#local-6989586621679958167"><span class="hs-identifier hs-var hs-var">written'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958172"><span class="hs-identifier hs-var">written</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958169"><span class="hs-identifier hs-var">chunkSize</span></a></span><span>
</span><span id="line-68"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679958165"><span class="annot"><span class="annottext">crc' :: CRC
</span><a href="#local-6989586621679958165"><span class="hs-identifier hs-var hs-var">crc'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; CRC -&gt; CRC
forall a. CRC32 a =&gt; a -&gt; CRC -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#updateCRC"><span class="hs-identifier hs-var">updateCRC</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958170"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679958171"><span class="hs-identifier hs-var">crc</span></a></span><span>
</span><span id="line-69"></span><span>      </span><span class="annot"><span class="annottext">(Word64, CRC) -&gt; m (Word64, CRC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958167"><span class="hs-identifier hs-var">written'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679958165"><span class="hs-identifier hs-var">crc'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | Variation on 'hGetExactlyAt' that also computes a CRC</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetExactlyAtCRC"><span class="hs-identifier hs-type">hGetExactlyAtCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679958164"><span class="annot"><a href="#local-6989586621679958164"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679958163"><span class="annot"><a href="#local-6989586621679958163"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679958164"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958164"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958163"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-74"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958163"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-75"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span>    </span><span class="hs-comment">-- ^ The number of bytes to read.</span><span>
</span><span id="line-76"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-comment">-- ^ The offset at which to read.</span><span>
</span><span id="line-77"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958164"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">BL.ByteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span id="hGetExactlyAtCRC"><span class="annot"><span class="annottext">hGetExactlyAtCRC :: HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m (ByteString, CRC)
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetExactlyAtCRC"><span class="hs-identifier hs-var hs-var">hGetExactlyAtCRC</span></a></span></span><span> </span><span id="local-6989586621679958162"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958162"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679958161"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958161"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679958160"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958160"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679958159"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679958159"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- TODO Interleave reading with computing the CRC. Better cache locality</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- and fits better with incremental parsing, when we add support for that.</span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621679958158"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958158"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier hs-var">hGetExactlyAt</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958162"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958161"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679958160"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679958159"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679958156"><span class="annot"><span class="annottext">crc :: CRC
</span><a href="#local-6989586621679958156"><span class="hs-identifier hs-var hs-var">crc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; CRC
forall a. CRC32 a =&gt; a -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#computeCRC"><span class="hs-identifier hs-var">computeCRC</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958158"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">(ByteString, CRC) -&gt; m (ByteString, CRC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958158"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679958156"><span class="hs-identifier hs-var">crc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Variation on 'hGetAllAt' that also computes a CRC</span><span>
</span><span id="line-86"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetAllAtCRC"><span class="hs-identifier hs-type">hGetAllAtCRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679958155"><span class="annot"><a href="#local-6989586621679958155"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679958154"><span class="annot"><a href="#local-6989586621679958154"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958155"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-87"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958154"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-88"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679958154"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-89"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-comment">-- ^ The offset at which to read.</span><span>
</span><span id="line-90"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679958155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">BL.ByteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.CRC.html#CRC"><span class="hs-identifier hs-type">CRC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span id="hGetAllAtCRC"><span class="annot"><span class="annottext">hGetAllAtCRC :: HasFS m h -&gt; Handle h -&gt; AbsOffset -&gt; m (ByteString, CRC)
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#hGetAllAtCRC"><span class="hs-identifier hs-var hs-var">hGetAllAtCRC</span></a></span></span><span> </span><span id="local-6989586621679958153"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958153"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679958152"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958152"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679958151"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679958151"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">-- TODO Interleave reading with computing the CRC. Better cache locality</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- and fits better with incremental parsing, when we add support for that.</span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679958150"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958150"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
Monad m =&gt;
HasFS m h -&gt; Handle h -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAllAt"><span class="hs-identifier hs-var">hGetAllAt</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679958153"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679958152"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679958151"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679958148"><span class="annot"><span class="annottext">crc :: CRC
</span><a href="#local-6989586621679958148"><span class="hs-identifier hs-var hs-var">crc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; CRC
forall a. CRC32 a =&gt; a -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.FS.CRC.html#computeCRC"><span class="hs-identifier hs-var">computeCRC</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958150"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">(ByteString, CRC) -&gt; m (ByteString, CRC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679958150"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679958148"><span class="hs-identifier hs-var">crc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span></pre></body></html>