<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- 'runResponder' is using a redundant constraint.</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-redundant-constraints #-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">-- | Server implementation based on 'ConnectionManager'</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Server2</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerArguments"><span class="hs-identifier">ServerArguments</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.State.html#InboundGovernorObservableState"><span class="hs-identifier">InboundGovernorObservableState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.State.html#newObservableStateVar"><span class="hs-identifier">newObservableStateVar</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.State.html#newObservableStateVarIO"><span class="hs-identifier">newObservableStateVarIO</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.State.html#newObservableStateVarFromSeed"><span class="hs-identifier">newObservableStateVarFromSeed</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Run server</span></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server2.html#run"><span class="hs-identifier">run</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerTrace"><span class="hs-identifier">ServerTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier">AcceptConnectionsPolicyTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html#RemoteSt"><span class="hs-identifier">RemoteSt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html#RemoteTransition"><span class="hs-identifier">RemoteTransition</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html#RemoteTransitionTrace"><span class="hs-identifier">RemoteTransitionTrace</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-comment">-- * ControlChannel</span></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><span class="hs-identifier">ControlChannel</span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">handle</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">intercalate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">NonEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.IO.Exception</span></a></span><span class="hs-cpp">
#if !defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Foreign.C.Error</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html"><span class="hs-identifier">Ouroboros.Network.ConnectionHandler</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Types</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html"><span class="hs-identifier">Ouroboros.Network.InboundGovernor</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html"><span class="hs-identifier">Ouroboros.Network.InboundGovernor.ControlChannel</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html"><span class="hs-identifier">Ouroboros.Network.InboundGovernor.ControlChannel</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ControlChannel</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Mux.html"><span class="hs-identifier">Ouroboros.Network.Mux</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html"><span class="hs-identifier">Ouroboros.Network.Server.RateLimiting</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Snocket.html"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- Server API</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- | Server static configuration.</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-keyword">data</span><span> </span><span id="ServerArguments"><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerArguments"><span class="hs-identifier hs-var">ServerArguments</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256026"><span class="annot"><a href="#local-6989586621679256026"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxMode</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679256025"><span class="annot"><a href="#local-6989586621679256025"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679256024"><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679256023"><span class="annot"><a href="#local-6989586621679256023"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679256022"><span class="annot"><a href="#local-6989586621679256022"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679256021"><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679256020"><span class="annot"><a href="#local-6989586621679256020"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679256019"><span class="annot"><a href="#local-6989586621679256019"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-70"></span><span>    </span><span id="ServerArguments"><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerArguments"><span class="hs-identifier hs-var">ServerArguments</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-71"></span><span>      </span><span id="serverSockets"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; NonEmpty socket
</span><a href="Ouroboros.Network.Server2.html#serverSockets"><span class="hs-identifier hs-var hs-var">serverSockets</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256025"><span class="hs-identifier hs-type">socket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>      </span><span id="serverSnocket"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Snocket m socket peerAddr
</span><a href="Ouroboros.Network.Server2.html#serverSnocket"><span class="hs-identifier hs-var hs-var">serverSnocket</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256025"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>      </span><span id="serverTracer"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (ServerTrace peerAddr)
</span><a href="Ouroboros.Network.Server2.html#serverTracer"><span class="hs-identifier hs-var hs-var">serverTracer</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerTrace"><span class="hs-identifier hs-type">ServerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>      </span><span id="serverTrTracer"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (RemoteTransitionTrace peerAddr)
</span><a href="Ouroboros.Network.Server2.html#serverTrTracer"><span class="hs-identifier hs-var hs-var">serverTrTracer</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html#RemoteTransitionTrace"><span class="hs-identifier hs-type">RemoteTransitionTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>      </span><span id="serverInboundGovernorTracer"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (InboundGovernorTrace peerAddr)
</span><a href="Ouroboros.Network.Server2.html#serverInboundGovernorTracer"><span class="hs-identifier hs-var hs-var">serverInboundGovernorTracer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.html#InboundGovernorTrace"><span class="hs-identifier hs-type">InboundGovernorTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>      </span><span id="serverConnectionLimits"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; AcceptedConnectionsLimit
</span><a href="Ouroboros.Network.Server2.html#serverConnectionLimits"><span class="hs-identifier hs-var hs-var">serverConnectionLimits</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>      </span><span id="serverConnectionManager"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; MuxConnectionManager
     muxMode socket peerAddr versionNumber bytes m a b
</span><a href="Ouroboros.Network.Server2.html#serverConnectionManager"><span class="hs-identifier hs-var hs-var">serverConnectionManager</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionManager"><span class="hs-identifier hs-type">MuxConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256026"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256025"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-78"></span><span>                                                        </span><span class="annot"><a href="#local-6989586621679256023"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256022"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256020"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256019"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-comment">-- | Time for which all protocols need to be idle to trigger</span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-comment">-- 'DemotedToCold' transition.</span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span>      </span><span id="serverInboundIdleTimeout"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Maybe DiffTime
</span><a href="Ouroboros.Network.Server2.html#serverInboundIdleTimeout"><span class="hs-identifier hs-var hs-var">serverInboundIdleTimeout</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">-- | Server control var is passed as an argument; this allows to use the</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-comment">-- server to run and manage responders which needs to be started on</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-comment">-- inbound connections.</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span>      </span><span id="serverControlChannel"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; ServerControlChannel muxMode peerAddr bytes m a b
</span><a href="Ouroboros.Network.Server2.html#serverControlChannel"><span class="hs-identifier hs-var hs-var">serverControlChannel</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#ServerControlChannel"><span class="hs-identifier hs-type">ServerControlChannel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256026"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256024"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256022"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256020"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256019"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">-- | Observable mutable state.</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span>      </span><span id="serverObservableStateVar"><span class="annot"><span class="annottext">ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; StrictTVar m InboundGovernorObservableState
</span><a href="Ouroboros.Network.Server2.html#serverObservableStateVar"><span class="hs-identifier hs-var hs-var">serverObservableStateVar</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256021"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.State.html#InboundGovernorObservableState"><span class="hs-identifier hs-type">InboundGovernorObservableState</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Server pauses accepting connections after an 'CONNABORTED' error.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Ouroboros.Network.Server2.html#server_CONNABORTED_DELAY"><span class="hs-identifier hs-type">server_CONNABORTED_DELAY</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-99"></span><span id="server_CONNABORTED_DELAY"><span class="annot"><span class="annottext">server_CONNABORTED_DELAY :: DiffTime
</span><a href="Ouroboros.Network.Server2.html#server_CONNABORTED_DELAY"><span class="hs-identifier hs-var hs-var">server_CONNABORTED_DELAY</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | Run the server, which consists of the following components:</span><span>
</span><span id="line-102"></span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- * /inbound governor/, it corresponds to p2p-governor on outbound side</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- * /accept loop(s)/, one per given ip address.  We support up to one ipv4</span><span>
</span><span id="line-105"></span><span class="hs-comment">--   address and up to one ipv6 address, i.e. an ipv6 enabled node will run two</span><span>
</span><span id="line-106"></span><span class="hs-comment">--   accept loops on listening on different addresses with shared /inbound governor/.</span><span>
</span><span id="line-107"></span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- The server can be run in either of two 'MuxMode'-es:</span><span>
</span><span id="line-109"></span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- * 'InitiatorResponderMode'</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- * 'ResponderMode'</span><span>
</span><span id="line-112"></span><span class="hs-comment">--</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- The first one is used in data diffusion for /Node-To-Node protocol/, while the</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- other is useful for running a server for the /Node-To-Client protocol/.</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="annot"><a href="Ouroboros.Network.Server2.html#run"><span class="hs-identifier hs-type">run</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679255878"><span class="annot"><a href="#local-6989586621679255878"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679255877"><span class="annot"><a href="#local-6989586621679255877"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679255876"><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679255875"><span class="annot"><a href="#local-6989586621679255875"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679255874"><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679255873"><span class="annot"><a href="#local-6989586621679255873"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679255872"><span class="annot"><a href="#local-6989586621679255872"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-117"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span>    </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-118"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span>    </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-119"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadEvaluate</span></span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-120"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLabelledSTM</span></span><span>  </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-121"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span>     </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-122"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span>     </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-124"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span>    </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-125"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">HasResponder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255878"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-126"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-128"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerArguments"><span class="hs-identifier hs-type">ServerArguments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255878"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255877"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255875"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255873"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255872"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-131"></span><span id="run"><span class="annot"><span class="annottext">run :: ServerArguments
  muxMode socket peerAddr versionNumber ByteString m a b
-&gt; m Void
</span><a href="Ouroboros.Network.Server2.html#run"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerArguments"><span class="hs-identifier hs-type">ServerArguments</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-132"></span><span>      </span><span id="local-6989586621679255871"><span class="annot"><span class="annottext">NonEmpty socket
serverSockets :: NonEmpty socket
serverSockets :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; NonEmpty socket
</span><a href="#local-6989586621679255871"><span class="hs-identifier hs-var hs-var">serverSockets</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>      </span><span id="local-6989586621679255870"><span class="annot"><span class="annottext">Snocket m socket peerAddr
serverSnocket :: Snocket m socket peerAddr
serverSnocket :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var hs-var">serverSnocket</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>      </span><span id="local-6989586621679255869"><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace peerAddr)
serverTrTracer :: Tracer m (RemoteTransitionTrace peerAddr)
serverTrTracer :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (RemoteTransitionTrace peerAddr)
</span><a href="#local-6989586621679255869"><span class="hs-identifier hs-var hs-var">serverTrTracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="annottext">serverTracer :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (ServerTrace peerAddr)
</span><a href="Ouroboros.Network.Server2.html#serverTracer"><span class="hs-identifier hs-var">serverTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679255868"><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="annottext">serverInboundGovernorTracer :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Tracer m (InboundGovernorTrace peerAddr)
</span><a href="Ouroboros.Network.Server2.html#serverInboundGovernorTracer"><span class="hs-identifier hs-var">serverInboundGovernorTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679255867"><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace peerAddr)
</span><a href="#local-6989586621679255867"><span class="hs-identifier hs-var">inboundGovernorTracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><span class="annottext">serverConnectionLimits :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; AcceptedConnectionsLimit
</span><a href="Ouroboros.Network.Server2.html#serverConnectionLimits"><span class="hs-identifier hs-var">serverConnectionLimits</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>        </span><span id="local-6989586621679255866"><span class="annot"><span class="annottext">serverLimits :: AcceptedConnectionsLimit
</span><a href="#local-6989586621679255866"><span class="hs-identifier hs-var">serverLimits</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">acceptedConnectionsHardLimit :: AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsHardLimit"><span class="hs-identifier hs-var">acceptedConnectionsHardLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679255863"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679255863"><span class="hs-identifier hs-var">hardLimit</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>      </span><span id="local-6989586621679255862"><span class="annot"><span class="annottext">Maybe DiffTime
serverInboundIdleTimeout :: Maybe DiffTime
serverInboundIdleTimeout :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; Maybe DiffTime
</span><a href="#local-6989586621679255862"><span class="hs-identifier hs-var hs-var">serverInboundIdleTimeout</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>      </span><span id="local-6989586621679255861"><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
serverConnectionManager :: MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
serverConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; MuxConnectionManager
     muxMode socket peerAddr versionNumber bytes m a b
</span><a href="#local-6989586621679255861"><span class="hs-identifier hs-var hs-var">serverConnectionManager</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621679255860"><span class="annot"><span class="annottext">ServerControlChannel muxMode peerAddr ByteString m a b
serverControlChannel :: ServerControlChannel muxMode peerAddr ByteString m a b
serverControlChannel :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; ServerControlChannel muxMode peerAddr bytes m a b
</span><a href="#local-6989586621679255860"><span class="hs-identifier hs-var hs-var">serverControlChannel</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>      </span><span id="local-6989586621679255859"><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
serverObservableStateVar :: StrictTVar m InboundGovernorObservableState
serverObservableStateVar :: forall (muxMode :: MuxMode) socket peerAddr versionNumber bytes
       (m :: * -&gt; *) a b.
ServerArguments muxMode socket peerAddr versionNumber bytes m a b
-&gt; StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679255859"><span class="hs-identifier hs-var hs-var">serverObservableStateVar</span></a></span></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679255858"><span class="annot"><span class="annottext">sockets :: [socket]
</span><a href="#local-6989586621679255858"><span class="hs-identifier hs-var hs-var">sockets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty socket -&gt; [socket]
forall a. NonEmpty a -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NonEmpty.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty socket
</span><a href="#local-6989586621679255871"><span class="hs-identifier hs-var">serverSockets</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span id="local-6989586621679255856"><span class="annot"><span class="annottext">[peerAddr]
</span><a href="#local-6989586621679255856"><span class="hs-identifier hs-var">localAddresses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(socket -&gt; m peerAddr) -&gt; [socket] -&gt; m [peerAddr]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m peerAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><a href="Ouroboros.Network.Snocket.html#getLocalAddr"><span class="hs-identifier hs-var hs-var">getLocalAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[socket]
</span><a href="#local-6989586621679255858"><span class="hs-identifier hs-var">sockets</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
StrictTVar m a -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelTVarIO</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679255859"><span class="hs-identifier hs-var">serverObservableStateVar</span></a></span><span>
</span><span id="line-147"></span><span>                  </span><span class="hs-special">(</span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server-observable-state-&quot;</span></span><span>
</span><span id="line-148"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">intercalate</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(peerAddr -&gt; String) -&gt; [peerAddr] -&gt; [String]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[peerAddr]
</span><a href="#local-6989586621679255856"><span class="hs-identifier hs-var">localAddresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[peerAddr] -&gt; ServerTrace peerAddr
forall peerAddr. [peerAddr] -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrServerStarted"><span class="hs-identifier hs-var">TrServerStarted</span></a></span><span> </span><span class="annot"><span class="annottext">[peerAddr]
</span><a href="#local-6989586621679255856"><span class="hs-identifier hs-var">localAddresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679255849"><span class="annot"><span class="annottext">threads :: [m Void]
</span><a href="#local-6989586621679255849"><span class="hs-identifier hs-var hs-var">threads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inbound-governor-&quot;</span></span><span>
</span><span id="line-152"></span><span>                                        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">intercalate</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(peerAddr -&gt; String) -&gt; [peerAddr] -&gt; [String]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[peerAddr]
</span><a href="#local-6989586621679255856"><span class="hs-identifier hs-var">localAddresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>                                        </span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>                        </span><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace peerAddr)
-&gt; Tracer m (InboundGovernorTrace peerAddr)
-&gt; ServerControlChannel muxMode peerAddr ByteString m a b
-&gt; Maybe DiffTime
-&gt; MuxConnectionManager
     muxMode socket peerAddr versionNumber ByteString m a b
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; m Void
forall (muxMode :: MuxMode) socket peerAddr versionNumber
       (m :: * -&gt; *) a b.
(MonadAsync m, MonadCatch m, MonadEvaluate m, MonadThrow m,
 MonadThrow (STM m), MonadTime m, MonadTimer m, MonadMask m,
 Ord peerAddr, HasResponder muxMode ~ 'True) =&gt;
Tracer m (RemoteTransitionTrace peerAddr)
-&gt; Tracer m (InboundGovernorTrace peerAddr)
-&gt; ServerControlChannel muxMode peerAddr ByteString m a b
-&gt; Maybe DiffTime
-&gt; MuxConnectionManager
     muxMode socket peerAddr versionNumber ByteString m a b
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; m Void
</span><a href="Ouroboros.Network.InboundGovernor.html#inboundGovernor"><span class="hs-identifier hs-var">inboundGovernor</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace peerAddr)
</span><a href="#local-6989586621679255869"><span class="hs-identifier hs-var">serverTrTracer</span></a></span><span>
</span><span id="line-155"></span><span>                                        </span><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace peerAddr)
</span><a href="#local-6989586621679255867"><span class="hs-identifier hs-var">inboundGovernorTracer</span></a></span><span>
</span><span id="line-156"></span><span>                                        </span><span class="annot"><span class="annottext">ServerControlChannel muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679255860"><span class="hs-identifier hs-var">serverControlChannel</span></a></span><span>
</span><span id="line-157"></span><span>                                        </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="#local-6989586621679255862"><span class="hs-identifier hs-var">serverInboundIdleTimeout</span></a></span><span>
</span><span id="line-158"></span><span>                                        </span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
</span><a href="#local-6989586621679255861"><span class="hs-identifier hs-var">serverConnectionManager</span></a></span><span>
</span><span id="line-159"></span><span>                                        </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679255859"><span class="hs-identifier hs-var">serverObservableStateVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>                    </span><span class="annot"><span class="annottext">m Void -&gt; [m Void] -&gt; [m Void]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m (Accept m socket peerAddr)
forall (m :: * -&gt; *) fd addr.
Snocket m fd addr -&gt; fd -&gt; m (Accept m fd addr)
</span><a href="Ouroboros.Network.Snocket.html#accept"><span class="hs-identifier hs-var hs-var">accept</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255845"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">m (Accept m socket peerAddr)
-&gt; (Accept m socket peerAddr -&gt; m Void) -&gt; m Void
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255844"><span class="hs-identifier hs-var">acceptLoop</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255843"><span class="hs-identifier hs-var">localAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>                        </span><span class="annot"><span class="annottext">m Void -&gt; m () -&gt; m Void
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255845"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-162"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679255843"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255843"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679255845"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255845"><span class="hs-identifier hs-var">socket</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[peerAddr]
</span><a href="#local-6989586621679255856"><span class="hs-identifier hs-var">localAddresses</span></a></span><span> </span><span class="annot"><span class="annottext">[peerAddr] -&gt; [socket] -&gt; [(peerAddr, socket)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[socket]
</span><a href="#local-6989586621679255858"><span class="hs-identifier hs-var">sockets</span></a></span><span>
</span><span id="line-163"></span><span>                      </span><span class="hs-special">]</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-comment">-- race all the threads</span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="annottext">(m Void -&gt; m Void -&gt; m Void) -&gt; [m Void] -&gt; m Void
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl1'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679255840"><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679255840"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679255839"><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679255839"><span class="hs-identifier hs-var">io</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Void -&gt; Void) -&gt; (Void -&gt; Void) -&gt; Either Void Void -&gt; Void
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="annot"><span class="annottext">Void -&gt; Void
forall a. a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Void -&gt; Void
forall a. a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Void Void -&gt; Void) -&gt; m (Either Void Void) -&gt; m Void
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679255840"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">m Void -&gt; m Void -&gt; m (Either Void Void)
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; m b -&gt; m (Either a b)
</span><span class="hs-operator hs-var">`race`</span></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679255839"><span class="hs-identifier hs-var">io</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[m Void]
</span><a href="#local-6989586621679255849"><span class="hs-identifier hs-var">threads</span></a></span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">m Void -&gt; m () -&gt; m Void
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span>
</span><span id="line-168"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrace peerAddr
forall peerAddr. ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrServerStopped"><span class="hs-identifier hs-var">TrServerStopped</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span class="annot"><span class="annottext">m Void -&gt; (SomeException -&gt; m Void) -&gt; m Void
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span>
</span><span id="line-170"></span><span>          </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679255833"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255833"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncCancelled
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255833"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-172"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AsyncCancelled</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>              </span><span class="annot"><span class="annottext">Maybe AsyncCancelled
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ServerTrace peerAddr
forall peerAddr. SomeException -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrServerError"><span class="hs-identifier hs-var">TrServerError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255833"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="annottext">SomeException -&gt; m Void
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255833"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="#local-6989586621679255829"><span class="hs-identifier hs-type">iseCONNABORTED</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IOError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span>    </span><span class="hs-comment">-- On Windows the network packet classifies all errors</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- as OtherError. This means that we're forced to match</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- on the error string. The text string comes from</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- the network package's winSockErr.c, and if it ever</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">-- changes we must update our text string too.</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-identifier">iseCONNABORTED</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IOError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-string">&quot;Software caused connection abort (WSAECONNABORTED)&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-identifier">iseCONNABORTED</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#else
</span><span>    </span><span id="local-6989586621679255829"><span class="annot"><span class="annottext">iseCONNABORTED :: IOError -&gt; Bool
</span><a href="#local-6989586621679255829"><span class="hs-identifier hs-var hs-var">iseCONNABORTED</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IOError</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IOErrorType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679255827"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679255827"><span class="hs-identifier hs-var">cerrno</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">eCONNABORTED</span></a></span><span> </span><span class="annot"><span class="annottext">Errno -&gt; Errno -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; Errno
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Errno</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679255827"><span class="hs-identifier hs-var">cerrno</span></a></span><span class="hs-cpp">
#if defined(darwin_HOST_OS)
</span><span>    </span><span class="hs-comment">-- There is a bug in accept for IPv6 sockets. Instead of returning -1</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- and setting errno to ECONNABORTED an invalid (&gt;= 0) file descriptor</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">-- is returned, with the client address left unchanged. The uninitialized</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-comment">-- client address causes the network package to throw the user error below.</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-identifier">iseCONNABORTED</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IOError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">UserError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-string">&quot;Network.Socket.Types.peekSockAddr: address family '0' not supported.&quot;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><a href="#local-6989586621679255829"><span class="hs-identifier hs-var">iseCONNABORTED</span></a></span><span> </span><span class="annot"><span class="annottext">IOError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="#local-6989586621679255844"><span class="hs-identifier hs-type">acceptLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-199"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Accept"><span class="hs-identifier hs-type">Accept</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255877"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-200"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621679255844"><span class="annot"><span class="annottext">acceptLoop :: peerAddr -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255844"><span class="hs-identifier hs-var hs-var">acceptLoop</span></a></span></span><span> </span><span id="local-6989586621679255824"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255824"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span> </span><span id="local-6989586621679255823"><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255823"><span class="hs-identifier hs-var">acceptOne0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m Void) -&gt; m Void
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m Void) -&gt; m Void)
-&gt; ((forall a. m a -&gt; m a) -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679255821"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679255821"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;accept-loop-&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255824"><span class="hs-identifier hs-var">localAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">(forall a. m a -&gt; m a) -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255820"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679255821"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255823"><span class="hs-identifier hs-var">acceptOne0</span></a></span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">m Void -&gt; (SomeException -&gt; m Void) -&gt; m Void
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679255819"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255819"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ServerTrace peerAddr
forall peerAddr. SomeException -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrServerError"><span class="hs-identifier hs-var">TrServerError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255819"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>                    </span><span class="annot"><span class="annottext">m () -&gt; m Void -&gt; m Void
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m Void
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255819"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-comment">-- we must guarantee that 'includeInboundConnection' is called,</span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-comment">-- otherwise we will have a resource leak.</span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- The 'mask' makes sure that exceptions are not delivered once</span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-comment">-- between accepting a socket and starting thread that runs</span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-comment">-- 'includeInboundConnection'.</span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- NOTE: when we will make 'includeInboundConnection' a non blocking</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- (issue #3478) we still need to guarantee the above property.</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><a href="#local-6989586621679255820"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679255818"><span class="annot"><a href="#local-6989586621679255818"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255818"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255818"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Accept"><span class="hs-identifier hs-type">Accept</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255877"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679255876"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-219"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679255874"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span id="local-6989586621679255820"><span class="annot"><span class="annottext">go :: (forall a. m a -&gt; m a) -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255820"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679255817"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679255817"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span id="local-6989586621679255816"><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255816"><span class="hs-identifier hs-var">acceptOne</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>          </span><span id="local-6989586621679255815"><span class="annot"><span class="annottext">(Accepted socket peerAddr, Accept m socket peerAddr)
</span><a href="#local-6989586621679255815"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Accepted socket peerAddr, Accept m socket peerAddr)
-&gt; m (Accepted socket peerAddr, Accept m socket peerAddr)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679255817"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Accepted socket peerAddr, Accept m socket peerAddr)
 -&gt; m (Accepted socket peerAddr, Accept m socket peerAddr))
-&gt; m (Accepted socket peerAddr, Accept m socket peerAddr)
-&gt; m (Accepted socket peerAddr, Accept m socket peerAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-222"></span><span>            </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
-&gt; STM m Int -&gt; AcceptedConnectionsLimit -&gt; m ()
forall (m :: * -&gt; *).
(MonadSTM m, MonadDelay m, MonadTime m) =&gt;
Tracer m AcceptConnectionsPolicyTrace
-&gt; STM m Int -&gt; AcceptedConnectionsLimit -&gt; m ()
</span><a href="Ouroboros.Network.Server.RateLimiting.html#runConnectionRateLimits"><span class="hs-identifier hs-var">runConnectionRateLimits</span></a></span><span>
</span><span id="line-223"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AcceptConnectionsPolicyTrace -&gt; ServerTrace peerAddr
forall peerAddr.
AcceptConnectionsPolicyTrace -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrAcceptPolicyTrace"><span class="hs-identifier hs-var">TrAcceptPolicyTrace</span></a></span><span> </span><span class="annot"><span class="annottext">(AcceptConnectionsPolicyTrace -&gt; ServerTrace peerAddr)
-&gt; Tracer m (ServerTrace peerAddr)
-&gt; Tracer m AcceptConnectionsPolicyTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
-&gt; STM m Int
forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
(HasResponder muxMode ~ 'True) =&gt;
ConnectionManager muxMode socket peerAddr handle handleError m
-&gt; STM m Int
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#numberOfConnections"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span> </span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
</span><a href="#local-6989586621679255861"><span class="hs-identifier hs-var">serverConnectionManager</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>              </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679255866"><span class="hs-identifier hs-var">serverLimits</span></a></span><span>
</span><span id="line-226"></span><span>            </span><span class="annot"><span class="annottext">Accept m socket peerAddr
-&gt; m (Accepted socket peerAddr, Accept m socket peerAddr)
forall (m :: * -&gt; *) fd addr.
Accept m fd addr -&gt; m (Accepted fd addr, Accept m fd addr)
</span><a href="Ouroboros.Network.Snocket.html#runAccept"><span class="hs-identifier hs-var hs-var">runAccept</span></a></span><span> </span><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255816"><span class="hs-identifier hs-var">acceptOne</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Accepted socket peerAddr, Accept m socket peerAddr)
</span><a href="#local-6989586621679255815"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-229"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Snocket.html#AcceptFailure"><span class="hs-identifier hs-type">AcceptFailure</span></a></span><span> </span><span id="local-6989586621679255809"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255809"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679255808"><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255808"><span class="hs-identifier hs-var">acceptNext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>              </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ServerTrace peerAddr
forall peerAddr. SomeException -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrAcceptError"><span class="hs-identifier hs-var">TrAcceptError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255809"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>              </span><span class="hs-comment">-- Try to determine if the connection was aborted by the remote end</span><span>
</span><span id="line-232"></span><span>              </span><span class="hs-comment">-- before we could process the accept, or if it was a resource</span><span>
</span><span id="line-233"></span><span>              </span><span class="hs-comment">-- exhaustion problem.</span><span>
</span><span id="line-234"></span><span>              </span><span class="hs-comment">-- NB. This piece of code is fragile and depends on specific</span><span>
</span><span id="line-235"></span><span>              </span><span class="hs-comment">-- strings/mappings in the network and base libraries.</span><span>
</span><span id="line-236"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe IOError
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255809"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>                 </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679255806"><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679255806"><span class="hs-identifier hs-var">ioErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>                   </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IOError -&gt; Bool
</span><a href="#local-6989586621679255829"><span class="hs-identifier hs-var">iseCONNABORTED</span></a></span><span> </span><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679255806"><span class="hs-identifier hs-var">ioErr</span></a></span><span>
</span><span id="line-239"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Server2.html#server_CONNABORTED_DELAY"><span class="hs-identifier hs-var">server_CONNABORTED_DELAY</span></a></span><span>
</span><span id="line-240"></span><span>                        </span><span class="annot"><span class="annottext">m () -&gt; m Void -&gt; m Void
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(forall a. m a -&gt; m a) -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255820"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679255817"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255808"><span class="hs-identifier hs-var">acceptNext</span></a></span><span>
</span><span id="line-241"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IOError -&gt; m Void
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679255806"><span class="hs-identifier hs-var">ioErr</span></a></span><span>
</span><span id="line-242"></span><span>                 </span><span class="annot"><span class="annottext">Maybe IOError
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m Void
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679255809"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Accepted"><span class="hs-identifier hs-type">Accepted</span></a></span><span> </span><span id="local-6989586621679255803"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255803"><span class="hs-identifier hs-var">socket</span></a></span></span><span> </span><span id="local-6989586621679255802"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255802"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679255801"><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255801"><span class="hs-identifier hs-var">acceptNext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>              </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr) -&gt; ServerTrace peerAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace peerAddr)
</span><a href="#local-6989586621679255868"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; ServerTrace peerAddr
forall peerAddr. peerAddr -&gt; ServerTrace peerAddr
</span><a href="Ouroboros.Network.Server2.html#TrAcceptConnection"><span class="hs-identifier hs-var">TrAcceptConnection</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255802"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>                  </span><span class="annot"><span class="annottext">m () -&gt; m (Async m ())
forall (m :: * -&gt; *) a. MonadAsync m =&gt; m a -&gt; m (Async m a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (Async m ())) -&gt; m () -&gt; m (Async m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-248"></span><span>                    </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679255798"><span class="annot"><span class="annottext">Connected
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
</span><a href="#local-6989586621679255798"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-249"></span><span>                         </span><span class="annot"><span class="annottext">m (Connected
     peerAddr
     (Handle muxMode peerAddr ByteString m a b)
     (HandleError muxMode versionNumber))
-&gt; m (Connected
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber))
forall a. m a -&gt; m a
</span><a href="#local-6989586621679255817"><span class="hs-identifier hs-var">unmask</span></a></span><span>
</span><span id="line-250"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
-&gt; IncludeInboundConnection
     socket
     peerAddr
     (Handle muxMode peerAddr ByteString m a b)
     (HandleError muxMode versionNumber)
     m
forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
(HasResponder muxMode ~ 'True) =&gt;
ConnectionManager muxMode socket peerAddr handle handleError m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#includeInboundConnection"><span class="hs-identifier hs-var">includeInboundConnection</span></a></span><span>
</span><span id="line-251"></span><span>                             </span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode socket peerAddr versionNumber ByteString m a b
</span><a href="#local-6989586621679255861"><span class="hs-identifier hs-var">serverConnectionManager</span></a></span><span>
</span><span id="line-252"></span><span>                             </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679255863"><span class="hs-identifier hs-var">hardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255803"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679255802"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>                       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Connected
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
</span><a href="#local-6989586621679255798"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-254"></span><span>                         </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-type">Connected</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>                         </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-type">Disconnected</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>                           </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255803"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-257"></span><span>                           </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>                    </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`onException`</span></span><span>
</span><span id="line-259"></span><span>                      </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255803"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-260"></span><span>              </span><span class="annot"><span class="annottext">m (Async m ()) -&gt; m () -&gt; m (Async m ())
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`onException`</span></span><span>
</span><span id="line-261"></span><span>                 </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679255870"><span class="hs-identifier hs-var">serverSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679255803"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-262"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>              </span><span class="annot"><span class="annottext">m (Async m ()) -&gt; m Void -&gt; m Void
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(forall a. m a -&gt; m a) -&gt; Accept m socket peerAddr -&gt; m Void
</span><a href="#local-6989586621679255820"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679255817"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">Accept m socket peerAddr
</span><a href="#local-6989586621679255801"><span class="hs-identifier hs-var">acceptNext</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">--</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- Trace</span><span>
</span><span id="line-267"></span><span class="hs-comment">--</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-keyword">data</span><span> </span><span id="ServerTrace"><span class="annot"><a href="Ouroboros.Network.Server2.html#ServerTrace"><span class="hs-identifier hs-var">ServerTrace</span></a></span></span><span> </span><span id="local-6989586621679255998"><span class="annot"><a href="#local-6989586621679255998"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="TrAcceptConnection"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrAcceptConnection"><span class="hs-identifier hs-var">TrAcceptConnection</span></a></span></span><span>            </span><span class="annot"><a href="#local-6989586621679255998"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrAcceptError"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrAcceptError"><span class="hs-identifier hs-var">TrAcceptError</span></a></span></span><span>                 </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrAcceptPolicyTrace"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrAcceptPolicyTrace"><span class="hs-identifier hs-var">TrAcceptPolicyTrace</span></a></span></span><span>           </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier hs-type">AcceptConnectionsPolicyTrace</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrServerStarted"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrServerStarted"><span class="hs-identifier hs-var">TrServerStarted</span></a></span></span><span>               </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679255998"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrServerStopped"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrServerStopped"><span class="hs-identifier hs-var">TrServerStopped</span></a></span></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrServerError"><span class="annot"><a href="Ouroboros.Network.Server2.html#TrServerError"><span class="hs-identifier hs-var">TrServerError</span></a></span></span><span>                 </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">-- ^ similar to 'TrAcceptConnection' but it is logged once the connection is</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- handed to inbound connection manager, e.g. after handshake negotiation.</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679255788"><span id="local-6989586621679255790"><span id="local-6989586621679255792"><span class="annot"><span class="annottext">Int -&gt; ServerTrace peerAddr -&gt; String -&gt; String
[ServerTrace peerAddr] -&gt; String -&gt; String
ServerTrace peerAddr -&gt; String
(Int -&gt; ServerTrace peerAddr -&gt; String -&gt; String)
-&gt; (ServerTrace peerAddr -&gt; String)
-&gt; ([ServerTrace peerAddr] -&gt; String -&gt; String)
-&gt; Show (ServerTrace peerAddr)
forall peerAddr.
Show peerAddr =&gt;
Int -&gt; ServerTrace peerAddr -&gt; String -&gt; String
forall peerAddr.
Show peerAddr =&gt;
[ServerTrace peerAddr] -&gt; String -&gt; String
forall peerAddr. Show peerAddr =&gt; ServerTrace peerAddr -&gt; String
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [ServerTrace peerAddr] -&gt; String -&gt; String
$cshowList :: forall peerAddr.
Show peerAddr =&gt;
[ServerTrace peerAddr] -&gt; String -&gt; String
show :: ServerTrace peerAddr -&gt; String
$cshow :: forall peerAddr. Show peerAddr =&gt; ServerTrace peerAddr -&gt; String
showsPrec :: Int -&gt; ServerTrace peerAddr -&gt; String -&gt; String
$cshowsPrec :: forall peerAddr.
Show peerAddr =&gt;
Int -&gt; ServerTrace peerAddr -&gt; String -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span></pre></body></html>