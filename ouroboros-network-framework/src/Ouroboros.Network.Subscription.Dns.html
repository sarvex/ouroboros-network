<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">{- Partial implementation of RFC8305, https://tools.ietf.org/html/rfc8305 .
 - Prioritization of destination addresses doesn't implement longest prefix matching
 - and doesn't take address scope etc. into account.
 -}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Subscription.Dns</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier">DnsSubscriptionTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier">Resolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionParams"><span class="hs-identifier">DnsSubscriptionParams</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker%27"><span class="hs-identifier">dnsSubscriptionWorker'</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker"><span class="hs-identifier">dnsSubscriptionWorker</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsResolve"><span class="hs-identifier">dnsResolve</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#resolutionDelay"><span class="hs-identifier">resolutionDelay</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Traces</span></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier">SubscriptionTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier">DnsTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier">ErrorPolicyTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier">WithDomainName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier">WithAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IP</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IP</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.DNS</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DNS</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Socket</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Text.Printf</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html"><span class="hs-identifier">Ouroboros.Network.ErrorPolicy</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Snocket.html"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier">Snocket</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Socket.html"><span class="hs-identifier">Ouroboros.Network.Socket</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Subscription.Ip.html"><span class="hs-identifier">Ouroboros.Network.Subscription.Ip</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html"><span class="hs-identifier">Ouroboros.Network.Subscription.Subscriber</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Subscription.Worker.html"><span class="hs-identifier">Ouroboros.Network.Subscription.Worker</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- | Time to wait for an AAAA response after receiving an A response.</span><span>
</span><span id="line-52"></span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#resolutionDelay"><span class="hs-identifier hs-type">resolutionDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-53"></span><span id="resolutionDelay"><span class="annot"><span class="annottext">resolutionDelay :: DiffTime
</span><a href="Ouroboros.Network.Subscription.Dns.html#resolutionDelay"><span class="hs-identifier hs-var hs-var">resolutionDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0.05</span></span><span> </span><span class="hs-comment">-- 50ms delay</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">data</span><span> </span><span id="DnsSubscriptionTarget"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier hs-var">DnsSubscriptionTarget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DnsSubscriptionTarget"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier hs-var">DnsSubscriptionTarget</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-57"></span><span>      </span><span id="dstDomain"><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; Domain
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstDomain"><span class="hs-identifier hs-var hs-var">dstDomain</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">DNS.Domain</span></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dstPort"><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; PortNumber
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstPort"><span class="hs-identifier hs-var hs-var">dstPort</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Socket.PortNumber</span></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dstValency"><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; Int
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstValency"><span class="hs-identifier hs-var hs-var">dstValency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260703"><span id="local-6989586621679260705"><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool
(DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool)
-&gt; (DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool)
-&gt; Eq DnsSubscriptionTarget
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool
$c/= :: DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool
== :: DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool
$c== :: DnsSubscriptionTarget -&gt; DnsSubscriptionTarget -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679260696"><span id="local-6989586621679260698"><span id="local-6989586621679260700"><span class="annot"><span class="annottext">Int -&gt; DnsSubscriptionTarget -&gt; ShowS
[DnsSubscriptionTarget] -&gt; ShowS
DnsSubscriptionTarget -&gt; String
(Int -&gt; DnsSubscriptionTarget -&gt; ShowS)
-&gt; (DnsSubscriptionTarget -&gt; String)
-&gt; ([DnsSubscriptionTarget] -&gt; ShowS)
-&gt; Show DnsSubscriptionTarget
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DnsSubscriptionTarget] -&gt; ShowS
$cshowList :: [DnsSubscriptionTarget] -&gt; ShowS
show :: DnsSubscriptionTarget -&gt; String
$cshow :: DnsSubscriptionTarget -&gt; String
showsPrec :: Int -&gt; DnsSubscriptionTarget -&gt; ShowS
$cshowsPrec :: Int -&gt; DnsSubscriptionTarget -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">data</span><span> </span><span id="Resolver"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-var">Resolver</span></a></span></span><span> </span><span id="local-6989586621679260835"><span class="annot"><a href="#local-6989586621679260835"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Resolver"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-var">Resolver</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-64"></span><span>      </span><span id="lookupA"><span class="annot"><span class="annottext">Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
</span><a href="Ouroboros.Network.Subscription.Dns.html#lookupA"><span class="hs-identifier hs-var hs-var">lookupA</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.Domain</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.DNSError</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="lookupAAAA"><span class="annot"><span class="annottext">Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
</span><a href="Ouroboros.Network.Subscription.Dns.html#lookupAAAA"><span class="hs-identifier hs-var hs-var">lookupAAAA</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.Domain</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.DNSError</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621679260724"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#withResolver"><span class="hs-identifier hs-type">withResolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.ResolvSeed</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260724"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260724"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-69"></span><span id="withResolver"><span class="annot"><span class="annottext">withResolver :: PortNumber -&gt; ResolvSeed -&gt; (Resolver IO -&gt; IO a) -&gt; IO a
</span><a href="Ouroboros.Network.Subscription.Dns.html#withResolver"><span class="hs-identifier hs-var hs-var">withResolver</span></a></span></span><span> </span><span id="local-6989586621679260690"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621679260690"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621679260689"><span class="annot"><span class="annottext">ResolvSeed
</span><a href="#local-6989586621679260689"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621679260688"><span class="annot"><span class="annottext">Resolver IO -&gt; IO a
</span><a href="#local-6989586621679260688"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><span class="annottext">ResolvSeed -&gt; (Resolver -&gt; IO a) -&gt; IO a
forall a. ResolvSeed -&gt; (Resolver -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">DNS.withResolver</span></span><span> </span><span class="annot"><span class="annottext">ResolvSeed
</span><a href="#local-6989586621679260689"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">((Resolver -&gt; IO a) -&gt; IO a) -&gt; (Resolver -&gt; IO a) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679260686"><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260686"><span class="hs-identifier hs-var">dnsResolver</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><span class="annottext">Resolver IO -&gt; IO a
</span><a href="#local-6989586621679260688"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Domain -&gt; IO (Either DNSError [SockAddr]))
-&gt; (Domain -&gt; IO (Either DNSError [SockAddr])) -&gt; Resolver IO
forall (m :: * -&gt; *).
(Domain -&gt; m (Either DNSError [SockAddr]))
-&gt; (Domain -&gt; m (Either DNSError [SockAddr])) -&gt; Resolver m
</span><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-var">Resolver</span></a></span><span>
</span><span id="line-72"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Resolver -&gt; Domain -&gt; IO (Either DNSError [SockAddr])
</span><a href="#local-6989586621679260685"><span class="hs-identifier hs-var">ipv4ToSockAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260686"><span class="hs-identifier hs-var">dnsResolver</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Resolver -&gt; Domain -&gt; IO (Either DNSError [SockAddr])
</span><a href="#local-6989586621679260684"><span class="hs-identifier hs-var">ipv6ToSockAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260686"><span class="hs-identifier hs-var">dnsResolver</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621679260685"><span class="annot"><span class="annottext">ipv4ToSockAddr :: Resolver -&gt; Domain -&gt; IO (Either DNSError [SockAddr])
</span><a href="#local-6989586621679260685"><span class="hs-identifier hs-var hs-var">ipv4ToSockAddr</span></a></span></span><span> </span><span id="local-6989586621679260683"><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260683"><span class="hs-identifier hs-var">dnsResolver</span></a></span></span><span> </span><span id="local-6989586621679260682"><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260682"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>        </span><span id="local-6989586621679260681"><span class="annot"><span class="annottext">Either DNSError [IPv4]
</span><a href="#local-6989586621679260681"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Resolver -&gt; Domain -&gt; IO (Either DNSError [IPv4])
</span><span class="hs-identifier hs-var">DNS.lookupA</span></span><span> </span><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260683"><span class="hs-identifier hs-var">dnsResolver</span></a></span><span> </span><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260682"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either DNSError [IPv4]
</span><a href="#local-6989586621679260681"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-78"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260679"><span class="annot"><span class="annottext">[IPv4]
</span><a href="#local-6989586621679260679"><span class="hs-identifier hs-var">ips</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr]))
-&gt; Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; Either DNSError [SockAddr]
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">([SockAddr] -&gt; Either DNSError [SockAddr])
-&gt; [SockAddr] -&gt; Either DNSError [SockAddr]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(IPv4 -&gt; SockAddr) -&gt; [IPv4] -&gt; [SockAddr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber -&gt; HostAddress -&gt; SockAddr
</span><span class="hs-identifier hs-var">Socket.SockAddrInet</span></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621679260690"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">(HostAddress -&gt; SockAddr)
-&gt; (IPv4 -&gt; HostAddress) -&gt; IPv4 -&gt; SockAddr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span>
</span><span id="line-79"></span><span>                                                  </span><span class="annot"><span class="annottext">IPv4 -&gt; HostAddress
</span><span class="hs-identifier hs-var">IP.toHostAddress</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[IPv4]
</span><a href="#local-6989586621679260679"><span class="hs-identifier hs-var">ips</span></a></span><span>
</span><span id="line-80"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260675"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260675"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr]))
-&gt; Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; Either DNSError [SockAddr]
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260675"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621679260684"><span class="annot"><span class="annottext">ipv6ToSockAddr :: Resolver -&gt; Domain -&gt; IO (Either DNSError [SockAddr])
</span><a href="#local-6989586621679260684"><span class="hs-identifier hs-var hs-var">ipv6ToSockAddr</span></a></span></span><span> </span><span id="local-6989586621679260674"><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260674"><span class="hs-identifier hs-var">dnsResolver</span></a></span></span><span> </span><span id="local-6989586621679260673"><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260673"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>        </span><span id="local-6989586621679260672"><span class="annot"><span class="annottext">Either DNSError [IPv6]
</span><a href="#local-6989586621679260672"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Resolver -&gt; Domain -&gt; IO (Either DNSError [IPv6])
</span><span class="hs-identifier hs-var">DNS.lookupAAAA</span></span><span> </span><span class="annot"><span class="annottext">Resolver
</span><a href="#local-6989586621679260674"><span class="hs-identifier hs-var">dnsResolver</span></a></span><span> </span><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260673"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either DNSError [IPv6]
</span><a href="#local-6989586621679260672"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-85"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260670"><span class="annot"><span class="annottext">[IPv6]
</span><a href="#local-6989586621679260670"><span class="hs-identifier hs-var">ips</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr]))
-&gt; Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; Either DNSError [SockAddr]
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">([SockAddr] -&gt; Either DNSError [SockAddr])
-&gt; [SockAddr] -&gt; Either DNSError [SockAddr]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(IPv6 -&gt; SockAddr) -&gt; [IPv6] -&gt; [SockAddr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679260669"><span class="annot"><span class="annottext">IPv6
</span><a href="#local-6989586621679260669"><span class="hs-identifier hs-var">ip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PortNumber
-&gt; HostAddress -&gt; HostAddress6 -&gt; HostAddress -&gt; SockAddr
</span><span class="hs-identifier hs-var">Socket.SockAddrInet6</span></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621679260690"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">HostAddress
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IPv6 -&gt; HostAddress6
</span><span class="hs-identifier hs-var">IP.toHostAddress6</span></span><span> </span><span class="annot"><span class="annottext">IPv6
</span><a href="#local-6989586621679260669"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HostAddress
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[IPv6]
</span><a href="#local-6989586621679260670"><span class="hs-identifier hs-var">ips</span></a></span><span>
</span><span id="line-86"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260666"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260666"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr]))
-&gt; Either DNSError [SockAddr] -&gt; IO (Either DNSError [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; Either DNSError [SockAddr]
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260666"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsResolve"><span class="hs-identifier hs-type">dnsResolve</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679260734"><span class="annot"><a href="#local-6989586621679260734"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679260735"><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679260733"><span class="annot"><a href="#local-6989586621679260733"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-90"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-91"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-92"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span>  </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-93"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-94"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier hs-type">DnsTrace</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260734"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679260734"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260733"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.PeerState.html#BeforeConnect"><span class="hs-identifier hs-type">BeforeConnect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260733"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier hs-type">DnsSubscriptionTarget</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span id="dnsResolve"><span class="annot"><span class="annottext">dnsResolve :: Tracer m DnsTrace
-&gt; m a
-&gt; (a
    -&gt; (Resolver m -&gt; m (SubscriptionTarget m SockAddr))
    -&gt; m (SubscriptionTarget m SockAddr))
-&gt; StrictTVar m s
-&gt; BeforeConnect m s SockAddr
-&gt; DnsSubscriptionTarget
-&gt; m (SubscriptionTarget m SockAddr)
</span><a href="Ouroboros.Network.Subscription.Dns.html#dnsResolve"><span class="hs-identifier hs-var hs-var">dnsResolve</span></a></span></span><span> </span><span id="local-6989586621679260665"><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679260664"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679260664"><span class="hs-identifier hs-var">getSeed</span></a></span></span><span> </span><span id="local-6989586621679260663"><span class="annot"><span class="annottext">a
-&gt; (Resolver m -&gt; m (SubscriptionTarget m SockAddr))
-&gt; m (SubscriptionTarget m SockAddr)
</span><a href="#local-6989586621679260663"><span class="hs-identifier hs-var">withResolverFn</span></a></span></span><span> </span><span id="local-6989586621679260662"><span class="annot"><span class="annottext">StrictTVar m s
</span><a href="#local-6989586621679260662"><span class="hs-identifier hs-var">peerStatesVar</span></a></span></span><span> </span><span id="local-6989586621679260661"><span class="annot"><span class="annottext">BeforeConnect m s SockAddr
</span><a href="#local-6989586621679260661"><span class="hs-identifier hs-var">beforeConnect</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier hs-type">DnsSubscriptionTarget</span></a></span><span> </span><span id="local-6989586621679260660"><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260660"><span class="hs-identifier hs-var">domain</span></a></span></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621679260659"><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679260659"><span class="hs-identifier hs-var">rs_e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either SomeException a
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Either SomeException a) -&gt; m a -&gt; m (Either SomeException a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679260664"><span class="hs-identifier hs-var">getSeed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
-&gt; [Handler m (Either SomeException a)]
-&gt; m (Either SomeException a)
forall (m :: * -&gt; *) a. MonadCatch m =&gt; m a -&gt; [Handler m a] -&gt; m a
</span><span class="hs-operator hs-var">`catches`</span></span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(DNSError -&gt; m (Either SomeException a))
-&gt; Handler m (Either SomeException a)
forall (m :: * -&gt; *) a e. Exception e =&gt; (e -&gt; m a) -&gt; Handler m a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260655"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260655"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.DNSError</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-105"></span><span>            </span><span class="annot"><span class="annottext">Either SomeException a -&gt; m (Either SomeException a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException a
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException a)
-&gt; SomeException -&gt; Either SomeException a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toException</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260655"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>        </span><span class="hs-comment">-- On windows getSeed fails with BadConfiguration if the network is down.</span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(IOError -&gt; m (Either SomeException a))
-&gt; Handler m (Either SomeException a)
forall (m :: * -&gt; *) a e. Exception e =&gt; (e -&gt; m a) -&gt; Handler m a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260653"><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679260653"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IOError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>            </span><span class="annot"><span class="annottext">Either SomeException a -&gt; m (Either SomeException a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException a
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException a)
-&gt; SomeException -&gt; Either SomeException a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IOError -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toException</span></a></span><span> </span><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679260653"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>        </span><span class="hs-comment">-- On OSX getSeed can fail with IOError if all network devices are down.</span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679260659"><span class="hs-identifier hs-var">rs_e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-112"></span><span>         </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260652"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260652"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>             </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupException"><span class="hs-identifier hs-var">DnsTraceLookupException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260652"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-114"></span><span>             </span><span class="annot"><span class="annottext">SubscriptionTarget m SockAddr -&gt; m (SubscriptionTarget m SockAddr)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionTarget m SockAddr
 -&gt; m (SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
-&gt; m (SubscriptionTarget m SockAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; SubscriptionTarget m SockAddr
forall (m :: * -&gt; *) target.
Applicative m =&gt;
[target] -&gt; SubscriptionTarget m target
</span><a href="Ouroboros.Network.Subscription.Subscriber.html#listSubscriptionTarget"><span class="hs-identifier hs-var">listSubscriptionTarget</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>         </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260648"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679260648"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>             </span><span class="annot"><span class="annottext">a
-&gt; (Resolver m -&gt; m (SubscriptionTarget m SockAddr))
-&gt; m (SubscriptionTarget m SockAddr)
</span><a href="#local-6989586621679260663"><span class="hs-identifier hs-var">withResolverFn</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679260648"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">((Resolver m -&gt; m (SubscriptionTarget m SockAddr))
 -&gt; m (SubscriptionTarget m SockAddr))
-&gt; (Resolver m -&gt; m (SubscriptionTarget m SockAddr))
-&gt; m (SubscriptionTarget m SockAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679260647"><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260647"><span class="hs-identifier hs-var">resolver</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>                 </span><span class="hs-comment">-- Though the DNS lib does have its own timeouts, these do not work</span><span>
</span><span id="line-119"></span><span>                 </span><span class="hs-comment">-- on Windows reliably so as a workaround we add an extra layer</span><span>
</span><span id="line-120"></span><span>                 </span><span class="hs-comment">-- of timeout on the outside.</span><span>
</span><span id="line-121"></span><span>                 </span><span class="hs-comment">-- TODO: Fix upstream dns lib.</span><span>
</span><span id="line-122"></span><span>                 </span><span class="hs-comment">--       On windows the aid_ipv6 and aid_ipv4 threads are leaked incase</span><span>
</span><span id="line-123"></span><span>                 </span><span class="hs-comment">--       of an exception in the main thread.</span><span>
</span><span id="line-124"></span><span>                 </span><span id="local-6989586621679260646"><span class="annot"><span class="annottext">Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260646"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
forall (m :: * -&gt; *) a.
MonadTimer m =&gt;
DiffTime -&gt; m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">timeout</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
 -&gt; m (Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr))))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>                          </span><span id="local-6989586621679260644"><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260644"><span class="hs-identifier hs-var">aid_ipv6</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [SockAddr] -&gt; m (Async m [SockAddr])
forall (m :: * -&gt; *) a. MonadAsync m =&gt; m a -&gt; m (Async m a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(m [SockAddr] -&gt; m (Async m [SockAddr]))
-&gt; m [SockAddr] -&gt; m (Async m [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m -&gt; m [SockAddr]
</span><a href="#local-6989586621679260642"><span class="hs-identifier hs-var">resolveAAAA</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260647"><span class="hs-identifier hs-var">resolver</span></a></span><span>
</span><span id="line-126"></span><span>                          </span><span id="local-6989586621679260641"><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260641"><span class="hs-identifier hs-var">aid_ipv4</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [SockAddr] -&gt; m (Async m [SockAddr])
forall (m :: * -&gt; *) a. MonadAsync m =&gt; m a -&gt; m (Async m a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(m [SockAddr] -&gt; m (Async m [SockAddr]))
-&gt; m [SockAddr] -&gt; m (Async m [SockAddr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m -&gt; Async m [SockAddr] -&gt; m [SockAddr]
</span><a href="#local-6989586621679260640"><span class="hs-identifier hs-var">resolveA</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260647"><span class="hs-identifier hs-var">resolver</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260644"><span class="hs-identifier hs-var">aid_ipv6</span></a></span><span>
</span><span id="line-127"></span><span>                          </span><span id="local-6989586621679260639"><span class="annot"><span class="annottext">Either
  (Either SomeException [SockAddr]) (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260639"><span class="hs-identifier hs-var">rd_e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
-&gt; Async m [SockAddr]
-&gt; m (Either
        (Either SomeException [SockAddr])
        (Either SomeException [SockAddr]))
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
Async m a
-&gt; Async m b
-&gt; m (Either (Either SomeException a) (Either SomeException b))
</span><span class="hs-identifier hs-var">waitEitherCatch</span></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260644"><span class="hs-identifier hs-var">aid_ipv6</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260641"><span class="hs-identifier hs-var">aid_ipv4</span></a></span><span>
</span><span id="line-128"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (Either SomeException [SockAddr]) (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260639"><span class="hs-identifier hs-var">rd_e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-129"></span><span>                            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260637"><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260637"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>                              </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv6First"><span class="hs-identifier hs-var">DnsTraceLookupIPv6First</span></a></span><span>
</span><span id="line-131"></span><span>                              </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260637"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(([SockAddr]
  -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260634"><span class="hs-identifier hs-var">threadTargetCycle</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260641"><span class="hs-identifier hs-var">aid_ipv4</span></a></span><span>
</span><span id="line-132"></span><span>                            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260633"><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260633"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>                              </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv4First"><span class="hs-identifier hs-var">DnsTraceLookupIPv4First</span></a></span><span>
</span><span id="line-134"></span><span>                              </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260633"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(([SockAddr]
  -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260634"><span class="hs-identifier hs-var">threadTargetCycle</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260644"><span class="hs-identifier hs-var">aid_ipv6</span></a></span><span>
</span><span id="line-135"></span><span>                 </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260646"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-136"></span><span>                   </span><span class="annot"><span class="annottext">Maybe (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>                     </span><span class="hs-comment">-- TODO: the thread timedout, we should trace it</span><span>
</span><span id="line-138"></span><span>                     </span><span class="annot"><span class="annottext">SubscriptionTarget m SockAddr -&gt; m (SubscriptionTarget m SockAddr)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
forall (m :: * -&gt; *) target.
m (Maybe (target, SubscriptionTarget m target))
-&gt; SubscriptionTarget m target
</span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-var">SubscriptionTarget</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
 -&gt; SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>                   </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679260630"><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
</span><a href="#local-6989586621679260630"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>                     </span><span class="annot"><span class="annottext">SubscriptionTarget m SockAddr -&gt; m (SubscriptionTarget m SockAddr)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
forall (m :: * -&gt; *) target.
m (Maybe (target, SubscriptionTarget m target))
-&gt; SubscriptionTarget m target
</span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-var">SubscriptionTarget</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
 -&gt; SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
</span><a href="#local-6989586621679260630"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- Creates a subscription target from an optional first socket and a tail</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="#local-6989586621679260629"><span class="hs-identifier hs-type">targetCons</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621679260629"><span class="annot"><span class="annottext">targetCons :: SockAddr
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260629"><span class="hs-identifier hs-var hs-var">targetCons</span></a></span></span><span> </span><span id="local-6989586621679260628"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260628"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621679260627"><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260627"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>      </span><span id="local-6989586621679260626"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679260626"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m s -&gt; BeforeConnect m s SockAddr -&gt; SockAddr -&gt; m Bool
forall (m :: * -&gt; *) s addr.
(MonadSTM m, MonadTime m) =&gt;
StrictTVar m s -&gt; BeforeConnect m s addr -&gt; addr -&gt; m Bool
</span><a href="Ouroboros.Network.Subscription.PeerState.html#runBeforeConnect"><span class="hs-identifier hs-var">runBeforeConnect</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m s
</span><a href="#local-6989586621679260662"><span class="hs-identifier hs-var">peerStatesVar</span></a></span><span> </span><span class="annot"><span class="annottext">BeforeConnect m s SockAddr
</span><a href="#local-6989586621679260661"><span class="hs-identifier hs-var">beforeConnect</span></a></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260628"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679260626"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SockAddr, SubscriptionTarget m SockAddr)
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; Maybe (SockAddr, SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SockAddr, SubscriptionTarget m SockAddr)
-&gt; Maybe (SockAddr, SubscriptionTarget m SockAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260628"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; SubscriptionTarget m SockAddr
forall (m :: * -&gt; *) target.
m (Maybe (target, SubscriptionTarget m target))
-&gt; SubscriptionTarget m target
</span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-var">SubscriptionTarget</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260627"><span class="hs-identifier hs-var">next</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260627"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-comment">-- Takes the result of a thread, returning an optional first socket in the subscription target result,</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-comment">-- then calls the given function to get the tail</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="#local-6989586621679260635"><span class="hs-identifier hs-type">handleThreadResult</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621679260635"><span class="annot"><span class="annottext">handleThreadResult :: Either SomeException [SockAddr]
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260635"><span class="hs-identifier hs-var hs-var">handleThreadResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260624"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260624"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679260623"><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260623"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupException"><span class="hs-identifier hs-var">DnsTraceLookupException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260624"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260623"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679260622"><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260622"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260622"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260621"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260621"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679260620"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260620"><span class="hs-identifier hs-var">addrs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679260619"><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260619"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260629"><span class="hs-identifier hs-var">targetCons</span></a></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260621"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260619"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260620"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- Called when a thread is still running, and the other finished already</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- Cycles between trying to get a result from the running thread, and the results of the finished thread</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- If results of the finished thread are exhausted, wait until the running thread completes</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="#local-6989586621679260634"><span class="hs-identifier hs-type">threadTargetCycle</span></a></span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-171"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621679260634"><span class="annot"><span class="annottext">threadTargetCycle :: Async m [SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260634"><span class="hs-identifier hs-var hs-var">threadTargetCycle</span></a></span></span><span> </span><span id="local-6989586621679260618"><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260618"><span class="hs-identifier hs-var">asyn</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>      </span><span id="local-6989586621679260617"><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260617"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr] -&gt; m (Either SomeException [SockAddr])
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
Async m a -&gt; m (Either SomeException a)
</span><span class="hs-identifier hs-var">waitCatch</span></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260618"><span class="hs-identifier hs-var">asyn</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260617"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">(([SockAddr]
  -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260615"><span class="hs-identifier hs-var">targetCycle</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621679260634"><span class="hs-identifier hs-var">threadTargetCycle</span></a></span><span> </span><span id="local-6989586621679260614"><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260614"><span class="hs-identifier hs-var">asyn</span></a></span></span><span> </span><span id="local-6989586621679260613"><span class="annot"><span class="annottext">a :: [SockAddr]
</span><a href="#local-6989586621679260613"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679260612"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260612"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621679260611"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260611"><span class="hs-identifier hs-var">addrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>      </span><span id="local-6989586621679260610"><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260610"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr] -&gt; m (Maybe (Either SomeException [SockAddr]))
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
Async m a -&gt; m (Maybe (Either SomeException a))
</span><span class="hs-identifier hs-var">poll</span></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260614"><span class="hs-identifier hs-var">asyn</span></a></span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260610"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>        </span><span class="hs-comment">-- The running thread finished, handle the result, then cycle over all results</span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679260608"><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260608"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260635"><span class="hs-identifier hs-var">handleThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException [SockAddr]
</span><a href="#local-6989586621679260608"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(([SockAddr]
  -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; ([SockAddr]
    -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260615"><span class="hs-identifier hs-var">targetCycle</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260613"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-comment">-- The running thread is still going, emit an address of the finished thread, then check again</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr])
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SockAddr
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260629"><span class="hs-identifier hs-var">targetCons</span></a></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260612"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
 -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr)))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260634"><span class="hs-identifier hs-var">threadTargetCycle</span></a></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260614"><span class="hs-identifier hs-var">asyn</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260611"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">-- Called when both threads exited and we know the results of both.</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- Returns a subscription target that cycles between the results until both results are exhausted</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><a href="#local-6989586621679260615"><span class="hs-identifier hs-type">targetCycle</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679260615"><span class="annot"><span class="annottext">targetCycle :: [SockAddr]
-&gt; [SockAddr]
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260615"><span class="hs-identifier hs-var hs-var">targetCycle</span></a></span></span><span> </span><span id="local-6989586621679260607"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260607"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679260606"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260606"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260605"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260607"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; [SockAddr] -&gt; [SockAddr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679260604"><span class="hs-operator hs-var">`interleave`</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260606"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>        </span><span id="local-6989586621679260605"><span class="annot"><span class="annottext">go :: [SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260605"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SockAddr, SubscriptionTarget m SockAddr)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><a href="#local-6989586621679260605"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260603"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260603"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621679260602"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260602"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
-&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260629"><span class="hs-identifier hs-var">targetCons</span></a></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679260603"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SockAddr] -&gt; m (Maybe (SockAddr, SubscriptionTarget m SockAddr))
</span><a href="#local-6989586621679260605"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260602"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>        </span><span id="local-6989586621679260604"><span class="annot"><span class="annottext">interleave :: [a] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679260604"><span class="hs-identifier hs-var hs-var">interleave</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span id="local-6989586621679260601"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260601"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260601"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><a href="#local-6989586621679260604"><span class="hs-identifier hs-var">interleave</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679260600"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679260600"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621679260599"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260599"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679260598"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260598"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679260600"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621679260604"><span class="hs-identifier hs-var">interleave</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260598"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679260599"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="#local-6989586621679260642"><span class="hs-identifier hs-type">resolveAAAA</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-198"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621679260642"><span class="annot"><span class="annottext">resolveAAAA :: Resolver m -&gt; m [SockAddr]
</span><a href="#local-6989586621679260642"><span class="hs-identifier hs-var hs-var">resolveAAAA</span></a></span></span><span> </span><span id="local-6989586621679260597"><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260597"><span class="hs-identifier hs-var">resolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621679260596"><span class="annot"><span class="annottext">Either DNSError [SockAddr]
</span><a href="#local-6989586621679260596"><span class="hs-identifier hs-var">r_e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
forall (m :: * -&gt; *).
Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
</span><a href="Ouroboros.Network.Subscription.Dns.html#lookupAAAA"><span class="hs-identifier hs-var hs-var">lookupAAAA</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260597"><span class="hs-identifier hs-var">resolver</span></a></span><span> </span><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260660"><span class="hs-identifier hs-var">domain</span></a></span><span>
</span><span id="line-201"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr]
</span><a href="#local-6989586621679260596"><span class="hs-identifier hs-var">r_e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-202"></span><span>             </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260595"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260595"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>                 </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAError"><span class="hs-identifier hs-var">DnsTraceLookupAAAAError</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260595"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-204"></span><span>                 </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m [SockAddr]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-205"></span><span>             </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260593"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260593"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>                 </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAResult"><span class="hs-identifier hs-var">DnsTraceLookupAAAAResult</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260593"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>                 </span><span class="hs-comment">-- XXX Addresses should be sorted here based on DeltaQueue.</span><span>
</span><span id="line-209"></span><span>                 </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m [SockAddr]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260593"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="#local-6989586621679260640"><span class="hs-identifier hs-type">resolveA</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-212"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679260735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621679260640"><span class="annot"><span class="annottext">resolveA :: Resolver m -&gt; Async m [SockAddr] -&gt; m [SockAddr]
</span><a href="#local-6989586621679260640"><span class="hs-identifier hs-var hs-var">resolveA</span></a></span></span><span> </span><span id="local-6989586621679260591"><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260591"><span class="hs-identifier hs-var">resolver</span></a></span></span><span> </span><span id="local-6989586621679260590"><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260590"><span class="hs-identifier hs-var">aid_ipv6</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679260589"><span class="annot"><span class="annottext">Either DNSError [SockAddr]
</span><a href="#local-6989586621679260589"><span class="hs-identifier hs-var">r_e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
forall (m :: * -&gt; *).
Resolver m -&gt; Domain -&gt; m (Either DNSError [SockAddr])
</span><a href="Ouroboros.Network.Subscription.Dns.html#lookupA"><span class="hs-identifier hs-var hs-var">lookupA</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver m
</span><a href="#local-6989586621679260591"><span class="hs-identifier hs-var">resolver</span></a></span><span> </span><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260660"><span class="hs-identifier hs-var">domain</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either DNSError [SockAddr]
</span><a href="#local-6989586621679260589"><span class="hs-identifier hs-var">r_e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-217"></span><span>             </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679260588"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260588"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>                 </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAError"><span class="hs-identifier hs-var">DnsTraceLookupAError</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260588"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-219"></span><span>                 </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m [SockAddr]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-220"></span><span>             </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679260586"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260586"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>                 </span><span class="annot"><span class="annottext">Tracer m DnsTrace -&gt; DnsTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m DnsTrace
</span><a href="#local-6989586621679260665"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; m ()) -&gt; DnsTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAResult"><span class="hs-identifier hs-var">DnsTraceLookupAResult</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260586"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>                 </span><span class="hs-comment">{- From RFC8305.
                  - If a positive A response is received first due to reordering, the client
                  - SHOULD wait a short time for the AAAA response to ensure that preference is
                  - given to IPv6.
                  -}</span><span>
</span><span id="line-228"></span><span>                 </span><span id="local-6989586621679260584"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679260584"><span class="hs-identifier hs-var">timeoutVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; m (TVar m Bool)
forall (m :: * -&gt; *). MonadTimer m =&gt; DiffTime -&gt; m (TVar m Bool)
</span><span class="hs-identifier hs-var">registerDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Subscription.Dns.html#resolutionDelay"><span class="hs-identifier hs-var">resolutionDelay</span></a></span><span>
</span><span id="line-229"></span><span>                 </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>                     </span><span id="local-6989586621679260581"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679260581"><span class="hs-identifier hs-var">timedOut</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">Lazy.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679260584"><span class="hs-identifier hs-var">timeoutVar</span></a></span><span>
</span><span id="line-231"></span><span>                     </span><span id="local-6989586621679260579"><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260579"><span class="hs-identifier hs-var">ipv6Done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
-&gt; STM m (Maybe (Either SomeException [SockAddr]))
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
Async m a -&gt; STM m (Maybe (Either SomeException a))
</span><span class="hs-identifier hs-var">pollSTM</span></span><span> </span><span class="annot"><span class="annottext">Async m [SockAddr]
</span><a href="#local-6989586621679260590"><span class="hs-identifier hs-var">aid_ipv6</span></a></span><span>
</span><span id="line-232"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679260581"><span class="hs-identifier hs-var">timedOut</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr]) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Either SomeException [SockAddr])
</span><a href="#local-6989586621679260579"><span class="hs-identifier hs-var">ipv6Done</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>                 </span><span class="hs-comment">-- XXX Addresses should be sorted here based on DeltaQueue.</span><span>
</span><span id="line-235"></span><span>                 </span><span class="annot"><span class="annottext">[SockAddr] -&gt; m [SockAddr]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260586"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span id="local-6989586621679260726"><span id="local-6989586621679260727"><span id="local-6989586621679260728"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker%27"><span class="hs-identifier hs-type">dnsSubscriptionWorker'</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.Socket</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier hs-type">DnsTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Socket.html#NetworkMutableState"><span class="hs-identifier hs-type">NetworkMutableState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260728"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679260728"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionParams"><span class="hs-identifier hs-type">DnsSubscriptionParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260727"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Worker.html#Main"><span class="hs-identifier hs-type">Main</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.PeerState.html#PeerStates"><span class="hs-identifier hs-type">PeerStates</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679260726"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.Socket</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260727"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260726"><span class="hs-identifier hs-type">x</span></a></span></span></span></span><span>
</span><span id="line-251"></span><span id="dnsSubscriptionWorker%27"><span class="annot"><span class="annottext">dnsSubscriptionWorker' :: Snocket IO Socket SockAddr
-&gt; Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (WithDomainName DnsTrace)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; IO b
-&gt; (b
    -&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
    -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; DnsSubscriptionParams a
-&gt; Main IO (PeerStates IO SockAddr) x
-&gt; (Socket -&gt; IO a)
-&gt; IO x
</span><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker%27"><span class="hs-identifier hs-var hs-var">dnsSubscriptionWorker'</span></a></span></span><span> </span><span id="local-6989586621679260575"><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
</span><a href="#local-6989586621679260575"><span class="hs-identifier hs-var">snocket</span></a></span></span><span> </span><span id="local-6989586621679260574"><span class="annot"><span class="annottext">Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
</span><a href="#local-6989586621679260574"><span class="hs-identifier hs-var">subTracer</span></a></span></span><span> </span><span id="local-6989586621679260573"><span class="annot"><span class="annottext">Tracer IO (WithDomainName DnsTrace)
</span><a href="#local-6989586621679260573"><span class="hs-identifier hs-var">dnsTracer</span></a></span></span><span> </span><span id="local-6989586621679260572"><span class="annot"><span class="annottext">Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
</span><a href="#local-6989586621679260572"><span class="hs-identifier hs-var">errorPolicyTracer</span></a></span></span><span>
</span><span id="line-252"></span><span>                       </span><span id="local-6989586621679260571"><span class="annot"><span class="annottext">networkState :: NetworkMutableState SockAddr
</span><a href="#local-6989586621679260571"><span class="hs-identifier hs-var">networkState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.Socket.html#NetworkMutableState"><span class="hs-identifier hs-type">NetworkMutableState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679260569"><span class="annot"><span class="annottext">StrictTVar IO (PeerStates IO SockAddr)
nmsPeerStates :: forall addr.
NetworkMutableState addr -&gt; StrictTVar IO (PeerStates IO addr)
nmsPeerStates :: StrictTVar IO (PeerStates IO SockAddr)
</span><a href="Ouroboros.Network.Socket.html#nmsPeerStates"><span class="hs-identifier hs-var hs-var">nmsPeerStates</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-253"></span><span>                       </span><span id="local-6989586621679260567"><span class="annot"><span class="annottext">IO b
</span><a href="#local-6989586621679260567"><span class="hs-identifier hs-var">setupResolver</span></a></span></span><span> </span><span id="local-6989586621679260566"><span class="annot"><span class="annottext">b
-&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; IO (SubscriptionTarget IO SockAddr)
</span><a href="#local-6989586621679260566"><span class="hs-identifier hs-var">resolver</span></a></span></span><span>
</span><span id="line-254"></span><span>                       </span><span class="annot"><a href="Ouroboros.Network.Subscription.Ip.html#SubscriptionParams"><span class="hs-identifier hs-type">SubscriptionParams</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679260564"><span class="annot"><span class="annottext">LocalAddresses SockAddr
spLocalAddresses :: forall a target.
SubscriptionParams a target -&gt; LocalAddresses SockAddr
spLocalAddresses :: LocalAddresses SockAddr
</span><a href="Ouroboros.Network.Subscription.Ip.html#spLocalAddresses"><span class="hs-identifier hs-var hs-var">spLocalAddresses</span></a></span></span><span>
</span><span id="line-255"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679260562"><span class="annot"><span class="annottext">SockAddr -&gt; Maybe DiffTime
spConnectionAttemptDelay :: forall a target.
SubscriptionParams a target -&gt; SockAddr -&gt; Maybe DiffTime
spConnectionAttemptDelay :: SockAddr -&gt; Maybe DiffTime
</span><a href="Ouroboros.Network.Subscription.Ip.html#spConnectionAttemptDelay"><span class="hs-identifier hs-var hs-var">spConnectionAttemptDelay</span></a></span></span><span>
</span><span id="line-256"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">spSubscriptionTarget :: forall a target. SubscriptionParams a target -&gt; target
</span><a href="Ouroboros.Network.Subscription.Ip.html#spSubscriptionTarget"><span class="hs-identifier hs-var">spSubscriptionTarget</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679260559"><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260559"><span class="hs-identifier hs-var">dst</span></a></span></span><span>
</span><span id="line-257"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679260558"><span class="annot"><span class="annottext">ErrorPolicies
spErrorPolicies :: forall a target. SubscriptionParams a target -&gt; ErrorPolicies
spErrorPolicies :: ErrorPolicies
</span><a href="Ouroboros.Network.Subscription.Ip.html#spErrorPolicies"><span class="hs-identifier hs-var hs-var">spErrorPolicies</span></a></span></span><span>
</span><span id="line-258"></span><span>                                          </span><span class="hs-special">}</span><span>
</span><span id="line-259"></span><span>                       </span><span id="local-6989586621679260556"><span class="annot"><span class="annottext">Main IO (PeerStates IO SockAddr) x
</span><a href="#local-6989586621679260556"><span class="hs-identifier hs-var">main</span></a></span></span><span> </span><span id="local-6989586621679260555"><span class="annot"><span class="annottext">Socket -&gt; IO a
</span><a href="#local-6989586621679260555"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
-&gt; Tracer IO (SubscriptionTrace SockAddr)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; WorkerParams IO LocalAddresses SockAddr
-&gt; ErrorPolicies
-&gt; Main IO (PeerStates IO SockAddr) x
-&gt; (Socket -&gt; IO a)
-&gt; IO x
forall x a.
Snocket IO Socket SockAddr
-&gt; Tracer IO (SubscriptionTrace SockAddr)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; WorkerParams IO LocalAddresses SockAddr
-&gt; ErrorPolicies
-&gt; Main IO (PeerStates IO SockAddr) x
-&gt; (Socket -&gt; IO a)
-&gt; IO x
</span><a href="Ouroboros.Network.Subscription.Ip.html#subscriptionWorker"><span class="hs-identifier hs-var">subscriptionWorker</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
</span><a href="#local-6989586621679260575"><span class="hs-identifier hs-var">snocket</span></a></span><span>
</span><span id="line-261"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Domain
-&gt; SubscriptionTrace SockAddr
-&gt; WithDomainName (SubscriptionTrace SockAddr)
forall a. Domain -&gt; a -&gt; WithDomainName a
</span><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-var">WithDomainName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; Domain
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstDomain"><span class="hs-identifier hs-var hs-var">dstDomain</span></a></span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260559"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SubscriptionTrace SockAddr
 -&gt; WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (SubscriptionTrace SockAddr)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
</span><a href="#local-6989586621679260574"><span class="hs-identifier hs-var">subTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                       </span><span class="annot"><span class="annottext">Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
</span><a href="#local-6989586621679260572"><span class="hs-identifier hs-var">errorPolicyTracer</span></a></span><span>
</span><span id="line-263"></span><span>                       </span><span class="annot"><span class="annottext">NetworkMutableState SockAddr
</span><a href="#local-6989586621679260571"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-264"></span><span>                       </span><span class="annot"><span class="annottext">WorkerParams :: forall (m :: * -&gt; *) (localAddrs :: * -&gt; *) addr.
localAddrs addr
-&gt; (addr -&gt; localAddrs addr -&gt; Maybe addr)
-&gt; (addr -&gt; Maybe DiffTime)
-&gt; m (SubscriptionTarget m addr)
-&gt; Int
-&gt; WorkerParams m localAddrs addr
</span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier hs-type">WorkerParams</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wpLocalAddresses :: LocalAddresses SockAddr
</span><a href="Ouroboros.Network.Subscription.Worker.html#wpLocalAddresses"><span class="hs-identifier hs-var">wpLocalAddresses</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalAddresses SockAddr
</span><a href="#local-6989586621679260564"><span class="hs-identifier hs-var">spLocalAddresses</span></a></span><span>
</span><span id="line-265"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wpConnectionAttemptDelay :: SockAddr -&gt; Maybe DiffTime
</span><a href="Ouroboros.Network.Subscription.Worker.html#wpConnectionAttemptDelay"><span class="hs-identifier hs-var">wpConnectionAttemptDelay</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; Maybe DiffTime
</span><a href="#local-6989586621679260562"><span class="hs-identifier hs-var">spConnectionAttemptDelay</span></a></span><span>
</span><span id="line-266"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wpSubscriptionTarget :: IO (SubscriptionTarget IO SockAddr)
</span><a href="Ouroboros.Network.Subscription.Worker.html#wpSubscriptionTarget"><span class="hs-identifier hs-var">wpSubscriptionTarget</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>                                        </span><span class="annot"><span class="annottext">Tracer IO DnsTrace
-&gt; IO b
-&gt; (b
    -&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
    -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; StrictTVar IO (PeerStates IO SockAddr)
-&gt; BeforeConnect IO (PeerStates IO SockAddr) SockAddr
-&gt; DnsSubscriptionTarget
-&gt; IO (SubscriptionTarget IO SockAddr)
forall a (m :: * -&gt; *) s.
(MonadAsync m, MonadCatch m, MonadTime m, MonadTimer m) =&gt;
Tracer m DnsTrace
-&gt; m a
-&gt; (a
    -&gt; (Resolver m -&gt; m (SubscriptionTarget m SockAddr))
    -&gt; m (SubscriptionTarget m SockAddr))
-&gt; StrictTVar m s
-&gt; BeforeConnect m s SockAddr
-&gt; DnsSubscriptionTarget
-&gt; m (SubscriptionTarget m SockAddr)
</span><a href="Ouroboros.Network.Subscription.Dns.html#dnsResolve"><span class="hs-identifier hs-var">dnsResolve</span></a></span><span>
</span><span id="line-268"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Domain -&gt; DnsTrace -&gt; WithDomainName DnsTrace
forall a. Domain -&gt; a -&gt; WithDomainName a
</span><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-var">WithDomainName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; Domain
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstDomain"><span class="hs-identifier hs-var hs-var">dstDomain</span></a></span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260559"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DnsTrace -&gt; WithDomainName DnsTrace)
-&gt; Tracer IO (WithDomainName DnsTrace) -&gt; Tracer IO DnsTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (WithDomainName DnsTrace)
</span><a href="#local-6989586621679260573"><span class="hs-identifier hs-var">dnsTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>                                          </span><span class="annot"><span class="annottext">IO b
</span><a href="#local-6989586621679260567"><span class="hs-identifier hs-var">setupResolver</span></a></span><span> </span><span class="annot"><span class="annottext">b
-&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; IO (SubscriptionTarget IO SockAddr)
</span><a href="#local-6989586621679260566"><span class="hs-identifier hs-var">resolver</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar IO (PeerStates IO SockAddr)
</span><a href="#local-6989586621679260569"><span class="hs-identifier hs-var">nmsPeerStates</span></a></span><span> </span><span class="annot"><span class="annottext">BeforeConnect IO (PeerStates IO SockAddr) SockAddr
forall (m :: * -&gt; *) addr.
(MonadSTM m, Ord addr) =&gt;
BeforeConnect m (PeerStates m addr) addr
</span><a href="Ouroboros.Network.Subscription.PeerState.html#beforeConnectTx"><span class="hs-identifier hs-var">beforeConnectTx</span></a></span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260559"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-270"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wpValency :: Int
</span><a href="Ouroboros.Network.Subscription.Worker.html#wpValency"><span class="hs-identifier hs-var">wpValency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; Int
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstValency"><span class="hs-identifier hs-var hs-var">dstValency</span></a></span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260559"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-271"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wpSelectAddress :: SockAddr -&gt; LocalAddresses SockAddr -&gt; Maybe SockAddr
</span><a href="Ouroboros.Network.Subscription.Worker.html#wpSelectAddress"><span class="hs-identifier hs-var">wpSelectAddress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; LocalAddresses SockAddr -&gt; Maybe SockAddr
</span><a href="Ouroboros.Network.Subscription.Ip.html#selectSockAddr"><span class="hs-identifier hs-var">selectSockAddr</span></a></span><span>
</span><span id="line-272"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-273"></span><span>                       </span><span class="annot"><span class="annottext">ErrorPolicies
</span><a href="#local-6989586621679260558"><span class="hs-identifier hs-var">spErrorPolicies</span></a></span><span>
</span><span id="line-274"></span><span>                       </span><span class="annot"><span class="annottext">Main IO (PeerStates IO SockAddr) x
</span><a href="#local-6989586621679260556"><span class="hs-identifier hs-var">main</span></a></span><span>
</span><span id="line-275"></span><span>                       </span><span class="annot"><span class="annottext">Socket -&gt; IO a
</span><a href="#local-6989586621679260555"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-keyword">type</span><span> </span><span id="DnsSubscriptionParams"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionParams"><span class="hs-identifier hs-var">DnsSubscriptionParams</span></a></span></span><span> </span><span id="local-6989586621679260543"><span class="annot"><a href="#local-6989586621679260543"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Ip.html#SubscriptionParams"><span class="hs-identifier hs-type">SubscriptionParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260543"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionTarget"><span class="hs-identifier hs-type">DnsSubscriptionTarget</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span id="local-6989586621679260542"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker"><span class="hs-identifier hs-type">dnsSubscriptionWorker</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.Socket</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier hs-type">DnsTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Socket.html#NetworkMutableState"><span class="hs-identifier hs-type">NetworkMutableState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsSubscriptionParams"><span class="hs-identifier hs-type">DnsSubscriptionParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260542"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Socket.Socket</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260542"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span></span><span>
</span><span id="line-289"></span><span id="dnsSubscriptionWorker"><span class="annot"><span class="annottext">dnsSubscriptionWorker :: Snocket IO Socket SockAddr
-&gt; Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (WithDomainName DnsTrace)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; DnsSubscriptionParams a
-&gt; (Socket -&gt; IO a)
-&gt; IO Void
</span><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker"><span class="hs-identifier hs-var hs-var">dnsSubscriptionWorker</span></a></span></span><span> </span><span id="local-6989586621679260541"><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
</span><a href="#local-6989586621679260541"><span class="hs-identifier hs-var">snocket</span></a></span></span><span> </span><span id="local-6989586621679260540"><span class="annot"><span class="annottext">Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
</span><a href="#local-6989586621679260540"><span class="hs-identifier hs-var">subTracer</span></a></span></span><span> </span><span id="local-6989586621679260539"><span class="annot"><span class="annottext">Tracer IO (WithDomainName DnsTrace)
</span><a href="#local-6989586621679260539"><span class="hs-identifier hs-var">dnsTracer</span></a></span></span><span> </span><span id="local-6989586621679260538"><span class="annot"><span class="annottext">Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
</span><a href="#local-6989586621679260538"><span class="hs-identifier hs-var">errTrace</span></a></span></span><span> </span><span id="local-6989586621679260537"><span class="annot"><span class="annottext">NetworkMutableState SockAddr
</span><a href="#local-6989586621679260537"><span class="hs-identifier hs-var">networkState</span></a></span></span><span>
</span><span id="line-290"></span><span>                      </span><span id="local-6989586621679260536"><span class="annot"><span class="annottext">params :: DnsSubscriptionParams a
</span><a href="#local-6989586621679260536"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.Subscription.Ip.html#SubscriptionParams"><span class="hs-identifier hs-type">SubscriptionParams</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679260535"><span class="annot"><span class="annottext">DnsSubscriptionTarget
spSubscriptionTarget :: DnsSubscriptionTarget
spSubscriptionTarget :: forall a target. SubscriptionParams a target -&gt; target
</span><a href="#local-6989586621679260535"><span class="hs-identifier hs-var hs-var">spSubscriptionTarget</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679260534"><span class="annot"><span class="annottext">Socket -&gt; IO a
</span><a href="#local-6989586621679260534"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-291"></span><span>   </span><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
-&gt; Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (WithDomainName DnsTrace)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; IO ResolvSeed
-&gt; (ResolvSeed
    -&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
    -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; DnsSubscriptionParams a
-&gt; Main IO (PeerStates IO SockAddr) Void
-&gt; (Socket -&gt; IO a)
-&gt; IO Void
forall b a x.
Snocket IO Socket SockAddr
-&gt; Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
-&gt; Tracer IO (WithDomainName DnsTrace)
-&gt; Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
-&gt; NetworkMutableState SockAddr
-&gt; IO b
-&gt; (b
    -&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
    -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; DnsSubscriptionParams a
-&gt; Main IO (PeerStates IO SockAddr) x
-&gt; (Socket -&gt; IO a)
-&gt; IO x
</span><a href="Ouroboros.Network.Subscription.Dns.html#dnsSubscriptionWorker%27"><span class="hs-identifier hs-var">dnsSubscriptionWorker'</span></a></span><span>
</span><span id="line-292"></span><span>       </span><span class="annot"><span class="annottext">Snocket IO Socket SockAddr
</span><a href="#local-6989586621679260541"><span class="hs-identifier hs-var">snocket</span></a></span><span>
</span><span id="line-293"></span><span>       </span><span class="annot"><span class="annottext">Tracer IO (WithDomainName (SubscriptionTrace SockAddr))
</span><a href="#local-6989586621679260540"><span class="hs-identifier hs-var">subTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (WithDomainName DnsTrace)
</span><a href="#local-6989586621679260539"><span class="hs-identifier hs-var">dnsTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (WithAddr SockAddr ErrorPolicyTrace)
</span><a href="#local-6989586621679260538"><span class="hs-identifier hs-var">errTrace</span></a></span><span>
</span><span id="line-294"></span><span>       </span><span class="annot"><span class="annottext">NetworkMutableState SockAddr
</span><a href="#local-6989586621679260537"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-295"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolvConf -&gt; IO ResolvSeed
</span><span class="hs-identifier hs-var">DNS.makeResolvSeed</span></span><span> </span><span class="annot"><span class="annottext">ResolvConf
</span><span class="hs-identifier hs-var">DNS.defaultResolvConf</span></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber
-&gt; ResolvSeed
-&gt; (Resolver IO -&gt; IO (SubscriptionTarget IO SockAddr))
-&gt; IO (SubscriptionTarget IO SockAddr)
forall a. PortNumber -&gt; ResolvSeed -&gt; (Resolver IO -&gt; IO a) -&gt; IO a
</span><a href="Ouroboros.Network.Subscription.Dns.html#withResolver"><span class="hs-identifier hs-var">withResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DnsSubscriptionTarget -&gt; PortNumber
</span><a href="Ouroboros.Network.Subscription.Dns.html#dstPort"><span class="hs-identifier hs-var hs-var">dstPort</span></a></span><span> </span><span class="annot"><span class="annottext">DnsSubscriptionTarget
</span><a href="#local-6989586621679260535"><span class="hs-identifier hs-var">spSubscriptionTarget</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>       </span><span class="annot"><span class="annottext">DnsSubscriptionParams a
</span><a href="#local-6989586621679260536"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-298"></span><span>       </span><span class="annot"><span class="annottext">Main IO (PeerStates IO SockAddr) Void
forall (m :: * -&gt; *) addr.
(MonadThrow (STM m), MonadSTM m) =&gt;
Main m (PeerStates m addr) Void
</span><a href="Ouroboros.Network.Subscription.Ip.html#mainTx"><span class="hs-identifier hs-var">mainTx</span></a></span><span>
</span><span id="line-299"></span><span>       </span><span class="annot"><span class="annottext">Socket -&gt; IO a
</span><a href="#local-6989586621679260534"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-keyword">data</span><span> </span><span id="WithDomainName"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-var">WithDomainName</span></a></span></span><span> </span><span id="local-6989586621679260743"><span class="annot"><a href="#local-6989586621679260743"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WithDomainName"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-var">WithDomainName</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-302"></span><span>      </span><span id="wdnDomain"><span class="annot"><span class="annottext">WithDomainName a -&gt; Domain
</span><a href="Ouroboros.Network.Subscription.Dns.html#wdnDomain"><span class="hs-identifier hs-var hs-var">wdnDomain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.Domain</span></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="wdnEvent"><span class="annot"><span class="annottext">WithDomainName a -&gt; a
</span><a href="Ouroboros.Network.Subscription.Dns.html#wdnEvent"><span class="hs-identifier hs-var hs-var">wdnEvent</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679260743"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span id="local-6989586621679260528"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679260523"><span id="local-6989586621679260526"><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260528"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679260528"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621679260522"><span class="annot"><span class="annottext">show :: WithDomainName a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#WithDomainName"><span class="hs-identifier hs-type">WithDomainName</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679260520"><span class="annot"><span class="annottext">Domain
wdnDomain :: Domain
wdnDomain :: forall a. WithDomainName a -&gt; Domain
</span><a href="#local-6989586621679260520"><span class="hs-identifier hs-var hs-var">wdnDomain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679260519"><span class="annot"><span class="annottext">a
wdnEvent :: a
wdnEvent :: forall a. WithDomainName a -&gt; a
</span><a href="#local-6989586621679260519"><span class="hs-identifier hs-var hs-var">wdnEvent</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; ShowS
forall r. PrintfType r =&gt; String -&gt; r
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">printf</span></a></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Domain: %s %s&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Domain -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Domain
</span><a href="#local-6989586621679260520"><span class="hs-identifier hs-var">wdnDomain</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679260519"><span class="hs-identifier hs-var">wdnEvent</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-keyword">data</span><span> </span><span id="DnsTrace"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier hs-var">DnsTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-310"></span><span>      </span><span id="DnsTraceLookupException"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupException"><span class="hs-identifier hs-var">DnsTraceLookupException</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupAError"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAError"><span class="hs-identifier hs-var">DnsTraceLookupAError</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.DNSError</span></span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupAAAAError"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAError"><span class="hs-identifier hs-var">DnsTraceLookupAAAAError</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DNS.DNSError</span></span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupIPv6First"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv6First"><span class="hs-identifier hs-var">DnsTraceLookupIPv6First</span></a></span></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupIPv4First"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv4First"><span class="hs-identifier hs-var">DnsTraceLookupIPv4First</span></a></span></span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupAResult"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAResult"><span class="hs-identifier hs-var">DnsTraceLookupAResult</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DnsTraceLookupAAAAResult"><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAResult"><span class="hs-identifier hs-var">DnsTraceLookupAAAAResult</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679260513"><span id="local-6989586621679260516"><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTrace"><span class="hs-identifier hs-type">DnsTrace</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621679260512"><span class="annot"><span class="annottext">show :: DnsTrace -&gt; String
</span><a href="#local-6989586621679260512"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupException"><span class="hs-identifier hs-type">DnsTraceLookupException</span></a></span><span> </span><span id="local-6989586621679260511"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260511"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookup exception &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679260511"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAError"><span class="hs-identifier hs-type">DnsTraceLookupAError</span></a></span><span> </span><span id="local-6989586621679260510"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260510"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;A lookup failed with &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260510"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAError"><span class="hs-identifier hs-type">DnsTraceLookupAAAAError</span></a></span><span> </span><span id="local-6989586621679260509"><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260509"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;AAAA lookup failed with &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DNSError
</span><a href="#local-6989586621679260509"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv4First"><span class="hs-identifier hs-var">DnsTraceLookupIPv4First</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Returning IPv4 address first&quot;</span></span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DnsTrace
</span><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupIPv6First"><span class="hs-identifier hs-var">DnsTraceLookupIPv6First</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Returning IPv6 address first&quot;</span></span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAResult"><span class="hs-identifier hs-type">DnsTraceLookupAResult</span></a></span><span> </span><span id="local-6989586621679260508"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260508"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lookup A result: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260508"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Subscription.Dns.html#DnsTraceLookupAAAAResult"><span class="hs-identifier hs-type">DnsTraceLookupAAAAResult</span></a></span><span> </span><span id="local-6989586621679260507"><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260507"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lookup AAAAA result: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">[SockAddr]
</span><a href="#local-6989586621679260507"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-326"></span></pre></body></html>