<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="%24con2tag_3uLrXGuZzeZDRRg12Iz1l4"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Rage limiting of accepted connections</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Server.RateLimiting</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier">AcceptedConnectionsLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#runConnectionRateLimits"><span class="hs-identifier">runConnectionRateLimits</span></a></span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Tracing</span></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier">AcceptConnectionsPolicyTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Text.Printf</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-comment">-- | Policy which governs how to limit the number of accepted connections.</span><span>
</span><span id="line-24"></span><span class="hs-comment">--</span><span>
</span><span id="line-25"></span><span class="hs-keyword">data</span><span> </span><span id="AcceptedConnectionsLimit"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-var">AcceptedConnectionsLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AcceptedConnectionsLimit"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-var">AcceptedConnectionsLimit</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-comment">-- | Hard limit of accepted connections.</span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-29"></span><span>    </span><span id="acceptedConnectionsHardLimit"><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsHardLimit"><span class="hs-identifier hs-var hs-var">acceptedConnectionsHardLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-comment">-- | Soft limit of accepted connections.  If we are above this threshold,</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-comment">-- we will start rate limiting.</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-34"></span><span>    </span><span id="acceptedConnectionsSoftLimit"><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsSoftLimit"><span class="hs-identifier hs-var hs-var">acceptedConnectionsSoftLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-comment">-- | Max delay for limiting accepted connections.  We use linear</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-comment">-- regression starting from 0 at the soft limit up to</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-comment">-- `acceptedConnectionDelay` at the hard limit.</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-40"></span><span>    </span><span id="acceptedConnectionsDelay"><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; DiffTime
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsDelay"><span class="hs-identifier hs-var hs-var">acceptedConnectionsDelay</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679254710"><span id="local-6989586621679254712"><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
(AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; (AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; Eq AcceptedConnectionsLimit
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c/= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
== :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c== :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679254694"><span id="local-6989586621679254696"><span id="local-6989586621679254698"><span id="local-6989586621679254700"><span id="local-6989586621679254702"><span id="local-6989586621679254704"><span id="local-6989586621679254706"><span class="annot"><span class="annottext">Eq AcceptedConnectionsLimit
Eq AcceptedConnectionsLimit
-&gt; (AcceptedConnectionsLimit
    -&gt; AcceptedConnectionsLimit -&gt; Ordering)
-&gt; (AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; (AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; (AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; (AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool)
-&gt; (AcceptedConnectionsLimit
    -&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit)
-&gt; (AcceptedConnectionsLimit
    -&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit)
-&gt; Ord AcceptedConnectionsLimit
AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Ordering
AcceptedConnectionsLimit
-&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: AcceptedConnectionsLimit
-&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit
$cmin :: AcceptedConnectionsLimit
-&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit
max :: AcceptedConnectionsLimit
-&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit
$cmax :: AcceptedConnectionsLimit
-&gt; AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit
&gt;= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c&gt;= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
&gt; :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c&gt; :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
&lt;= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c&lt;= :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
&lt; :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
$c&lt; :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Bool
compare :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Ordering
$ccompare :: AcceptedConnectionsLimit -&gt; AcceptedConnectionsLimit -&gt; Ordering
$cp1Ord :: Eq AcceptedConnectionsLimit
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679254687"><span id="local-6989586621679254689"><span id="local-6989586621679254691"><span class="annot"><span class="annottext">Int -&gt; AcceptedConnectionsLimit -&gt; ShowS
[AcceptedConnectionsLimit] -&gt; ShowS
AcceptedConnectionsLimit -&gt; String
(Int -&gt; AcceptedConnectionsLimit -&gt; ShowS)
-&gt; (AcceptedConnectionsLimit -&gt; String)
-&gt; ([AcceptedConnectionsLimit] -&gt; ShowS)
-&gt; Show AcceptedConnectionsLimit
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [AcceptedConnectionsLimit] -&gt; ShowS
$cshowList :: [AcceptedConnectionsLimit] -&gt; ShowS
show :: AcceptedConnectionsLimit -&gt; String
$cshow :: AcceptedConnectionsLimit -&gt; String
showsPrec :: Int -&gt; AcceptedConnectionsLimit -&gt; ShowS
$cshowsPrec :: Int -&gt; AcceptedConnectionsLimit -&gt; ShowS
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-comment">-- | Rate limiting instruction.</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span class="hs-keyword">data</span><span> </span><span id="RateLimitDelay"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#RateLimitDelay"><span class="hs-identifier hs-var">RateLimitDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-48"></span><span>      </span><span class="hs-comment">-- | no rate limiting</span><span>
</span><span id="line-49"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-50"></span><span>      </span><span id="NoRateLimiting"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#NoRateLimiting"><span class="hs-identifier hs-var">NoRateLimiting</span></a></span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span>      </span><span class="hs-comment">-- | We are above the soft limit, we delay accepting the next connection&gt;</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SoftDelay"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#SoftDelay"><span class="hs-identifier hs-var">SoftDelay</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-comment">-- | We are above the hard limit, wait until the number of connections</span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-comment">-- drops below the given threshold (currently this is the hard limit,</span><span>
</span><span id="line-57"></span><span>      </span><span class="hs-comment">-- which means we keep `acceptedConnectionsHardLimit` number of</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-comment">-- connections, later we c could be configured to something between</span><span>
</span><span id="line-59"></span><span>      </span><span class="hs-comment">-- `acceptedConnesiontSoftLimit` and `acceptedConnectionsHardLimit`).</span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="HardLimit"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#HardLimit"><span class="hs-identifier hs-var">HardLimit</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- | Interpretation of the 'AcceptedConnectionsLimit' policy.</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#getRateLimitDecision"><span class="hs-identifier hs-type">getRateLimitDecision</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-67"></span><span>                     </span><span class="hs-comment">-- ^ number of served concurrent connections</span><span>
</span><span id="line-68"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span>
</span><span id="line-69"></span><span>                     </span><span class="hs-comment">-- ^ limits</span><span>
</span><span id="line-70"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#RateLimitDelay"><span class="hs-identifier hs-type">RateLimitDelay</span></a></span><span>
</span><span id="line-71"></span><span id="getRateLimitDecision"><span class="annot"><span class="annottext">getRateLimitDecision :: Int -&gt; AcceptedConnectionsLimit -&gt; RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#getRateLimitDecision"><span class="hs-identifier hs-var hs-var">getRateLimitDecision</span></a></span></span><span> </span><span id="local-6989586621679254681"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254681"><span class="hs-identifier hs-var">numberOfConnections</span></a></span></span><span>
</span><span id="line-72"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679254680"><span class="annot"><span class="annottext">Word32
acceptedConnectionsHardLimit :: Word32
acceptedConnectionsHardLimit :: AcceptedConnectionsLimit -&gt; Word32
</span><a href="#local-6989586621679254680"><span class="hs-identifier hs-var hs-var">acceptedConnectionsHardLimit</span></a></span></span><span>
</span><span id="line-73"></span><span>                                              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679254679"><span class="annot"><span class="annottext">Word32
acceptedConnectionsSoftLimit :: Word32
acceptedConnectionsSoftLimit :: AcceptedConnectionsLimit -&gt; Word32
</span><a href="#local-6989586621679254679"><span class="hs-identifier hs-var hs-var">acceptedConnectionsSoftLimit</span></a></span></span><span>
</span><span id="line-74"></span><span>                                              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679254678"><span class="annot"><span class="annottext">DiffTime
acceptedConnectionsDelay :: DiffTime
acceptedConnectionsDelay :: AcceptedConnectionsLimit -&gt; DiffTime
</span><a href="#local-6989586621679254678"><span class="hs-identifier hs-var hs-var">acceptedConnectionsDelay</span></a></span></span><span>
</span><span id="line-75"></span><span>                                              </span><span class="hs-special">}</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- below the soft limit we accept connections without any delay</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254681"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254676"><span class="hs-identifier hs-var">softLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#NoRateLimiting"><span class="hs-identifier hs-var">NoRateLimiting</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- above the hard limit will will wait until the number of connections drops</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- below the soft limit</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254681"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254675"><span class="hs-identifier hs-var">hardLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#HardLimit"><span class="hs-identifier hs-var">HardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254680"><span class="hs-identifier hs-var">acceptedConnectionsHardLimit</span></a></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">-- in between we scale the delay using linear regression.</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#SoftDelay"><span class="hs-identifier hs-var">SoftDelay</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; RateLimitDelay) -&gt; DiffTime -&gt; RateLimitDelay
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; DiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254681"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254676"><span class="hs-identifier hs-var">softLimit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254678"><span class="hs-identifier hs-var">acceptedConnectionsDelay</span></a></span><span>
</span><span id="line-88"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">/</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; DiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254675"><span class="hs-identifier hs-var">hardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254676"><span class="hs-identifier hs-var">softLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`max`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><a href="#local-6989586621679254675"><span class="hs-identifier hs-type">hardLimit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679254676"><span class="hs-identifier hs-type">softLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621679254675"><span class="annot"><span class="annottext">hardLimit :: Int
</span><a href="#local-6989586621679254675"><span class="hs-identifier hs-var hs-var">hardLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254680"><span class="hs-identifier hs-var">acceptedConnectionsHardLimit</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679254676"><span class="annot"><span class="annottext">softLimit :: Int
</span><a href="#local-6989586621679254676"><span class="hs-identifier hs-var hs-var">softLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254679"><span class="hs-identifier hs-var">acceptedConnectionsSoftLimit</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- | Get the number of current connections, make decision based on</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- 'AcceptedConnectionsLimit' and execute it.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span id="local-6989586621679254671"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#runConnectionRateLimits"><span class="hs-identifier hs-type">runConnectionRateLimits</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span>   </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-100"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadDelay</span></span><span> </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-101"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span>  </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-102"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier hs-type">AcceptConnectionsPolicyTrace</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679254671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-107"></span><span id="runConnectionRateLimits"><span class="annot"><span class="annottext">runConnectionRateLimits :: Tracer m AcceptConnectionsPolicyTrace
-&gt; STM m Int -&gt; AcceptedConnectionsLimit -&gt; m ()
</span><a href="Ouroboros.Network.Server.RateLimiting.html#runConnectionRateLimits"><span class="hs-identifier hs-var hs-var">runConnectionRateLimits</span></a></span></span><span> </span><span id="local-6989586621679254669"><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
</span><a href="#local-6989586621679254669"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-108"></span><span>                        </span><span id="local-6989586621679254668"><span class="annot"><span class="annottext">STM m Int
</span><a href="#local-6989586621679254668"><span class="hs-identifier hs-var">numberOfConnectionsSTM</span></a></span></span><span>
</span><span id="line-109"></span><span>                        </span><span id="local-6989586621679254667"><span class="annot"><span class="annottext">acceptedConnectionsLimit :: AcceptedConnectionsLimit
</span><a href="#local-6989586621679254667"><span class="hs-identifier hs-var">acceptedConnectionsLimit</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span>
</span><span id="line-110"></span><span>                          </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679254666"><span class="annot"><span class="annottext">DiffTime
acceptedConnectionsDelay :: DiffTime
acceptedConnectionsDelay :: AcceptedConnectionsLimit -&gt; DiffTime
</span><a href="#local-6989586621679254666"><span class="hs-identifier hs-var hs-var">acceptedConnectionsDelay</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621679254665"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254665"><span class="hs-identifier hs-var">numberOfConnections</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Int -&gt; m Int
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM m Int
</span><a href="#local-6989586621679254668"><span class="hs-identifier hs-var">numberOfConnectionsSTM</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; AcceptedConnectionsLimit -&gt; RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#getRateLimitDecision"><span class="hs-identifier hs-var">getRateLimitDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254665"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679254667"><span class="hs-identifier hs-var">acceptedConnectionsLimit</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="annottext">RateLimitDelay
</span><a href="Ouroboros.Network.Server.RateLimiting.html#NoRateLimiting"><span class="hs-identifier hs-var">NoRateLimiting</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#SoftDelay"><span class="hs-identifier hs-type">SoftDelay</span></a></span><span> </span><span id="local-6989586621679254663"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254663"><span class="hs-identifier hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
</span><a href="#local-6989586621679254669"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Int -&gt; AcceptConnectionsPolicyTrace
</span><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionRateLimiting"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionRateLimiting</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254663"><span class="hs-identifier hs-var">delay</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254665"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254663"><span class="hs-identifier hs-var">delay</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-comment">-- wait until the current number of connection drops below the limit, and</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-comment">-- wait at least 'acceptedConnectionsDelay'.  This is to avoid accepting</span><span>
</span><span id="line-122"></span><span>      </span><span class="hs-comment">-- the last connection to frequently if it fails almost immediately .</span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#HardLimit"><span class="hs-identifier hs-type">HardLimit</span></a></span><span> </span><span id="local-6989586621679254660"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254660"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
</span><a href="#local-6989586621679254669"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; AcceptConnectionsPolicyTrace
</span><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionHardLimit"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionHardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254660"><span class="hs-identifier hs-var">limit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>        </span><span id="local-6989586621679254658"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679254658"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>          </span><span id="local-6989586621679254656"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254656"><span class="hs-identifier hs-var">numberOfConnections'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Int
</span><a href="#local-6989586621679254668"><span class="hs-identifier hs-var">numberOfConnectionsSTM</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254656"><span class="hs-identifier hs-var">numberOfConnections'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254660"><span class="hs-identifier hs-var">limit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>        </span><span id="local-6989586621679254654"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679254654"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679254653"><span class="annot"><span class="annottext">remainingDelay :: DiffTime
</span><a href="#local-6989586621679254653"><span class="hs-identifier hs-var hs-var">remainingDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254666"><span class="hs-identifier hs-var">acceptedConnectionsDelay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679254654"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; DiffTime
</span><span class="hs-operator hs-var">`diffTime`</span></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679254658"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254653"><span class="hs-identifier hs-var">remainingDelay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>          </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254653"><span class="hs-identifier hs-var">remainingDelay</span></a></span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621679254650"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254650"><span class="hs-identifier hs-var">numberOfConnections'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Int -&gt; m Int
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM m Int
</span><a href="#local-6989586621679254668"><span class="hs-identifier hs-var">numberOfConnectionsSTM</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m AcceptConnectionsPolicyTrace
</span><a href="#local-6989586621679254669"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(AcceptConnectionsPolicyTrace -&gt; m ())
-&gt; AcceptConnectionsPolicyTrace -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; AcceptConnectionsPolicyTrace
</span><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionResume"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionResume</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254650"><span class="hs-identifier hs-var">numberOfConnections'</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">--</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- trace</span><span>
</span><span id="line-139"></span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | Trace for the 'AcceptConnectionsLimit' policy.</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-keyword">data</span><span> </span><span id="AcceptConnectionsPolicyTrace"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier hs-var">AcceptConnectionsPolicyTrace</span></a></span></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="ServerTraceAcceptConnectionRateLimiting"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionRateLimiting"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionRateLimiting</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="ServerTraceAcceptConnectionHardLimit"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionHardLimit"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionHardLimit</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="ServerTraceAcceptConnectionResume"><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionResume"><span class="hs-identifier hs-var">ServerTraceAcceptConnectionResume</span></a></span></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679254645"><span id="local-6989586621679254647"><span class="annot"><span class="annottext">AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
(AcceptConnectionsPolicyTrace
 -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; Eq AcceptConnectionsPolicyTrace
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c/= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
== :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c== :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679254630"><span id="local-6989586621679254632"><span id="local-6989586621679254634"><span id="local-6989586621679254636"><span id="local-6989586621679254638"><span id="local-6989586621679254640"><span id="local-6989586621679254642"><span class="annot"><span class="annottext">Eq AcceptConnectionsPolicyTrace
Eq AcceptConnectionsPolicyTrace
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Ordering)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; Bool)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace)
-&gt; (AcceptConnectionsPolicyTrace
    -&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace)
-&gt; Ord AcceptConnectionsPolicyTrace
AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Ordering
AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace
$cmin :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace
max :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace
$cmax :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; AcceptConnectionsPolicyTrace
&gt;= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c&gt;= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
&gt; :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c&gt; :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
&lt;= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c&lt;= :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
&lt; :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
$c&lt; :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Bool
compare :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Ordering
$ccompare :: AcceptConnectionsPolicyTrace
-&gt; AcceptConnectionsPolicyTrace -&gt; Ordering
$cp1Ord :: Eq AcceptConnectionsPolicyTrace
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679254625"><span id="local-6989586621679254628"><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptConnectionsPolicyTrace"><span class="hs-identifier hs-type">AcceptConnectionsPolicyTrace</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679254624"><span class="annot"><span class="annottext">show :: AcceptConnectionsPolicyTrace -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionRateLimiting"><span class="hs-identifier hs-type">ServerTraceAcceptConnectionRateLimiting</span></a></span><span> </span><span id="local-6989586621679254622"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254622"><span class="hs-identifier hs-var">delay</span></a></span></span><span> </span><span id="local-6989586621679254621"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254621"><span class="hs-identifier hs-var">numberOfConnections</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String -&gt; ShowS
forall r. PrintfType r =&gt; String -&gt; r
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">printf</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rate limiting accepting connections, delaying next accept for %s, currently serving %s connections&quot;</span></span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254622"><span class="hs-identifier hs-var">delay</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254621"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionHardLimit"><span class="hs-identifier hs-type">ServerTraceAcceptConnectionHardLimit</span></a></span><span> </span><span id="local-6989586621679254619"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254619"><span class="hs-identifier hs-var">limit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall r. PrintfType r =&gt; String -&gt; r
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">printf</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hard rate limit reached, waiting until the number of connections drops below %s&quot;</span></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679254619"><span class="hs-identifier hs-var">limit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#ServerTraceAcceptConnectionResume"><span class="hs-identifier hs-type">ServerTraceAcceptConnectionResume</span></a></span><span> </span><span id="local-6989586621679254618"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254618"><span class="hs-identifier hs-var">numberOfConnections</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; String
forall r. PrintfType r =&gt; String -&gt; r
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">printf</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hard rate limit over, accepting connections again, currently serving %d connections&quot;</span></span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254618"><span class="hs-identifier hs-var">numberOfConnections</span></a></span><span>
</span><span id="line-162"></span></pre></body></html>