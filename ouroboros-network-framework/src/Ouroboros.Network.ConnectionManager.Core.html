<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures        #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns        #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TupleSections         #-}</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Undecidable instances are need for 'Show' instance of 'ConnectionState'.</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances  #-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">-- | The implementation of connection manager.</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Core</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerArguments"><span class="hs-identifier">ConnectionManagerArguments</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#withConnectionManager"><span class="hs-identifier">withConnectionManager</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultTimeWaitTimeout"><span class="hs-identifier">defaultTimeWaitTimeout</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultProtocolIdleTimeout"><span class="hs-identifier">defaultProtocolIdleTimeout</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultResetTimeout"><span class="hs-identifier">defaultResetTimeout</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier">ConnectionState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier">abstractState</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LazySTM</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">guard</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&gt;=&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadFork</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwTo</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">handle</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad.Fix</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldMap'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">traverse_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">on</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">maybeToList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">CallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">callStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier">Data.Monoid.Synchronisation</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Data.Wedge.html"><span class="hs-identifier">Data.Wedge</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word32</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">Network.Mux.Trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">MuxTrace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">WithMuxBearer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">Network.Mux.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">MuxMode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html"><span class="hs-identifier">Ouroboros.Network.ConnectionId</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Types</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CM</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html"><span class="hs-identifier">Ouroboros.Network.InboundGovernor.ControlChannel</span></a></span><span>
</span><span id="line-60"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#ControlChannel"><span class="hs-identifier">ControlChannel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html"><span class="hs-identifier">Ouroboros.Network.InboundGovernor.ControlChannel</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ControlChannel</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html"><span class="hs-identifier">Ouroboros.Network.MuxMode</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html"><span class="hs-identifier">Ouroboros.Network.Server.RateLimiting</span></a></span><span>
</span><span id="line-64"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier">AcceptedConnectionsLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Snocket.html"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- | Arguments for a 'ConnectionManager' which are independent of 'MuxMode'.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-keyword">data</span><span> </span><span id="ConnectionManagerArguments"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerArguments"><span class="hs-identifier hs-var">ConnectionManagerArguments</span></a></span></span><span> </span><span id="local-6989586621679257385"><span class="annot"><a href="#local-6989586621679257385"><span class="hs-identifier hs-type">handlerTrace</span></a></span></span><span> </span><span id="local-6989586621679257384"><span class="annot"><a href="#local-6989586621679257384"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679257383"><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679257382"><span class="annot"><a href="#local-6989586621679257382"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679257381"><span class="annot"><a href="#local-6989586621679257381"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679257380"><span class="annot"><a href="#local-6989586621679257380"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679257379"><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>    </span><span id="ConnectionManagerArguments"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerArguments"><span class="hs-identifier hs-var">ConnectionManagerArguments</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-72"></span><span>        </span><span class="hs-comment">-- | Connection manager tracer.</span><span>
</span><span id="line-73"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span>        </span><span id="cmTracer"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmTracer"><span class="hs-identifier hs-var hs-var">cmTracer</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerTrace"><span class="hs-identifier hs-type">ConnectionManagerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257385"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-comment">-- | Trace state transitions.</span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span>        </span><span id="cmTrTracer"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer
     m
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmTrTracer"><span class="hs-identifier hs-var hs-var">cmTrTracer</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-type">TransitionTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-79"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257382"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257381"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257380"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-comment">-- | Mux trace.</span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span>        </span><span id="cmMuxTracer"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmMuxTracer"><span class="hs-identifier hs-var hs-var">cmMuxTracer</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">WithMuxBearer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxTrace</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-comment">-- | @IPv4@ address of the connection manager.  If given, outbound</span><span>
</span><span id="line-86"></span><span>        </span><span class="hs-comment">-- connections to an @IPv4@ address will bound to it.  To use</span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-comment">-- bidirectional @TCP@ connections, it must be the same as the server</span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-comment">-- listening @IPv4@ address.</span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span>        </span><span id="cmIPv4Address"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Maybe peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmIPv4Address"><span class="hs-identifier hs-var hs-var">cmIPv4Address</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-comment">-- | @IPv6@ address of the connection manager.  If given, outbound</span><span>
</span><span id="line-93"></span><span>        </span><span class="hs-comment">-- connections to an @IPv6@ address will bound to it.  To use</span><span>
</span><span id="line-94"></span><span>        </span><span class="hs-comment">-- bidirectional @TCP@ connections, it must be the same as the server</span><span>
</span><span id="line-95"></span><span>        </span><span class="hs-comment">-- listening @IPv6@ address.</span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-97"></span><span>        </span><span id="cmIPv6Address"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Maybe peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmIPv6Address"><span class="hs-identifier hs-var hs-var">cmIPv6Address</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>        </span><span id="cmAddressType"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; peerAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmAddressType"><span class="hs-identifier hs-var hs-var">cmAddressType</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AddressType"><span class="hs-identifier hs-type">AddressType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>        </span><span class="hs-comment">-- | Snocket for the 'socket' type.</span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span>        </span><span id="cmSnocket"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Snocket m socket peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmSnocket"><span class="hs-identifier hs-var hs-var">cmSnocket</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257384"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>        </span><span class="hs-comment">-- | Make MuxBearer.</span><span>
</span><span id="line-106"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span>        </span><span id="cmMakeBearer"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; MakeBearer m socket
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmMakeBearer"><span class="hs-identifier hs-var hs-var">cmMakeBearer</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MakeBearer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257384"><span class="hs-identifier hs-type">socket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>        </span><span class="hs-comment">-- | Socket configuration.</span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-111"></span><span>        </span><span id="cmConfigureSocket"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; socket -&gt; Maybe peerAddr -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmConfigureSocket"><span class="hs-identifier hs-var hs-var">cmConfigureSocket</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679257384"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-comment">-- | @TCP@ will held connections in @TIME_WAIT@ state for up to two MSL</span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-comment">-- (maximum segment time).  On Linux this is set to '60' seconds on</span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-comment">-- other system this might be up to four minutes.</span><span>
</span><span id="line-116"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-comment">-- This is configurable, so we can set different value in tests.</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-comment">-- When this timeout expires a connection will transition from</span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-comment">-- 'TerminatingState' to 'TerminatedState'.</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span>        </span><span id="cmTimeWaitTimeout"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; DiffTime
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmTimeWaitTimeout"><span class="hs-identifier hs-var hs-var">cmTimeWaitTimeout</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-comment">-- | Inactivity timeout before the connection will be reset.  It is the</span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-comment">-- timeout attached to the 'OutboundIdleState'.</span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span>        </span><span id="cmOutboundIdleTimeout"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; DiffTime
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmOutboundIdleTimeout"><span class="hs-identifier hs-var hs-var">cmOutboundIdleTimeout</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-comment">-- | @version@ represents the tuple of @versionNumber@ and</span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-comment">-- @agreedOptions@.</span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-132"></span><span>        </span><span id="connectionDataFlow"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; version -&gt; DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionDataFlow"><span class="hs-identifier hs-var hs-var">connectionDataFlow</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679257380"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#DataFlow"><span class="hs-identifier hs-type">DataFlow</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">-- | Prune policy</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>        </span><span id="cmPrunePolicy"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; PrunePolicy peerAddr (STM m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmPrunePolicy"><span class="hs-identifier hs-var hs-var">cmPrunePolicy</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#PrunePolicy"><span class="hs-identifier hs-type">PrunePolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257383"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257379"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>        </span><span id="cmConnectionsLimits"><span class="annot"><span class="annottext">ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; AcceptedConnectionsLimit
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmConnectionsLimits"><span class="hs-identifier hs-var hs-var">cmConnectionsLimits</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Server.RateLimiting.html#AcceptedConnectionsLimit"><span class="hs-identifier hs-type">AcceptedConnectionsLimit</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">-- | 'MutableConnState', which supplies a unique identifier.</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- TODO: We can get away without id, by tracking connections in</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- `TerminatingState` using a seprate priority search queue.</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-keyword">data</span><span> </span><span id="MutableConnState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-var">MutableConnState</span></a></span></span><span> </span><span id="local-6989586621679257516"><span class="annot"><a href="#local-6989586621679257516"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679257515"><span class="annot"><a href="#local-6989586621679257515"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679257514"><span class="annot"><a href="#local-6989586621679257514"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679257513"><span class="annot"><a href="#local-6989586621679257513"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679257512"><span class="annot"><a href="#local-6989586621679257512"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MutableConnState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-var">MutableConnState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- | A unique identifier</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-149"></span><span>    </span><span id="connStateId"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m -&gt; Int
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connStateId"><span class="hs-identifier hs-var hs-var">connStateId</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- | Mutable state</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span>    </span><span id="connVar"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257516"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257515"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257514"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-154"></span><span>                                                    </span><span class="annot"><a href="#local-6989586621679257513"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257512"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span id="local-6989586621679256993"><span id="local-6989586621679256994"><span id="local-6989586621679256995"><span id="local-6989586621679256996"><span id="local-6989586621679256997"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679256990"><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256997"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256996"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256995"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256994"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256993"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621679256988"><span class="annot"><span class="annottext">== :: MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var hs-var hs-var hs-var">(==)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">(==)</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Bool)
-&gt; (MutableConnState peerAddr handle handleError version m -&gt; Int)
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m -&gt; Int
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m -&gt; Int
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connStateId"><span class="hs-identifier hs-var hs-var">connStateId</span></a></span></span></span></span></span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | A supply of fresh id's.</span><span>
</span><span id="line-163"></span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- We use a fresh ids for 'MutableConnState'.</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-keyword">newtype</span><span> </span><span id="FreshIdSupply"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-var">FreshIdSupply</span></a></span></span><span> </span><span id="local-6989586621679257493"><span class="annot"><a href="#local-6989586621679257493"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FreshIdSupply"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-var">FreshIdSupply</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="getFreshId"><span class="annot"><span class="annottext">FreshIdSupply m -&gt; STM m Int
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getFreshId"><span class="hs-identifier hs-var hs-var">getFreshId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">-- | Create a 'FreshIdSupply' inside an 'STM' monad.</span><span>
</span><span id="line-170"></span><span class="hs-comment">--</span><span>
</span><span id="line-171"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#newFreshIdSupply"><span class="hs-identifier hs-type">newFreshIdSupply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679257346"><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-172"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span id="newFreshIdSupply"><span class="annot"><span class="annottext">newFreshIdSupply :: Proxy m -&gt; STM m (FreshIdSupply m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#newFreshIdSupply"><span class="hs-identifier hs-var hs-var">newFreshIdSupply</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679256984"><span class="annot"><span class="annottext">StrictTVar m Int
</span><a href="#local-6989586621679256984"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; STM m (StrictTVar m Int)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679256982"><span class="hs-identifier hs-type">getFreshId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-176"></span><span>        </span><span id="local-6989586621679256982"><span class="annot"><span class="annottext">getFreshId :: STM m Int
</span><a href="#local-6989586621679256982"><span class="hs-identifier hs-var hs-var">getFreshId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>          </span><span id="local-6989586621679256981"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256981"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m Int -&gt; STM m Int
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m Int
</span><a href="#local-6989586621679256984"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-178"></span><span>          </span><span class="annot"><span class="annottext">StrictTVar m Int -&gt; Int -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m Int
</span><a href="#local-6989586621679256984"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256981"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; STM m Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256981"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">FreshIdSupply m -&gt; STM m (FreshIdSupply m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(FreshIdSupply m -&gt; STM m (FreshIdSupply m))
-&gt; FreshIdSupply m -&gt; STM m (FreshIdSupply m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply :: forall (m :: * -&gt; *). STM m Int -&gt; FreshIdSupply m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">STM m Int
getFreshId :: STM m Int
getFreshId :: STM m Int
</span><a href="#local-6989586621679256982"><span class="hs-identifier hs-var hs-var">getFreshId</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621679257128"><span id="local-6989586621679257129"><span id="local-6989586621679257130"><span id="local-6989586621679257131"><span id="local-6989586621679257132"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#newMutableConnState"><span class="hs-identifier hs-type">newMutableConnState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257132"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-184"></span><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257132"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-185"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257131"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257130"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257129"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-186"></span><span>                                       </span><span class="annot"><a href="#local-6989586621679257128"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257132"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-187"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257132"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257131"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257130"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257129"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-188"></span><span>                                               </span><span class="annot"><a href="#local-6989586621679257128"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257132"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-189"></span><span id="newMutableConnState"><span class="annot"><span class="annottext">newMutableConnState :: FreshIdSupply m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#newMutableConnState"><span class="hs-identifier hs-var hs-var">newMutableConnState</span></a></span></span><span> </span><span id="local-6989586621679256976"><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256976"><span class="hs-identifier hs-var">freshIdSupply</span></a></span></span><span> </span><span id="local-6989586621679256975"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256975"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>      </span><span id="local-6989586621679256974"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256974"><span class="hs-identifier hs-var">connStateId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m -&gt; STM m Int
forall (m :: * -&gt; *). FreshIdSupply m -&gt; STM m Int
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getFreshId"><span class="hs-identifier hs-var hs-var">getFreshId</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256976"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span>
</span><span id="line-191"></span><span>      </span><span id="local-6989586621679256973"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256973"><span class="hs-identifier hs-var">connVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; STM
     m
     (StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256975"><span class="hs-identifier hs-var">connState</span></a></span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m (MutableConnState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState :: forall peerAddr handle handleError version (m :: * -&gt; *).
Int
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; MutableConnState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Int
connStateId :: Int
connStateId :: Int
</span><a href="#local-6989586621679256974"><span class="hs-identifier hs-var hs-var">connStateId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256973"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | 'ConnectionManager' state: for each peer we keep a 'ConnectionState' in</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- a mutable variable, which reduces congestion on the 'TMVar' which keeps</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- 'ConnectionManagerState'.</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- It is important we can lookup by remote @peerAddr@; this way we can find if</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- the connection manager is already managing a connection towards that</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- @peerAddr@ and reuse the 'ConnectionState'.</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-keyword">type</span><span> </span><span id="ConnectionManagerState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-var">ConnectionManagerState</span></a></span></span><span> </span><span id="local-6989586621679256972"><span class="annot"><a href="#local-6989586621679256972"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679256971"><span class="annot"><a href="#local-6989586621679256971"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679256970"><span class="annot"><a href="#local-6989586621679256970"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679256969"><span class="annot"><a href="#local-6989586621679256969"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679256968"><span class="annot"><a href="#local-6989586621679256968"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256972"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256972"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256971"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256970"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256969"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256968"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span id="local-6989586621679257234"><span id="local-6989586621679257235"><span id="local-6989586621679257236"><span id="local-6989586621679257237"><span id="local-6989586621679257238"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionManagerStateToCounters"><span class="hs-identifier hs-type">connectionManagerStateToCounters</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257238"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257238"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257237"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257236"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257235"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257234"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-type">ConnectionManagerCounters</span></a></span></span></span></span></span></span><span>
</span><span id="line-209"></span><span id="connectionManagerStateToCounters"><span class="annot"><span class="annottext">connectionManagerStateToCounters :: Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionManagerStateToCounters"><span class="hs-identifier hs-var hs-var">connectionManagerStateToCounters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m
 -&gt; ConnectionManagerCounters)
-&gt; Map
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap'</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionManagerCounters
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
-&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionStateToCounters"><span class="hs-identifier hs-var">connectionStateToCounters</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | State of a connection.</span><span>
</span><span id="line-213"></span><span class="hs-comment">--</span><span>
</span><span id="line-214"></span><span class="hs-keyword">data</span><span> </span><span id="ConnectionState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-var">ConnectionState</span></a></span></span><span> </span><span id="local-6989586621679257269"><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679257268"><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679257270"><span class="annot"><a href="#local-6989586621679257270"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679257267"><span class="annot"><a href="#local-6989586621679257267"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679257266"><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-comment">-- | Each outbound connections starts in this state.</span><span>
</span><span id="line-216"></span><span>    </span><span id="ReservedOutboundState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-comment">-- | Each inbound connection starts in this state, outbound connection</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">-- reach this state once `connect` call returns.</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- note: the async handle is lazy, because it's passed with 'mfix'.</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UnnegotiatedState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-var">UnnegotiatedState</span></a></span></span><span>   </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Provenance"><span class="hs-identifier hs-type">Provenance</span></a></span><span>
</span><span id="line-223"></span><span>                        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- | @OutboundState Unidirectional@ state.</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OutboundUniState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-var">OutboundUniState</span></a></span></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- | Either @OutboundState Duplex@ or @OutobundState^\tau Duplex@.</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OutboundDupState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#TimeoutExpired"><span class="hs-identifier hs-type">TimeoutExpired</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- | Before connection is reset it is put in 'OutboundIdleState' for the</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">-- duration of 'cmOutboundIdleTimeout'.</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OutboundIdleState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-var">OutboundIdleState</span></a></span></span><span>   </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#DataFlow"><span class="hs-identifier hs-type">DataFlow</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InboundIdleState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-var">InboundIdleState</span></a></span></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#DataFlow"><span class="hs-identifier hs-type">DataFlow</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InboundState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-var">InboundState</span></a></span></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#DataFlow"><span class="hs-identifier hs-type">DataFlow</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DuplexState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-var">DuplexState</span></a></span></span><span>         </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679257268"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TerminatingState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257269"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257270"><span class="hs-identifier hs-type">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TerminatedState"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span></span><span>                              </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257270"><span class="hs-identifier hs-type">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- | Return 'True' for states in which the connection was already closed.</span><span>
</span><span id="line-244"></span><span class="hs-comment">--</span><span>
</span><span id="line-245"></span><span id="local-6989586621679256951"><span id="local-6989586621679256952"><span id="local-6989586621679256953"><span id="local-6989586621679256954"><span id="local-6989586621679256955"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionTerminated"><span class="hs-identifier hs-type">connectionTerminated</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256955"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256954"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256953"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256952"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256951"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-246"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-247"></span><span id="connectionTerminated"><span class="annot"><span class="annottext">connectionTerminated :: ConnectionState peerAddr handle handleError version m -&gt; Bool
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionTerminated"><span class="hs-identifier hs-var hs-var">connectionTerminated</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-248"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionTerminated"><span class="hs-identifier hs-var">connectionTerminated</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-249"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionTerminated"><span class="hs-identifier hs-var">connectionTerminated</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | Perform counting from an 'AbstractState'</span><span>
</span><span id="line-254"></span><span id="local-6989586621679257473"><span id="local-6989586621679257474"><span id="local-6989586621679257475"><span id="local-6989586621679257476"><span id="local-6989586621679257477"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionStateToCounters"><span class="hs-identifier hs-type">connectionStateToCounters</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257477"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257476"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257475"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257474"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257473"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-type">ConnectionManagerCounters</span></a></span></span></span></span></span></span><span>
</span><span id="line-257"></span><span id="connectionStateToCounters"><span class="annot"><span class="annottext">connectionStateToCounters :: ConnectionState peerAddr handle handleError version m
-&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionStateToCounters"><span class="hs-identifier hs-var hs-var">connectionStateToCounters</span></a></span></span><span> </span><span id="local-6989586621679256949"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256949"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256949"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-259"></span><span>      </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
forall a. Monoid a =&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256944"><span class="hs-identifier hs-var">unidirectionalConn</span></a></span><span>
</span><span id="line-266"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span>  </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var">duplexConn</span></a></span><span>
</span><span id="line-269"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256944"><span class="hs-identifier hs-var">unidirectionalConn</span></a></span><span>
</span><span id="line-272"></span><span>                                             </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var">duplexConn</span></a></span><span>
</span><span id="line-275"></span><span>                                             </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256944"><span class="hs-identifier hs-var">unidirectionalConn</span></a></span><span>
</span><span id="line-278"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var">duplexConn</span></a></span><span>
</span><span id="line-281"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256944"><span class="hs-identifier hs-var">unidirectionalConn</span></a></span><span>
</span><span id="line-284"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var">duplexConn</span></a></span><span>
</span><span id="line-287"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256940"><span class="hs-identifier hs-var">fullDuplexConn</span></a></span><span>
</span><span id="line-290"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var">duplexConn</span></a></span><span>
</span><span id="line-291"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var">inboundConn</span></a></span><span>
</span><span id="line-292"></span><span>                                            </span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerCounters -&gt; ConnectionManagerCounters
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var">outboundConn</span></a></span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
forall a. Monoid a =&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-295"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><span class="hs-identifier">_</span></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerCounters
forall a. Monoid a =&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621679256940"><span class="annot"><span class="annottext">fullDuplexConn :: ConnectionManagerCounters
</span><a href="#local-6989586621679256940"><span class="hs-identifier hs-var hs-var">fullDuplexConn</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-var">ConnectionManagerCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621679256943"><span class="annot"><span class="annottext">duplexConn :: ConnectionManagerCounters
</span><a href="#local-6989586621679256943"><span class="hs-identifier hs-var hs-var">duplexConn</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-var">ConnectionManagerCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621679256944"><span class="annot"><span class="annottext">unidirectionalConn :: ConnectionManagerCounters
</span><a href="#local-6989586621679256944"><span class="hs-identifier hs-var hs-var">unidirectionalConn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-var">ConnectionManagerCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621679256947"><span class="annot"><span class="annottext">inboundConn :: ConnectionManagerCounters
</span><a href="#local-6989586621679256947"><span class="hs-identifier hs-var hs-var">inboundConn</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-var">ConnectionManagerCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621679256945"><span class="annot"><span class="annottext">outboundConn :: ConnectionManagerCounters
</span><a href="#local-6989586621679256945"><span class="hs-identifier hs-var hs-var">outboundConn</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerCounters"><span class="hs-identifier hs-var">ConnectionManagerCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span id="local-6989586621679256934"><span id="local-6989586621679256935"><span id="local-6989586621679256936"><span id="local-6989586621679256937"><span id="local-6989586621679256938"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679256929"><span id="local-6989586621679256932"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256938"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-305"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256937"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-306"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679256936"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-307"></span><span>         </span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256938"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256935"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256937"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256934"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256936"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621679256927"><span class="annot"><span class="annottext">show :: ConnectionState peerAddr handle handleError version m -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ReservedOutboundState&quot;</span></span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span id="local-6989586621679256925"><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256925"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679256924"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256924"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256923"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256923"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UnnegotiatedState &quot;</span></span><span>
</span><span id="line-312"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Provenance -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256925"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-313"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-314"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256924"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-315"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-316"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256923"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256920"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256920"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256919"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256919"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256918"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256918"><span class="hs-identifier hs-var">_handle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OutboundState Unidirectional &quot;</span></span><span>
</span><span id="line-320"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256920"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-321"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-322"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256919"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256917"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256917"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256916"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256916"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256915"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256915"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256914"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256914"><span class="hs-identifier hs-var">expired</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OutboundState &quot;</span></span><span>
</span><span id="line-326"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256917"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-327"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-328"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256916"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-330"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TimeoutExpired -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256914"><span class="hs-identifier hs-var">expired</span></a></span><span>
</span><span id="line-331"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256913"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256913"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256912"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256912"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256911"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256911"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256910"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256910"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OutboundIdleState &quot;</span></span><span>
</span><span id="line-334"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256913"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-335"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-336"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256912"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-338"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256910"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-339"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256909"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256909"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256908"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256908"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256907"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256907"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256906"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256906"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;InboundIdleState &quot;</span></span><span>
</span><span id="line-342"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256909"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-343"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-344"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256908"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-346"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256906"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-347"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span>  </span><span id="local-6989586621679256905"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256905"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256904"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256904"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256903"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256903"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256902"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256902"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;InboundState &quot;</span></span><span>
</span><span id="line-350"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256905"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-351"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-352"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256904"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-354"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256902"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-355"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span>   </span><span id="local-6989586621679256901"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256901"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256900"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256900"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256899"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256899"><span class="hs-identifier hs-var">_handle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DuplexState &quot;</span></span><span>
</span><span id="line-358"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256901"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-359"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-360"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256900"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span id="local-6989586621679256898"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256898"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256897"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256897"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256896"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256896"><span class="hs-identifier hs-var">handleError</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TerminatingState &quot;</span></span><span>
</span><span id="line-364"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256898"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-365"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-366"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256897"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-368"></span><span>              </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; [String]
forall a. Maybe a -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; ShowS
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; (handleError -&gt; String) -&gt; handleError -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">handleError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(handleError -&gt; String) -&gt; Maybe handleError -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256896"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span id="local-6989586621679256893"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256893"><span class="hs-identifier hs-var">handleError</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TerminatedState&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-371"></span><span>              </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; [String]
forall a. Maybe a -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; ShowS
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; (handleError -&gt; String) -&gt; handleError -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">handleError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(handleError -&gt; String) -&gt; Maybe handleError -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256893"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span id="local-6989586621679257248"><span id="local-6989586621679257249"><span id="local-6989586621679257250"><span id="local-6989586621679257251"><span id="local-6989586621679257252"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-type">getConnThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257252"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257251"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257250"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257249"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257248"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-375"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257248"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-376"></span><span id="getConnThread"><span class="annot"><span class="annottext">getConnThread :: ConnectionState peerAddr handle handleError version m
-&gt; Maybe (Async m ())
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var hs-var">getConnThread</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span>                                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-377"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span id="local-6989586621679256891"><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256891"><span class="hs-identifier hs-var">_pr</span></a></span></span><span>   </span><span id="local-6989586621679256890"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256890"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256889"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256889"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256889"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-378"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span>        </span><span id="local-6989586621679256888"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256888"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256887"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256887"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256886"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256886"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256887"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-379"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span>        </span><span id="local-6989586621679256885"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256885"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256884"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256884"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256883"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256883"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256882"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256882"><span class="hs-identifier hs-var">_te</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256884"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-380"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span>       </span><span id="local-6989586621679256881"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256881"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256880"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256880"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256879"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256879"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256878"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256878"><span class="hs-identifier hs-var">_df</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256880"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-381"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span>        </span><span id="local-6989586621679256877"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256877"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256876"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256876"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256875"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256875"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256874"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256874"><span class="hs-identifier hs-var">_df</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256876"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-382"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span>            </span><span id="local-6989586621679256873"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256873"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256872"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256872"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256871"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256871"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256870"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256870"><span class="hs-identifier hs-var">_df</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256872"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-383"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span>             </span><span id="local-6989586621679256869"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256869"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256868"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256868"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256867"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256867"><span class="hs-identifier hs-var">_handle</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256868"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-384"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span>        </span><span id="local-6989586621679256866"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256866"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256865"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256865"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256864"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256864"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256865"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-385"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">-- | Get 'DataFlow' for a connection.  It returns 'Nowhere' if that connection</span><span>
</span><span id="line-388"></span><span class="hs-comment">-- is either not yet created or in terminating state, 'There' for  unnegotiated</span><span>
</span><span id="line-389"></span><span class="hs-comment">-- connections and 'Here' if the data flow is known.</span><span>
</span><span id="line-390"></span><span class="hs-comment">--</span><span>
</span><span id="line-391"></span><span id="local-6989586621679257157"><span id="local-6989586621679257158"><span id="local-6989586621679257159"><span id="local-6989586621679257160"><span id="local-6989586621679257161"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-type">getConnType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257161"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257160"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257159"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257158"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257157"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionType"><span class="hs-identifier hs-type">ConnectionType</span></a></span></span></span></span></span></span><span>
</span><span id="line-393"></span><span id="getConnType"><span class="annot"><span class="annottext">getConnType :: ConnectionState peerAddr handle handleError version m
-&gt; Maybe ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var hs-var">getConnType</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span>                                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConnectionType
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-394"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span id="local-6989586621679256862"><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256862"><span class="hs-identifier hs-var">pr</span></a></span></span><span>  </span><span id="local-6989586621679256861"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256861"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256860"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256860"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnnegotiatedConn"><span class="hs-identifier hs-var">UnnegotiatedConn</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256862"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span>      </span><span id="local-6989586621679256858"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256858"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256857"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256857"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256856"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256856"><span class="hs-identifier hs-var">_handle</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance -&gt; DataFlow -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#NegotiatedConn"><span class="hs-identifier hs-var">NegotiatedConn</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span>      </span><span id="local-6989586621679256854"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256854"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256853"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256853"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256852"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256852"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256851"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256851"><span class="hs-identifier hs-var">_te</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance -&gt; DataFlow -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#NegotiatedConn"><span class="hs-identifier hs-var">NegotiatedConn</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span>     </span><span id="local-6989586621679256850"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256850"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256849"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256849"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256848"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256848"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256847"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256847"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataFlow -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundIdleConn"><span class="hs-identifier hs-var">OutboundIdleConn</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256847"><span class="hs-identifier hs-var">df</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span>      </span><span id="local-6989586621679256845"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256845"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256844"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256844"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256843"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256843"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256842"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256842"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataFlow -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#InboundIdleConn"><span class="hs-identifier hs-var">InboundIdleConn</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256842"><span class="hs-identifier hs-var">df</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span>          </span><span id="local-6989586621679256840"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256840"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256839"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256839"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256838"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256838"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256837"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256837"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance -&gt; DataFlow -&gt; ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#NegotiatedConn"><span class="hs-identifier hs-var">NegotiatedConn</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256837"><span class="hs-identifier hs-var">df</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span>           </span><span id="local-6989586621679256836"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256836"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256835"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256835"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256834"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256834"><span class="hs-identifier hs-var">_handle</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType -&gt; Maybe ConnectionType
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#DuplexConn"><span class="hs-identifier hs-var">DuplexConn</span></a></span><span>
</span><span id="line-401"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span>      </span><span id="local-6989586621679256832"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256832"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256831"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256831"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256830"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256830"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConnectionType
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-402"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConnectionType
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span class="hs-comment">-- | Return 'True' if a connection is inbound.  This must agree with</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- 'connectionStateToCounters'.  Both are used for prunning.</span><span>
</span><span id="line-407"></span><span class="hs-comment">--</span><span>
</span><span id="line-408"></span><span id="local-6989586621679257162"><span id="local-6989586621679257163"><span id="local-6989586621679257164"><span id="local-6989586621679257165"><span id="local-6989586621679257166"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-type">isInboundConn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257166"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257165"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257164"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257163"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257162"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-409"></span><span id="isInboundConn"><span class="annot"><span class="annottext">isInboundConn :: ConnectionState peerAddr handle handleError version m -&gt; Bool
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var hs-var">isInboundConn</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-410"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span id="local-6989586621679256828"><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679256827"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256827"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256826"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256826"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256828"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance -&gt; Provenance -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span>
</span><span id="line-411"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-412"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-413"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-414"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-415"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-416"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-417"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-418"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span id="local-6989586621679257332"><span id="local-6989586621679257333"><span id="local-6989586621679257334"><span id="local-6989586621679257335"><span id="local-6989586621679257336"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-type">abstractState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#MaybeUnknown"><span class="hs-identifier hs-type">MaybeUnknown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257336"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257335"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257333"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257332"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span></span></span></span></span></span><span>
</span><span id="line-422"></span><span id="abstractState"><span class="annot"><span class="annottext">abstractState :: MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var hs-var">abstractState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="annottext">MaybeUnknown (ConnectionState muxMode peerAddr m a b)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnknownConnectionSt"><span class="hs-identifier hs-var">UnknownConnectionSt</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Race"><span class="hs-identifier hs-type">Race</span></a></span><span> </span><span id="local-6989586621679256822"><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b
</span><a href="#local-6989586621679256822"><span class="hs-identifier hs-var">s'</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b -&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
ConnectionState muxMode peerAddr m a b -&gt; AbstractState
</span><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b
</span><a href="#local-6989586621679256822"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-type">Known</span></a></span><span> </span><span id="local-6989586621679256819"><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b
</span><a href="#local-6989586621679256819"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b -&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
ConnectionState muxMode peerAddr m a b -&gt; AbstractState
</span><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState muxMode peerAddr m a b
</span><a href="#local-6989586621679256819"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621679257407"><span id="local-6989586621679257408"><span id="local-6989586621679257409"><span id="local-6989586621679257410"><span id="local-6989586621679257411"><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257411"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257410"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257408"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257407"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span></span></span></span></span></span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621679256821"><span class="annot"><span class="annottext">go :: ConnectionState muxMode peerAddr m a b -&gt; AbstractState
</span><a href="#local-6989586621679256821"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-type">ReservedOutboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ReservedOutboundSt"><span class="hs-identifier hs-var">ReservedOutboundSt</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span id="local-6989586621679256817"><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256817"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance -&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnnegotiatedSt"><span class="hs-identifier hs-var">UnnegotiatedSt</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256817"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-430"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span>    </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundUniSt"><span class="hs-identifier hs-var">OutboundUniSt</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span>    </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256814"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256814"><span class="hs-identifier hs-var">te</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeoutExpired -&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundDupSt"><span class="hs-identifier hs-var">OutboundDupSt</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256814"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256812"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256812"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundIdleSt"><span class="hs-identifier hs-var">OutboundIdleSt</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256812"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256810"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256810"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#InboundIdleSt"><span class="hs-identifier hs-var">InboundIdleSt</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256810"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span>     </span><span class="annot"><span class="annottext">ConnectionId muxMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async b ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256808"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256808"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#InboundSt"><span class="hs-identifier hs-var">InboundSt</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256808"><span class="hs-identifier hs-var">df</span></a></span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#DuplexSt"><span class="hs-identifier hs-var">DuplexSt</span></a></span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatingSt"><span class="hs-identifier hs-var">TerminatingSt</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><a href="#local-6989586621679256821"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="hs-comment">-- | The default value for 'cmTimeWaitTimeout'.</span><span>
</span><span id="line-441"></span><span class="hs-comment">--</span><span>
</span><span id="line-442"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultTimeWaitTimeout"><span class="hs-identifier hs-type">defaultTimeWaitTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-443"></span><span id="defaultTimeWaitTimeout"><span class="annot"><span class="annottext">defaultTimeWaitTimeout :: DiffTime
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultTimeWaitTimeout"><span class="hs-identifier hs-var hs-var">defaultTimeWaitTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">60</span></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-comment">-- | Inactivity timeout.  It configures how long to wait since the local side</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- demoted remote peer to /cold/, before closing the connection.</span><span>
</span><span id="line-447"></span><span class="hs-comment">--</span><span>
</span><span id="line-448"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultProtocolIdleTimeout"><span class="hs-identifier hs-type">defaultProtocolIdleTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-449"></span><span id="defaultProtocolIdleTimeout"><span class="annot"><span class="annottext">defaultProtocolIdleTimeout :: DiffTime
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultProtocolIdleTimeout"><span class="hs-identifier hs-var hs-var">defaultProtocolIdleTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultResetTimeout"><span class="hs-identifier hs-type">defaultResetTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-452"></span><span id="defaultResetTimeout"><span class="annot"><span class="annottext">defaultResetTimeout :: DiffTime
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#defaultResetTimeout"><span class="hs-identifier hs-var hs-var">defaultResetTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-keyword">newtype</span><span> </span><span id="PruneAction"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneAction"><span class="hs-identifier hs-var">PruneAction</span></a></span></span><span> </span><span id="local-6989586621679257143"><span class="annot"><a href="#local-6989586621679257143"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PruneAction"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneAction"><span class="hs-identifier hs-var">PruneAction</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="runPruneAction"><span class="annot"><span class="annottext">PruneAction m -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#runPruneAction"><span class="hs-identifier hs-var hs-var">runPruneAction</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679257143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="hs-comment">-- | Instruction used internally in @unregisterOutboundConnectionImpl@, e.g. in</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- the implementation of one of the two  @DemotedToCold^{dataFlow}_{Local}@</span><span>
</span><span id="line-459"></span><span class="hs-comment">-- transitions.</span><span>
</span><span id="line-460"></span><span class="hs-comment">--</span><span>
</span><span id="line-461"></span><span class="hs-keyword">data</span><span> </span><span id="DemoteToColdLocal"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocal"><span class="hs-identifier hs-var">DemoteToColdLocal</span></a></span></span><span> </span><span id="local-6989586621679257064"><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679257059"><span class="annot"><a href="#local-6989586621679257059"><span class="hs-identifier hs-type">handlerTrace</span></a></span></span><span> </span><span id="local-6989586621679257063"><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679257062"><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679257061"><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679257060"><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- | Any @DemotedToCold@ transition which terminates the connection:</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">--   DemotedToCold^{Duplex}_{Local} : * -&gt; TerminatingState</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-comment">-- from the spec.</span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="DemotedToColdLocal"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemotedToColdLocal"><span class="hs-identifier hs-var">DemotedToColdLocal</span></a></span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-471"></span><span>                                              </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-472"></span><span>                                              </span><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>                             </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-474"></span><span>                                            </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-475"></span><span>                                            </span><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-comment">-- | Any @DemoteToCold@ transition which does not terminate the connection, i.e.</span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-comment">--   DemotedToCold^{Duplex}_{Local} : OutboundState^\tau Duplex</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-comment">--                                  &#8594; InboundIdleState^\tau</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-comment">-- or the case where the connection is already in 'TerminatingState' or</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-comment">-- 'TerminatedState'.</span><span>
</span><span id="line-484"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DemoteToColdLocalNoop"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-486"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-487"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>                            </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-comment">-- | Duplex connection was demoted, prune connections.</span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="PruneConnections"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneConnections"><span class="hs-identifier hs-var">PruneConnections</span></a></span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneAction"><span class="hs-identifier hs-type">PruneAction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>                             </span><span class="hs-comment">-- ^ prune action</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>                            </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span>
</span><span id="line-496"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-497"></span><span>                                 </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-498"></span><span>                                 </span><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-500"></span><span>                                             </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257063"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-501"></span><span>                                             </span><span class="annot"><a href="#local-6989586621679257062"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257061"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257060"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span>                             </span><span class="hs-comment">-- ^ Left case is for when the connection which</span><span>
</span><span id="line-505"></span><span>                             </span><span class="hs-comment">-- triggered pruning is pruned in this case we do</span><span>
</span><span id="line-506"></span><span>                             </span><span class="hs-comment">-- not want to trace a new transition.</span><span>
</span><span id="line-507"></span><span>                             </span><span class="hs-comment">--</span><span>
</span><span id="line-508"></span><span>                             </span><span class="hs-comment">-- Right case is for when the connection which</span><span>
</span><span id="line-509"></span><span>                             </span><span class="hs-comment">-- triggered pruning isn't pruned. In this case</span><span>
</span><span id="line-510"></span><span>                             </span><span class="hs-comment">-- we do want to trace a new transition.</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-comment">-- | Demote error.</span><span>
</span><span id="line-514"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DemoteToColdLocalError"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalError"><span class="hs-identifier hs-var">DemoteToColdLocalError</span></a></span></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManagerTrace"><span class="hs-identifier hs-type">ConnectionManagerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257064"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257059"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>                             </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="hs-comment">-- | Entry point for using the connection manager.  This is a classic @with@ style</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- combinator, which cleans resources on exit of the callback (whether cleanly</span><span>
</span><span id="line-520"></span><span class="hs-comment">-- or through an exception).</span><span>
</span><span id="line-521"></span><span class="hs-comment">--</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- Including a connection (either inbound or outbound) is an idempotent</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- operation on connection manager state.  The connection manager will always</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- return the handle that was first to be included in its state.</span><span>
</span><span id="line-525"></span><span class="hs-comment">--</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- Once an inbound connection is passed to the 'ConnectionManager', the manager</span><span>
</span><span id="line-527"></span><span class="hs-comment">-- is responsible for the resource.</span><span>
</span><span id="line-528"></span><span class="hs-comment">--</span><span>
</span><span id="line-529"></span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#withConnectionManager"><span class="hs-identifier hs-type">withConnectionManager</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256797"><span class="annot"><a href="#local-6989586621679256797"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxMode</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679256796"><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679256795"><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679256794"><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span></span><span> </span><span id="local-6989586621679256793"><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679256792"><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span></span><span> </span><span id="local-6989586621679256791"><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span></span><span> </span><span id="local-6989586621679256790"><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679256789"><span class="annot"><a href="#local-6989586621679256789"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-531"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLabelledSTM</span></span><span>   </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-532"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTraceSTM</span></span><span>      </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-533"></span><span>       </span><span class="hs-comment">-- 'MonadFork' is only to get access to 'throwTo'</span><span>
</span><span id="line-534"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span>          </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-535"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span>         </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-536"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadEvaluate</span></span><span>      </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadFix</span></a></span><span>           </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-538"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span>          </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-539"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMonotonicTime</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-540"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span>         </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-544"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-545"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-546"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerArguments"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandler"><span class="hs-identifier hs-type">ConnectionHandler</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679256797"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- ^ Callback which runs in a thread dedicated for a given connection.</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#HandleErrorType"><span class="hs-identifier hs-type">HandleErrorType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-comment">-- ^ classify 'handleError's</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#InResponderMode"><span class="hs-identifier hs-type">InResponderMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256797"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#ControlChannel"><span class="hs-identifier hs-type">ControlChannel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-comment">-- ^ On outbound duplex connections we need to notify the server about</span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">-- a new connection.</span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256797"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256789"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-comment">-- ^ Continuation which receives the 'ConnectionManager'.  It must not leak</span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-comment">-- outside of scope of this callback.  Once it returns all resources</span><span>
</span><span id="line-558"></span><span>    </span><span class="hs-comment">-- will be closed.</span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256789"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-560"></span><span id="withConnectionManager"><span class="annot"><span class="annottext">withConnectionManager :: ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; ConnectionHandler
     muxMode handlerTrace socket peerAddr handle handleError version m
-&gt; (handleError -&gt; HandleErrorType)
-&gt; InResponderMode muxMode (ControlChannel peerAddr handle m)
-&gt; (ConnectionManager muxMode socket peerAddr handle handleError m
    -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withConnectionManager"><span class="hs-identifier hs-var hs-var">withConnectionManager</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerArguments"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-561"></span><span>                          </span><span class="annot"><span class="annottext">cmTracer :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmTracer"><span class="hs-identifier hs-var">cmTracer</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679256788"><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-562"></span><span>                          </span><span class="annot"><span class="annottext">cmTrTracer :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer
     m
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmTrTracer"><span class="hs-identifier hs-var">cmTrTracer</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679256787"><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-563"></span><span>                          </span><span class="annot"><span class="annottext">cmMuxTracer :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#cmMuxTracer"><span class="hs-identifier hs-var">cmMuxTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679256786"><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="#local-6989586621679256786"><span class="hs-identifier hs-var">muxTracer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-564"></span><span>                          </span><span id="local-6989586621679256785"><span class="annot"><span class="annottext">Maybe peerAddr
cmIPv4Address :: Maybe peerAddr
cmIPv4Address :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Maybe peerAddr
</span><a href="#local-6989586621679256785"><span class="hs-identifier hs-var hs-var">cmIPv4Address</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-565"></span><span>                          </span><span id="local-6989586621679256784"><span class="annot"><span class="annottext">Maybe peerAddr
cmIPv6Address :: Maybe peerAddr
cmIPv6Address :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Maybe peerAddr
</span><a href="#local-6989586621679256784"><span class="hs-identifier hs-var hs-var">cmIPv6Address</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-566"></span><span>                          </span><span id="local-6989586621679256783"><span class="annot"><span class="annottext">peerAddr -&gt; Maybe AddressType
cmAddressType :: peerAddr -&gt; Maybe AddressType
cmAddressType :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; peerAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679256783"><span class="hs-identifier hs-var hs-var">cmAddressType</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-567"></span><span>                          </span><span id="local-6989586621679256782"><span class="annot"><span class="annottext">Snocket m socket peerAddr
cmSnocket :: Snocket m socket peerAddr
cmSnocket :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var hs-var">cmSnocket</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-568"></span><span>                          </span><span id="local-6989586621679256781"><span class="annot"><span class="annottext">MakeBearer m socket
cmMakeBearer :: MakeBearer m socket
cmMakeBearer :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; MakeBearer m socket
</span><a href="#local-6989586621679256781"><span class="hs-identifier hs-var hs-var">cmMakeBearer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-569"></span><span>                          </span><span id="local-6989586621679256780"><span class="annot"><span class="annottext">socket -&gt; Maybe peerAddr -&gt; m ()
cmConfigureSocket :: socket -&gt; Maybe peerAddr -&gt; m ()
cmConfigureSocket :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; socket -&gt; Maybe peerAddr -&gt; m ()
</span><a href="#local-6989586621679256780"><span class="hs-identifier hs-var hs-var">cmConfigureSocket</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-570"></span><span>                          </span><span id="local-6989586621679256779"><span class="annot"><span class="annottext">DiffTime
cmTimeWaitTimeout :: DiffTime
cmTimeWaitTimeout :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; DiffTime
</span><a href="#local-6989586621679256779"><span class="hs-identifier hs-var hs-var">cmTimeWaitTimeout</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-571"></span><span>                          </span><span id="local-6989586621679256778"><span class="annot"><span class="annottext">DiffTime
cmOutboundIdleTimeout :: DiffTime
cmOutboundIdleTimeout :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; DiffTime
</span><a href="#local-6989586621679256778"><span class="hs-identifier hs-var hs-var">cmOutboundIdleTimeout</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-572"></span><span>                          </span><span id="local-6989586621679256777"><span class="annot"><span class="annottext">version -&gt; DataFlow
connectionDataFlow :: version -&gt; DataFlow
connectionDataFlow :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; version -&gt; DataFlow
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var hs-var">connectionDataFlow</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-573"></span><span>                          </span><span id="local-6989586621679256776"><span class="annot"><span class="annottext">PrunePolicy peerAddr (STM m)
cmPrunePolicy :: PrunePolicy peerAddr (STM m)
cmPrunePolicy :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; PrunePolicy peerAddr (STM m)
</span><a href="#local-6989586621679256776"><span class="hs-identifier hs-var hs-var">cmPrunePolicy</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-574"></span><span>                          </span><span id="local-6989586621679256775"><span class="annot"><span class="annottext">AcceptedConnectionsLimit
cmConnectionsLimits :: AcceptedConnectionsLimit
cmConnectionsLimits :: forall handlerTrace socket peerAddr handle handleError version
       (m :: * -&gt; *).
ConnectionManagerArguments
  handlerTrace socket peerAddr handle handleError version m
-&gt; AcceptedConnectionsLimit
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var hs-var">cmConnectionsLimits</span></a></span></span><span>
</span><span id="line-575"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-576"></span><span>                      </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandler"><span class="hs-identifier hs-type">ConnectionHandler</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-577"></span><span>                          </span><span id="local-6989586621679256773"><span class="annot"><span class="annottext">WithMuxTuple
  muxMode
  (ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m)
connectionHandler :: forall (muxMode :: MuxMode) handlerTrace socket peerAddr handle
       handleError version (m :: * -&gt; *).
ConnectionHandler
  muxMode handlerTrace socket peerAddr handle handleError version m
-&gt; WithMuxTuple
     muxMode
     (ConnectionHandlerFn
        handlerTrace socket peerAddr handle handleError version m)
connectionHandler :: WithMuxTuple
  muxMode
  (ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#connectionHandler"><span class="hs-identifier hs-var hs-var">connectionHandler</span></a></span></span><span>
</span><span id="line-578"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-579"></span><span>                      </span><span id="local-6989586621679256771"><span class="annot"><span class="annottext">handleError -&gt; HandleErrorType
</span><a href="#local-6989586621679256771"><span class="hs-identifier hs-var">classifyHandleError</span></a></span></span><span>
</span><span id="line-580"></span><span>                      </span><span id="local-6989586621679256770"><span class="annot"><span class="annottext">InResponderMode muxMode (ControlChannel peerAddr handle m)
</span><a href="#local-6989586621679256770"><span class="hs-identifier hs-var">inboundGovernorControlChannel</span></a></span></span><span>
</span><span id="line-581"></span><span>                      </span><span id="local-6989586621679256769"><span class="annot"><span class="annottext">ConnectionManager muxMode socket peerAddr handle handleError m
-&gt; m a
</span><a href="#local-6989586621679256769"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679256768"><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">freshIdSupply</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256767"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>       </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-584"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-585"></span><span>                                                   </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>           </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (FreshIdSupply m,
   StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m))
-&gt; m (FreshIdSupply m,
      StrictTMVar
        m (ConnectionManagerState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (FreshIdSupply m,
    StrictTMVar
      m (ConnectionManagerState peerAddr handle handleError version m))
 -&gt; m (FreshIdSupply m,
       StrictTMVar
         m (ConnectionManagerState peerAddr handle handleError version m)))
-&gt; STM
     m
     (FreshIdSupply m,
      StrictTMVar
        m (ConnectionManagerState peerAddr handle handleError version m))
-&gt; m (FreshIdSupply m,
      StrictTMVar
        m (ConnectionManagerState peerAddr handle handleError version m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-588"></span><span>          </span><span id="local-6989586621679256765"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m
     (StrictTMVar
        m (ConnectionManagerState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (StrictTMVar m a)
</span><span class="hs-identifier hs-var">newTMVar</span></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
forall k a. Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-589"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; String -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
StrictTMVar m a -&gt; String -&gt; STM m ()
</span><span class="hs-identifier hs-var">labelTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cm-state&quot;</span></span><span>
</span><span id="line-590"></span><span>          </span><span class="annot"><span class="annottext">Proxy m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (Maybe
      (Maybe
         (ConnectionManagerState peerAddr handle handleError version m))
    -&gt; Maybe
         (ConnectionManagerState peerAddr handle handleError version m)
    -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall (m :: * -&gt; *) (proxy :: (* -&gt; *) -&gt; *) a.
MonadTraceSTM m =&gt;
proxy m
-&gt; StrictTMVar m a
-&gt; (Maybe (Maybe a) -&gt; Maybe a -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
</span><span class="hs-identifier hs-var">traceTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy m
forall k (t :: k). Proxy t
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-591"></span><span>                   </span><span class="annot"><span class="annottext">((Maybe
    (Maybe
       (ConnectionManagerState peerAddr handle handleError version m))
  -&gt; Maybe
       (ConnectionManagerState peerAddr handle handleError version m)
  -&gt; InspectMonad m TraceValue)
 -&gt; STM m ())
-&gt; (Maybe
      (Maybe
         (ConnectionManagerState peerAddr handle handleError version m))
    -&gt; Maybe
         (ConnectionManagerState peerAddr handle handleError version m)
    -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256759"><span class="annot"><span class="annottext">Maybe
  (Maybe
     (ConnectionManagerState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256759"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679256758"><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256758"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-592"></span><span>                     </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Maybe
     (ConnectionManagerState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256759"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256758"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-593"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Maybe
     (ConnectionManagerState peerAddr handle handleError version m))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TraceValue -&gt; InspectMonad m TraceValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TraceValue
</span><span class="hs-identifier hs-var">DontTrace</span></span><span>
</span><span id="line-594"></span><span>                       </span><span class="hs-comment">-- taken</span><span>
</span><span id="line-595"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TraceValue -&gt; InspectMonad m TraceValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TraceValue
</span><span class="hs-identifier hs-var">TraceString</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cm-state: taken&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>                       </span><span class="hs-comment">-- released</span><span>
</span><span id="line-597"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TraceValue -&gt; InspectMonad m TraceValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TraceValue
</span><span class="hs-identifier hs-var">TraceString</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cm-state: released&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Maybe
     (ConnectionManagerState peerAddr handle handleError version m))
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (ConnectionManagerState peerAddr handle handleError version m)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TraceValue -&gt; InspectMonad m TraceValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TraceValue
</span><span class="hs-identifier hs-var">DontTrace</span></span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>          </span><span id="local-6989586621679256755"><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256755"><span class="hs-identifier hs-var">freshIdSupply</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Proxy m -&gt; STM m (FreshIdSupply m)
forall (m :: * -&gt; *).
MonadSTM m =&gt;
Proxy m -&gt; STM m (FreshIdSupply m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#newFreshIdSupply"><span class="hs-identifier hs-var">newFreshIdSupply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy m
forall k (t :: k). Proxy t
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>          </span><span class="annot"><span class="annottext">(FreshIdSupply m,
 StrictTMVar
   m (ConnectionManagerState peerAddr handle handleError version m))
-&gt; STM
     m
     (FreshIdSupply m,
      StrictTMVar
        m (ConnectionManagerState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256755"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256765"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679256754"><span class="hs-identifier hs-type">readState</span></a></span><span>
</span><span id="line-604"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>        </span><span id="local-6989586621679256754"><span class="annot"><span class="annottext">readState :: m (Map peerAddr AbstractState)
</span><a href="#local-6989586621679256754"><span class="hs-identifier hs-var hs-var">readState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">STM m (Map peerAddr AbstractState)
-&gt; m (Map peerAddr AbstractState)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Map peerAddr AbstractState)
 -&gt; m (Map peerAddr AbstractState))
-&gt; STM m (Map peerAddr AbstractState)
-&gt; m (Map peerAddr AbstractState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-607"></span><span>              </span><span id="local-6989586621679256753"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256753"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-608"></span><span>              </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m AbstractState)
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m (Map peerAddr AbstractState)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m
 -&gt; AbstractState)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m AbstractState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; (ConnectionState peerAddr handle handleError version m
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; AbstractState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>                       </span><span class="annot"><span class="annottext">(STM m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m AbstractState)
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m AbstractState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span>
</span><span id="line-610"></span><span>                       </span><span class="annot"><span class="annottext">(StrictTVar
   m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; StrictTVar
         m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span>
</span><span id="line-611"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>                       </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256753"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>        </span><span class="annot"><a href="#local-6989586621679256750"><span class="hs-identifier hs-type">connectionManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256797"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-615"></span><span>                                               </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-616"></span><span>        </span><span id="local-6989586621679256750"><span class="annot"><span class="annottext">connectionManager :: ConnectionManager muxMode socket peerAddr handle handleError m
</span><a href="#local-6989586621679256750"><span class="hs-identifier hs-var hs-var">connectionManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-617"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithMuxTuple
  muxMode
  (ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m)
</span><a href="#local-6989586621679256773"><span class="hs-identifier hs-var">connectionHandler</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#WithInitiatorMode"><span class="hs-identifier hs-type">WithInitiatorMode</span></a></span><span> </span><span id="local-6989586621679256748"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256748"><span class="hs-identifier hs-var">outboundHandler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-619"></span><span>              </span><span class="annot"><span class="annottext">ConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
-&gt; m (Map peerAddr AbstractState)
-&gt; ConnectionManager muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-620"></span><span>                </span><span class="annot"><span class="annottext">getConnectionManager :: WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#getConnectionManager"><span class="hs-identifier hs-var">getConnectionManager</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-621"></span><span>                  </span><span class="annot"><span class="annottext">OutboundConnectionManager
  muxMode socket peerAddr handle handleError m
-&gt; WithMuxMode
     'InitiatorMode
     (OutboundConnectionManager
        muxMode socket peerAddr handle handleError m)
     (InboundConnectionManager
        muxMode socket peerAddr handle handleError m)
forall a b. a -&gt; WithMuxMode 'InitiatorMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithInitiatorMode"><span class="hs-identifier hs-var">WithInitiatorMode</span></a></span><span>
</span><span id="line-622"></span><span>                    </span><span class="annot"><span class="annottext">OutboundConnectionManager :: forall (muxMode :: MuxMode) peerAddr handle handleError
       (m :: * -&gt; *) socket.
(HasInitiator muxMode ~ 'True) =&gt;
RequestOutboundConnection peerAddr handle handleError m
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; OutboundConnectionManager
     muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundConnectionManager"><span class="hs-identifier hs-type">OutboundConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-623"></span><span>                        </span><span class="annot"><span class="annottext">ocmRequestConnection :: RequestOutboundConnection peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ocmRequestConnection"><span class="hs-identifier hs-var">ocmRequestConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-624"></span><span>                          </span><span class="annot"><span class="annottext">HasCallStack =&gt;
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; RequestOutboundConnection peerAddr handle handleError m
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; RequestOutboundConnection peerAddr handle handleError m
</span><a href="#local-6989586621679256743"><span class="hs-identifier hs-var">requestOutboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-625"></span><span>                                                        </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256748"><span class="hs-identifier hs-var">outboundHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-626"></span><span>                        </span><span class="annot"><span class="annottext">ocmUnregisterConnection :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ocmUnregisterConnection"><span class="hs-identifier hs-var">ocmUnregisterConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-627"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256741"><span class="hs-identifier hs-var">unregisterOutboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-628"></span><span>                      </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-629"></span><span>                </span><span class="annot"><span class="annottext">m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#readState"><span class="hs-identifier hs-var hs-var">readState</span></a></span><span>
</span><span id="line-630"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-631"></span><span>
</span><span id="line-632"></span><span>            </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#WithResponderMode"><span class="hs-identifier hs-type">WithResponderMode</span></a></span><span> </span><span id="local-6989586621679256738"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256738"><span class="hs-identifier hs-var">inboundHandler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-633"></span><span>              </span><span class="annot"><span class="annottext">ConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
-&gt; m (Map peerAddr AbstractState)
-&gt; ConnectionManager muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-634"></span><span>                </span><span class="annot"><span class="annottext">getConnectionManager :: WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#getConnectionManager"><span class="hs-identifier hs-var">getConnectionManager</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-635"></span><span>                  </span><span class="annot"><span class="annottext">InboundConnectionManager
  muxMode socket peerAddr handle handleError m
-&gt; WithMuxMode
     'ResponderMode
     (OutboundConnectionManager
        muxMode socket peerAddr handle handleError m)
     (InboundConnectionManager
        muxMode socket peerAddr handle handleError m)
forall b a. b -&gt; WithMuxMode 'ResponderMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithResponderMode"><span class="hs-identifier hs-var">WithResponderMode</span></a></span><span>
</span><span id="line-636"></span><span>                    </span><span class="annot"><span class="annottext">InboundConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
(HasResponder muxMode ~ 'True) =&gt;
IncludeInboundConnection socket peerAddr handle handleError m
-&gt; (peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr))
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; STM m Int
-&gt; InboundConnectionManager
     muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#InboundConnectionManager"><span class="hs-identifier hs-type">InboundConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-637"></span><span>                        </span><span class="annot"><span class="annottext">icmIncludeConnection :: IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmIncludeConnection"><span class="hs-identifier hs-var">icmIncludeConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-638"></span><span>                          </span><span class="annot"><span class="annottext">HasCallStack =&gt;
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var">includeInboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-639"></span><span>                                                       </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256738"><span class="hs-identifier hs-var">inboundHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-640"></span><span>                        </span><span class="annot"><span class="annottext">icmUnregisterConnection :: peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmUnregisterConnection"><span class="hs-identifier hs-var">icmUnregisterConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-641"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr)
</span><a href="#local-6989586621679256733"><span class="hs-identifier hs-var">unregisterInboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-642"></span><span>                        </span><span class="annot"><span class="annottext">icmPromotedToWarmRemote :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmPromotedToWarmRemote"><span class="hs-identifier hs-var">icmPromotedToWarmRemote</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-643"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var">promotedToWarmRemoteImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-644"></span><span>                        </span><span class="annot"><span class="annottext">icmDemotedToColdRemote :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmDemotedToColdRemote"><span class="hs-identifier hs-var">icmDemotedToColdRemote</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-645"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256729"><span class="hs-identifier hs-var">demotedToColdRemoteImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-646"></span><span>                        </span><span class="annot"><span class="annottext">icmNumberOfConnections :: STM m Int
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmNumberOfConnections"><span class="hs-identifier hs-var">icmNumberOfConnections</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-647"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM m Int)
-&gt; STM m Int
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span>
</span><span id="line-648"></span><span>                      </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-649"></span><span>                </span><span class="annot"><span class="annottext">m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#readState"><span class="hs-identifier hs-var hs-var">readState</span></a></span><span>
</span><span id="line-650"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span>            </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#WithInitiatorResponderMode"><span class="hs-identifier hs-type">WithInitiatorResponderMode</span></a></span><span> </span><span id="local-6989586621679256725"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256725"><span class="hs-identifier hs-var">outboundHandler</span></a></span></span><span> </span><span id="local-6989586621679256724"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256724"><span class="hs-identifier hs-var">inboundHandler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-653"></span><span>              </span><span class="annot"><span class="annottext">ConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
-&gt; m (Map peerAddr AbstractState)
-&gt; ConnectionManager muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-654"></span><span>                </span><span class="annot"><span class="annottext">getConnectionManager :: WithMuxMode
  muxMode
  (OutboundConnectionManager
     muxMode socket peerAddr handle handleError m)
  (InboundConnectionManager
     muxMode socket peerAddr handle handleError m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#getConnectionManager"><span class="hs-identifier hs-var">getConnectionManager</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-655"></span><span>                  </span><span class="annot"><span class="annottext">OutboundConnectionManager
  muxMode socket peerAddr handle handleError m
-&gt; InboundConnectionManager
     muxMode socket peerAddr handle handleError m
-&gt; WithMuxMode
     'InitiatorResponderMode
     (OutboundConnectionManager
        muxMode socket peerAddr handle handleError m)
     (InboundConnectionManager
        muxMode socket peerAddr handle handleError m)
forall a b. a -&gt; b -&gt; WithMuxMode 'InitiatorResponderMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithInitiatorResponderMode"><span class="hs-identifier hs-var">WithInitiatorResponderMode</span></a></span><span>
</span><span id="line-656"></span><span>                    </span><span class="annot"><span class="annottext">OutboundConnectionManager :: forall (muxMode :: MuxMode) peerAddr handle handleError
       (m :: * -&gt; *) socket.
(HasInitiator muxMode ~ 'True) =&gt;
RequestOutboundConnection peerAddr handle handleError m
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; OutboundConnectionManager
     muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OutboundConnectionManager"><span class="hs-identifier hs-type">OutboundConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-657"></span><span>                        </span><span class="annot"><span class="annottext">ocmRequestConnection :: RequestOutboundConnection peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ocmRequestConnection"><span class="hs-identifier hs-var">ocmRequestConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-658"></span><span>                          </span><span class="annot"><span class="annottext">HasCallStack =&gt;
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; RequestOutboundConnection peerAddr handle handleError m
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; RequestOutboundConnection peerAddr handle handleError m
</span><a href="#local-6989586621679256743"><span class="hs-identifier hs-var">requestOutboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-659"></span><span>                                                        </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256725"><span class="hs-identifier hs-var">outboundHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-660"></span><span>                        </span><span class="annot"><span class="annottext">ocmUnregisterConnection :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ocmUnregisterConnection"><span class="hs-identifier hs-var">ocmUnregisterConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-661"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256741"><span class="hs-identifier hs-var">unregisterOutboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-662"></span><span>                      </span><span class="hs-special">}</span><span>
</span><span id="line-663"></span><span>                    </span><span class="annot"><span class="annottext">InboundConnectionManager :: forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
(HasResponder muxMode ~ 'True) =&gt;
IncludeInboundConnection socket peerAddr handle handleError m
-&gt; (peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr))
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; (peerAddr -&gt; m (OperationResult AbstractState))
-&gt; STM m Int
-&gt; InboundConnectionManager
     muxMode socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#InboundConnectionManager"><span class="hs-identifier hs-type">InboundConnectionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-664"></span><span>                        </span><span class="annot"><span class="annottext">icmIncludeConnection :: IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmIncludeConnection"><span class="hs-identifier hs-var">icmIncludeConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-665"></span><span>                          </span><span class="annot"><span class="annottext">HasCallStack =&gt;
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var">includeInboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256768"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-666"></span><span>                                                       </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256724"><span class="hs-identifier hs-var">inboundHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-667"></span><span>                        </span><span class="annot"><span class="annottext">icmUnregisterConnection :: peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmUnregisterConnection"><span class="hs-identifier hs-var">icmUnregisterConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-668"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr)
</span><a href="#local-6989586621679256733"><span class="hs-identifier hs-var">unregisterInboundConnectionImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-669"></span><span>                        </span><span class="annot"><span class="annottext">icmPromotedToWarmRemote :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmPromotedToWarmRemote"><span class="hs-identifier hs-var">icmPromotedToWarmRemote</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-670"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var">promotedToWarmRemoteImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-671"></span><span>                        </span><span class="annot"><span class="annottext">icmDemotedToColdRemote :: peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmDemotedToColdRemote"><span class="hs-identifier hs-var">icmDemotedToColdRemote</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-672"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256729"><span class="hs-identifier hs-var">demotedToColdRemoteImpl</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-673"></span><span>                        </span><span class="annot"><span class="annottext">icmNumberOfConnections :: STM m Int
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#icmNumberOfConnections"><span class="hs-identifier hs-var">icmNumberOfConnections</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-674"></span><span>                          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM m Int)
-&gt; STM m Int
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span>
</span><span id="line-675"></span><span>                      </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-676"></span><span>                </span><span class="annot"><span class="annottext">m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
readState :: m (Map peerAddr AbstractState)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#readState"><span class="hs-identifier hs-var hs-var">readState</span></a></span><span>
</span><span id="line-677"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><span class="annottext">ConnectionManager muxMode socket peerAddr handle handleError m
-&gt; m a
</span><a href="#local-6989586621679256769"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager muxMode socket peerAddr handle handleError m
</span><a href="#local-6989586621679256750"><span class="hs-identifier hs-var">connectionManager</span></a></span><span>
</span><span id="line-680"></span><span>      </span><span class="hs-comment">-- Since this exception handler is blocking it might receive exceptions</span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-comment">-- during its execution, which we want to avoid, so we wrap it around</span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-comment">-- uninterruptibleMask_.</span><span>
</span><span id="line-683"></span><span>      </span><span class="annot"><span class="annottext">m a -&gt; m () -&gt; m a
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">uninterruptibleMask_</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-684"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrShutdown"><span class="hs-identifier hs-var">TrShutdown</span></a></span><span>
</span><span id="line-685"></span><span>
</span><span id="line-686"></span><span>        </span><span id="local-6989586621679256720"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256720"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m (ConnectionManagerState peerAddr handle handleError version m)
 -&gt; m (ConnectionManagerState
         peerAddr handle handleError version m))
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m (ConnectionManagerState peerAddr handle handleError version m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256767"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-687"></span><span>        </span><span class="hs-comment">-- Spawning one thread for each connection cleanup avoids spending time</span><span>
</span><span id="line-688"></span><span>        </span><span class="hs-comment">-- waiting for locks and cleanup logic that could delay closing the</span><span>
</span><span id="line-689"></span><span>        </span><span class="hs-comment">-- connections and making us not respecting certain timeouts.</span><span>
</span><span id="line-690"></span><span>        </span><span id="local-6989586621679256719"><span class="annot"><span class="annottext">[Async m ()]
</span><a href="#local-6989586621679256719"><span class="hs-identifier hs-var">asyncs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map peerAddr (Async m ()) -&gt; [Async m ()]
forall k a. Map k a -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span>
</span><span id="line-691"></span><span>          </span><span class="annot"><span class="annottext">(Map peerAddr (Async m ()) -&gt; [Async m ()])
-&gt; m (Map peerAddr (Async m ())) -&gt; m [Async m ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(peerAddr
 -&gt; MutableConnState peerAddr handle handleError version m
 -&gt; m (Maybe (Async m ())))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; m (Map peerAddr (Async m ()))
forall (f :: * -&gt; *) k a b.
Applicative f =&gt;
(k -&gt; a -&gt; f (Maybe b)) -&gt; Map k a -&gt; f (Map k b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.traverseMaybeWithKey</span></a></span><span>
</span><span id="line-692"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256716"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256716"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256715"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256715"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>            </span><span class="hs-comment">-- cleanup handler for that thread will close socket associated</span><span>
</span><span id="line-694"></span><span>            </span><span class="hs-comment">-- with the thread.  We put each connection in 'TerminatedState' to</span><span>
</span><span id="line-695"></span><span>            </span><span class="hs-comment">-- try that none of the connection threads will enter</span><span>
</span><span id="line-696"></span><span>            </span><span class="hs-comment">-- 'TerminatingState' (and thus delay shutdown for 'tcp_WAIT_TIME'</span><span>
</span><span id="line-697"></span><span>            </span><span class="hs-comment">-- seconds) when receiving the 'AsyncCancelled' exception. However,</span><span>
</span><span id="line-698"></span><span>            </span><span class="hs-comment">-- we can have a race between the finally handler and the `cleanup`</span><span>
</span><span id="line-699"></span><span>            </span><span class="hs-comment">-- callback. If the finally block loses the race, the received</span><span>
</span><span id="line-700"></span><span>            </span><span class="hs-comment">-- 'AsyncCancelled' should interrupt the 'threadDelay'.</span><span>
</span><span id="line-701"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-702"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256714"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256714"><span class="hs-identifier hs-var">connState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256713"><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256713"><span class="hs-identifier hs-var">trT</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256712"><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256712"><span class="hs-identifier hs-var">trU</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256711"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256711"><span class="hs-identifier hs-var">shouldTraceTerminated</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256710"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256710"><span class="hs-identifier hs-var">shouldTraceUnknown</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (ConnectionState peerAddr handle handleError version m,
   TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m),
   TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m),
   Bool, Bool)
-&gt; m (ConnectionState peerAddr handle handleError version m,
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      Bool, Bool)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (ConnectionState peerAddr handle handleError version m,
    TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m),
    TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m),
    Bool, Bool)
 -&gt; m (ConnectionState peerAddr handle handleError version m,
       TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m),
       TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m),
       Bool, Bool))
-&gt; STM
     m
     (ConnectionState peerAddr handle handleError version m,
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      Bool, Bool)
-&gt; m (ConnectionState peerAddr handle handleError version m,
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      Bool, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-704"></span><span>                  </span><span id="local-6989586621679256709"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256709"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256715"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-705"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256708"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256708"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-706"></span><span>                      </span><span id="local-6989586621679256707"><span class="annot"><span class="annottext">trT :: TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256707"><span class="hs-identifier hs-var hs-var">trT</span></a></span></span><span>                   </span><span class="hs-glyph">=</span><span>
</span><span id="line-707"></span><span>                        </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256716"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256709"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256708"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span>                      </span><span id="local-6989586621679256704"><span class="annot"><span class="annottext">absConnState :: AbstractState
</span><a href="#local-6989586621679256704"><span class="hs-identifier hs-var hs-var">absConnState</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256709"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>                      </span><span id="local-6989586621679256703"><span class="annot"><span class="annottext">shouldTraceTerminated :: Bool
</span><a href="#local-6989586621679256703"><span class="hs-identifier hs-var hs-var">shouldTraceTerminated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256704"><span class="hs-identifier hs-var">absConnState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-710"></span><span>                      </span><span id="local-6989586621679256701"><span class="annot"><span class="annottext">shouldTraceUnknown :: Bool
</span><a href="#local-6989586621679256701"><span class="hs-identifier hs-var hs-var">shouldTraceUnknown</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256704"><span class="hs-identifier hs-var">absConnState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ReservedOutboundSt"><span class="hs-identifier hs-var">ReservedOutboundSt</span></a></span><span>
</span><span id="line-711"></span><span>                      </span><span id="local-6989586621679256700"><span class="annot"><span class="annottext">trU :: TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256700"><span class="hs-identifier hs-var hs-var">trU</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-712"></span><span>                              </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256716"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-713"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256708"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-714"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-715"></span><span>                                          </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256715"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256708"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-718"></span><span>                  </span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m,
 TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m),
 TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m),
 Bool, Bool)
-&gt; STM
     m
     (ConnectionState peerAddr handle handleError version m,
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m),
      Bool, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256709"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256707"><span class="hs-identifier hs-var">trT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256700"><span class="hs-identifier hs-var">trU</span></a></span><span>
</span><span id="line-719"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256703"><span class="hs-identifier hs-var">shouldTraceTerminated</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256701"><span class="hs-identifier hs-var">shouldTraceUnknown</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256711"><span class="hs-identifier hs-var">shouldTraceTerminated</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-722"></span><span>              </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256713"><span class="hs-identifier hs-var">trT</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span>              </span><span class="hs-comment">-- If an Async exception is received after a connection gets set</span><span>
</span><span id="line-725"></span><span>              </span><span class="hs-comment">-- to ReservedOutboundSt, BUT after a connect call is made and,</span><span>
</span><span id="line-726"></span><span>              </span><span class="hs-comment">-- therefore still does not have a connection handler thread, we</span><span>
</span><span id="line-727"></span><span>              </span><span class="hs-comment">-- should trace the unknown transition as well.</span><span>
</span><span id="line-728"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256710"><span class="hs-identifier hs-var">shouldTraceUnknown</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-729"></span><span>                </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256712"><span class="hs-identifier hs-var">trU</span></a></span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span>            </span><span class="hs-comment">-- using 'throwTo' here, since we want to block only until connection</span><span>
</span><span id="line-732"></span><span>            </span><span class="hs-comment">-- handler thread receives an exception so as to not take up extra</span><span>
</span><span id="line-733"></span><span>            </span><span class="hs-comment">-- time and making us go above timeout schedules.</span><span>
</span><span id="line-734"></span><span>            </span><span class="annot"><span class="annottext">(Async m () -&gt; m (Async m ()))
-&gt; Maybe (Async m ()) -&gt; m (Maybe (Async m ()))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span>
</span><span id="line-735"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256696"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256696"><span class="hs-identifier hs-var">thread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-736"></span><span>                </span><span class="annot"><span class="annottext">ThreadId m -&gt; AsyncCancelled -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256696"><span class="hs-identifier hs-var">thread</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span>
</span><span id="line-737"></span><span>                </span><span class="annot"><span class="annottext">Async m () -&gt; m (Async m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256696"><span class="hs-identifier hs-var">thread</span></a></span><span>
</span><span id="line-738"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Maybe (Async m ())
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
-&gt; Maybe (Async m ())
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256714"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>          </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256720"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LastToFinishM (STM m) () -&gt; STM m ()
forall (m :: * -&gt; *) a. LastToFinishM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier hs-var hs-var">runLastToFinishM</span></a></span><span>
</span><span id="line-743"></span><span>                   </span><span class="annot"><span class="annottext">(LastToFinishM (STM m) () -&gt; STM m ())
-&gt; LastToFinishM (STM m) () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Async m () -&gt; LastToFinishM (STM m) ())
-&gt; [Async m ()] -&gt; LastToFinishM (STM m) ()
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM m () -&gt; LastToFinishM (STM m) ()
forall (m :: * -&gt; *) a. m a -&gt; LastToFinishM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier hs-var">LastToFinishM</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; LastToFinishM (STM m) ())
-&gt; (STM m (Either SomeException ()) -&gt; STM m ())
-&gt; STM m (Either SomeException ())
-&gt; LastToFinishM (STM m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Either SomeException ()) -&gt; STM m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (Either SomeException ()) -&gt; LastToFinishM (STM m) ())
-&gt; (Async m () -&gt; STM m (Either SomeException ()))
-&gt; Async m ()
-&gt; LastToFinishM (STM m) ()
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; STM m (Either SomeException ())
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
Async m a -&gt; STM m (Either SomeException a)
</span><span class="hs-identifier hs-var">waitCatchSTM</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Async m ()]
</span><a href="#local-6989586621679256719"><span class="hs-identifier hs-var">asyncs</span></a></span><span>
</span><span id="line-744"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-746"></span><span>    </span><span class="annot"><a href="#local-6989586621679256690"><span class="hs-identifier hs-type">traceCounters</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>    </span><span id="local-6989586621679256690"><span class="annot"><span class="annottext">traceCounters :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var hs-var">traceCounters</span></a></span></span><span> </span><span id="local-6989586621679256689"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256689"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>      </span><span id="local-6989586621679256688"><span class="annot"><span class="annottext">Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256688"><span class="hs-identifier hs-var">mState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Map
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; m (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Map
      peerAddr (ConnectionState peerAddr handle handleError version m))
 -&gt; m (Map
         peerAddr (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; m (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256689"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM
         m
         (Map
            peerAddr (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m
     (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">(StrictTVar
   m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; StrictTVar
         m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerCounters
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionManagerCounters
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionManagerCounters"><span class="hs-identifier hs-var">TrConnectionManagerCounters</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
forall peerAddr handle handleError version (m :: * -&gt; *).
Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionManagerStateToCounters"><span class="hs-identifier hs-var">connectionManagerStateToCounters</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256688"><span class="hs-identifier hs-var">mState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>    </span><span class="annot"><a href="#local-6989586621679256727"><span class="hs-identifier hs-type">countIncomingConnections</span></a></span><span>
</span><span id="line-752"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-753"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-754"></span><span>    </span><span id="local-6989586621679256727"><span class="annot"><span class="annottext">countIncomingConnections :: ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var hs-var">countIncomingConnections</span></a></span></span><span> </span><span id="local-6989586621679256686"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256686"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-755"></span><span>          </span><span class="annot"><span class="annottext">ConnectionManagerCounters -&gt; Int
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#inboundConns"><span class="hs-identifier hs-var hs-var">inboundConns</span></a></span><span>
</span><span id="line-756"></span><span>        </span><span class="annot"><span class="annottext">(ConnectionManagerCounters -&gt; Int)
-&gt; (Map
      peerAddr (ConnectionState peerAddr handle handleError version m)
    -&gt; ConnectionManagerCounters)
-&gt; Map
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
forall peerAddr handle handleError version (m :: * -&gt; *).
Map
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionManagerCounters
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionManagerStateToCounters"><span class="hs-identifier hs-var">connectionManagerStateToCounters</span></a></span><span>
</span><span id="line-757"></span><span>      </span><span class="annot"><span class="annottext">(Map
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; Int)
-&gt; STM
     m
     (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; STM m Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m
     (Map
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">(StrictTVar
   m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; StrictTVar
         m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256686"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span>    </span><span class="hs-comment">-- Fork connection thread.</span><span>
</span><span id="line-761"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-762"></span><span>    </span><span class="hs-comment">-- TODO: We could probably elegantly eliminate 'PromiseWriter', now that we use</span><span>
</span><span id="line-763"></span><span>    </span><span class="hs-comment">-- MonadFix.</span><span>
</span><span id="line-764"></span><span>    </span><span class="annot"><a href="#local-6989586621679256684"><span class="hs-identifier hs-type">forkConnectionHandler</span></a></span><span>
</span><span id="line-765"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-769"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#PromiseWriter"><span class="hs-identifier hs-type">PromiseWriter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandlerFn"><span class="hs-identifier hs-type">ConnectionHandlerFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-771"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>    </span><span id="local-6989586621679256684"><span class="annot"><span class="annottext">forkConnectionHandler :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; socket
-&gt; ConnectionId peerAddr
-&gt; PromiseWriter m (Either handleError (handle, version))
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; m (Async m ())
</span><a href="#local-6989586621679256684"><span class="hs-identifier hs-var hs-var">forkConnectionHandler</span></a></span></span><span> </span><span id="local-6989586621679256683"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256683"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span>
</span><span id="line-773"></span><span>                          </span><span id="local-6989586621679256682"><span class="annot"><span class="annottext">mutableConnState :: MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256682"><span class="hs-identifier hs-var">mutableConnState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256681"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-774"></span><span>                          </span><span id="local-6989586621679256680"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256680"><span class="hs-identifier hs-var">socket</span></a></span></span><span>
</span><span id="line-775"></span><span>                          </span><span id="local-6989586621679256679"><span class="annot"><span class="annottext">connId :: ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">remoteAddress :: forall addr. ConnectionId addr -&gt; addr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679256676"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-776"></span><span>                          </span><span id="local-6989586621679256675"><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256675"><span class="hs-identifier hs-var">writer</span></a></span></span><span>
</span><span id="line-777"></span><span>                          </span><span id="local-6989586621679256674"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256674"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-778"></span><span>        </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m (Async m ())) -&gt; m (Async m ())
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m (Async m ())) -&gt; m (Async m ()))
-&gt; ((forall a. m a -&gt; m a) -&gt; m (Async m ())) -&gt; m (Async m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256672"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679256672"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (Async m ())
forall (m :: * -&gt; *) a. MonadAsync m =&gt; m a -&gt; m (Async m a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (Async m ())) -&gt; m () -&gt; m (Async m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-779"></span><span>          </span><span class="annot"><span class="annottext">MaskedAction m () -&gt; (forall a. m a -&gt; m a) -&gt; m ()
forall (m :: * -&gt; *) a.
MaskedAction m a -&gt; (forall x. m x -&gt; m x) -&gt; m a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#runWithUnmask"><span class="hs-identifier hs-var hs-var">runWithUnmask</span></a></span><span>
</span><span id="line-780"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256674"><span class="hs-identifier hs-var">handler</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256680"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256675"><span class="hs-identifier hs-var">writer</span></a></span><span>
</span><span id="line-781"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; handlerTrace -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; handlerTrace -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionHandler"><span class="hs-identifier hs-var">TrConnectionHandler</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">(handlerTrace -&gt; ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Tracer m handlerTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>                     </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span>
</span><span id="line-783"></span><span>                     </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256668"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256668"><span class="hs-identifier hs-var">bearerTimeout</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-784"></span><span>                       </span><span class="annot"><span class="annottext">MakeBearer m socket
-&gt; DiffTime -&gt; Tracer m MuxTrace -&gt; socket -&gt; m (MuxBearer m)
forall (m :: * -&gt; *) fd.
MakeBearer m fd
-&gt; DiffTime -&gt; Tracer m MuxTrace -&gt; fd -&gt; m (MuxBearer m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var hs-var">getBearer</span></a></span><span> </span><span class="annot"><span class="annottext">MakeBearer m socket
</span><a href="#local-6989586621679256781"><span class="hs-identifier hs-var">cmMakeBearer</span></a></span><span>
</span><span id="line-785"></span><span>                         </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256668"><span class="hs-identifier hs-var">bearerTimeout</span></a></span><span>
</span><span id="line-786"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace
forall peerid a. peerid -&gt; a -&gt; WithMuxBearer peerid a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/network-mux-0.3.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">WithMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">(MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m MuxTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="#local-6989586621679256786"><span class="hs-identifier hs-var">muxTracer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>            </span><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679256672"><span class="hs-identifier hs-var">unmask</span></a></span><span>
</span><span id="line-788"></span><span>          </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679256665"><span class="hs-identifier hs-var">cleanup</span></a></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-790"></span><span>        </span><span class="annot"><a href="#local-6989586621679256665"><span class="hs-identifier hs-type">cleanup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>        </span><span id="local-6989586621679256665"><span class="annot"><span class="annottext">cleanup :: m ()
</span><a href="#local-6989586621679256665"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-792"></span><span>          </span><span class="hs-comment">-- We must ensure that we update 'connVar',</span><span>
</span><span id="line-793"></span><span>          </span><span class="hs-comment">-- `requestOutboundConnection` might be blocked on it awaiting for:</span><span>
</span><span id="line-794"></span><span>          </span><span class="hs-comment">-- - handshake negotiation; or</span><span>
</span><span id="line-795"></span><span>          </span><span class="hs-comment">-- - `Terminate: TerminatingState &#8594; TerminatedState` transition.</span><span>
</span><span id="line-796"></span><span>          </span><span class="hs-comment">-- That's why we use 'uninterruptibleMask'. Note that this cleanup</span><span>
</span><span id="line-797"></span><span>          </span><span class="hs-comment">-- function after all is interruptible, because we unmask async</span><span>
</span><span id="line-798"></span><span>          </span><span class="hs-comment">-- exceptions around 'threadDelay', but even if an async exception</span><span>
</span><span id="line-799"></span><span>          </span><span class="hs-comment">-- hits there we will update `connVar`.</span><span>
</span><span id="line-800"></span><span>          </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">uninterruptibleMask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256663"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679256663"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-801"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionCleanup"><span class="hs-identifier hs-var">TrConnectionCleanup</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>            </span><span id="local-6989586621679256661"><span class="annot"><span class="annottext">Either
  ()
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256661"><span class="hs-identifier hs-var">eTransition</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
          Either
            ()
            (Transition'
               (MaybeUnknown
                  (ConnectionState peerAddr handle handleError version m)))))
-&gt; m (Either
        ()
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a b.
(MonadEvaluate m, MonadMask m, MonadSTM m) =&gt;
StrictTMVar m a -&gt; (a -&gt; m (a, b)) -&gt; m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVar"><span class="hs-identifier hs-var">modifyTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256683"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerState peerAddr handle handleError version m
  -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
        Either
          ()
          (Transition'
             (MaybeUnknown
                (ConnectionState peerAddr handle handleError version m)))))
 -&gt; m (Either
         ()
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
          Either
            ()
            (Transition'
               (MaybeUnknown
                  (ConnectionState peerAddr handle handleError version m)))))
-&gt; m (Either
        ()
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256659"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256659"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>              </span><span id="local-6989586621679256658"><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256658"><span class="hs-identifier hs-var">eTransition</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Either
      (Maybe
         (TransitionTrace
            peerAddr (ConnectionState peerAddr handle handleError version m)))
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
 -&gt; m (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>                </span><span id="local-6989586621679256657"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256657"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-805"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256656"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-806"></span><span>                    </span><span id="local-6989586621679256655"><span class="annot"><span class="annottext">transition :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256655"><span class="hs-identifier hs-var hs-var">transition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256657"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-807"></span><span>                    </span><span id="local-6989586621679256654"><span class="annot"><span class="annottext">transitionTrace :: TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var hs-var">transitionTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256655"><span class="hs-identifier hs-var">transition</span></a></span><span>
</span><span id="line-808"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256657"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-809"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-810"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-811"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-813"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-814"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-816"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-817"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-820"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-822"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-823"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-825"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-826"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-828"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-829"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-831"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256656"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-832"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256654"><span class="hs-identifier hs-var">transitionTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-834"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256655"><span class="hs-identifier hs-var">transition</span></a></span><span>
</span><span id="line-835"></span><span>                  </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-836"></span><span>                    </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m)))
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m)))
 -&gt; STM
      m
      (Either
         (Maybe
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m)))
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (Maybe
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m)))
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (Maybe
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m)))
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m)))
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256658"><span class="hs-identifier hs-var">eTransition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-839"></span><span>                </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256653"><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256653"><span class="hs-identifier hs-var">mbTransition</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-840"></span><span>                  </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256653"><span class="hs-identifier hs-var">mbTransition</span></a></span><span>
</span><span id="line-841"></span><span>                  </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256680"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-842"></span><span>                  </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Either
   ()
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))))
-&gt; m (ConnectionManagerState peerAddr handle handleError version m,
      Either
        ()
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256659"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-843"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Either
     ()
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>                </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679256650"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256650"><span class="hs-identifier hs-var">transition</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-846"></span><span>                  </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256680"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-847"></span><span>                  </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Either
   ()
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))))
-&gt; m (ConnectionManagerState peerAddr handle handleError version m,
      Either
        ()
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256659"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-848"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     ()
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256650"><span class="hs-identifier hs-var">transition</span></a></span><span>
</span><span id="line-849"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  ()
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256661"><span class="hs-identifier hs-var">eTransition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-852"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-853"></span><span>                </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span>
</span><span id="line-854"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-855"></span><span>                            </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-856"></span><span>                            </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-857"></span><span>                               </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-859"></span><span>                               </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-860"></span><span>                </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256683"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-861"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679256649"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256649"><span class="hs-identifier hs-var">transition</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-862"></span><span>                </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionTimeWait"><span class="hs-identifier hs-var">TrConnectionTimeWait</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-863"></span><span>                   </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256779"><span class="hs-identifier hs-var">cmTimeWaitTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-864"></span><span>                     </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- make sure we wait at least 'cmTimeWaitTimeout', we</span><span>
</span><span id="line-865"></span><span>                         </span><span class="hs-comment">-- ignore all 'AsyncCancelled' exceptions.</span><span>
</span><span id="line-866"></span><span>                         </span><span id="local-6989586621679256646"><span class="annot"><span class="annottext">forceThreadDelay :: DiffTime -&gt; m ()
</span><a href="#local-6989586621679256646"><span class="hs-identifier hs-var hs-var">forceThreadDelay</span></a></span></span><span> </span><span id="local-6989586621679256645"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256645"><span class="hs-identifier hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256645"><span class="hs-identifier hs-var">delay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-867"></span><span>                         </span><span class="annot"><a href="#local-6989586621679256646"><span class="hs-identifier hs-var">forceThreadDelay</span></a></span><span> </span><span id="local-6989586621679256643"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256643"><span class="hs-identifier hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-868"></span><span>                           </span><span id="local-6989586621679256642"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256642"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-869"></span><span>                           </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679256663"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256643"><span class="hs-identifier hs-var">delay</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>                             </span><span class="annot"><span class="annottext">m () -&gt; (SomeException -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256638"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256638"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-871"></span><span>                                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncCancelled
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256638"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-872"></span><span>                                </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-873"></span><span>                                     </span><span id="local-6989586621679256636"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256636"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-874"></span><span>                                     </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
</span><a href="#local-6989586621679256646"><span class="hs-identifier hs-var">forceThreadDelay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256643"><span class="hs-identifier hs-var">delay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256636"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; DiffTime
</span><span class="hs-operator hs-var">`diffTime`</span></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679256642"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>                                   </span><span class="annot"><span class="annottext">Maybe AsyncCancelled
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256638"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-876"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
</span><a href="#local-6989586621679256646"><span class="hs-identifier hs-var">forceThreadDelay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256779"><span class="hs-identifier hs-var">cmTimeWaitTimeout</span></a></span><span>
</span><span id="line-877"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-878"></span><span>                  </span><span class="hs-comment">-- We must ensure that we update 'connVar',</span><span>
</span><span id="line-879"></span><span>                  </span><span class="hs-comment">-- `requestOutboundConnection` might be blocked on it awaiting for:</span><span>
</span><span id="line-880"></span><span>                  </span><span class="hs-comment">-- - handshake negotiation; or</span><span>
</span><span id="line-881"></span><span>                  </span><span class="hs-comment">-- - `Terminate: TerminatingState &#8594; TerminatedState` transition.</span><span>
</span><span id="line-882"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionTimeWaitDone"><span class="hs-identifier hs-var">TrConnectionTimeWaitDone</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256679"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span>                  </span><span id="local-6989586621679256632"><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256632"><span class="hs-identifier hs-var">trs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  [Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
 -&gt; m [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-885"></span><span>                    </span><span id="local-6989586621679256631"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256631"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-886"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256630"><span class="annot"><span class="annottext">transition' :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256630"><span class="hs-identifier hs-var hs-var">transition'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256649"><span class="hs-identifier hs-var">transition</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256631"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-887"></span><span>                        </span><span id="local-6989586621679256629"><span class="annot"><span class="annottext">shouldTrace :: Bool
</span><a href="#local-6989586621679256629"><span class="hs-identifier hs-var hs-var">shouldTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256631"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>                                   </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-889"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256681"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>                    </span><span class="hs-comment">--  We have to be careful when deleting it from</span><span>
</span><span id="line-891"></span><span>                    </span><span class="hs-comment">--  'ConnectionManagerState'.</span><span>
</span><span id="line-892"></span><span>                    </span><span id="local-6989586621679256628"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256628"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-893"></span><span>                      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; (ConnectionManagerState peerAddr handle handleError version m,
        Bool))
-&gt; STM m Bool
forall (m :: * -&gt; *) a b.
MonadSTM m =&gt;
StrictTMVar m a -&gt; (a -&gt; (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarPure"><span class="hs-identifier hs-var">modifyTMVarPure</span></a></span><span>
</span><span id="line-894"></span><span>                        </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256683"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-895"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256626"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256626"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-896"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256626"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-897"></span><span>                            </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256626"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>                            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256624"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256624"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-899"></span><span>                              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256682"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256624"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-900"></span><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256626"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256626"><span class="hs-identifier hs-var">state</span></a></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span>
</span><span id="line-904"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256628"><span class="hs-identifier hs-var">updated</span></a></span><span>
</span><span id="line-905"></span><span>                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-906"></span><span>                      </span><span class="hs-comment">-- Key was present in the dictionary (stateVar) and</span><span>
</span><span id="line-907"></span><span>                      </span><span class="hs-comment">-- removed so we trace the removal.</span><span>
</span><span id="line-908"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256623"><span class="annot"><span class="annottext">trs :: [Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256623"><span class="hs-identifier hs-var hs-var">trs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-909"></span><span>                                     </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-910"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-911"></span><span>                                     </span><span class="hs-special">}</span><span>
</span><span id="line-912"></span><span>                                  </span><span class="hs-special">]</span><span>
</span><span id="line-913"></span><span>                        </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([Transition'
    (MaybeUnknown
       (ConnectionState peerAddr handle handleError version m))]
 -&gt; STM
      m
      [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-914"></span><span>                          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256629"><span class="hs-identifier hs-var">shouldTrace</span></a></span><span>
</span><span id="line-915"></span><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256630"><span class="hs-identifier hs-var">transition'</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
forall peerAddr handle handleError version (m :: * -&gt; *).
[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256623"><span class="hs-identifier hs-var">trs</span></a></span><span>
</span><span id="line-916"></span><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
forall peerAddr handle handleError version (m :: * -&gt; *).
[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256623"><span class="hs-identifier hs-var">trs</span></a></span><span>
</span><span id="line-917"></span><span>                      </span><span class="hs-comment">-- Key was not present in the dictionary (stateVar),</span><span>
</span><span id="line-918"></span><span>                      </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-919"></span><span>                      </span><span class="hs-comment">-- deletion.</span><span>
</span><span id="line-920"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-921"></span><span>                      </span><span class="hs-comment">-- OR</span><span>
</span><span id="line-922"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-923"></span><span>                      </span><span class="hs-comment">-- Key was overwritten in the dictionary (stateVar),</span><span>
</span><span id="line-924"></span><span>                      </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-925"></span><span>                      </span><span class="hs-comment">-- overwritting.</span><span>
</span><span id="line-926"></span><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-927"></span><span>
</span><span id="line-928"></span><span>                  </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256676"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256632"><span class="hs-identifier hs-var">trs</span></a></span><span>
</span><span id="line-929"></span><span>                  </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256683"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-930"></span><span>
</span><span id="line-931"></span><span>    </span><span class="hs-comment">-- Pruning is done in two stages:</span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-comment">-- * an STM transaction which selects which connections to prune, and sets</span><span>
</span><span id="line-933"></span><span>    </span><span class="hs-comment">--   their state to 'TerminatedState';</span><span>
</span><span id="line-934"></span><span>    </span><span class="hs-comment">-- * an io action which logs and cancells all the connection handler</span><span>
</span><span id="line-935"></span><span>    </span><span class="hs-comment">--   threads.</span><span>
</span><span id="line-936"></span><span>    </span><span class="annot"><a href="#local-6989586621679256622"><span class="hs-identifier hs-type">mkPruneAction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-937"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-938"></span><span>                  </span><span class="hs-comment">-- ^ number of connections to prune</span><span>
</span><span id="line-939"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-940"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-941"></span><span>                  </span><span class="hs-comment">-- ^ next connection state, if it will not be pruned.</span><span>
</span><span id="line-942"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneAction"><span class="hs-identifier hs-type">PruneAction</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>                  </span><span class="hs-comment">-- ^ return if the connection was choose to be prunned and the</span><span>
</span><span id="line-946"></span><span>                  </span><span class="hs-comment">-- 'PruneAction'</span><span>
</span><span id="line-947"></span><span>    </span><span id="local-6989586621679256622"><span class="annot"><span class="annottext">mkPruneAction :: peerAddr
-&gt; Int
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Async m ()
-&gt; STM m (Bool, PruneAction m)
</span><a href="#local-6989586621679256622"><span class="hs-identifier hs-var hs-var">mkPruneAction</span></a></span></span><span> </span><span id="local-6989586621679256621"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256621"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679256620"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256620"><span class="hs-identifier hs-var">numberToPrune</span></a></span></span><span> </span><span id="local-6989586621679256619"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256619"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span id="local-6989586621679256618"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256618"><span class="hs-identifier hs-var">connState'</span></a></span></span><span> </span><span id="local-6989586621679256617"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256617"><span class="hs-identifier hs-var">connVar</span></a></span></span><span> </span><span id="local-6989586621679256616"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256616"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-948"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679256615"><span class="annot"><a href="#local-6989586621679256615"><span class="hs-identifier hs-var">choiceMap'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionType"><span class="hs-identifier hs-type">ConnectionType</span></a></span><span>
</span><span id="line-949"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-951"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span>
</span><span id="line-952"></span><span>                                        </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-953"></span><span>                                        </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-954"></span><span>                                        </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-955"></span><span>                                  </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((peerAddr
  -&gt; MutableConnState peerAddr handle handleError version m
  -&gt; STM
       m
       (Maybe
          (ConnectionType, Async m (),
           StrictTVar
             m (ConnectionState peerAddr handle handleError version m))))
 -&gt; ConnectionManagerState peerAddr handle handleError version m
 -&gt; STM
      m
      (Map
         peerAddr
         (ConnectionType, Async m (),
          StrictTVar
            m (ConnectionState peerAddr handle handleError version m))))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; (peerAddr
    -&gt; MutableConnState peerAddr handle handleError version m
    -&gt; STM
         m
         (Maybe
            (ConnectionType, Async m (),
             StrictTVar
               m (ConnectionState peerAddr handle handleError version m))))
-&gt; STM
     m
     (Map
        peerAddr
        (ConnectionType, Async m (),
         StrictTVar
           m (ConnectionState peerAddr handle handleError version m)))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">(peerAddr
 -&gt; MutableConnState peerAddr handle handleError version m
 -&gt; STM
      m
      (Maybe
         (ConnectionType, Async m (),
          StrictTVar
            m (ConnectionState peerAddr handle handleError version m))))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m
     (Map
        peerAddr
        (ConnectionType, Async m (),
         StrictTVar
           m (ConnectionState peerAddr handle handleError version m)))
forall (f :: * -&gt; *) k a b.
Applicative f =&gt;
(k -&gt; a -&gt; f (Maybe b)) -&gt; Map k a -&gt; f (Map k b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.traverseMaybeWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256619"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((peerAddr
  -&gt; MutableConnState peerAddr handle handleError version m
  -&gt; STM
       m
       (Maybe
          (ConnectionType, Async m (),
           StrictTVar
             m (ConnectionState peerAddr handle handleError version m))))
 -&gt; STM
      m
      (Map
         peerAddr
         (ConnectionType, Async m (),
          StrictTVar
            m (ConnectionState peerAddr handle handleError version m))))
-&gt; (peerAddr
    -&gt; MutableConnState peerAddr handle handleError version m
    -&gt; STM
         m
         (Maybe
            (ConnectionType, Async m (),
             StrictTVar
               m (ConnectionState peerAddr handle handleError version m))))
-&gt; STM
     m
     (Map
        peerAddr
        (ConnectionType, Async m (),
         StrictTVar
           m (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256613"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256613"><span class="hs-identifier hs-var">_peerAddr</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679256612"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256612"><span class="hs-identifier hs-var">connVar'</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-957"></span><span>             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256611"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256611"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-958"></span><span>                 </span><span class="hs-comment">-- this expression returns @Maybe (connType, connThread)@;</span><span>
</span><span id="line-959"></span><span>                 </span><span class="hs-comment">-- 'traverseMaybeWithKey' collects all 'Just' cases.</span><span>
</span><span id="line-960"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m -&gt; Bool
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m -&gt; Bool
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#isInboundConn"><span class="hs-identifier hs-var">isInboundConn</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256611"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-961"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256612"><span class="hs-identifier hs-var">connVar'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ConnectionType
 -&gt; Async m ()
 -&gt; (ConnectionType, Async m (),
     StrictTVar
       m (ConnectionState peerAddr handle handleError version m)))
-&gt; Maybe ConnectionType
-&gt; Maybe
     (Async m ()
      -&gt; (ConnectionType, Async m (),
          StrictTVar
            m (ConnectionState peerAddr handle handleError version m)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Maybe ConnectionType
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
-&gt; Maybe ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256611"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-962"></span><span>                              </span><span class="annot"><span class="annottext">Maybe
  (Async m ()
   -&gt; (ConnectionType, Async m (),
       StrictTVar
         m (ConnectionState peerAddr handle handleError version m)))
-&gt; Maybe (Async m ())
-&gt; Maybe
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Maybe (Async m ())
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
-&gt; Maybe (Async m ())
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnThread"><span class="hs-identifier hs-var">getConnThread</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256611"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-963"></span><span>         </span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m
 -&gt; Maybe
      (ConnectionType, Async m (),
       StrictTVar
         m (ConnectionState peerAddr handle handleError version m)))
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
-&gt; STM
     m
     (Maybe
        (ConnectionType, Async m (),
         StrictTVar
           m (ConnectionState peerAddr handle handleError version m)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256612"><span class="hs-identifier hs-var">connVar'</span></a></span><span>
</span><span id="line-964"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256610"><span class="annot"><span class="annottext">choiceMap :: Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256610"><span class="hs-identifier hs-var hs-var">choiceMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-965"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Maybe ConnectionType
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
-&gt; Maybe ConnectionType
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#getConnType"><span class="hs-identifier hs-var">getConnType</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256618"><span class="hs-identifier hs-var">connState'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-966"></span><span>              </span><span class="annot"><span class="annottext">Maybe ConnectionType
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256615"><span class="hs-identifier hs-var">choiceMap'</span></a></span><span>
</span><span id="line-967"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256609"><span class="annot"><span class="annottext">ConnectionType
</span><a href="#local-6989586621679256609"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; (ConnectionType, Async m (),
    StrictTVar
      m (ConnectionState peerAddr handle handleError version m))
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256621"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionType
</span><a href="#local-6989586621679256609"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256616"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256617"><span class="hs-identifier hs-var">connVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-968"></span><span>                                    </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256615"><span class="hs-identifier hs-var">choiceMap'</span></a></span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span>      </span><span id="local-6989586621679256607"><span class="annot"><span class="annottext">Set peerAddr
</span><a href="#local-6989586621679256607"><span class="hs-identifier hs-var">pruneSet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-971"></span><span>        </span><span class="annot"><span class="annottext">PrunePolicy peerAddr (STM m)
</span><a href="#local-6989586621679256776"><span class="hs-identifier hs-var">cmPrunePolicy</span></a></span><span>
</span><span id="line-972"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679256606"><span class="annot"><span class="annottext">ConnectionType
</span><a href="#local-6989586621679256606"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionType
</span><a href="#local-6989586621679256606"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ConnectionType, Async m (),
  StrictTVar
    m (ConnectionState peerAddr handle handleError version m))
 -&gt; ConnectionType)
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
-&gt; Map peerAddr ConnectionType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256610"><span class="hs-identifier hs-var">choiceMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>          </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256620"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256605"><span class="annot"><span class="annottext">pruneMap :: Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256605"><span class="hs-identifier hs-var hs-var">pruneMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256610"><span class="hs-identifier hs-var">choiceMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
-&gt; Set peerAddr
-&gt; Map
     peerAddr
     (ConnectionType, Async m (),
      StrictTVar
        m (ConnectionState peerAddr handle handleError version m))
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-operator hs-var">`Map.restrictKeys`</span></a></span><span> </span><span class="annot"><span class="annottext">Set peerAddr
</span><a href="#local-6989586621679256607"><span class="hs-identifier hs-var">pruneSet</span></a></span><span>
</span><span id="line-976"></span><span>      </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
-&gt; ((ConnectionType, Async m (),
     StrictTVar
       m (ConnectionState peerAddr handle handleError version m))
    -&gt; STM m ())
-&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256605"><span class="hs-identifier hs-var">pruneMap</span></a></span><span> </span><span class="annot"><span class="annottext">(((ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
  -&gt; STM m ())
 -&gt; STM m ())
-&gt; ((ConnectionType, Async m (),
     StrictTVar
       m (ConnectionState peerAddr handle handleError version m))
    -&gt; STM m ())
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256603"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256603"><span class="hs-identifier hs-var">connVar'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-977"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256603"><span class="hs-identifier hs-var">connVar'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-978"></span><span>
</span><span id="line-979"></span><span>      </span><span class="annot"><span class="annottext">(Bool, PruneAction m) -&gt; STM m (Bool, PruneAction m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256621"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; Set peerAddr -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set peerAddr
</span><a href="#local-6989586621679256607"><span class="hs-identifier hs-var">pruneSet</span></a></span><span>
</span><span id="line-980"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m () -&gt; PruneAction m
forall (m :: * -&gt; *). m () -&gt; PruneAction m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneAction"><span class="hs-identifier hs-var">PruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; PruneAction m) -&gt; m () -&gt; PruneAction m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-981"></span><span>                 </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set peerAddr
-&gt; Int
-&gt; Set peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Set peerAddr
-&gt; Int
-&gt; Set peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrPruneConnections"><span class="hs-identifier hs-var">TrPruneConnections</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
-&gt; Set peerAddr
forall k a. Map k a -&gt; Set k
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256605"><span class="hs-identifier hs-var">pruneMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>                                                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256620"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span>
</span><span id="line-983"></span><span>                                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
-&gt; Set peerAddr
forall k a. Map k a -&gt; Set k
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256610"><span class="hs-identifier hs-var">choiceMap</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>                 </span><span class="hs-comment">-- we don't block until the thread terminates, delivering the</span><span>
</span><span id="line-985"></span><span>                 </span><span class="hs-comment">-- async exception is enough (although in this case, there's no</span><span>
</span><span id="line-986"></span><span>                 </span><span class="hs-comment">-- difference, since we put the connection in 'TerminatedState'</span><span>
</span><span id="line-987"></span><span>                 </span><span class="hs-comment">-- which avoids the 'cmTimeWaitTimeout').</span><span>
</span><span id="line-988"></span><span>                 </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
-&gt; ((ConnectionType, Async m (),
     StrictTVar
       m (ConnectionState peerAddr handle handleError version m))
    -&gt; m ())
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peerAddr
  (ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256605"><span class="hs-identifier hs-var">pruneMap</span></a></span><span> </span><span class="annot"><span class="annottext">(((ConnectionType, Async m (),
   StrictTVar
     m (ConnectionState peerAddr handle handleError version m))
  -&gt; m ())
 -&gt; m ())
-&gt; ((ConnectionType, Async m (),
     StrictTVar
       m (ConnectionState peerAddr handle handleError version m))
    -&gt; m ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256599"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256599"><span class="hs-identifier hs-var">connThread'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-989"></span><span>                                   </span><span class="annot"><span class="annottext">ThreadId m -&gt; AsyncCancelled -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256599"><span class="hs-identifier hs-var">connThread'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>                                           </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span>
</span><span id="line-991"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span>    </span><span class="annot"><a href="#local-6989586621679256735"><span class="hs-identifier hs-type">includeInboundConnectionImpl</span></a></span><span>
</span><span id="line-994"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-995"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-996"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-997"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandlerFn"><span class="hs-identifier hs-type">ConnectionHandlerFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-998"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-999"></span><span>        </span><span class="hs-comment">-- ^ inbound connections hard limit</span><span>
</span><span id="line-1000"></span><span>        </span><span class="hs-comment">-- TODO: This is needed because the accept loop can not guarantee that</span><span>
</span><span id="line-1001"></span><span>        </span><span class="hs-comment">-- includeInboundConnection can run safely without going above the</span><span>
</span><span id="line-1002"></span><span>        </span><span class="hs-comment">-- hardlimit.  We have to check if we are not above the hard limit</span><span>
</span><span id="line-1003"></span><span>        </span><span class="hs-comment">-- after locking the connection manager state `TMVar` and  then decide</span><span>
</span><span id="line-1004"></span><span>        </span><span class="hs-comment">-- whether we can include the connection or not.</span><span>
</span><span id="line-1005"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span>
</span><span id="line-1006"></span><span>        </span><span class="hs-comment">-- ^ resource to include in the state</span><span>
</span><span id="line-1007"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-1008"></span><span>        </span><span class="hs-comment">-- ^ remote address used as an identifier of the resource</span><span>
</span><span id="line-1009"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-type">Connected</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1010"></span><span>    </span><span id="local-6989586621679256735"><span class="annot"><span class="annottext">includeInboundConnectionImpl :: FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; IncludeInboundConnection socket peerAddr handle handleError m
</span><a href="#local-6989586621679256735"><span class="hs-identifier hs-var hs-var">includeInboundConnectionImpl</span></a></span></span><span> </span><span id="local-6989586621679256598"><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256598"><span class="hs-identifier hs-var">freshIdSupply</span></a></span></span><span>
</span><span id="line-1011"></span><span>                                 </span><span id="local-6989586621679256597"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span>
</span><span id="line-1012"></span><span>                                 </span><span id="local-6989586621679256596"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256596"><span class="hs-identifier hs-var">handler</span></a></span></span><span>
</span><span id="line-1013"></span><span>                                 </span><span id="local-6989586621679256595"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679256595"><span class="hs-identifier hs-var">hardLimit</span></a></span></span><span>
</span><span id="line-1014"></span><span>                                 </span><span id="local-6989586621679256594"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256594"><span class="hs-identifier hs-var">socket</span></a></span></span><span>
</span><span id="line-1015"></span><span>                                 </span><span id="local-6989586621679256593"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1016"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679256592"><span class="annot"><span class="annottext">Maybe
  (MutableConnState peerAddr handle handleError version m,
   Async m (), PromiseReader m (Either handleError (handle, version)))
</span><a href="#local-6989586621679256592"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256591"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
          (Maybe
             (MutableConnState peerAddr handle handleError version m,
              Async m (),
              PromiseReader m (Either handleError (handle, version))),
           ConnectionId peerAddr)))
-&gt; m (Maybe
        (MutableConnState peerAddr handle handleError version m,
         Async m (),
         PromiseReader m (Either handleError (handle, version))),
      ConnectionId peerAddr)
forall (m :: * -&gt; *) a b.
(MonadEvaluate m, MonadMask m, MonadSTM m) =&gt;
StrictTMVar m a -&gt; (a -&gt; m (a, b)) -&gt; m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVar"><span class="hs-identifier hs-var">modifyTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerState peerAddr handle handleError version m
  -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
        (Maybe
           (MutableConnState peerAddr handle handleError version m,
            Async m (),
            PromiseReader m (Either handleError (handle, version))),
         ConnectionId peerAddr)))
 -&gt; m (Maybe
         (MutableConnState peerAddr handle handleError version m,
          Async m (),
          PromiseReader m (Either handleError (handle, version))),
       ConnectionId peerAddr))
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; m (ConnectionManagerState peerAddr handle handleError version m,
          (Maybe
             (MutableConnState peerAddr handle handleError version m,
              Async m (),
              PromiseReader m (Either handleError (handle, version))),
           ConnectionId peerAddr)))
-&gt; m (Maybe
        (MutableConnState peerAddr handle handleError version m,
         Async m (),
         PromiseReader m (Either handleError (handle, version))),
      ConnectionId peerAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256590"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256590"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1017"></span><span>          </span><span id="local-6989586621679256589"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256589"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m peerAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><a href="Ouroboros.Network.Snocket.html#getLocalAddr"><span class="hs-identifier hs-var hs-var">getLocalAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256594"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-1018"></span><span>          </span><span id="local-6989586621679256587"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256587"><span class="hs-identifier hs-var">numberOfCons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Int -&gt; m Int
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Int -&gt; m Int) -&gt; STM m Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256590"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1019"></span><span>
</span><span id="line-1020"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256586"><span class="annot"><span class="annottext">connId :: ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var hs-var">connId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId :: forall addr. addr -&gt; addr -&gt; ConnectionId addr
</span><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">peerAddr
localAddress :: peerAddr
localAddress :: peerAddr
</span><a href="Ouroboros.Network.ConnectionId.html#localAddress"><span class="hs-identifier hs-var hs-var">localAddress</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">remoteAddress :: peerAddr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1021"></span><span>
</span><span id="line-1022"></span><span>              </span><span class="hs-comment">-- Check if after accepting this connection we get above the</span><span>
</span><span id="line-1023"></span><span>              </span><span class="hs-comment">-- hard limit</span><span>
</span><span id="line-1024"></span><span>              </span><span id="local-6989586621679256584"><span class="annot"><span class="annottext">canAccept :: Bool
</span><a href="#local-6989586621679256584"><span class="hs-identifier hs-var hs-var">canAccept</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256587"><span class="hs-identifier hs-var">numberOfCons</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679256595"><span class="hs-identifier hs-var">hardLimit</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256584"><span class="hs-identifier hs-var">canAccept</span></a></span><span>
</span><span id="line-1027"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1028"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256582"><span class="annot"><span class="annottext">provenance :: Provenance
</span><a href="#local-6989586621679256582"><span class="hs-identifier hs-var hs-var">provenance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span>
</span><span id="line-1029"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrIncludeConnection"><span class="hs-identifier hs-var">TrIncludeConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256582"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1030"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256580"><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256580"><span class="hs-identifier hs-var">reader</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256579"><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256579"><span class="hs-identifier hs-var">writer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (PromiseReader m (Either handleError (handle, version)),
   PromiseWriter m (Either handleError (handle, version)))
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadThrow (STM m)) =&gt;
m (PromiseReader m a, PromiseWriter m a)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#newEmptyPromiseIO"><span class="hs-identifier hs-var">newEmptyPromiseIO</span></a></span><span>
</span><span id="line-1031"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256577"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256577"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256576"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256576"><span class="hs-identifier hs-var">connVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256575"><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256575"><span class="hs-identifier hs-var">connState0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256574"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256574"><span class="hs-identifier hs-var">connState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1032"></span><span>              </span><span class="annot"><span class="annottext">((Async m (),
  MutableConnState peerAddr handle handleError version m,
  Maybe (ConnectionState peerAddr handle handleError version m),
  ConnectionState peerAddr handle handleError version m)
 -&gt; m (Async m (),
       MutableConnState peerAddr handle handleError version m,
       Maybe (ConnectionState peerAddr handle handleError version m),
       ConnectionState peerAddr handle handleError version m))
-&gt; m (Async m (),
      MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m),
      ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadFix m =&gt; (a -&gt; m a) -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mfix</span></a></span><span> </span><span class="annot"><span class="annottext">(((Async m (),
   MutableConnState peerAddr handle handleError version m,
   Maybe (ConnectionState peerAddr handle handleError version m),
   ConnectionState peerAddr handle handleError version m)
  -&gt; m (Async m (),
        MutableConnState peerAddr handle handleError version m,
        Maybe (ConnectionState peerAddr handle handleError version m),
        ConnectionState peerAddr handle handleError version m))
 -&gt; m (Async m (),
       MutableConnState peerAddr handle handleError version m,
       Maybe (ConnectionState peerAddr handle handleError version m),
       ConnectionState peerAddr handle handleError version m))
-&gt; ((Async m (),
     MutableConnState peerAddr handle handleError version m,
     Maybe (ConnectionState peerAddr handle handleError version m),
     ConnectionState peerAddr handle handleError version m)
    -&gt; m (Async m (),
          MutableConnState peerAddr handle handleError version m,
          Maybe (ConnectionState peerAddr handle handleError version m),
          ConnectionState peerAddr handle handleError version m))
-&gt; m (Async m (),
      MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m),
      ConnectionState peerAddr handle handleError version m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span id="local-6989586621679256573"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256573"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256572"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256572"><span class="hs-identifier hs-var">_mutableConnVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256571"><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256571"><span class="hs-identifier hs-var">_connState0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256570"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256570"><span class="hs-identifier hs-var">_connState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1033"></span><span>                </span><span class="hs-comment">-- Either</span><span>
</span><span id="line-1034"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1035"></span><span>                </span><span class="hs-comment">--   Accepted    : &#9679; &#8594; UnnegotiatedState Inbound</span><span>
</span><span id="line-1036"></span><span>                </span><span class="hs-comment">--   Overwritten : &#9679; &#8594; UnnegotiatedState Inbound</span><span>
</span><span id="line-1037"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1038"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1039"></span><span>                </span><span class="hs-comment">-- This is subtle part, which needs to handle a near simultaneous</span><span>
</span><span id="line-1040"></span><span>                </span><span class="hs-comment">-- open.  We cannot rely on 'ReservedOutboundState' state as</span><span>
</span><span id="line-1041"></span><span>                </span><span class="hs-comment">-- a lock.  It may happen that the `requestOutboundConnection`</span><span>
</span><span id="line-1042"></span><span>                </span><span class="hs-comment">-- will put 'ReservedOutboundState', but before it will call `connect`</span><span>
</span><span id="line-1043"></span><span>                </span><span class="hs-comment">-- the `accept` call will return.  We overwrite the state and</span><span>
</span><span id="line-1044"></span><span>                </span><span class="hs-comment">-- replace the connection state 'TVar' with a fresh one.  Nothing</span><span>
</span><span id="line-1045"></span><span>                </span><span class="hs-comment">-- is blocked on the replaced 'TVar'.</span><span>
</span><span id="line-1046"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256569"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256569"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; Async m ()
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Provenance
-&gt; ConnectionId peerAddr
-&gt; Async m ()
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-var">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256582"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256573"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1047"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679256568"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256568"><span class="hs-identifier hs-var">mutableConnVar'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256567"><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256567"><span class="hs-identifier hs-var">connState0'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1048"></span><span>                  </span><span class="annot"><span class="annottext">STM
  m
  (MutableConnState peerAddr handle handleError version m,
   Maybe (ConnectionState peerAddr handle handleError version m))
-&gt; m (MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (MutableConnState peerAddr handle handleError version m,
    Maybe (ConnectionState peerAddr handle handleError version m))
 -&gt; m (MutableConnState peerAddr handle handleError version m,
       Maybe (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m))
-&gt; m (MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1049"></span><span>                    </span><span id="local-6989586621679256566"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256566"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
forall (m :: * -&gt; *) peerAddr handle handleError version.
MonadSTM m =&gt;
FreshIdSupply m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#newMutableConnState"><span class="hs-identifier hs-var">newMutableConnState</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256598"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256569"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1050"></span><span>                    </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; String -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
StrictTVar m a -&gt; String -&gt; STM m ()
</span><span class="hs-identifier hs-var">labelTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256566"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conn-state-&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1051"></span><span>                    </span><span id="local-6989586621679256564"><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256564"><span class="hs-identifier hs-var">connState0'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
-&gt; STM
     m (Maybe (ConnectionState peerAddr handle handleError version m))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">(StrictTVar
   m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; StrictTVar
         m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1052"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256590"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1053"></span><span>                    </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m,
 Maybe (ConnectionState peerAddr handle handleError version m))
-&gt; STM
     m
     (MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256566"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256564"><span class="hs-identifier hs-var">connState0'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1054"></span><span>                </span><span id="local-6989586621679256563"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256563"><span class="hs-identifier hs-var">connThread'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1055"></span><span>                  </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; socket
-&gt; ConnectionId peerAddr
-&gt; PromiseWriter m (Either handleError (handle, version))
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; m (Async m ())
</span><a href="#local-6989586621679256684"><span class="hs-identifier hs-var">forkConnectionHandler</span></a></span><span>
</span><span id="line-1056"></span><span>                     </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256568"><span class="hs-identifier hs-var">mutableConnVar'</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256594"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256579"><span class="hs-identifier hs-var">writer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256596"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-1057"></span><span>                </span><span class="annot"><span class="annottext">(Async m (),
 MutableConnState peerAddr handle handleError version m,
 Maybe (ConnectionState peerAddr handle handleError version m),
 ConnectionState peerAddr handle handleError version m)
-&gt; m (Async m (),
      MutableConnState peerAddr handle handleError version m,
      Maybe (ConnectionState peerAddr handle handleError version m),
      ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256563"><span class="hs-identifier hs-var">connThread'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256568"><span class="hs-identifier hs-var">mutableConnVar'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256567"><span class="hs-identifier hs-var">connState0'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256569"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1058"></span><span>
</span><span id="line-1059"></span><span>            </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1060"></span><span>                                 </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; (ConnectionState peerAddr handle handleError version m
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe (ConnectionState peerAddr handle handleError version m)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256575"><span class="hs-identifier hs-var">connState0</span></a></span><span>
</span><span id="line-1061"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256574"><span class="hs-identifier hs-var">connState</span></a></span><span>
</span><span id="line-1062"></span><span>                                            </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1063"></span><span>            </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 (Maybe
    (MutableConnState peerAddr handle handleError version m,
     Async m (),
     PromiseReader m (Either handleError (handle, version))),
  ConnectionId peerAddr))
-&gt; m (ConnectionManagerState peerAddr handle handleError version m,
      (Maybe
         (MutableConnState peerAddr handle handleError version m,
          Async m (),
          PromiseReader m (Either handleError (handle, version))),
       ConnectionId peerAddr))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256576"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256590"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1064"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m,
 Async m (), PromiseReader m (Either handleError (handle, version)))
-&gt; Maybe
     (MutableConnState peerAddr handle handleError version m,
      Async m (), PromiseReader m (Either handleError (handle, version)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256576"><span class="hs-identifier hs-var">connVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256577"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256580"><span class="hs-identifier hs-var">reader</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1065"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-1066"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-1067"></span><span>            </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 (Maybe
    (MutableConnState peerAddr handle handleError version m,
     Async m (),
     PromiseReader m (Either handleError (handle, version))),
  ConnectionId peerAddr))
-&gt; m (ConnectionManagerState peerAddr handle handleError version m,
      (Maybe
         (MutableConnState peerAddr handle handleError version m,
          Async m (),
          PromiseReader m (Either handleError (handle, version))),
       ConnectionId peerAddr))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256590"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1068"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (MutableConnState peerAddr handle handleError version m,
   Async m (), PromiseReader m (Either handleError (handle, version)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256586"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1069"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-1070"></span><span>
</span><span id="line-1071"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (MutableConnState peerAddr handle handleError version m,
   Async m (), PromiseReader m (Either handleError (handle, version)))
</span><a href="#local-6989586621679256592"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1072"></span><span>          </span><span class="annot"><span class="annottext">Maybe
  (MutableConnState peerAddr handle handleError version m,
   Async m (), PromiseReader m (Either handleError (handle, version)))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1073"></span><span>            </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256560"><span class="annot"><span class="annottext">mutableConnState :: MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256560"><span class="hs-identifier hs-var">mutableConnState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256559"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1076"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256558"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256558"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256557"><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256557"><span class="hs-identifier hs-var">reader</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1077"></span><span>            </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span>            </span><span id="local-6989586621679256556"><span class="annot"><span class="annottext">Either handleError (handle, version)
</span><a href="#local-6989586621679256556"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Either handleError (handle, version))
-&gt; m (Either handleError (handle, version))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Either handleError (handle, version))
 -&gt; m (Either handleError (handle, version)))
-&gt; STM m (Either handleError (handle, version))
-&gt; m (Either handleError (handle, version))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
-&gt; STM m (Either handleError (handle, version))
forall (m :: * -&gt; *) a. PromiseReader m a -&gt; STM m a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#readPromise"><span class="hs-identifier hs-var hs-var">readPromise</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256557"><span class="hs-identifier hs-var">reader</span></a></span><span>
</span><span id="line-1080"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either handleError (handle, version)
</span><a href="#local-6989586621679256556"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1081"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256554"><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256554"><span class="hs-identifier hs-var">handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1082"></span><span>                </span><span id="local-6989586621679256553"><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256553"><span class="hs-identifier hs-var">transitions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  [Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
 -&gt; m [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1083"></span><span>                  </span><span id="local-6989586621679256552"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256552"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1084"></span><span>
</span><span id="line-1085"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256551"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256551"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1086"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">handleError -&gt; HandleErrorType
</span><a href="#local-6989586621679256771"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256554"><span class="hs-identifier hs-var">handleError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1087"></span><span>                          </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1088"></span><span>                            </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256558"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1089"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256554"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>                          </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeProtocolViolation"><span class="hs-identifier hs-var">HandshakeProtocolViolation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1091"></span><span>                            </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256554"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span>                      </span><span id="local-6989586621679256548"><span class="annot"><span class="annottext">transition :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256548"><span class="hs-identifier hs-var hs-var">transition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256552"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256551"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1093"></span><span>                      </span><span id="local-6989586621679256547"><span class="annot"><span class="annottext">absConnState :: AbstractState
</span><a href="#local-6989586621679256547"><span class="hs-identifier hs-var hs-var">absConnState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256552"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span>                      </span><span id="local-6989586621679256546"><span class="annot"><span class="annottext">absConnState' :: AbstractState
</span><a href="#local-6989586621679256546"><span class="hs-identifier hs-var hs-var">absConnState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256551"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span>                      </span><span id="local-6989586621679256545"><span class="annot"><span class="annottext">shouldTrace :: Bool
</span><a href="#local-6989586621679256545"><span class="hs-identifier hs-var hs-var">shouldTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256547"><span class="hs-identifier hs-var">absConnState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-1096"></span><span>                      </span><span id="local-6989586621679256544"><span class="annot"><span class="annottext">isTerminating :: Bool
</span><a href="#local-6989586621679256544"><span class="hs-identifier hs-var hs-var">isTerminating</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256546"><span class="hs-identifier hs-var">absConnState'</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatingSt"><span class="hs-identifier hs-var">TerminatingSt</span></a></span><span>
</span><span id="line-1097"></span><span>
</span><span id="line-1098"></span><span>                  </span><span id="local-6989586621679256543"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256543"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1099"></span><span>                    </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM
         m
         (ConnectionManagerState peerAddr handle handleError version m,
          Bool))
-&gt; STM m Bool
forall (m :: * -&gt; *) a b.
MonadSTM m =&gt;
StrictTMVar m a -&gt; (a -&gt; STM m (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarSTM"><span class="hs-identifier hs-var">modifyTMVarSTM</span></a></span><span>
</span><span id="line-1100"></span><span>                      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1101"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256541"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256541"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1102"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256541"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1103"></span><span>                          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Bool)
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256541"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1104"></span><span>                          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256540"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256540"><span class="hs-identifier hs-var">mutableConnState'</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1105"></span><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256540"><span class="hs-identifier hs-var">mutableConnState'</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256560"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1106"></span><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1107"></span><span>                                </span><span class="hs-comment">-- 'handleError' might be either a handshake</span><span>
</span><span id="line-1108"></span><span>                                </span><span class="hs-comment">-- negotiation a protocol failure (an IO</span><span>
</span><span id="line-1109"></span><span>                                </span><span class="hs-comment">-- exception, a timeout or codec failure).  In</span><span>
</span><span id="line-1110"></span><span>                                </span><span class="hs-comment">-- the first case we should not reset the</span><span>
</span><span id="line-1111"></span><span>                                </span><span class="hs-comment">-- connection as this is not a protocol error.</span><span>
</span><span id="line-1112"></span><span>                                </span><span class="hs-comment">--</span><span>
</span><span id="line-1113"></span><span>                                </span><span class="hs-comment">-- If we are deleting the connState from the</span><span>
</span><span id="line-1114"></span><span>                                </span><span class="hs-comment">-- state then connState' can be TerminatingSt in</span><span>
</span><span id="line-1115"></span><span>                                </span><span class="hs-comment">-- which case we are going to transition</span><span>
</span><span id="line-1116"></span><span>                                </span><span class="hs-comment">-- TerminatingSt -&gt; TerminatedSt. Otherwise,</span><span>
</span><span id="line-1117"></span><span>                                </span><span class="hs-comment">-- Connection Manager cleanup will take care of</span><span>
</span><span id="line-1118"></span><span>                                </span><span class="hs-comment">-- tracing accordingly.</span><span>
</span><span id="line-1119"></span><span>                                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256551"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>                                </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Bool)
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256541"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1122"></span><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Bool)
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256541"><span class="hs-identifier hs-var">state</span></a></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256539"><span class="annot"><span class="annottext">transitions :: [Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256539"><span class="hs-identifier hs-var hs-var">transitions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1126"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-1127"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256551"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1128"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1129"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-1130"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256544"><span class="hs-identifier hs-var">isTerminating</span></a></span><span>
</span><span id="line-1131"></span><span>                        </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-1132"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-1133"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-1135"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-1136"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-1137"></span><span>
</span><span id="line-1138"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256543"><span class="hs-identifier hs-var">updated</span></a></span><span>
</span><span id="line-1139"></span><span>                     </span><span class="hs-keyword">then</span><span>
</span><span id="line-1140"></span><span>                    </span><span class="hs-comment">-- Key was present in the dictionary (stateVar) and</span><span>
</span><span id="line-1141"></span><span>                    </span><span class="hs-comment">-- removed so we trace the removal.</span><span>
</span><span id="line-1142"></span><span>                      </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([Transition'
    (MaybeUnknown
       (ConnectionState peerAddr handle handleError version m))]
 -&gt; STM
      m
      [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1143"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256545"><span class="hs-identifier hs-var">shouldTrace</span></a></span><span>
</span><span id="line-1144"></span><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256548"><span class="hs-identifier hs-var">transition</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256539"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-1145"></span><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256539"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-1146"></span><span>                    </span><span class="hs-comment">-- Key was not present in the dictionary (stateVar),</span><span>
</span><span id="line-1147"></span><span>                    </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-1148"></span><span>                    </span><span class="hs-comment">-- deletion.</span><span>
</span><span id="line-1149"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1150"></span><span>                    </span><span class="hs-comment">-- OR</span><span>
</span><span id="line-1151"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1152"></span><span>                    </span><span class="hs-comment">-- Key was overwritten in the dictionary (stateVar),</span><span>
</span><span id="line-1153"></span><span>                    </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-1154"></span><span>                    </span><span class="hs-comment">-- overwriting.</span><span>
</span><span id="line-1155"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span>                </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256553"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-1158"></span><span>                </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1159"></span><span>
</span><span id="line-1160"></span><span>                </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256554"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1161"></span><span>
</span><span id="line-1162"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256538"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256538"><span class="hs-identifier hs-var">handle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256537"><span class="annot"><span class="annottext">version
</span><a href="#local-6989586621679256537"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1163"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256536"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256536"><span class="hs-identifier hs-var hs-var">dataFlow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">version -&gt; DataFlow
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var">connectionDataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">version
</span><a href="#local-6989586621679256537"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-1164"></span><span>                </span><span id="local-6989586621679256535"><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256535"><span class="hs-identifier hs-var">mbTransition</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
 -&gt; m (Maybe
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1165"></span><span>                  </span><span id="local-6989586621679256534"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256534"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1166"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256534"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1167"></span><span>                    </span><span class="hs-comment">-- Inbound connections cannot be found in this state at this</span><span>
</span><span id="line-1168"></span><span>                    </span><span class="hs-comment">-- stage.</span><span>
</span><span id="line-1169"></span><span>                    </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1170"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>
</span><span id="line-1172"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1173"></span><span>                    </span><span class="hs-comment">-- The common case.</span><span>
</span><span id="line-1174"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1175"></span><span>                    </span><span class="hs-comment">-- Note: we don't set an explicit timeout here.  The</span><span>
</span><span id="line-1176"></span><span>                    </span><span class="hs-comment">-- server will set a timeout and call</span><span>
</span><span id="line-1177"></span><span>                    </span><span class="hs-comment">-- 'unregisterInboundConnection' when it expires.</span><span>
</span><span id="line-1178"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1179"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1180"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256530"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256530"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-var">InboundIdleState</span></a></span><span>
</span><span id="line-1181"></span><span>                                         </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256558"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256538"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1182"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">version -&gt; DataFlow
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var">connectionDataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">version
</span><a href="#local-6989586621679256537"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>                      </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256530"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1184"></span><span>                      </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256534"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256530"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1185"></span><span>
</span><span id="line-1186"></span><span>                    </span><span class="hs-comment">-- It is impossible to find a connection in 'OutboundUniState'</span><span>
</span><span id="line-1187"></span><span>                    </span><span class="hs-comment">-- or 'OutboundDupState', since 'includeInboundConnection'</span><span>
</span><span id="line-1188"></span><span>                    </span><span class="hs-comment">-- blocks until 'InboundState'.  This guarantees that this</span><span>
</span><span id="line-1189"></span><span>                    </span><span class="hs-comment">-- transactions runs first in case of race between</span><span>
</span><span id="line-1190"></span><span>                    </span><span class="hs-comment">-- 'requestOutboundConnection' and 'includeInboundConnection'.</span><span>
</span><span id="line-1191"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256529"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256529"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256528"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256528"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256527"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256527"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1192"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1193"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256526"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256526"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256525"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256525"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256524"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256524"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256523"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256523"><span class="hs-identifier hs-var">_expired</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1194"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>
</span><span id="line-1196"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256522"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256522"><span class="hs-identifier hs-var">dataFlow'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1197"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256521"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256521"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-var">InboundIdleState</span></a></span><span>
</span><span id="line-1198"></span><span>                                         </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256558"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256538"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1199"></span><span>                                         </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256522"><span class="hs-identifier hs-var">dataFlow'</span></a></span><span>
</span><span id="line-1200"></span><span>                      </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256559"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256521"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1201"></span><span>                      </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256534"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256521"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1202"></span><span>
</span><span id="line-1203"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1204"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1205"></span><span>
</span><span id="line-1206"></span><span>                    </span><span class="hs-comment">-- At this stage the inbound connection cannot be in</span><span>
</span><span id="line-1207"></span><span>                    </span><span class="hs-comment">-- 'InboundState', it would mean that there was another thread</span><span>
</span><span id="line-1208"></span><span>                    </span><span class="hs-comment">-- that included that connection, but this would violate @TCP@</span><span>
</span><span id="line-1209"></span><span>                    </span><span class="hs-comment">-- constraints.</span><span>
</span><span id="line-1210"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1211"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1212"></span><span>
</span><span id="line-1213"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1214"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>
</span><span id="line-1216"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1217"></span><span>
</span><span id="line-1218"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1219"></span><span>
</span><span id="line-1220"></span><span>                </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256593"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256535"><span class="hs-identifier hs-var">mbTransition</span></a></span><span>
</span><span id="line-1221"></span><span>                </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256597"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1222"></span><span>
</span><span id="line-1223"></span><span>                </span><span class="hs-comment">-- Note that we don't set a timeout thread here which would</span><span>
</span><span id="line-1224"></span><span>                </span><span class="hs-comment">-- perform:</span><span>
</span><span id="line-1225"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1226"></span><span>                </span><span class="hs-comment">--   Commit^{dataFlow}</span><span>
</span><span id="line-1227"></span><span>                </span><span class="hs-comment">--     : InboundIdleState dataFlow</span><span>
</span><span id="line-1228"></span><span>                </span><span class="hs-comment">--     &#8594; TerminatingState</span><span>
</span><span id="line-1229"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1230"></span><span>                </span><span class="hs-comment">-- This is not needed!  When we return from this call, the inbound</span><span>
</span><span id="line-1231"></span><span>                </span><span class="hs-comment">-- protocol governor will monitor the connection.  Once it becomes</span><span>
</span><span id="line-1232"></span><span>                </span><span class="hs-comment">-- idle, it will call 'unregisterInboundConnection' which will</span><span>
</span><span id="line-1233"></span><span>                </span><span class="hs-comment">-- perform the aforementioned @Commit@ transition.</span><span>
</span><span id="line-1234"></span><span>
</span><span id="line-1235"></span><span>                </span><span class="hs-comment">-- If mbTransition is Nothing, it means that the connVar was read</span><span>
</span><span id="line-1236"></span><span>                </span><span class="hs-comment">-- either in Terminating or TerminatedState. Either case we should</span><span>
</span><span id="line-1237"></span><span>                </span><span class="hs-comment">-- return Disconnected instead of Connected.</span><span>
</span><span id="line-1238"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256535"><span class="hs-identifier hs-var">mbTransition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1239"></span><span>                  </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Connected peerAddr handle handleError
 -&gt; m (Connected peerAddr handle handleError))
-&gt; Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1240"></span><span>                  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1241"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InResponderMode muxMode (ControlChannel peerAddr handle m)
</span><a href="#local-6989586621679256770"><span class="hs-identifier hs-var">inboundGovernorControlChannel</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1242"></span><span>                      </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#InResponderMode"><span class="hs-identifier hs-type">InResponderMode</span></a></span><span> </span><span id="local-6989586621679256519"><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
</span><a href="#local-6989586621679256519"><span class="hs-identifier hs-var">controlChannel</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1243"></span><span>                        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
-&gt; NewConnection peerAddr handle -&gt; STM m ()
forall peerAddr handle (m :: * -&gt; *).
ControlChannel peerAddr handle m
-&gt; NewConnection peerAddr handle -&gt; STM m ()
</span><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#writeMessage"><span class="hs-identifier hs-var hs-var">ControlChannel.writeMessage</span></a></span><span>
</span><span id="line-1244"></span><span>                                       </span><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
</span><a href="#local-6989586621679256519"><span class="hs-identifier hs-var">controlChannel</span></a></span><span>
</span><span id="line-1245"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; DataFlow
-&gt; handle
-&gt; NewConnection peerAddr handle
forall peerAddr handle.
Provenance
-&gt; ConnectionId peerAddr
-&gt; DataFlow
-&gt; handle
-&gt; NewConnection peerAddr handle
</span><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#NewConnection"><span class="hs-identifier hs-var">ControlChannel.NewConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256536"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256538"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1246"></span><span>                      </span><span class="annot"><span class="annottext">InResponderMode muxMode (ControlChannel peerAddr handle m)
</span><a href="Ouroboros.Network.MuxMode.html#NotInResponderMode"><span class="hs-identifier hs-var">NotInResponderMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1247"></span><span>                    </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Connected peerAddr handle handleError
 -&gt; m (Connected peerAddr handle handleError))
-&gt; Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256591"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256536"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256538"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1248"></span><span>
</span><span id="line-1249"></span><span>    </span><span class="hs-comment">-- We need 'mask' in order to guarantee that the traces are logged if an</span><span>
</span><span id="line-1250"></span><span>    </span><span class="hs-comment">-- async exception lands between the successful STM action and the logging</span><span>
</span><span id="line-1251"></span><span>    </span><span class="hs-comment">-- action.</span><span>
</span><span id="line-1252"></span><span>    </span><span class="annot"><a href="#local-6989586621679256733"><span class="hs-identifier hs-type">unregisterInboundConnectionImpl</span></a></span><span>
</span><span id="line-1253"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1254"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-1255"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationResult"><span class="hs-identifier hs-type">OperationResult</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#DemotedToColdRemoteTr"><span class="hs-identifier hs-type">DemotedToColdRemoteTr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1256"></span><span>    </span><span id="local-6989586621679256733"><span class="annot"><span class="annottext">unregisterInboundConnectionImpl :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult DemotedToColdRemoteTr)
</span><a href="#local-6989586621679256733"><span class="hs-identifier hs-var hs-var">unregisterInboundConnectionImpl</span></a></span></span><span> </span><span id="local-6989586621679256514"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256514"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679256513"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256513"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (OperationResult DemotedToColdRemoteTr)
-&gt; m (OperationResult DemotedToColdRemoteTr)
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m (OperationResult DemotedToColdRemoteTr)
 -&gt; m (OperationResult DemotedToColdRemoteTr))
-&gt; m (OperationResult DemotedToColdRemoteTr)
-&gt; m (OperationResult DemotedToColdRemoteTr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1257"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnregisterConnection"><span class="hs-identifier hs-var">TrUnregisterConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256513"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1258"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679256510"><span class="annot"><span class="annottext">Maybe (Async m ())
</span><a href="#local-6989586621679256510"><span class="hs-identifier hs-var">mbThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256509"><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256509"><span class="hs-identifier hs-var">mbTransition</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256508"><span class="annot"><span class="annottext">OperationResult DemotedToColdRemoteTr
</span><a href="#local-6989586621679256508"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256507"><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256507"><span class="hs-identifier hs-var">mbAssertion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Maybe (Async m ()),
   Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))),
   OperationResult DemotedToColdRemoteTr,
   Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe (Async m ()),
    Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))),
    OperationResult DemotedToColdRemoteTr,
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; m (Maybe (Async m ()),
       Maybe
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))),
       OperationResult DemotedToColdRemoteTr,
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1259"></span><span>        </span><span id="local-6989586621679256506"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256506"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256514"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1260"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256513"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256506"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1261"></span><span>          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1262"></span><span>            </span><span class="hs-comment">-- Note: this can happen if the inbound connection manager is</span><span>
</span><span id="line-1263"></span><span>            </span><span class="hs-comment">-- notified late about the connection which has already terminated</span><span>
</span><span id="line-1264"></span><span>            </span><span class="hs-comment">-- at this point.</span><span>
</span><span id="line-1265"></span><span>            </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1266"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1267"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#CommitTr"><span class="hs-identifier hs-var">CommitTr</span></a></span><span>
</span><span id="line-1268"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1269"></span><span>                 </span><span class="hs-special">)</span><span>
</span><span id="line-1270"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256503"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1271"></span><span>            </span><span id="local-6989586621679256502"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1272"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256501"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1273"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1274"></span><span>              </span><span class="hs-comment">-- In any of the following two states unregistering is not</span><span>
</span><span id="line-1275"></span><span>              </span><span class="hs-comment">-- supported.  'includeInboundConnection' is a synchronous</span><span>
</span><span id="line-1276"></span><span>              </span><span class="hs-comment">-- operation which returns only once the connection is</span><span>
</span><span id="line-1277"></span><span>              </span><span class="hs-comment">-- negotiated.</span><span>
</span><span id="line-1278"></span><span>              </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1279"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1280"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1281"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1282"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1283"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1284"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1285"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1286"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1287"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1288"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1289"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1290"></span><span>
</span><span id="line-1291"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1292"></span><span>              </span><span class="hs-comment">--   TimeoutExpired : OutboundState^\tau Duplex</span><span>
</span><span id="line-1293"></span><span>              </span><span class="hs-comment">--                  &#8594; OutboundState      Duplex</span><span>
</span><span id="line-1294"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1295"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256499"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256499"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256498"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256498"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256497"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256497"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1296"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256495"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256495"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256499"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256498"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256497"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Expired"><span class="hs-identifier hs-var">Expired</span></a></span><span>
</span><span id="line-1297"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256495"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1298"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1299"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256495"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1300"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#KeepTr"><span class="hs-identifier hs-var">KeepTr</span></a></span><span>
</span><span id="line-1301"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1302"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1303"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256492"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256492"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256491"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256491"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256490"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256490"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Expired"><span class="hs-identifier hs-var">Expired</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1304"></span><span>                </span><span class="annot"><span class="annottext">Bool
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe (Async m ()),
    Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))),
    OperationResult DemotedToColdRemoteTr,
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; STM
      m
      (Maybe (Async m ()),
       Maybe
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))),
       OperationResult DemotedToColdRemoteTr,
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1305"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1306"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1307"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#KeepTr"><span class="hs-identifier hs-var">KeepTr</span></a></span><span>
</span><span id="line-1308"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-1309"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnregisterInboundConnection"><span class="hs-identifier hs-var">UnregisterInboundConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256492"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1310"></span><span>                                                              </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1311"></span><span>                                 </span><span class="hs-special">)</span><span>
</span><span id="line-1312"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1313"></span><span>
</span><span id="line-1314"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256487"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256487"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256486"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256486"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256485"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256485"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1315"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1316"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1317"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1318"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1319"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1320"></span><span>
</span><span id="line-1321"></span><span>              </span><span class="hs-comment">-- unexpected state, this state is reachable only from outbound</span><span>
</span><span id="line-1322"></span><span>              </span><span class="hs-comment">-- states</span><span>
</span><span id="line-1323"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256484"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256484"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256483"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256483"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256482"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256482"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256481"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256481"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1324"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1325"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1326"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#CommitTr"><span class="hs-identifier hs-var">CommitTr</span></a></span><span>
</span><span id="line-1327"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-1328"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnregisterInboundConnection"><span class="hs-identifier hs-var">UnregisterInboundConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256484"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1329"></span><span>                                                              </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>                                 </span><span class="hs-special">)</span><span>
</span><span id="line-1331"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1332"></span><span>
</span><span id="line-1333"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1334"></span><span>              </span><span class="hs-comment">--   Commit^{dataFlow} : InboundIdleState dataFlow</span><span>
</span><span id="line-1335"></span><span>              </span><span class="hs-comment">--                     &#8594; TerminatingState</span><span>
</span><span id="line-1336"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1337"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1338"></span><span>              </span><span class="hs-comment">-- Note: the 'TrDemotedToColdRemote' is logged by the server.</span><span>
</span><span id="line-1339"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256480"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256480"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256479"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256479"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256478"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256478"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256477"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256477"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1340"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256476"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256476"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256480"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256479"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1341"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256476"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1342"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256479"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1343"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256476"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1344"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#CommitTr"><span class="hs-identifier hs-var">CommitTr</span></a></span><span>
</span><span id="line-1345"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1346"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1347"></span><span>
</span><span id="line-1348"></span><span>              </span><span class="hs-comment">-- the inbound protocol governor was supposed to call</span><span>
</span><span id="line-1349"></span><span>              </span><span class="hs-comment">-- 'demotedToColdRemote' first.</span><span>
</span><span id="line-1350"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256475"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256475"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256474"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256474"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256473"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256473"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256472"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256472"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1351"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256471"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256471"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256475"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256474"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1352"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256471"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1353"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; Maybe (Async m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256474"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1354"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256471"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1355"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1356"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-1357"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnregisterInboundConnection"><span class="hs-identifier hs-var">UnregisterInboundConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256475"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1358"></span><span>                                                              </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1359"></span><span>                                 </span><span class="hs-special">)</span><span>
</span><span id="line-1360"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span>              </span><span class="hs-comment">-- the inbound connection governor ought to call</span><span>
</span><span id="line-1363"></span><span>              </span><span class="hs-comment">-- 'demotedToColdRemote' first.</span><span>
</span><span id="line-1364"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span id="local-6989586621679256470"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256470"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256469"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256469"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256468"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256468"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1365"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256467"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256467"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256470"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256469"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256468"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span>
</span><span id="line-1366"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256503"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256467"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1367"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1368"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256502"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256467"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1369"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1370"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-1371"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnregisterInboundConnection"><span class="hs-identifier hs-var">UnregisterInboundConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256470"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1372"></span><span>                                                              </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256501"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1373"></span><span>                                 </span><span class="hs-special">)</span><span>
</span><span id="line-1374"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span>              </span><span class="hs-comment">-- If 'unregisterOutboundConnection' is called just before</span><span>
</span><span id="line-1377"></span><span>              </span><span class="hs-comment">-- 'unregisterInboundConnection', the latter one might observe</span><span>
</span><span id="line-1378"></span><span>              </span><span class="hs-comment">-- 'TerminatingState'.</span><span>
</span><span id="line-1379"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span id="local-6989586621679256466"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256466"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256465"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256465"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256464"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256464"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1380"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1381"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1382"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr -&gt; OperationResult DemotedToColdRemoteTr
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">DemotedToColdRemoteTr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#CommitTr"><span class="hs-identifier hs-var">CommitTr</span></a></span><span>
</span><span id="line-1383"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1384"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1385"></span><span>              </span><span class="hs-comment">-- However, 'TerminatedState' should not be observable by</span><span>
</span><span id="line-1386"></span><span>              </span><span class="hs-comment">-- 'unregisterInboundConnection', unless 'cmTimeWaitTimeout' is</span><span>
</span><span id="line-1387"></span><span>              </span><span class="hs-comment">-- close to 'serverProtocolIdleTimeout'.</span><span>
</span><span id="line-1388"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span id="local-6989586621679256463"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256463"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1389"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (Async m ()),
 Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 OperationResult DemotedToColdRemoteTr,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe (Async m ()),
      Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      OperationResult DemotedToColdRemoteTr,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (Async m ())
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1390"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1391"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult DemotedToColdRemoteTr
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-1392"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1393"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1394"></span><span>
</span><span id="line-1395"></span><span>      </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256513"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256509"><span class="hs-identifier hs-var">mbTransition</span></a></span><span>
</span><span id="line-1396"></span><span>      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256514"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1397"></span><span>
</span><span id="line-1398"></span><span>      </span><span class="hs-comment">-- 'throwTo' avoids blocking until 'cmTimeWaitTimeout' expires.</span><span>
</span><span id="line-1399"></span><span>      </span><span class="annot"><span class="annottext">(Async m () -&gt; m ()) -&gt; Maybe (Async m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ThreadId m -&gt; AsyncCancelled -&gt; m ())
-&gt; AsyncCancelled -&gt; ThreadId m -&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; AsyncCancelled -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span> </span><span class="annot"><span class="annottext">(ThreadId m -&gt; m ())
-&gt; (Async m () -&gt; ThreadId m) -&gt; Async m () -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Async m ())
</span><a href="#local-6989586621679256510"><span class="hs-identifier hs-var">mbThread</span></a></span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256507"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ())
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256461"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256461"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1403"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256461"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-1404"></span><span>        </span><span class="annot"><span class="annottext">Any -&gt; Any
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Any) -&gt; m (Any -&gt; Any)
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Any -&gt; Any
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1405"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span>      </span><span class="annot"><span class="annottext">OperationResult DemotedToColdRemoteTr
-&gt; m (OperationResult DemotedToColdRemoteTr)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">OperationResult DemotedToColdRemoteTr
</span><a href="#local-6989586621679256508"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-1408"></span><span>
</span><span id="line-1409"></span><span>    </span><span class="annot"><a href="#local-6989586621679256743"><span class="hs-identifier hs-type">requestOutboundConnectionImpl</span></a></span><span>
</span><span id="line-1410"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-1411"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#FreshIdSupply"><span class="hs-identifier hs-type">FreshIdSupply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1412"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1413"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandlerFn"><span class="hs-identifier hs-type">ConnectionHandlerFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256794"><span class="hs-identifier hs-type">handlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256795"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1414"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-1415"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-type">Connected</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1416"></span><span>    </span><span id="local-6989586621679256743"><span class="annot"><span class="annottext">requestOutboundConnectionImpl :: FreshIdSupply m
-&gt; StrictTMVar
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; RequestOutboundConnection peerAddr handle handleError m
</span><a href="#local-6989586621679256743"><span class="hs-identifier hs-var hs-var">requestOutboundConnectionImpl</span></a></span></span><span> </span><span id="local-6989586621679256459"><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256459"><span class="hs-identifier hs-var">freshIdSupply</span></a></span></span><span> </span><span id="local-6989586621679256458"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679256457"><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256457"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span id="local-6989586621679256456"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1417"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256455"><span class="annot"><span class="annottext">provenance :: Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var hs-var">provenance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span>
</span><span id="line-1418"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrIncludeConnection"><span class="hs-identifier hs-var">TrIncludeConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679256454"><span class="annot"><span class="annottext">Maybe
  (Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace))
</span><a href="#local-6989586621679256454"><span class="hs-identifier hs-var">trace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256453"><span class="annot"><span class="annottext">mutableConnState :: MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256453"><span class="hs-identifier hs-var">mutableConnState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256452"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1420"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256451"><span class="annot"><span class="annottext">Either
  (ConnectionManagerError peerAddr)
  (Wedge
     (Connected peerAddr handle handleError) (ConnectionId peerAddr))
</span><a href="#local-6989586621679256451"><span class="hs-identifier hs-var">eHandleWedge</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace)),
   MutableConnState peerAddr handle handleError version m,
   Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; m (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe
      (Either
         (TransitionTrace
            peerAddr (ConnectionState peerAddr handle handleError version m))
         (ConnectionManagerTrace peerAddr handlerTrace)),
    MutableConnState peerAddr handle handleError version m,
    Either
      (ConnectionManagerError peerAddr)
      (Wedge
         (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
 -&gt; m (Maybe
         (Either
            (TransitionTrace
               peerAddr (ConnectionState peerAddr handle handleError version m))
            (ConnectionManagerTrace peerAddr handlerTrace)),
       MutableConnState peerAddr handle handleError version m,
       Either
         (ConnectionManagerError peerAddr)
         (Wedge
            (Connected peerAddr handle handleError) (ConnectionId peerAddr))))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; m (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1421"></span><span>          </span><span id="local-6989586621679256450"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256450"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1422"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256450"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1423"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256449"><span class="annot"><span class="annottext">mutableConnState :: MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256448"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256448"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1424"></span><span>              </span><span id="local-6989586621679256447"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256448"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1425"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256446"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1426"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1427"></span><span>                </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1428"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionExists"><span class="hs-identifier hs-var">TrConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1429"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1430"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1431"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1432"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1433"></span><span>
</span><span id="line-1434"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span id="local-6989586621679256443"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256443"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256442"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256442"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1435"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionExists"><span class="hs-identifier hs-var">TrConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1436"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1437"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1438"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1439"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1440"></span><span>
</span><span id="line-1441"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span id="local-6989586621679256441"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256441"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256440"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256440"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1442"></span><span>                  </span><span class="hs-comment">-- we must not block inside @modifyTVar stateVar@, we</span><span>
</span><span id="line-1443"></span><span>                  </span><span class="hs-comment">-- return 'There' to indicate that we need to block on</span><span>
</span><span id="line-1444"></span><span>                  </span><span class="hs-comment">-- the connection state.</span><span>
</span><span id="line-1445"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1446"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1447"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Wedge
     (Connected peerAddr handle handleError) (ConnectionId peerAddr)
forall a b. b -&gt; Wedge a b
</span><a href="Data.Wedge.html#There"><span class="hs-identifier hs-var">There</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256441"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1448"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1449"></span><span>
</span><span id="line-1450"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1451"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionExists"><span class="hs-identifier hs-var">TrConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1452"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1453"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1454"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1455"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1456"></span><span>
</span><span id="line-1457"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1458"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionExists"><span class="hs-identifier hs-var">TrConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1459"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1460"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1461"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1462"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256438"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256438"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256437"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256437"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256436"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256436"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256435"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256435"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1465"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256434"><span class="annot"><span class="annottext">tr :: AbstractState
</span><a href="#local-6989586621679256434"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1466"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenOperation"><span class="hs-identifier hs-var">TrForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256434"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1467"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1468"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenOperation"><span class="hs-identifier hs-var">ForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256434"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1469"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256431"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256431"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256430"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256430"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256429"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256429"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1472"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenConnection"><span class="hs-identifier hs-var">TrForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256431"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1474"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1475"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenConnection"><span class="hs-identifier hs-var">ForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256431"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1476"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256426"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256426"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256425"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256425"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256424"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256424"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256423"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256423"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1479"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1480"></span><span>                  </span><span class="hs-comment">--   Awake^{Duplex}_{Local} : InboundIdleState Duplex</span><span>
</span><span id="line-1481"></span><span>                  </span><span class="hs-comment">--                          &#8594; OutboundState^\tau Duplex</span><span>
</span><span id="line-1482"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1483"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256422"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256422"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256426"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256425"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256424"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span>
</span><span id="line-1484"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256448"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256422"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1485"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-1486"></span><span>                                         </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1487"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256422"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1488"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1489"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; Wedge
     (Connected peerAddr handle handleError) (ConnectionId peerAddr)
forall a b. a -&gt; Wedge a b
</span><a href="Data.Wedge.html#Here"><span class="hs-identifier hs-var">Here</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256426"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256423"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256424"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1490"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1491"></span><span>
</span><span id="line-1492"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256420"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256420"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256419"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256419"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256418"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256418"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1493"></span><span>                  </span><span class="hs-comment">-- the remote side negotiated unidirectional connection, we</span><span>
</span><span id="line-1494"></span><span>                  </span><span class="hs-comment">-- cannot re-use it.</span><span>
</span><span id="line-1495"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenConnection"><span class="hs-identifier hs-var">TrForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256420"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1497"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1498"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenConnection"><span class="hs-identifier hs-var">ForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256420"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1499"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1500"></span><span>
</span><span id="line-1501"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256417"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256417"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256416"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256416"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256415"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256415"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256414"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256414"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1502"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1503"></span><span>                  </span><span class="hs-comment">--   PromotedToWarm^{Duplex}_{Local} : InboundState Duplex</span><span>
</span><span id="line-1504"></span><span>                  </span><span class="hs-comment">--                                   &#8594; DuplexState</span><span>
</span><span id="line-1505"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1506"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256413"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256413"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-var">DuplexState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256417"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256416"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256415"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1507"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256448"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256413"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1508"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-1509"></span><span>                                        </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1510"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256447"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256413"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1511"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1512"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; Wedge
     (Connected peerAddr handle handleError) (ConnectionId peerAddr)
forall a b. a -&gt; Wedge a b
</span><a href="Data.Wedge.html#Here"><span class="hs-identifier hs-var">Here</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256417"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256414"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256415"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1513"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span id="local-6989586621679256412"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256412"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256411"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256411"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span>  </span><span id="local-6989586621679256410"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256410"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1516"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr
-&gt; AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionExists"><span class="hs-identifier hs-var">TrConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256446"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1517"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256449"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1518"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span>
</span><span id="line-1519"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1520"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span id="local-6989586621679256409"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256409"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256408"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256408"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256407"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256407"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1523"></span><span>                  </span><span class="hs-comment">-- await for 'TerminatedState' or for removal of the</span><span>
</span><span id="line-1524"></span><span>                  </span><span class="hs-comment">-- connection from the state.</span><span>
</span><span id="line-1525"></span><span>                  </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace)),
   MutableConnState peerAddr handle handleError version m,
   Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-1526"></span><span>
</span><span id="line-1527"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span id="local-6989586621679256405"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256405"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1528"></span><span>                  </span><span class="hs-comment">-- the connection terminated; we can not reset 'connVar' and</span><span>
</span><span id="line-1529"></span><span>                  </span><span class="hs-comment">-- start afresh. We should wait for the removal of the</span><span>
</span><span id="line-1530"></span><span>                  </span><span class="hs-comment">-- connection from the state.</span><span>
</span><span id="line-1531"></span><span>                  </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace)),
   MutableConnState peerAddr handle handleError version m,
   Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-1532"></span><span>
</span><span id="line-1533"></span><span>            </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1534"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256404"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256404"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span>
</span><span id="line-1535"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679256403"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256403"><span class="hs-identifier hs-var">mutableConnState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span>
</span><span id="line-1536"></span><span>                                                    </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1537"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
forall (m :: * -&gt; *) peerAddr handle handleError version.
MonadSTM m =&gt;
FreshIdSupply m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m (MutableConnState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#newMutableConnState"><span class="hs-identifier hs-var">newMutableConnState</span></a></span><span> </span><span class="annot"><span class="annottext">FreshIdSupply m
</span><a href="#local-6989586621679256459"><span class="hs-identifier hs-var">freshIdSupply</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256404"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1538"></span><span>              </span><span class="hs-comment">-- TODO: label `connVar` using 'ConnectionId'</span><span>
</span><span id="line-1539"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; String -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
StrictTVar m a -&gt; String -&gt; STM m ()
</span><span class="hs-identifier hs-var">labelTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256403"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;conn-state-&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1540"></span><span>
</span><span id="line-1541"></span><span>              </span><span class="hs-comment">-- record the @connVar@ in 'ConnectionManagerState' we can use</span><span>
</span><span id="line-1542"></span><span>              </span><span class="hs-comment">-- 'swapTMVar' as we did not use 'takeTMVar' at the beginning of</span><span>
</span><span id="line-1543"></span><span>              </span><span class="hs-comment">-- this transaction.  Since we already 'readTMVar', it will not</span><span>
</span><span id="line-1544"></span><span>              </span><span class="hs-comment">-- block.</span><span>
</span><span id="line-1545"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679256402"><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256402"><span class="hs-identifier hs-var">mbConnState</span></a></span></span><span>
</span><span id="line-1546"></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionState"><span class="hs-identifier hs-type">ConnectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1547"></span><span>                   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m a
</span><span class="hs-identifier hs-var">swapTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1548"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256403"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256450"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1549"></span><span>                        </span><span class="annot"><span class="annottext">STM
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM
         m (Maybe (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m (Maybe (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(MutableConnState peerAddr handle handleError version m
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
-&gt; STM
     m (Maybe (ConnectionState peerAddr handle handleError version m))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">(StrictTVar
   m (ConnectionState peerAddr handle handleError version m)
 -&gt; STM m (ConnectionState peerAddr handle handleError version m))
-&gt; (MutableConnState peerAddr handle handleError version m
    -&gt; StrictTVar
         m (ConnectionState peerAddr handle handleError version m))
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connVar"><span class="hs-identifier hs-var hs-var">connVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (MutableConnState peerAddr handle handleError version m)
 -&gt; STM
      m (Maybe (ConnectionState peerAddr handle handleError version m)))
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; Maybe (MutableConnState peerAddr handle handleError version m))
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; STM
     m (Maybe (ConnectionState peerAddr handle handleError version m))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1550"></span><span>              </span><span class="annot"><span class="annottext">(Maybe
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace)),
 MutableConnState peerAddr handle handleError version m,
 Either
   (ConnectionManagerError peerAddr)
   (Wedge
      (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
-&gt; STM
     m
     (Maybe
        (Either
           (TransitionTrace
              peerAddr (ConnectionState peerAddr handle handleError version m))
           (ConnectionManagerTrace peerAddr handlerTrace)),
      MutableConnState peerAddr handle handleError version m,
      Either
        (ConnectionManagerError peerAddr)
        (Wedge
           (Connected peerAddr handle handleError) (ConnectionId peerAddr)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-1551"></span><span>                                    </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1552"></span><span>                                    </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1553"></span><span>                                        </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; (ConnectionState peerAddr handle handleError version m
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe (ConnectionState peerAddr handle handleError version m)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256402"><span class="hs-identifier hs-var">mbConnState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1554"></span><span>                                        </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256404"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1555"></span><span>                                      </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1556"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256403"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1557"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
-&gt; Either
     (ConnectionManagerError peerAddr)
     (Wedge
        (Connected peerAddr handle handleError) (ConnectionId peerAddr))
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
forall a b. Wedge a b
</span><a href="Data.Wedge.html#Nowhere"><span class="hs-identifier hs-var">Nowhere</span></a></span><span>
</span><span id="line-1558"></span><span>                     </span><span class="hs-special">)</span><span>
</span><span id="line-1559"></span><span>
</span><span id="line-1560"></span><span>        </span><span class="annot"><span class="annottext">(Either
   (TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
   (ConnectionManagerTrace peerAddr handlerTrace)
 -&gt; m ())
-&gt; Maybe
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ())
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; m ()
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace))
</span><a href="#local-6989586621679256454"><span class="hs-identifier hs-var">trace</span></a></span><span>
</span><span id="line-1561"></span><span>        </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1562"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (ConnectionManagerError peerAddr)
  (Wedge
     (Connected peerAddr handle handleError) (ConnectionId peerAddr))
</span><a href="#local-6989586621679256451"><span class="hs-identifier hs-var">eHandleWedge</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1563"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256398"><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
</span><a href="#local-6989586621679256398"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1564"></span><span>            </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
</span><a href="#local-6989586621679256398"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1565"></span><span>
</span><span id="line-1566"></span><span>          </span><span class="hs-comment">-- connection manager does not have a connection with @peerAddr@.</span><span>
</span><span id="line-1567"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Wedge
  (Connected peerAddr handle handleError) (ConnectionId peerAddr)
</span><a href="Data.Wedge.html#Nowhere"><span class="hs-identifier hs-var">Nowhere</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1568"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256397"><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256397"><span class="hs-identifier hs-var">reader</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256396"><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256396"><span class="hs-identifier hs-var">writer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (PromiseReader m (Either handleError (handle, version)),
   PromiseWriter m (Either handleError (handle, version)))
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadThrow (STM m)) =&gt;
m (PromiseReader m a, PromiseWriter m a)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#newEmptyPromiseIO"><span class="hs-identifier hs-var">newEmptyPromiseIO</span></a></span><span>
</span><span id="line-1569"></span><span>
</span><span id="line-1570"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256395"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256394"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256394"><span class="hs-identifier hs-var">connThread</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1571"></span><span>              </span><span class="hs-comment">-- This section of code passes the control over socket from</span><span>
</span><span id="line-1572"></span><span>              </span><span class="hs-comment">-- `bracketOnError` which is responsible for:</span><span>
</span><span id="line-1573"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1574"></span><span>              </span><span class="hs-comment">--    * creating socket</span><span>
</span><span id="line-1575"></span><span>              </span><span class="hs-comment">--    * connecting to remote host</span><span>
</span><span id="line-1576"></span><span>              </span><span class="hs-comment">--    * obtaining local address of the connection</span><span>
</span><span id="line-1577"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1578"></span><span>              </span><span class="hs-comment">-- to the connection handler and its resource cleanup.</span><span>
</span><span id="line-1579"></span><span>              </span><span class="hs-comment">-- Both the 'bracketOnError''s resource handler and the</span><span>
</span><span id="line-1580"></span><span>              </span><span class="hs-comment">-- connection handler cleanup function are responsible for:</span><span>
</span><span id="line-1581"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1582"></span><span>              </span><span class="hs-comment">--  * closing the socket</span><span>
</span><span id="line-1583"></span><span>              </span><span class="hs-comment">--  * freeing the slot in connection manager state map</span><span>
</span><span id="line-1584"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1585"></span><span>              </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m (ConnectionId peerAddr, Async m ()))
-&gt; m (ConnectionId peerAddr, Async m ())
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m (ConnectionId peerAddr, Async m ()))
 -&gt; m (ConnectionId peerAddr, Async m ()))
-&gt; ((forall a. m a -&gt; m a)
    -&gt; m (ConnectionId peerAddr, Async m ()))
-&gt; m (ConnectionId peerAddr, Async m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256393"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679256393"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1586"></span><span>
</span><span id="line-1587"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1588"></span><span>                </span><span class="hs-comment">-- connect</span><span>
</span><span id="line-1589"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1590"></span><span>
</span><span id="line-1591"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679256392"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256392"><span class="hs-identifier hs-var">socket</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256391"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256391"><span class="hs-identifier hs-var">connId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1592"></span><span>                  </span><span class="annot"><span class="annottext">m (socket, ConnectionId peerAddr)
-&gt; m (socket, ConnectionId peerAddr)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679256393"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">(m (socket, ConnectionId peerAddr)
 -&gt; m (socket, ConnectionId peerAddr))
-&gt; m (socket, ConnectionId peerAddr)
-&gt; m (socket, ConnectionId peerAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m socket
-&gt; (socket -&gt; m ())
-&gt; (socket -&gt; m (socket, ConnectionId peerAddr))
-&gt; m (socket, ConnectionId peerAddr)
forall (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracketOnError</span></span><span>
</span><span id="line-1593"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; peerAddr -&gt; m socket
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; addr -&gt; m fd
</span><a href="Ouroboros.Network.Snocket.html#openToConnect"><span class="hs-identifier hs-var hs-var">openToConnect</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1594"></span><span>                    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679256388"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256388"><span class="hs-identifier hs-var">socket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">uninterruptibleMask_</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1595"></span><span>                      </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m ()
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256388"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-1596"></span><span>                      </span><span id="local-6989586621679256387"><span class="annot"><span class="annottext">Either
  ()
  [Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256387"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Either
     ()
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))])
-&gt; m (Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Either
      ()
      [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
 -&gt; m (Either
         ()
         [Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))]))
-&gt; STM
     m
     (Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
-&gt; m (Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM
         m
         (ConnectionManagerState peerAddr handle handleError version m,
          Either
            ()
            [Transition'
               (MaybeUnknown
                  (ConnectionState peerAddr handle handleError version m))]))
-&gt; STM
     m
     (Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall (m :: * -&gt; *) a b.
MonadSTM m =&gt;
StrictTMVar m a -&gt; (a -&gt; STM m (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarSTM"><span class="hs-identifier hs-var">modifyTMVarSTM</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerState peerAddr handle handleError version m
  -&gt; STM
       m
       (ConnectionManagerState peerAddr handle handleError version m,
        Either
          ()
          [Transition'
             (MaybeUnknown
                (ConnectionState peerAddr handle handleError version m))]))
 -&gt; STM
      m
      (Either
         ()
         [Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))]))
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; STM
         m
         (ConnectionManagerState peerAddr handle handleError version m,
          Either
            ()
            [Transition'
               (MaybeUnknown
                  (ConnectionState peerAddr handle handleError version m))]))
-&gt; STM
     m
     (Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256386"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256386"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1597"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256386"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1598"></span><span>                          </span><span class="hs-comment">-- Lookup failed, which means connection was already</span><span>
</span><span id="line-1599"></span><span>                          </span><span class="hs-comment">-- removed.  So we just update the connVar and trace</span><span>
</span><span id="line-1600"></span><span>                          </span><span class="hs-comment">-- accordingly.</span><span>
</span><span id="line-1601"></span><span>                          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1602"></span><span>                            </span><span id="local-6989586621679256385"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256385"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1603"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256384"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256384"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1604"></span><span>                            </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256384"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1605"></span><span>                            </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Either
   ()
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-1606"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256386"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1607"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; Either
     ()
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256385"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256384"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1608"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-var">Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256384"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-1609"></span><span>                                      </span><span class="hs-special">]</span><span>
</span><span id="line-1610"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-1611"></span><span>
</span><span id="line-1612"></span><span>                          </span><span class="hs-comment">-- Current connVar.</span><span>
</span><span id="line-1613"></span><span>                          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256383"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256383"><span class="hs-identifier hs-var">mutableConnState'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1614"></span><span>                            </span><span class="hs-comment">-- If accept call returned first than connect then</span><span>
</span><span id="line-1615"></span><span>                            </span><span class="hs-comment">-- the connVar will be replaced. If it was</span><span>
</span><span id="line-1616"></span><span>                            </span><span class="hs-comment">-- replaced then we do not need to do anything.</span><span>
</span><span id="line-1617"></span><span>                            </span><span class="hs-comment">-- Otherwise, we need to remove the connVar from</span><span>
</span><span id="line-1618"></span><span>                            </span><span class="hs-comment">-- the state and trace accordingly.</span><span>
</span><span id="line-1619"></span><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256383"><span class="hs-identifier hs-var">mutableConnState'</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256453"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1620"></span><span>                               </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1621"></span><span>                                </span><span id="local-6989586621679256382"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256382"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1622"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256381"><span class="annot"><span class="annottext">state' :: ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256381"><span class="hs-identifier hs-var hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256386"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1623"></span><span>                                    </span><span id="local-6989586621679256380"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256380"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1624"></span><span>                                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256380"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1625"></span><span>                                </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Either
   ()
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-1626"></span><span>                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256381"><span class="hs-identifier hs-var">state'</span></a></span><span>
</span><span id="line-1627"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; Either
     ()
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256382"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256380"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1628"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-var">Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256380"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1629"></span><span>                                                       </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-1630"></span><span>                                          </span><span class="hs-special">]</span><span>
</span><span id="line-1631"></span><span>                                  </span><span class="hs-special">)</span><span>
</span><span id="line-1632"></span><span>                               </span><span class="hs-keyword">else</span><span>
</span><span id="line-1633"></span><span>                                </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m,
 Either
   ()
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     (ConnectionManagerState peerAddr handle handleError version m,
      Either
        ()
        [Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-1634"></span><span>                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256386"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1635"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Either
     ()
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1636"></span><span>                                  </span><span class="hs-special">)</span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  ()
  [Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256387"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1639"></span><span>                        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1640"></span><span>                        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679256379"><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256379"><span class="hs-identifier hs-var">trs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1641"></span><span>                          </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256379"><span class="hs-identifier hs-var">trs</span></a></span><span>
</span><span id="line-1642"></span><span>                      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1643"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-1644"></span><span>                    </span><span class="annot"><span class="annottext">((socket -&gt; m (socket, ConnectionId peerAddr))
 -&gt; m (socket, ConnectionId peerAddr))
-&gt; (socket -&gt; m (socket, ConnectionId peerAddr))
-&gt; m (socket, ConnectionId peerAddr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256378"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1645"></span><span>                      </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectionNotFound"><span class="hs-identifier hs-var">TrConnectionNotFound</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1646"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256376"><span class="annot"><span class="annottext">addr :: Maybe peerAddr
</span><a href="#local-6989586621679256376"><span class="hs-identifier hs-var hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679256783"><span class="hs-identifier hs-var">cmAddressType</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1647"></span><span>                                   </span><span class="annot"><span class="annottext">Maybe AddressType
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1648"></span><span>                                   </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#IPv4Address"><span class="hs-identifier hs-var">IPv4Address</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256785"><span class="hs-identifier hs-var">cmIPv4Address</span></a></span><span>
</span><span id="line-1649"></span><span>                                   </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#IPv6Address"><span class="hs-identifier hs-var">IPv6Address</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256784"><span class="hs-identifier hs-var">cmIPv6Address</span></a></span><span>
</span><span id="line-1650"></span><span>                      </span><span class="annot"><span class="annottext">socket -&gt; Maybe peerAddr -&gt; m ()
</span><a href="#local-6989586621679256780"><span class="hs-identifier hs-var">cmConfigureSocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256376"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-1651"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679256783"><span class="hs-identifier hs-var">cmAddressType</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1652"></span><span>                        </span><span class="annot"><span class="annottext">Maybe AddressType
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1653"></span><span>                        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#IPv4Address"><span class="hs-identifier hs-var">IPv4Address</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1654"></span><span>                             </span><span class="annot"><span class="annottext">(peerAddr -&gt; m ()) -&gt; Maybe peerAddr -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; peerAddr -&gt; m ()
forall (m :: * -&gt; *) fd addr.
Snocket m fd addr -&gt; fd -&gt; addr -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#bind"><span class="hs-identifier hs-var hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1655"></span><span>                                       </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256785"><span class="hs-identifier hs-var">cmIPv4Address</span></a></span><span>
</span><span id="line-1656"></span><span>                        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#IPv6Address"><span class="hs-identifier hs-var">IPv6Address</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1657"></span><span>                             </span><span class="annot"><span class="annottext">(peerAddr -&gt; m ()) -&gt; Maybe peerAddr -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; peerAddr -&gt; m ()
forall (m :: * -&gt; *) fd addr.
Snocket m fd addr -&gt; fd -&gt; addr -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#bind"><span class="hs-identifier hs-var hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1658"></span><span>                                       </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256784"><span class="hs-identifier hs-var">cmIPv6Address</span></a></span><span>
</span><span id="line-1659"></span><span>
</span><span id="line-1660"></span><span>                      </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe peerAddr
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Maybe peerAddr
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnect"><span class="hs-identifier hs-var">TrConnect</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256376"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1661"></span><span>                      </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; peerAddr -&gt; m ()
forall (m :: * -&gt; *) fd addr.
Snocket m fd addr -&gt; fd -&gt; addr -&gt; m ()
</span><a href="Ouroboros.Network.Snocket.html#connect"><span class="hs-identifier hs-var hs-var">connect</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1662"></span><span>                        </span><span class="annot"><span class="annottext">m () -&gt; (SomeException -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256370"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256370"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1663"></span><span>                          </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe peerAddr
-&gt; peerAddr
-&gt; SomeException
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Maybe peerAddr
-&gt; peerAddr
-&gt; SomeException
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrConnectError"><span class="hs-identifier hs-var">TrConnectError</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe peerAddr
</span><a href="#local-6989586621679256376"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256370"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1664"></span><span>                          </span><span class="hs-comment">-- the handler attached by `bracketOnError` will</span><span>
</span><span id="line-1665"></span><span>                          </span><span class="hs-comment">-- reset the state</span><span>
</span><span id="line-1666"></span><span>                          </span><span class="annot"><span class="annottext">SomeException -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679256370"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1667"></span><span>                      </span><span id="local-6989586621679256368"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256368"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr -&gt; socket -&gt; m peerAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><a href="Ouroboros.Network.Snocket.html#getLocalAddr"><span class="hs-identifier hs-var hs-var">getLocalAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m socket peerAddr
</span><a href="#local-6989586621679256782"><span class="hs-identifier hs-var">cmSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-1668"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256367"><span class="annot"><span class="annottext">connId :: ConnectionId peerAddr
</span><a href="#local-6989586621679256367"><span class="hs-identifier hs-var hs-var">connId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId :: forall addr. addr -&gt; addr -&gt; ConnectionId addr
</span><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">peerAddr
localAddress :: peerAddr
localAddress :: peerAddr
</span><a href="#local-6989586621679256368"><span class="hs-identifier hs-var hs-var">localAddress</span></a></span><span>
</span><span id="line-1669"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">remoteAddress :: peerAddr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1670"></span><span>                                                </span><span class="hs-special">}</span><span>
</span><span id="line-1671"></span><span>                      </span><span class="annot"><span class="annottext">(socket, ConnectionId peerAddr)
-&gt; m (socket, ConnectionId peerAddr)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256378"><span class="hs-identifier hs-var">socket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256367"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1672"></span><span>
</span><span id="line-1673"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1674"></span><span>                </span><span class="hs-comment">-- fork connection handler; it will unmask exceptions</span><span>
</span><span id="line-1675"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1676"></span><span>
</span><span id="line-1677"></span><span>                </span><span id="local-6989586621679256366"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256366"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1678"></span><span>                  </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; MutableConnState peerAddr handle handleError version m
-&gt; socket
-&gt; ConnectionId peerAddr
-&gt; PromiseWriter m (Either handleError (handle, version))
-&gt; ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m
-&gt; m (Async m ())
</span><a href="#local-6989586621679256684"><span class="hs-identifier hs-var">forkConnectionHandler</span></a></span><span>
</span><span id="line-1679"></span><span>                    </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256453"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679256392"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256391"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseWriter m (Either handleError (handle, version))
</span><a href="#local-6989586621679256396"><span class="hs-identifier hs-var">writer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  handlerTrace socket peerAddr handle handleError version m
</span><a href="#local-6989586621679256457"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-1680"></span><span>                </span><span class="annot"><span class="annottext">(ConnectionId peerAddr, Async m ())
-&gt; m (ConnectionId peerAddr, Async m ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256391"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256366"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1681"></span><span>
</span><span id="line-1682"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256365"><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256365"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256364"><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256364"><span class="hs-identifier hs-var">mbAssertion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))),
   Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))),
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; m (Maybe
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))),
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1683"></span><span>              </span><span id="local-6989586621679256363"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256363"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1684"></span><span>
</span><span id="line-1685"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1686"></span><span>              </span><span class="hs-comment">--  Connected : ReservedOutboundState</span><span>
</span><span id="line-1687"></span><span>              </span><span class="hs-comment">--            &#8594; UnnegotiatedState Outbound</span><span>
</span><span id="line-1688"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1689"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256363"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1690"></span><span>                </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1691"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256362"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256362"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; Async m ()
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Provenance
-&gt; ConnectionId peerAddr
-&gt; Async m ()
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-var">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256394"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1692"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256362"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1693"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256363"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256362"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1694"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1695"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1696"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1697"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1698"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1699"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1700"></span><span>                </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1701"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1702"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-1703"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#RequestOutboundConnection"><span class="hs-identifier hs-var">RequestOutboundConnection</span></a></span><span>
</span><span id="line-1704"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1705"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256363"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1706"></span><span>                                   </span><span class="hs-special">)</span><span>
</span><span id="line-1707"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-1708"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1709"></span><span>
</span><span id="line-1710"></span><span>            </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256365"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-1711"></span><span>            </span><span class="annot"><span class="annottext">(ConnectionManagerTrace peerAddr handlerTrace -&gt; m ())
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnectionManagerTrace peerAddr handlerTrace -&gt; m ())
-&gt; (() -&gt; m ())
-&gt; ConnectionManagerTrace peerAddr handlerTrace
-&gt; m ()
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="annot"><span class="annottext">(() -&gt; m ()) -&gt; (() -&gt; ()) -&gt; () -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; () -&gt; ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1712"></span><span>                      </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256364"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span>
</span><span id="line-1713"></span><span>            </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1714"></span><span>
</span><span id="line-1715"></span><span>            </span><span id="local-6989586621679256360"><span class="annot"><span class="annottext">Either handleError (handle, version)
</span><a href="#local-6989586621679256360"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Either handleError (handle, version))
-&gt; m (Either handleError (handle, version))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
-&gt; STM m (Either handleError (handle, version))
forall (m :: * -&gt; *) a. PromiseReader m a -&gt; STM m a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#readPromise"><span class="hs-identifier hs-var hs-var">readPromise</span></a></span><span> </span><span class="annot"><span class="annottext">PromiseReader m (Either handleError (handle, version))
</span><a href="#local-6989586621679256397"><span class="hs-identifier hs-var">reader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1716"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either handleError (handle, version)
</span><a href="#local-6989586621679256360"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1717"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256359"><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256359"><span class="hs-identifier hs-var">handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1718"></span><span>                </span><span id="local-6989586621679256358"><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256358"><span class="hs-identifier hs-var">transitions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  [Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
 -&gt; m [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
-&gt; m [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1719"></span><span>                  </span><span id="local-6989586621679256357"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256357"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1720"></span><span>
</span><span id="line-1721"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256356"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256356"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1722"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">handleError -&gt; HandleErrorType
</span><a href="#local-6989586621679256771"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256359"><span class="hs-identifier hs-var">handleError</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1723"></span><span>                          </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1724"></span><span>                            </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256394"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-1725"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256359"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1726"></span><span>                          </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeProtocolViolation"><span class="hs-identifier hs-var">HandshakeProtocolViolation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1727"></span><span>                            </span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256359"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1728"></span><span>                      </span><span id="local-6989586621679256355"><span class="annot"><span class="annottext">transition :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256355"><span class="hs-identifier hs-var hs-var">transition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256357"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256356"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1729"></span><span>                      </span><span id="local-6989586621679256354"><span class="annot"><span class="annottext">absConnState :: AbstractState
</span><a href="#local-6989586621679256354"><span class="hs-identifier hs-var hs-var">absConnState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256357"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1730"></span><span>                      </span><span id="local-6989586621679256353"><span class="annot"><span class="annottext">shouldTrace :: Bool
</span><a href="#local-6989586621679256353"><span class="hs-identifier hs-var hs-var">shouldTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256354"><span class="hs-identifier hs-var">absConnState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState -&gt; AbstractState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-1731"></span><span>
</span><span id="line-1732"></span><span>                  </span><span class="hs-comment">-- 'handleError' might be either a handshake negotiation</span><span>
</span><span id="line-1733"></span><span>                  </span><span class="hs-comment">-- a protocol failure (an IO exception, a timeout or</span><span>
</span><span id="line-1734"></span><span>                  </span><span class="hs-comment">-- codec failure).  In the first case we should not reset</span><span>
</span><span id="line-1735"></span><span>                  </span><span class="hs-comment">-- the connection as this is not a protocol error.</span><span>
</span><span id="line-1736"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256356"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1737"></span><span>
</span><span id="line-1738"></span><span>                  </span><span id="local-6989586621679256352"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256352"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1739"></span><span>                    </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; (ConnectionManagerState peerAddr handle handleError version m
    -&gt; (ConnectionManagerState peerAddr handle handleError version m,
        Bool))
-&gt; STM m Bool
forall (m :: * -&gt; *) a b.
MonadSTM m =&gt;
StrictTMVar m a -&gt; (a -&gt; (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarPure"><span class="hs-identifier hs-var">modifyTMVarPure</span></a></span><span>
</span><span id="line-1740"></span><span>                      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1741"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256351"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256351"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1742"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256351"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1743"></span><span>                          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256351"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1744"></span><span>                          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256350"><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256350"><span class="hs-identifier hs-var">mutableConnState'</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1745"></span><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256350"><span class="hs-identifier hs-var">mutableConnState'</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
-&gt; MutableConnState peerAddr handle handleError version m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MutableConnState peerAddr handle handleError version m
</span><a href="#local-6989586621679256453"><span class="hs-identifier hs-var">mutableConnState</span></a></span><span>
</span><span id="line-1746"></span><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionManagerState peerAddr handle handleError version m
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256351"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1747"></span><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256351"><span class="hs-identifier hs-var">state</span></a></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1748"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-1749"></span><span>
</span><span id="line-1750"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256352"><span class="hs-identifier hs-var">updated</span></a></span><span>
</span><span id="line-1751"></span><span>                     </span><span class="hs-keyword">then</span><span>
</span><span id="line-1752"></span><span>                    </span><span class="hs-comment">-- Key was present in the dictionary (stateVar) and</span><span>
</span><span id="line-1753"></span><span>                    </span><span class="hs-comment">-- removed so we trace the removal.</span><span>
</span><span id="line-1754"></span><span>                      </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([Transition'
    (MaybeUnknown
       (ConnectionState peerAddr handle handleError version m))]
 -&gt; STM
      m
      [Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))])
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1755"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256353"><span class="hs-identifier hs-var">shouldTrace</span></a></span><span>
</span><span id="line-1756"></span><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256355"><span class="hs-identifier hs-var">transition</span></a></span><span>
</span><span id="line-1757"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-1758"></span><span>                                   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1759"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-1760"></span><span>                                   </span><span class="hs-special">}</span><span>
</span><span id="line-1761"></span><span>                                </span><span class="hs-special">]</span><span>
</span><span id="line-1762"></span><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Transition :: forall state. state -&gt; state -&gt; Transition' state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span>
</span><span id="line-1763"></span><span>                                   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fromState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var">fromState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1764"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">toState :: MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#toState"><span class="hs-identifier hs-var">toState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
forall state. MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-1765"></span><span>                                   </span><span class="hs-special">}</span><span>
</span><span id="line-1766"></span><span>                                </span><span class="hs-special">]</span><span>
</span><span id="line-1767"></span><span>                    </span><span class="hs-comment">-- Key was not present in the dictionary (stateVar),</span><span>
</span><span id="line-1768"></span><span>                    </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-1769"></span><span>                    </span><span class="hs-comment">-- deletion.</span><span>
</span><span id="line-1770"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1771"></span><span>                    </span><span class="hs-comment">-- OR</span><span>
</span><span id="line-1772"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1773"></span><span>                    </span><span class="hs-comment">-- Key was overwritten in the dictionary (stateVar),</span><span>
</span><span id="line-1774"></span><span>                    </span><span class="hs-comment">-- so we do not trace anything as it was already traced upon</span><span>
</span><span id="line-1775"></span><span>                    </span><span class="hs-comment">-- overwriting.</span><span>
</span><span id="line-1776"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
-&gt; STM
     m
     [Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1777"></span><span>
</span><span id="line-1778"></span><span>
</span><span id="line-1779"></span><span>                </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; [Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))]
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))]
</span><a href="#local-6989586621679256358"><span class="hs-identifier hs-var">transitions</span></a></span><span>
</span><span id="line-1780"></span><span>                </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1781"></span><span>
</span><span id="line-1782"></span><span>                </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">handleError -&gt; Maybe handleError
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">handleError
</span><a href="#local-6989586621679256359"><span class="hs-identifier hs-var">handleError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1783"></span><span>
</span><span id="line-1784"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256349"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256349"><span class="hs-identifier hs-var">handle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256348"><span class="annot"><span class="annottext">version
</span><a href="#local-6989586621679256348"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1785"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256347"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256347"><span class="hs-identifier hs-var hs-var">dataFlow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">version -&gt; DataFlow
</span><a href="#local-6989586621679256777"><span class="hs-identifier hs-var">connectionDataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">version
</span><a href="#local-6989586621679256348"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-1786"></span><span>                </span><span class="hs-comment">-- We can safely overwrite the state: after successful</span><span>
</span><span id="line-1787"></span><span>                </span><span class="hs-comment">-- `connect` it's not possible to have a race condition</span><span>
</span><span id="line-1788"></span><span>                </span><span class="hs-comment">-- with any other inbound thread.  We are also guaranteed</span><span>
</span><span id="line-1789"></span><span>                </span><span class="hs-comment">-- to have exclusive access as an outbound thread.</span><span>
</span><span id="line-1790"></span><span>                </span><span id="local-6989586621679256346"><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256346"><span class="hs-identifier hs-var">mbTransition</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
 -&gt; m (Maybe
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m)))))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
-&gt; m (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1791"></span><span>                  </span><span id="local-6989586621679256345"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256345"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span>  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1792"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256345"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1793"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1794"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256347"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1795"></span><span>                        </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1796"></span><span>                          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1797"></span><span>                          </span><span class="hs-comment">--  Negotiated^{Unidirectional}_{Outbound}</span><span>
</span><span id="line-1798"></span><span>                          </span><span class="hs-comment">--    : UnnegotiatedState Outbound</span><span>
</span><span id="line-1799"></span><span>                          </span><span class="hs-comment">--    &#8594; OutboundUniState Outbound</span><span>
</span><span id="line-1800"></span><span>                          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1801"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256344"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256344"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-var">OutboundUniState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256394"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256349"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1802"></span><span>                          </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256344"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1803"></span><span>                          </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256345"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256344"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1804"></span><span>                        </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1805"></span><span>                          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1806"></span><span>                          </span><span class="hs-comment">--  Negotiated^{Duplex}_{Outbound}</span><span>
</span><span id="line-1807"></span><span>                          </span><span class="hs-comment">--    : UnnegotiatedState Outbound</span><span>
</span><span id="line-1808"></span><span>                          </span><span class="hs-comment">--    &#8594; OutboundDupState^\tau  Outbound</span><span>
</span><span id="line-1809"></span><span>                          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1810"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256343"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256343"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256394"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256349"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span>
</span><span id="line-1811"></span><span>                          </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256343"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1812"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InResponderMode muxMode (ControlChannel peerAddr handle m)
</span><a href="#local-6989586621679256770"><span class="hs-identifier hs-var">inboundGovernorControlChannel</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1813"></span><span>                            </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#InResponderMode"><span class="hs-identifier hs-type">InResponderMode</span></a></span><span> </span><span id="local-6989586621679256342"><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
</span><a href="#local-6989586621679256342"><span class="hs-identifier hs-var">controlChannel</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1814"></span><span>                              </span><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
-&gt; NewConnection peerAddr handle -&gt; STM m ()
forall peerAddr handle (m :: * -&gt; *).
ControlChannel peerAddr handle m
-&gt; NewConnection peerAddr handle -&gt; STM m ()
</span><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#writeMessage"><span class="hs-identifier hs-var hs-var">ControlChannel.writeMessage</span></a></span><span>
</span><span id="line-1815"></span><span>                                </span><span class="annot"><span class="annottext">ControlChannel peerAddr handle m
</span><a href="#local-6989586621679256342"><span class="hs-identifier hs-var">controlChannel</span></a></span><span>
</span><span id="line-1816"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; DataFlow
-&gt; handle
-&gt; NewConnection peerAddr handle
forall peerAddr handle.
Provenance
-&gt; ConnectionId peerAddr
-&gt; DataFlow
-&gt; handle
-&gt; NewConnection peerAddr handle
</span><a href="Ouroboros.Network.InboundGovernor.ControlChannel.html#NewConnection"><span class="hs-identifier hs-var">ControlChannel.NewConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256347"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256349"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1817"></span><span>                            </span><span class="annot"><span class="annottext">InResponderMode muxMode (ControlChannel peerAddr handle m)
</span><a href="Ouroboros.Network.MuxMode.html#NotInResponderMode"><span class="hs-identifier hs-var">NotInResponderMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1818"></span><span>                          </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; Maybe
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256345"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256343"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1819"></span><span>                    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1820"></span><span>                      </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1821"></span><span>                    </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1822"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256341"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256341"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256345"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1823"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Maybe
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenOperation"><span class="hs-identifier hs-var">ForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256341"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1824"></span><span>                </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span>  </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1825"></span><span>                          </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256346"><span class="hs-identifier hs-var">mbTransition</span></a></span><span>
</span><span id="line-1826"></span><span>                </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1827"></span><span>                </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Connected peerAddr handle handleError
 -&gt; m (Connected peerAddr handle handleError))
-&gt; Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256346"><span class="hs-identifier hs-var">mbTransition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1828"></span><span>                  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span>    </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256347"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256349"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1829"></span><span>                  </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256395"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1830"></span><span>
</span><span id="line-1831"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Wedge.html#There"><span class="hs-identifier hs-type">There</span></a></span><span> </span><span id="local-6989586621679256340"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1832"></span><span>            </span><span class="hs-comment">-- We can only enter the 'There' case if there is an inbound</span><span>
</span><span id="line-1833"></span><span>            </span><span class="hs-comment">-- connection, and we are about to reuse it, but we need to wait</span><span>
</span><span id="line-1834"></span><span>            </span><span class="hs-comment">-- for handshake.</span><span>
</span><span id="line-1835"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679256339"><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256339"><span class="hs-identifier hs-var">etr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256338"><span class="annot"><span class="annottext">Connected peerAddr handle handleError
</span><a href="#local-6989586621679256338"><span class="hs-identifier hs-var">connected</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace),
   Connected peerAddr handle handleError)
-&gt; m (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Either
      (TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
      (ConnectionManagerTrace peerAddr handlerTrace),
    Connected peerAddr handle handleError)
 -&gt; m (Either
         (TransitionTrace
            peerAddr (ConnectionState peerAddr handle handleError version m))
         (ConnectionManagerTrace peerAddr handlerTrace),
       Connected peerAddr handle handleError))
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
-&gt; m (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1836"></span><span>              </span><span id="local-6989586621679256337"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256337"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1837"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256337"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1838"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-type">ReservedOutboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1839"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span>
</span><span id="line-1840"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ImpossibleState"><span class="hs-identifier hs-var">ImpossibleState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; peerAddr
forall addr. ConnectionId addr -&gt; addr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1841"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1842"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError (ConnectionId peerAddr)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span>
</span><span id="line-1843"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError (ConnectionId peerAddr))
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; CallStack
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1844"></span><span>
</span><span id="line-1845"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Inbound"><span class="hs-identifier hs-var">Inbound</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1846"></span><span>                  </span><span class="hs-comment">-- await for connection negotiation</span><span>
</span><span id="line-1847"></span><span>                  </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace),
   Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-1848"></span><span>
</span><span id="line-1849"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1850"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError (ConnectionId peerAddr)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError (ConnectionId peerAddr))
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; CallStack
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1851"></span><span>
</span><span id="line-1852"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1853"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError (ConnectionId peerAddr)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError (ConnectionId peerAddr))
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; CallStack
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1854"></span><span>
</span><span id="line-1855"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256336"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256336"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256335"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256335"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256334"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256334"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256333"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256333"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1856"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256332"><span class="annot"><span class="annottext">tr :: AbstractState
</span><a href="#local-6989586621679256332"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256337"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1857"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
peerAddr
-&gt; AbstractState -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenOperation"><span class="hs-identifier hs-var">ForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256332"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1858"></span><span>
</span><span id="line-1859"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256331"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256331"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256330"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256330"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256329"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256329"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256328"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256328"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1860"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1861"></span><span>                  </span><span class="hs-comment">--   Awake^{Duplex}_{Local} : InboundIdleState Duplex</span><span>
</span><span id="line-1862"></span><span>                  </span><span class="hs-comment">--                          &#8594; OutboundState^\tau Duplex</span><span>
</span><span id="line-1863"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1864"></span><span>                  </span><span class="hs-comment">-- This transition can happen if there are concurrent</span><span>
</span><span id="line-1865"></span><span>                  </span><span class="hs-comment">-- `includeInboudConnection` and `requestOutboundConnection`</span><span>
</span><span id="line-1866"></span><span>                  </span><span class="hs-comment">-- calls.</span><span>
</span><span id="line-1867"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256327"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256327"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256330"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256329"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span>
</span><span id="line-1868"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256327"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1869"></span><span>                  </span><span class="annot"><span class="annottext">(Either
   (TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
   (ConnectionManagerTrace peerAddr handlerTrace),
 Connected peerAddr handle handleError)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-1870"></span><span>                                  </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1871"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256337"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256327"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1872"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256328"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256329"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1873"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256326"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256326"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256325"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256325"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256324"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256324"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1876"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span>
</span><span id="line-1877"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenConnection"><span class="hs-identifier hs-var">ForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1878"></span><span>
</span><span id="line-1879"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256323"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256323"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256322"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256322"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256321"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256321"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256320"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256320"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1880"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1881"></span><span>                  </span><span class="hs-comment">--   PromotedToWarm^{Duplex}_{Local} : InboundState Duplex</span><span>
</span><span id="line-1882"></span><span>                  </span><span class="hs-comment">--                                   &#8594; DuplexState</span><span>
</span><span id="line-1883"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1884"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-1885"></span><span>                  </span><span class="hs-comment">-- Note: this is unlikely to observe: @There connId@ only</span><span>
</span><span id="line-1886"></span><span>                  </span><span class="hs-comment">-- appears if an inbound connection is unnegotiated, it is</span><span>
</span><span id="line-1887"></span><span>                  </span><span class="hs-comment">-- more likely to observe the</span><span>
</span><span id="line-1888"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1889"></span><span>                  </span><span class="hs-comment">--    InboundIdleState Duplex -&gt; OutboundDupState</span><span>
</span><span id="line-1890"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1891"></span><span>                  </span><span class="hs-comment">-- transition.</span><span>
</span><span id="line-1892"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256319"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256319"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-var">DuplexState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256322"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256321"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1893"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256452"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256319"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1894"></span><span>                  </span><span class="annot"><span class="annottext">(Either
   (TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
   (ConnectionManagerTrace peerAddr handlerTrace),
 Connected peerAddr handle handleError)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span>
</span><span id="line-1895"></span><span>                                  </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256456"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-1896"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256337"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256319"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1897"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; DataFlow -&gt; handle -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Connected"><span class="hs-identifier hs-var">Connected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256320"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256321"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1898"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1899"></span><span>
</span><span id="line-1900"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1901"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError peerAddr
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError peerAddr)
-&gt; ConnectionManagerError peerAddr
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
forall peerAddr.
ConnectionId peerAddr
-&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ForbiddenConnection"><span class="hs-identifier hs-var">ForbiddenConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1902"></span><span>
</span><span id="line-1903"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1904"></span><span>                  </span><span class="annot"><span class="annottext">ConnectionManagerError (ConnectionId peerAddr)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadThrow (STM m), Exception e) =&gt;
e -&gt; STM m a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallStack -&gt; ConnectionManagerError (ConnectionId peerAddr))
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall a. HasCallStack =&gt; (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var">withCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; CallStack
-&gt; ConnectionManagerError (ConnectionId peerAddr)
forall peerAddr.
Provenance
-&gt; peerAddr -&gt; CallStack -&gt; ConnectionManagerError peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionExists"><span class="hs-identifier hs-var">ConnectionExists</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1905"></span><span>
</span><span id="line-1906"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span id="local-6989586621679256318"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256318"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256317"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256317"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256316"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256316"><span class="hs-identifier hs-var">handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1907"></span><span>                  </span><span class="annot"><span class="annottext">(Either
   (TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
   (ConnectionManagerTrace peerAddr handlerTrace),
 Connected peerAddr handle handleError)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; ConnectionId peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrTerminatingConnection"><span class="hs-identifier hs-var">TrTerminatingConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1908"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256316"><span class="hs-identifier hs-var">handleError</span></a></span><span>
</span><span id="line-1909"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1910"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span id="local-6989586621679256314"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256314"><span class="hs-identifier hs-var">handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1911"></span><span>                  </span><span class="annot"><span class="annottext">(Either
   (TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
   (ConnectionManagerTrace peerAddr handlerTrace),
 Connected peerAddr handle handleError)
-&gt; STM
     m
     (Either
        (TransitionTrace
           peerAddr (ConnectionState peerAddr handle handleError version m))
        (ConnectionManagerTrace peerAddr handlerTrace),
      Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Either
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
     (ConnectionManagerTrace peerAddr handlerTrace)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrTerminatedConnection"><span class="hs-identifier hs-var">TrTerminatedConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="#local-6989586621679256455"><span class="hs-identifier hs-var">provenance</span></a></span><span>
</span><span id="line-1912"></span><span>                                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; peerAddr
forall addr. ConnectionId addr -&gt; addr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1913"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
forall peerAddr handle handleError.
ConnectionId peerAddr
-&gt; Maybe handleError -&gt; Connected peerAddr handle handleError
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Disconnected"><span class="hs-identifier hs-var">Disconnected</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256340"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256314"><span class="hs-identifier hs-var">handleError</span></a></span><span>
</span><span id="line-1914"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-1915"></span><span>
</span><span id="line-1916"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
  (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256339"><span class="hs-identifier hs-var">etr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1917"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256312"><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256312"><span class="hs-identifier hs-var">tr'</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionTrace
  peerAddr (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256312"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-1918"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679256311"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256311"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span>   </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256311"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-1919"></span><span>            </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1920"></span><span>            </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
</span><a href="#local-6989586621679256338"><span class="hs-identifier hs-var">connected</span></a></span><span>
</span><span id="line-1921"></span><span>
</span><span id="line-1922"></span><span>          </span><span class="hs-comment">-- Connection manager has a connection which can be reused.</span><span>
</span><span id="line-1923"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Wedge.html#Here"><span class="hs-identifier hs-type">Here</span></a></span><span> </span><span id="local-6989586621679256310"><span class="annot"><span class="annottext">Connected peerAddr handle handleError
</span><a href="#local-6989586621679256310"><span class="hs-identifier hs-var">connected</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1924"></span><span>            </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256458"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1925"></span><span>            </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
-&gt; m (Connected peerAddr handle handleError)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Connected peerAddr handle handleError
</span><a href="#local-6989586621679256310"><span class="hs-identifier hs-var">connected</span></a></span><span>
</span><span id="line-1926"></span><span>
</span><span id="line-1927"></span><span>
</span><span id="line-1928"></span><span>    </span><span class="annot"><a href="#local-6989586621679256741"><span class="hs-identifier hs-type">unregisterOutboundConnectionImpl</span></a></span><span>
</span><span id="line-1929"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1930"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1931"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-1932"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationResult"><span class="hs-identifier hs-type">OperationResult</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1933"></span><span>    </span><span id="local-6989586621679256741"><span class="annot"><span class="annottext">unregisterOutboundConnectionImpl :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256741"><span class="hs-identifier hs-var hs-var">unregisterOutboundConnectionImpl</span></a></span></span><span> </span><span id="local-6989586621679256309"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679256308"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1934"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
Provenance
-&gt; peerAddr -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnregisterConnection"><span class="hs-identifier hs-var">TrUnregisterConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Outbound"><span class="hs-identifier hs-var">Outbound</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1935"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679256307"><span class="annot"><span class="annottext">DemoteToColdLocal
  peerAddr handlerTrace handle handleError version m
</span><a href="#local-6989586621679256307"><span class="hs-identifier hs-var">transition</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256306"><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256306"><span class="hs-identifier hs-var">mbAssertion</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1936"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m,
   Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (DemoteToColdLocal
      peerAddr handlerTrace handle handleError version m,
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; m (DemoteToColdLocal
         peerAddr handlerTrace handle handleError version m,
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1937"></span><span>        </span><span id="local-6989586621679256305"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256305"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-1938"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256305"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1939"></span><span>          </span><span class="hs-comment">-- if the connection errored, it will remove itself from the state.</span><span>
</span><span id="line-1940"></span><span>          </span><span class="hs-comment">-- Calling 'unregisterOutboundConnection' is a no-op in this case.</span><span>
</span><span id="line-1941"></span><span>          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnknownConnectionSt"><span class="hs-identifier hs-var">UnknownConnectionSt</span></a></span><span>
</span><span id="line-1942"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1943"></span><span>
</span><span id="line-1944"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256304"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1945"></span><span>            </span><span id="local-6989586621679256303"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1946"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256302"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1947"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1948"></span><span>              </span><span class="hs-comment">-- In any of the following three states unregistering is not</span><span>
</span><span id="line-1949"></span><span>              </span><span class="hs-comment">-- supported.  'requestOutboundConnection' is a synchronous</span><span>
</span><span id="line-1950"></span><span>              </span><span class="hs-comment">-- operation which returns only once the connection is</span><span>
</span><span id="line-1951"></span><span>              </span><span class="hs-comment">-- negotiated.</span><span>
</span><span id="line-1952"></span><span>              </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-var">ReservedOutboundState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1953"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-1954"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalError"><span class="hs-identifier hs-var">DemoteToColdLocalError</span></a></span><span>
</span><span id="line-1955"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenOperation"><span class="hs-identifier hs-var">TrForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1956"></span><span>                     </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1957"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1958"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1959"></span><span>
</span><span id="line-1960"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1961"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-1962"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalError"><span class="hs-identifier hs-var">DemoteToColdLocalError</span></a></span><span>
</span><span id="line-1963"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenOperation"><span class="hs-identifier hs-var">TrForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1964"></span><span>                     </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1965"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1966"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1967"></span><span>
</span><span id="line-1968"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256301"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256301"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256300"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256300"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256299"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256299"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1969"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1970"></span><span>                </span><span class="hs-comment">--   DemotedToCold^{Unidirectional}_{Local}</span><span>
</span><span id="line-1971"></span><span>                </span><span class="hs-comment">--     : OutboundState Unidirectional</span><span>
</span><span id="line-1972"></span><span>                </span><span class="hs-comment">--     &#8594; OutboundIdleState Unidirectional</span><span>
</span><span id="line-1973"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1974"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256298"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256298"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-var">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256301"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256300"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256299"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1975"></span><span>                                                   </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span>
</span><span id="line-1976"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256298"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1977"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Transition
     (ConnectionState peerAddr handle handleError version m)
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemotedToColdLocal"><span class="hs-identifier hs-var">DemotedToColdLocal</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256301"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256300"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1978"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256298"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1979"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1980"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1981"></span><span>
</span><span id="line-1982"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256297"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256297"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256296"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256296"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256295"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256295"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Expired"><span class="hs-identifier hs-var">Expired</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1983"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1984"></span><span>                </span><span class="hs-comment">--   DemotedToCold^{Duplex}_{Local}</span><span>
</span><span id="line-1985"></span><span>                </span><span class="hs-comment">--     : OutboundState Duplex</span><span>
</span><span id="line-1986"></span><span>                </span><span class="hs-comment">--     &#8594; OutboundIdleState^\tau</span><span>
</span><span id="line-1987"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-1988"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256294"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256294"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-var">OutboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256297"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256296"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256295"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-1989"></span><span>                                                   </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>
</span><span id="line-1990"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256294"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1991"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Transition
     (ConnectionState peerAddr handle handleError version m)
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemotedToColdLocal"><span class="hs-identifier hs-var">DemotedToColdLocal</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256297"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256296"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-1992"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256294"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1993"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1994"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1995"></span><span>
</span><span id="line-1996"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256293"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256293"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256292"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256292"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256291"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256291"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1997"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256290"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256290"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-var">InboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256293"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256292"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256291"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>
</span><span id="line-1998"></span><span>                    </span><span id="local-6989586621679256289"><span class="annot"><span class="annottext">tr :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256289"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256290"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-1999"></span><span>
</span><span id="line-2000"></span><span>                </span><span id="local-6989586621679256288"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256288"><span class="hs-identifier hs-var">numberOfConns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256305"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-2001"></span><span>
</span><span id="line-2002"></span><span>                </span><span class="hs-comment">-- use 'numberOfConns + 1' because we want to know if we</span><span>
</span><span id="line-2003"></span><span>                </span><span class="hs-comment">-- actually let this connection evolve or if we need to make</span><span>
</span><span id="line-2004"></span><span>                </span><span class="hs-comment">-- room for it by pruning.  This is because</span><span>
</span><span id="line-2005"></span><span>                </span><span class="hs-comment">-- 'countIncomingConnections' does not count 'OutboundDupState'</span><span>
</span><span id="line-2006"></span><span>                </span><span class="hs-comment">-- as an inbound connection, but does so for 'InboundIdleState'.</span><span>
</span><span id="line-2007"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256287"><span class="annot"><span class="annottext">numberToPrune :: Int
</span><a href="#local-6989586621679256287"><span class="hs-identifier hs-var hs-var">numberToPrune</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2008"></span><span>                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256288"><span class="hs-identifier hs-var">numberOfConns</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2009"></span><span>                      </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span>
</span><span id="line-2010"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsHardLimit"><span class="hs-identifier hs-var hs-var">acceptedConnectionsHardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var">cmConnectionsLimits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2011"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256287"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2012"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2013"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256285"><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256285"><span class="hs-identifier hs-var">prune</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2014"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Int
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Async m ()
-&gt; STM m (Bool, PruneAction m)
</span><a href="#local-6989586621679256622"><span class="hs-identifier hs-var">mkPruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256287"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256305"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256290"><span class="hs-identifier hs-var">connState'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256292"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-2015"></span><span>                  </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-2016"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PruneAction m
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
PruneAction m
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (Transition
        (ConnectionState peerAddr handle handleError version m))
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneConnections"><span class="hs-identifier hs-var">PruneConnections</span></a></span><span> </span><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256285"><span class="hs-identifier hs-var">prune</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2017"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2018"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-2019"></span><span>
</span><span id="line-2020"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2021"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2022"></span><span>                  </span><span class="hs-comment">--   DemotedToCold^{Duplex}_{Local}</span><span>
</span><span id="line-2023"></span><span>                  </span><span class="hs-comment">--     : OutboundState^\tau Duplex</span><span>
</span><span id="line-2024"></span><span>                  </span><span class="hs-comment">--     &#8594; InboundIdleState^\tau Duplex</span><span>
</span><span id="line-2025"></span><span>                  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2026"></span><span>                  </span><span class="hs-comment">-- does not require to perform any additional io action (we</span><span>
</span><span id="line-2027"></span><span>                  </span><span class="hs-comment">-- already updated 'connVar').</span><span>
</span><span id="line-2028"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256290"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2029"></span><span>                  </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256289"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2030"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2031"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-2032"></span><span>
</span><span id="line-2033"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256284"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256284"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256283"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256283"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256282"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256282"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span id="local-6989586621679256281"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256281"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2034"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2035"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2036"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2037"></span><span>
</span><span id="line-2038"></span><span>              </span><span class="hs-comment">-- TODO: This assertion is benign and also hit rarely (once per</span><span>
</span><span id="line-2039"></span><span>              </span><span class="hs-comment">-- 100_000 simulations)</span><span>
</span><span id="line-2040"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256280"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256280"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256279"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256279"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256278"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256278"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256277"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256277"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2041"></span><span>                </span><span class="hs-comment">-- assert (dataFlow == Duplex) $</span><span>
</span><span id="line-2042"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2043"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2044"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2045"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256276"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256276"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256275"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256275"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256274"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256274"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256273"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256273"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2046"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256272"><span class="annot"><span class="annottext">mbAssertion :: Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256272"><span class="hs-identifier hs-var hs-var">mbAssertion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2047"></span><span>                      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256273"><span class="hs-identifier hs-var">dataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow -&gt; DataFlow -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>
</span><span id="line-2048"></span><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2049"></span><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2050"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnregisterOutboundConnection"><span class="hs-identifier hs-var">UnregisterOutboundConnection</span></a></span><span>
</span><span id="line-2051"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256276"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2052"></span><span>                                        </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2053"></span><span>                                   </span><span class="hs-special">)</span><span>
</span><span id="line-2054"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-2055"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
ConnectionManagerTrace peerAddr handlerTrace
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalError"><span class="hs-identifier hs-var">DemoteToColdLocalError</span></a></span><span>
</span><span id="line-2056"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
peerAddr
-&gt; AbstractState -&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrForbiddenOperation"><span class="hs-identifier hs-var">TrForbiddenOperation</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2057"></span><span>                     </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2058"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256272"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span>
</span><span id="line-2059"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-2060"></span><span>
</span><span id="line-2061"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span id="local-6989586621679256270"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256270"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256269"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256269"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256268"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256268"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2062"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2063"></span><span>                </span><span class="hs-comment">--   DemotedToCold^{Duplex}_{Local} : DuplexState</span><span>
</span><span id="line-2064"></span><span>                </span><span class="hs-comment">--                                  &#8594; InboundState Duplex</span><span>
</span><span id="line-2065"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2066"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-2067"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256267"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256267"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-var">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256270"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256269"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256268"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span>
</span><span id="line-2068"></span><span>                    </span><span id="local-6989586621679256266"><span class="annot"><span class="annottext">tr :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256266"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256303"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256267"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2069"></span><span>
</span><span id="line-2070"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2071"></span><span>                </span><span class="hs-comment">-- DemotedToCold^{Duplex}_{Local} : DuplexState</span><span>
</span><span id="line-2072"></span><span>                </span><span class="hs-comment">--                                &#8594; InboundState Duplex</span><span>
</span><span id="line-2073"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2074"></span><span>                </span><span class="hs-comment">-- does not require to perform any additional io action (we</span><span>
</span><span id="line-2075"></span><span>                </span><span class="hs-comment">-- already updated 'connVar').</span><span>
</span><span id="line-2076"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256304"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256267"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2077"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256266"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2078"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2079"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2080"></span><span>
</span><span id="line-2081"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span id="local-6989586621679256265"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256265"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256264"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256264"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256263"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256263"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2082"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2083"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2084"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2085"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span id="local-6989586621679256262"><span class="annot"><span class="annottext">Maybe handleError
</span><a href="#local-6989586621679256262"><span class="hs-identifier hs-var">_handleError</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2086"></span><span>                </span><span class="annot"><span class="annottext">(DemoteToColdLocal
   peerAddr handlerTrace handle handleError version m,
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (DemoteToColdLocal
        peerAddr handlerTrace handle handleError version m,
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
forall peerAddr handlerTrace handle handleError version
       (m :: * -&gt; *).
Maybe
  (Transition
     (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
-&gt; DemoteToColdLocal
     peerAddr handlerTrace handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-var">DemoteToColdLocalNoop</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256302"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2087"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2088"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2089"></span><span>
</span><span id="line-2090"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256306"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ())
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256261"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256261"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2091"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256261"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-2092"></span><span>        </span><span class="annot"><span class="annottext">Any -&gt; Any
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Any) -&gt; m (Any -&gt; Any)
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Any -&gt; Any
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2093"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2094"></span><span>
</span><span id="line-2095"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DemoteToColdLocal
  peerAddr handlerTrace handle handleError version m
</span><a href="#local-6989586621679256307"><span class="hs-identifier hs-var">transition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2096"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemotedToColdLocal"><span class="hs-identifier hs-type">DemotedToColdLocal</span></a></span><span> </span><span id="local-6989586621679256260"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256260"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256259"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256259"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256258"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256258"><span class="hs-identifier hs-var">connVar</span></a></span></span><span> </span><span id="local-6989586621679256257"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256257"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2097"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256257"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2098"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2099"></span><span>          </span><span id="local-6989586621679256256"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679256256"><span class="hs-identifier hs-var">timeoutVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; m (TVar m Bool)
forall (m :: * -&gt; *). MonadTimer m =&gt; DiffTime -&gt; m (TVar m Bool)
</span><span class="hs-identifier hs-var">registerDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679256778"><span class="hs-identifier hs-var">cmOutboundIdleTimeout</span></a></span><span>
</span><span id="line-2100"></span><span>          </span><span id="local-6989586621679256254"><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256254"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m))
-&gt; m (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Either
      (ConnectionState peerAddr handle handleError version m)
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m (Either
         (ConnectionState peerAddr handle handleError version m)
         (ConnectionState peerAddr handle handleError version m)))
-&gt; STM
     m
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
-&gt; m (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FirstToFinish
  (STM m)
  (Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m))
-&gt; STM
     m
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. FirstToFinish m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier hs-var hs-var">runFirstToFinish</span></a></span><span> </span><span class="annot"><span class="annottext">(FirstToFinish
   (STM m)
   (Either
      (ConnectionState peerAddr handle handleError version m)
      (ConnectionState peerAddr handle handleError version m))
 -&gt; STM
      m
      (Either
         (ConnectionState peerAddr handle handleError version m)
         (ConnectionState peerAddr handle handleError version m)))
-&gt; FirstToFinish
     (STM m)
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
-&gt; STM
     m
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2101"></span><span>               </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m))
-&gt; FirstToFinish
     (STM m)
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. m a -&gt; FirstToFinish m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier hs-var">FirstToFinish</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679256251"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256251"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256258"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-2102"></span><span>                                 </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256251"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2103"></span><span>                                          </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-2104"></span><span>                                          </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-2105"></span><span>                                       </span><span class="hs-special">)</span><span>
</span><span id="line-2106"></span><span>                                 </span><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (ConnectionState peerAddr handle handleError version m)
-&gt; STM
     m
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m)
forall a b. a -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256251"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2107"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-2108"></span><span>            </span><span class="annot"><span class="annottext">FirstToFinish
  (STM m)
  (Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m))
-&gt; FirstToFinish
     (STM m)
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
-&gt; FirstToFinish
     (STM m)
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m))
-&gt; FirstToFinish
     (STM m)
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (m :: * -&gt; *) a. m a -&gt; FirstToFinish m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.7/monoidal-synchronisation-0.1.0.2/noopt/doc/html/monoidal-synchronisation/src"><span class="hs-identifier hs-var">FirstToFinish</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679256249"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256249"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">LazySTM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679256256"><span class="hs-identifier hs-var">timeoutVar</span></a></span><span>
</span><span id="line-2109"></span><span>                                 </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256249"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2110"></span><span>                                 </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (ConnectionState peerAddr handle handleError version m)
forall a b. b -&gt; Either a b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m
 -&gt; Either
      (ConnectionState peerAddr handle handleError version m)
      (ConnectionState peerAddr handle handleError version m))
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
-&gt; STM
     m
     (Either
        (ConnectionState peerAddr handle handleError version m)
        (ConnectionState peerAddr handle handleError version m))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256258"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-2111"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-2112"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256254"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2113"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679256247"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256247"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2114"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256246"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256246"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-var">TerminatingState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256260"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256259"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2115"></span><span>              </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256258"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256246"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2116"></span><span>              </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span>
</span><span id="line-2117"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256247"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256246"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2118"></span><span>              </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2119"></span><span>              </span><span class="hs-comment">-- We rely on the `finally` handler of connection thread to:</span><span>
</span><span id="line-2120"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-2121"></span><span>              </span><span class="hs-comment">-- - close the socket,</span><span>
</span><span id="line-2122"></span><span>              </span><span class="hs-comment">-- - set the state to 'TerminatedState'</span><span>
</span><span id="line-2123"></span><span>              </span><span class="hs-comment">-- - 'throwTo' avoids blocking until 'cmTimeWaitTimeout' expires.</span><span>
</span><span id="line-2124"></span><span>              </span><span class="annot"><span class="annottext">ThreadId m -&gt; AsyncCancelled -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async m () -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256259"><span class="hs-identifier hs-var">connThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2125"></span><span>                      </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span>
</span><span id="line-2126"></span><span>              </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256246"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2127"></span><span>
</span><span id="line-2128"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256245"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256245"><span class="hs-identifier hs-var">connState</span></a></span></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m -&gt; Bool
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionState peerAddr handle handleError version m -&gt; Bool
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#connectionTerminated"><span class="hs-identifier hs-var">connectionTerminated</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256245"><span class="hs-identifier hs-var">connState</span></a></span><span>
</span><span id="line-2129"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2130"></span><span>              </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256245"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2131"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679256244"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256244"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2132"></span><span>              </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256244"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2133"></span><span>
</span><span id="line-2134"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#PruneConnections"><span class="hs-identifier hs-type">PruneConnections</span></a></span><span> </span><span id="local-6989586621679256243"><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256243"><span class="hs-identifier hs-var">prune</span></a></span></span><span> </span><span id="local-6989586621679256242"><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256242"><span class="hs-identifier hs-var">eTr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2135"></span><span>          </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; m ())
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; TransitionTrace
         peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256242"><span class="hs-identifier hs-var">eTr</span></a></span><span>
</span><span id="line-2136"></span><span>          </span><span class="annot"><span class="annottext">PruneAction m -&gt; m ()
forall (m :: * -&gt; *). PruneAction m -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#runPruneAction"><span class="hs-identifier hs-var hs-var">runPruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256243"><span class="hs-identifier hs-var">prune</span></a></span><span>
</span><span id="line-2137"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2138"></span><span>          </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ConnectionState peerAddr handle handleError version m
 -&gt; MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; Either
     (ConnectionState peerAddr handle handleError version m)
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. Transition' state -&gt; state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var hs-var">fromState</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (ConnectionState peerAddr handle handleError version m)
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256242"><span class="hs-identifier hs-var">eTr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2139"></span><span>
</span><span id="line-2140"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalError"><span class="hs-identifier hs-type">DemoteToColdLocalError</span></a></span><span> </span><span id="local-6989586621679256241"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256241"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span id="local-6989586621679256240"><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256240"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2141"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256241"><span class="hs-identifier hs-var">trace</span></a></span><span>
</span><span id="line-2142"></span><span>          </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256240"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2143"></span><span>
</span><span id="line-2144"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DemoteToColdLocalNoop"><span class="hs-identifier hs-type">DemoteToColdLocalNoop</span></a></span><span> </span><span id="local-6989586621679256239"><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256239"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679256238"><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256238"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2145"></span><span>          </span><span class="annot"><span class="annottext">(TransitionTrace
   peerAddr (ConnectionState peerAddr handle handleError version m)
 -&gt; m ())
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256308"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; TransitionTrace
      peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; Maybe
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; Maybe
     (TransitionTrace
        peerAddr (ConnectionState peerAddr handle handleError version m))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256239"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2146"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256309"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2147"></span><span>          </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbstractState -&gt; OperationResult AbstractState
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256238"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2148"></span><span>
</span><span id="line-2149"></span><span>
</span><span id="line-2150"></span><span>    </span><span class="hs-comment">-- Needs to mask the STM action and the tracing for the case of an async</span><span>
</span><span id="line-2151"></span><span>    </span><span class="hs-comment">-- exception falls right between the STM commit and the IO tracing. This</span><span>
</span><span id="line-2152"></span><span>    </span><span class="hs-comment">-- guarantees that the same order of transitions and its trace.</span><span>
</span><span id="line-2153"></span><span>    </span><span class="annot"><a href="#local-6989586621679256731"><span class="hs-identifier hs-type">promotedToWarmRemoteImpl</span></a></span><span>
</span><span id="line-2154"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2155"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-2156"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationResult"><span class="hs-identifier hs-type">OperationResult</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2157"></span><span>    </span><span id="local-6989586621679256731"><span class="annot"><span class="annottext">promotedToWarmRemoteImpl :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256731"><span class="hs-identifier hs-var hs-var">promotedToWarmRemoteImpl</span></a></span></span><span> </span><span id="local-6989586621679256237"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256237"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679256236"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (OperationResult AbstractState)
-&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m (OperationResult AbstractState)
 -&gt; m (OperationResult AbstractState))
-&gt; m (OperationResult AbstractState)
-&gt; m (OperationResult AbstractState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2158"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679256235"><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256235"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256234"><span class="annot"><span class="annottext">Maybe (PruneAction m)
</span><a href="#local-6989586621679256234"><span class="hs-identifier hs-var">pruneTr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256233"><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256233"><span class="hs-identifier hs-var">mbAssertion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))),
   Maybe (PruneAction m),
   Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (OperationResult
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))),
    Maybe (PruneAction m),
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; m (OperationResult
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))),
       Maybe (PruneAction m),
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2159"></span><span>        </span><span id="local-6989586621679256232"><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256237"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2160"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256231"><span class="annot"><span class="annottext">mbConnVar :: Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256231"><span class="hs-identifier hs-var hs-var">mbConnVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-2161"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256231"><span class="hs-identifier hs-var">mbConnVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2162"></span><span>          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnknownConnectionSt"><span class="hs-identifier hs-var">UnknownConnectionSt</span></a></span><span>
</span><span id="line-2163"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2164"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2165"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-2166"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256230"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2167"></span><span>            </span><span id="local-6989586621679256229"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-2168"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256228"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2169"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2170"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-type">ReservedOutboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2171"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2172"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2173"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2174"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#PromotedToWarmRemote"><span class="hs-identifier hs-var">PromotedToWarmRemote</span></a></span><span>
</span><span id="line-2175"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2176"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2177"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2178"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2179"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256226"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256226"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2180"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2181"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2182"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2183"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#PromotedToWarmRemote"><span class="hs-identifier hs-var">PromotedToWarmRemote</span></a></span><span>
</span><span id="line-2184"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256226"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2185"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2186"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2187"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2188"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256225"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256225"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256224"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256224"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256223"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256223"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2189"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2190"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2191"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2192"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#PromotedToWarmRemote"><span class="hs-identifier hs-var">PromotedToWarmRemote</span></a></span><span>
</span><span id="line-2193"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256225"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2194"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2195"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2196"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2197"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256222"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256222"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256221"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256221"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256220"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256220"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256219"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256219"><span class="hs-identifier hs-var">_expired</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2198"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2199"></span><span>                </span><span class="hs-comment">--   PromotedToWarm^{Duplex}_{Remote} : OutboundState Duplex</span><span>
</span><span id="line-2200"></span><span>                </span><span class="hs-comment">--                                    &#8594; DuplexState</span><span>
</span><span id="line-2201"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2202"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-2203"></span><span>                </span><span class="hs-comment">-- For connections that reach DuplexState we are not sure if</span><span>
</span><span id="line-2204"></span><span>                </span><span class="hs-comment">-- this was due to a connection that was established due to TCP</span><span>
</span><span id="line-2205"></span><span>                </span><span class="hs-comment">-- simultaneous open or normal connect/accept. If it was</span><span>
</span><span id="line-2206"></span><span>                </span><span class="hs-comment">-- established due to TCP simultaneous open a DuplexState can</span><span>
</span><span id="line-2207"></span><span>                </span><span class="hs-comment">-- make us go above the Server number of connections hard limit,</span><span>
</span><span id="line-2208"></span><span>                </span><span class="hs-comment">-- hence we need to prune connections.</span><span>
</span><span id="line-2209"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-2210"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256218"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256218"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-var">DuplexState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256222"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256221"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256220"><span class="hs-identifier hs-var">handle</span></a></span><span>
</span><span id="line-2211"></span><span>                    </span><span id="local-6989586621679256217"><span class="annot"><span class="annottext">tr :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256217"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256218"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2212"></span><span>
</span><span id="line-2213"></span><span>                </span><span id="local-6989586621679256216"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256216"><span class="hs-identifier hs-var">numberOfConns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-2214"></span><span>
</span><span id="line-2215"></span><span>                </span><span class="hs-comment">-- use 'numberOfConns + 1' because we want to know if we</span><span>
</span><span id="line-2216"></span><span>                </span><span class="hs-comment">-- actually let this connection evolve if we need to make</span><span>
</span><span id="line-2217"></span><span>                </span><span class="hs-comment">-- room for them by pruning.</span><span>
</span><span id="line-2218"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256215"><span class="annot"><span class="annottext">numberToPrune :: Int
</span><a href="#local-6989586621679256215"><span class="hs-identifier hs-var hs-var">numberToPrune</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2219"></span><span>                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256216"><span class="hs-identifier hs-var">numberOfConns</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2220"></span><span>                      </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span>
</span><span id="line-2221"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsHardLimit"><span class="hs-identifier hs-var hs-var">acceptedConnectionsHardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var">cmConnectionsLimits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2222"></span><span>
</span><span id="line-2223"></span><span>                </span><span class="hs-comment">-- Are we above the hard limit?</span><span>
</span><span id="line-2224"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256215"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2225"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2226"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621679256214"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256214"><span class="hs-identifier hs-var">pruneSelf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256213"><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256213"><span class="hs-identifier hs-var">prune</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2227"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Int
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Async m ()
-&gt; STM m (Bool, PruneAction m)
</span><a href="#local-6989586621679256622"><span class="hs-identifier hs-var">mkPruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256215"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256218"><span class="hs-identifier hs-var">connState'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256221"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-2228"></span><span>
</span><span id="line-2229"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM m () -&gt; STM m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256214"><span class="hs-identifier hs-var">pruneSelf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2230"></span><span>                    </span><span class="annot"><span class="annottext">(STM m () -&gt; STM m ()) -&gt; STM m () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256218"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2231"></span><span>
</span><span id="line-2232"></span><span>                  </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-2233"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256217"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-2234"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PruneAction m -&gt; Maybe (PruneAction m)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256213"><span class="hs-identifier hs-var">prune</span></a></span><span>
</span><span id="line-2235"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2236"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-2237"></span><span>
</span><span id="line-2238"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2239"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256218"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2240"></span><span>                  </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256217"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-2241"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2242"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2243"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-2244"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256211"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256211"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256210"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256210"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256209"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256209"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256208"><span class="annot"><span class="annottext">dataFlow :: DataFlow
</span><a href="#local-6989586621679256208"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Duplex"><span class="hs-identifier hs-var">Duplex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2245"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2246"></span><span>                </span><span class="hs-comment">--   Awake^{Duplex}_{Remote} : OutboundIdleState^\tau Duplex</span><span>
</span><span id="line-2247"></span><span>                </span><span class="hs-comment">--                           &#8594; InboundState Duplex</span><span>
</span><span id="line-2248"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2249"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256207"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256207"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-var">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256211"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256210"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256209"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256208"><span class="hs-identifier hs-var">dataFlow</span></a></span><span>
</span><span id="line-2250"></span><span>                    </span><span id="local-6989586621679256206"><span class="annot"><span class="annottext">tr :: Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256206"><span class="hs-identifier hs-var hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256207"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2251"></span><span>
</span><span id="line-2252"></span><span>                </span><span id="local-6989586621679256205"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256205"><span class="hs-identifier hs-var">numberOfConns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
-&gt; STM m Int
</span><a href="#local-6989586621679256727"><span class="hs-identifier hs-var">countIncomingConnections</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-2253"></span><span>
</span><span id="line-2254"></span><span>                </span><span class="hs-comment">-- use 'numberOfConns + 1' because we want to know if we</span><span>
</span><span id="line-2255"></span><span>                </span><span class="hs-comment">-- actually let this connection evolve if we need to make</span><span>
</span><span id="line-2256"></span><span>                </span><span class="hs-comment">-- room for it by pruning.</span><span>
</span><span id="line-2257"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256204"><span class="annot"><span class="annottext">numberToPrune :: Int
</span><a href="#local-6989586621679256204"><span class="hs-identifier hs-var hs-var">numberToPrune</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2258"></span><span>                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256205"><span class="hs-identifier hs-var">numberOfConns</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2259"></span><span>                      </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span>
</span><span id="line-2260"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AcceptedConnectionsLimit -&gt; Word32
</span><a href="Ouroboros.Network.Server.RateLimiting.html#acceptedConnectionsHardLimit"><span class="hs-identifier hs-var hs-var">acceptedConnectionsHardLimit</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679256775"><span class="hs-identifier hs-var">cmConnectionsLimits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2261"></span><span>
</span><span id="line-2262"></span><span>                </span><span class="hs-comment">-- Are we above the hard limit?</span><span>
</span><span id="line-2263"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256204"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2264"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2265"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621679256203"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256203"><span class="hs-identifier hs-var">pruneSelf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256202"><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256202"><span class="hs-identifier hs-var">prune</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2266"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; Int
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
-&gt; Async m ()
-&gt; STM m (Bool, PruneAction m)
</span><a href="#local-6989586621679256622"><span class="hs-identifier hs-var">mkPruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679256204"><span class="hs-identifier hs-var">numberToPrune</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerState peerAddr handle handleError version m
</span><a href="#local-6989586621679256232"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256207"><span class="hs-identifier hs-var">connState'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256210"><span class="hs-identifier hs-var">connThread</span></a></span><span>
</span><span id="line-2267"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM m () -&gt; STM m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679256203"><span class="hs-identifier hs-var">pruneSelf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2268"></span><span>                     </span><span class="annot"><span class="annottext">(STM m () -&gt; STM m ()) -&gt; STM m () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256207"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2269"></span><span>
</span><span id="line-2270"></span><span>                  </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-2271"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
Maybe handleError
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-var">TerminatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe handleError
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2272"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PruneAction m -&gt; Maybe (PruneAction m)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256202"><span class="hs-identifier hs-var">prune</span></a></span><span>
</span><span id="line-2273"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2274"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-2275"></span><span>
</span><span id="line-2276"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2277"></span><span>                  </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256207"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2278"></span><span>                  </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256206"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-2279"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2280"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2281"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-2282"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256201"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256201"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256200"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256200"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256199"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256199"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Unidirectional"><span class="hs-identifier hs-var">Unidirectional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2283"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2284"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2285"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2286"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2287"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256198"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256198"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256197"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256197"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256196"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256196"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256195"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256195"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2288"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2289"></span><span>                </span><span class="hs-comment">--   Awake^{dataFlow}_{Remote} : InboundIdleState Duplex</span><span>
</span><span id="line-2290"></span><span>                </span><span class="hs-comment">--                             &#8594; InboundState Duplex</span><span>
</span><span id="line-2291"></span><span>                </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2292"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256194"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256194"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-var">InboundState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256198"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256197"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256196"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256195"><span class="hs-identifier hs-var">dataFlow</span></a></span><span>
</span><span id="line-2293"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256230"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256194"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2294"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256194"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2295"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2296"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2297"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2298"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256193"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256193"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">handle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2299"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2300"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2301"></span><span>                       </span><span class="hs-comment">-- already in 'InboundState'?</span><span>
</span><span id="line-2302"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2303"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#PromotedToWarmRemote"><span class="hs-identifier hs-var">PromotedToWarmRemote</span></a></span><span>
</span><span id="line-2304"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256193"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2305"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256228"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2306"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2307"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2308"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2309"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256229"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2310"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2311"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2312"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2313"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2314"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatingSt"><span class="hs-identifier hs-var">TerminatingSt</span></a></span><span>
</span><span id="line-2315"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2316"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2317"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2318"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2319"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (PruneAction m),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedSt"><span class="hs-identifier hs-var">TerminatedSt</span></a></span><span>
</span><span id="line-2320"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2321"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2322"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2323"></span><span>
</span><span id="line-2324"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256233"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ())
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256192"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256192"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2325"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256192"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-2326"></span><span>        </span><span class="annot"><span class="annottext">Any -&gt; Any
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Any) -&gt; m (Any -&gt; Any)
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Any -&gt; Any
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2327"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2328"></span><span>
</span><span id="line-2329"></span><span>      </span><span class="hs-comment">-- trace transition</span><span>
</span><span id="line-2330"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256235"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
</span><a href="#local-6989586621679256234"><span class="hs-identifier hs-var">pruneTr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2331"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-type">OperationSuccess</span></a></span><span> </span><span id="local-6989586621679256191"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256191"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PruneAction m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2332"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256191"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2333"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256237"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2334"></span><span>
</span><span id="line-2335"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-type">OperationSuccess</span></a></span><span> </span><span id="local-6989586621679256190"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256190"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679256189"><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256189"><span class="hs-identifier hs-var">prune</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2336"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256236"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256190"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2337"></span><span>          </span><span class="annot"><span class="annottext">PruneAction m -&gt; m ()
forall (m :: * -&gt; *). PruneAction m -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#runPruneAction"><span class="hs-identifier hs-var hs-var">runPruneAction</span></a></span><span> </span><span class="annot"><span class="annottext">PruneAction m
</span><a href="#local-6989586621679256189"><span class="hs-identifier hs-var">prune</span></a></span><span>
</span><span id="line-2338"></span><span>          </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256237"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2339"></span><span>
</span><span id="line-2340"></span><span>        </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (PruneAction m))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2341"></span><span>      </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. Transition' state -&gt; state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var hs-var">fromState</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; AbstractState)
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; OperationResult AbstractState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256235"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2342"></span><span>
</span><span id="line-2343"></span><span>
</span><span id="line-2344"></span><span>    </span><span class="annot"><a href="#local-6989586621679256729"><span class="hs-identifier hs-type">demotedToColdRemoteImpl</span></a></span><span>
</span><span id="line-2345"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ConnectionManagerState"><span class="hs-identifier hs-type">ConnectionManagerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256793"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256792"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256791"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2346"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256796"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-2347"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679256790"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationResult"><span class="hs-identifier hs-type">OperationResult</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#AbstractState"><span class="hs-identifier hs-type">AbstractState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2348"></span><span>    </span><span id="local-6989586621679256729"><span class="annot"><span class="annottext">demotedToColdRemoteImpl :: StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; peerAddr -&gt; m (OperationResult AbstractState)
</span><a href="#local-6989586621679256729"><span class="hs-identifier hs-var hs-var">demotedToColdRemoteImpl</span></a></span></span><span> </span><span id="local-6989586621679256188"><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256188"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679256187"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256187"><span class="hs-identifier hs-var">peerAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2349"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679256186"><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256186"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256185"><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256185"><span class="hs-identifier hs-var">mbAssertion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m))),
   Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (OperationResult
      (Transition'
         (MaybeUnknown
            (ConnectionState peerAddr handle handleError version m))),
    Maybe (ConnectionManagerTrace peerAddr handlerTrace))
 -&gt; m (OperationResult
         (Transition'
            (MaybeUnknown
               (ConnectionState peerAddr handle handleError version m))),
       Maybe (ConnectionManagerTrace peerAddr handlerTrace)))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; m (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2350"></span><span>        </span><span id="local-6989586621679256184"><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256184"><span class="hs-identifier hs-var">mbConnVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">peerAddr
-&gt; ConnectionManagerState peerAddr handle handleError version m
-&gt; Maybe (MutableConnState peerAddr handle handleError version m)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/containers-0.6.5.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256187"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnectionManagerState peerAddr handle handleError version m
 -&gt; Maybe (MutableConnState peerAddr handle handleError version m))
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (Maybe (MutableConnState peerAddr handle handleError version m))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; STM
     m (ConnectionManagerState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256188"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2351"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256184"><span class="hs-identifier hs-var">mbConnVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2352"></span><span>          </span><span class="annot"><span class="annottext">Maybe (MutableConnState peerAddr handle handleError version m)
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnknownConnectionSt"><span class="hs-identifier hs-var">UnknownConnectionSt</span></a></span><span>
</span><span id="line-2353"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2354"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-2355"></span><span>          </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#MutableConnState"><span class="hs-identifier hs-type">MutableConnState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679256183"><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
connVar :: forall peerAddr handle handleError version (m :: * -&gt; *).
MutableConnState peerAddr handle handleError version m
-&gt; StrictTVar
     m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256183"><span class="hs-identifier hs-var hs-var">connVar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2356"></span><span>            </span><span id="local-6989586621679256182"><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; STM m (ConnectionState peerAddr handle handleError version m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256183"><span class="hs-identifier hs-var">connVar</span></a></span><span>
</span><span id="line-2357"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256181"><span class="annot"><span class="annottext">st :: AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. state -&gt; MaybeUnknown state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Known"><span class="hs-identifier hs-var">Known</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2358"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2359"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#ReservedOutboundState"><span class="hs-identifier hs-type">ReservedOutboundState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2360"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2361"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2362"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#DemotedToColdRemote"><span class="hs-identifier hs-var">DemotedToColdRemote</span></a></span><span>
</span><span id="line-2363"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2364"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2365"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2366"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2367"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#UnnegotiatedState"><span class="hs-identifier hs-type">UnnegotiatedState</span></a></span><span> </span><span class="annot"><span class="annottext">Provenance
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679256179"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256179"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2368"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2369"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2370"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#DemotedToColdRemote"><span class="hs-identifier hs-var">DemotedToColdRemote</span></a></span><span>
</span><span id="line-2371"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256179"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2372"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2373"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2374"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2375"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundUniState"><span class="hs-identifier hs-type">OutboundUniState</span></a></span><span> </span><span id="local-6989586621679256178"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256178"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256177"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256177"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256176"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256176"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2376"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#UnsupportedState"><span class="hs-identifier hs-var">UnsupportedState</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2377"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
-&gt; Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
forall peerAddr handlerTrace.
AssertionLocation peerAddr
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TrUnexpectedlyFalseAssertion"><span class="hs-identifier hs-var">CM.TrUnexpectedlyFalseAssertion</span></a></span><span>
</span><span id="line-2378"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
forall peerAddr.
Maybe (ConnectionId peerAddr)
-&gt; AbstractState -&gt; AssertionLocation peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#DemotedToColdRemote"><span class="hs-identifier hs-var">DemotedToColdRemote</span></a></span><span>
</span><span id="line-2379"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr -&gt; Maybe (ConnectionId peerAddr)
forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256178"><span class="hs-identifier hs-var">connId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2380"></span><span>                                  </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2381"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-2382"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2383"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-type">OutboundDupState</span></a></span><span> </span><span id="local-6989586621679256175"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256175"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256174"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256174"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256173"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256173"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256172"><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="#local-6989586621679256172"><span class="hs-identifier hs-var">_expired</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2384"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2385"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2386"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2387"></span><span>              </span><span class="hs-comment">-- one can only enter 'OutboundIdleState' if remote state is</span><span>
</span><span id="line-2388"></span><span>              </span><span class="hs-comment">-- already cold.</span><span>
</span><span id="line-2389"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundIdleState"><span class="hs-identifier hs-type">OutboundIdleState</span></a></span><span> </span><span id="local-6989586621679256171"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256171"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256170"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256170"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256169"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256169"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256168"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256168"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2390"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2391"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2392"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2393"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-type">InboundIdleState</span></a></span><span> </span><span id="local-6989586621679256167"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256167"><span class="hs-identifier hs-var">_connId</span></a></span></span><span> </span><span id="local-6989586621679256166"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256166"><span class="hs-identifier hs-var">_connThread</span></a></span></span><span> </span><span id="local-6989586621679256165"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256165"><span class="hs-identifier hs-var">_handle</span></a></span></span><span> </span><span id="local-6989586621679256164"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256164"><span class="hs-identifier hs-var">_dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2394"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2395"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2396"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2397"></span><span>
</span><span id="line-2398"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2399"></span><span>              </span><span class="hs-comment">--   DemotedToCold^{dataFlow}_{Remote}</span><span>
</span><span id="line-2400"></span><span>              </span><span class="hs-comment">--     : InboundState dataFlow</span><span>
</span><span id="line-2401"></span><span>              </span><span class="hs-comment">--     &#8594; InboundIdleState^\tau dataFlow</span><span>
</span><span id="line-2402"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2403"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundState"><span class="hs-identifier hs-type">InboundState</span></a></span><span> </span><span id="local-6989586621679256163"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256163"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256162"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256162"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256161"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256161"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679256160"><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256160"><span class="hs-identifier hs-var">dataFlow</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2404"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256159"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256159"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; DataFlow
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#InboundIdleState"><span class="hs-identifier hs-var">InboundIdleState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256163"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256162"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256161"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><a href="#local-6989586621679256160"><span class="hs-identifier hs-var">dataFlow</span></a></span><span>
</span><span id="line-2405"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256183"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256159"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2406"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256159"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2407"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2408"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2409"></span><span>
</span><span id="line-2410"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2411"></span><span>              </span><span class="hs-comment">--   DemotedToCold^{dataFlow}_{Remote}</span><span>
</span><span id="line-2412"></span><span>              </span><span class="hs-comment">--     : DuplexState</span><span>
</span><span id="line-2413"></span><span>              </span><span class="hs-comment">--     &#8594; OutboundState^\tau Duplex</span><span>
</span><span id="line-2414"></span><span>              </span><span class="hs-comment">-- @</span><span>
</span><span id="line-2415"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#DuplexState"><span class="hs-identifier hs-type">DuplexState</span></a></span><span> </span><span id="local-6989586621679256158"><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256158"><span class="hs-identifier hs-var">connId</span></a></span></span><span> </span><span id="local-6989586621679256157"><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256157"><span class="hs-identifier hs-var">connThread</span></a></span></span><span> </span><span id="local-6989586621679256156"><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256156"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2416"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679256155"><span class="annot"><span class="annottext">connState' :: ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256155"><span class="hs-identifier hs-var hs-var">connState'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
forall peerAddr handle handleError version (m :: * -&gt; *).
ConnectionId peerAddr
-&gt; Async m ()
-&gt; handle
-&gt; TimeoutExpired
-&gt; ConnectionState peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#OutboundDupState"><span class="hs-identifier hs-var">OutboundDupState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679256158"><span class="hs-identifier hs-var">connId</span></a></span><span> </span><span class="annot"><span class="annottext">Async m ()
</span><a href="#local-6989586621679256157"><span class="hs-identifier hs-var">connThread</span></a></span><span> </span><span class="annot"><span class="annottext">handle
</span><a href="#local-6989586621679256156"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutExpired
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#Ticking"><span class="hs-identifier hs-var">Ticking</span></a></span><span>
</span><span id="line-2417"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (ConnectionState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256183"><span class="hs-identifier hs-var">connVar</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256155"><span class="hs-identifier hs-var">connState'</span></a></span><span>
</span><span id="line-2418"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. a -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-var">OperationSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
-&gt; ConnectionState peerAddr handle handleError version m
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
forall state. state -&gt; state -&gt; Transition state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#mkTransition"><span class="hs-identifier hs-var">mkTransition</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256182"><span class="hs-identifier hs-var">connState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionState peerAddr handle handleError version m
</span><a href="#local-6989586621679256155"><span class="hs-identifier hs-var">connState'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2419"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2420"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2421"></span><span>
</span><span id="line-2422"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatingState"><span class="hs-identifier hs-type">TerminatingState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2423"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedConnection"><span class="hs-identifier hs-var">TerminatedConnection</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2424"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2425"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2426"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#TerminatedState"><span class="hs-identifier hs-type">TerminatedState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2427"></span><span>                </span><span class="annot"><span class="annottext">(OperationResult
   (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))),
 Maybe (ConnectionManagerTrace peerAddr handlerTrace))
-&gt; STM
     m
     (OperationResult
        (Transition'
           (MaybeUnknown
              (ConnectionState peerAddr handle handleError version m))),
      Maybe (ConnectionManagerTrace peerAddr handlerTrace))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AbstractState
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
forall a. AbstractState -&gt; OperationResult a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TerminatedConnection"><span class="hs-identifier hs-var">TerminatedConnection</span></a></span><span> </span><span class="annot"><span class="annottext">AbstractState
</span><a href="#local-6989586621679256181"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-2428"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2429"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-2430"></span><span>
</span><span id="line-2431"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256185"><span class="hs-identifier hs-var">mbAssertion</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ())
-&gt; (ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256153"><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256153"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2432"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
-&gt; ConnectionManagerTrace peerAddr handlerTrace -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionManagerTrace peerAddr handlerTrace)
</span><a href="#local-6989586621679256788"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManagerTrace peerAddr handlerTrace
</span><a href="#local-6989586621679256153"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-2433"></span><span>        </span><span class="annot"><span class="annottext">Any -&gt; Any
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Any -&gt; Any) -&gt; m (Any -&gt; Any)
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Any -&gt; Any
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2434"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2435"></span><span>
</span><span id="line-2436"></span><span>      </span><span class="hs-comment">-- trace transition</span><span>
</span><span id="line-2437"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256186"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2438"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#OperationSuccess"><span class="hs-identifier hs-type">OperationSuccess</span></a></span><span> </span><span id="local-6989586621679256152"><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256152"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2439"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256787"><span class="hs-identifier hs-var">trTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; TransitionTrace
     peerAddr (ConnectionState peerAddr handle handleError version m)
forall peerAddr state.
peerAddr -&gt; Transition' state -&gt; TransitionTrace' peerAddr state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#TransitionTrace"><span class="hs-identifier hs-var">TransitionTrace</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679256187"><span class="hs-identifier hs-var">peerAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
</span><a href="#local-6989586621679256152"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2440"></span><span>        </span><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2441"></span><span>
</span><span id="line-2442"></span><span>      </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
-&gt; m ()
</span><a href="#local-6989586621679256690"><span class="hs-identifier hs-var">traceCounters</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTMVar
  m (ConnectionManagerState peerAddr handle handleError version m)
</span><a href="#local-6989586621679256188"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-2443"></span><span>      </span><span class="annot"><span class="annottext">OperationResult AbstractState -&gt; m (OperationResult AbstractState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState peerAddr handle handleError version m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#abstractState"><span class="hs-identifier hs-var">abstractState</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState peerAddr handle handleError version m)
 -&gt; AbstractState)
-&gt; (Transition'
      (MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
    -&gt; MaybeUnknown
         (ConnectionState peerAddr handle handleError version m))
-&gt; Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m))
-&gt; AbstractState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Transition'
  (MaybeUnknown
     (ConnectionState peerAddr handle handleError version m))
-&gt; MaybeUnknown
     (ConnectionState peerAddr handle handleError version m)
forall state. Transition' state -&gt; state
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#fromState"><span class="hs-identifier hs-var hs-var">fromState</span></a></span><span> </span><span class="annot"><span class="annottext">(Transition'
   (MaybeUnknown
      (ConnectionState peerAddr handle handleError version m))
 -&gt; AbstractState)
-&gt; OperationResult
     (Transition'
        (MaybeUnknown
           (ConnectionState peerAddr handle handleError version m)))
-&gt; OperationResult AbstractState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OperationResult
  (Transition'
     (MaybeUnknown
        (ConnectionState peerAddr handle handleError version m)))
</span><a href="#local-6989586621679256186"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2444"></span><span>
</span><span id="line-2445"></span><span>
</span><span id="line-2446"></span><span class="hs-comment">--</span><span>
</span><span id="line-2447"></span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-2448"></span><span class="hs-comment">--</span><span>
</span><span id="line-2449"></span><span>
</span><span id="line-2450"></span><span class="hs-comment">-- | Perform some operation on 'Just', given the field inside the 'Just'.</span><span>
</span><span id="line-2451"></span><span class="hs-comment">--</span><span>
</span><span id="line-2452"></span><span id="local-6989586621679257099"><span id="local-6989586621679257100"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-type">whenJust</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257099"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257099"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-2453"></span><span id="whenJust"><span class="annot"><span class="annottext">whenJust :: Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#whenJust"><span class="hs-identifier hs-var hs-var">whenJust</span></a></span></span><span> </span><span id="local-6989586621679256151"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679256151"><span class="hs-identifier hs-var">mg</span></a></span></span><span> </span><span id="local-6989586621679256150"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679256150"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; (a -&gt; m ()) -&gt; Maybe a -&gt; m ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679256150"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679256151"><span class="hs-identifier hs-var">mg</span></a></span><span>
</span><span id="line-2454"></span><span>
</span><span id="line-2455"></span><span class="hs-comment">-- | Like 'modifyMVar' but strict in @a@ and for 'TMVar's</span><span>
</span><span id="line-2456"></span><span class="hs-comment">--</span><span>
</span><span id="line-2457"></span><span id="local-6989586621679257212"><span id="local-6989586621679257213"><span id="local-6989586621679257215"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVar"><span class="hs-identifier hs-type">modifyTMVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadEvaluate</span></span><span> </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2458"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span>     </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2459"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span>      </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2460"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-2461"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257213"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-2462"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257213"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257213"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679257212"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2463"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257215"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257212"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2464"></span><span id="modifyTMVar"><span class="annot"><span class="annottext">modifyTMVar :: StrictTMVar m a -&gt; (a -&gt; m (a, b)) -&gt; m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVar"><span class="hs-identifier hs-var hs-var">modifyTMVar</span></a></span></span><span> </span><span id="local-6989586621679256149"><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256149"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679256148"><span class="annot"><span class="annottext">a -&gt; m (a, b)
</span><a href="#local-6989586621679256148"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2465"></span><span>  </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679256147"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679256147"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2466"></span><span>    </span><span id="local-6989586621679256146"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256146"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256149"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2467"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679256144"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256144"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679256143"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256143"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (a, b) -&gt; m (a, b)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679256147"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m (a, b)
</span><a href="#local-6989586621679256148"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256146"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m (a, b) -&gt; ((a, b) -&gt; m (a, b)) -&gt; m (a, b)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(a, b) -&gt; m (a, b)
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span class="hs-special">)</span><span>
</span><span id="line-2468"></span><span>      </span><span class="annot"><span class="annottext">m (a, b) -&gt; m () -&gt; m (a, b)
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`onException`</span></span><span>
</span><span id="line-2469"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256149"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256146"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2470"></span><span>    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256149"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256144"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2471"></span><span>    </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256143"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2472"></span><span>
</span><span id="line-2473"></span><span id="local-6989586621679257116"><span id="local-6989586621679257117"><span id="local-6989586621679257118"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarSTM"><span class="hs-identifier hs-type">modifyTMVarSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257117"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257117"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257117"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679257116"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257116"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2474"></span><span id="modifyTMVarSTM"><span class="annot"><span class="annottext">modifyTMVarSTM :: StrictTMVar m a -&gt; (a -&gt; STM m (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarSTM"><span class="hs-identifier hs-var hs-var">modifyTMVarSTM</span></a></span></span><span> </span><span id="local-6989586621679256140"><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256140"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679256139"><span class="annot"><span class="annottext">a -&gt; STM m (a, b)
</span><a href="#local-6989586621679256139"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2475"></span><span>    </span><span id="local-6989586621679256138"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256138"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256140"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2476"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679256137"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256137"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679256136"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256136"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m (a, b)
</span><a href="#local-6989586621679256139"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256138"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2477"></span><span>    </span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256140"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256137"><span class="hs-identifier hs-var">a'</span></a></span><span>
</span><span id="line-2478"></span><span>    </span><span class="annot"><span class="annottext">b -&gt; STM m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256136"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2479"></span><span>
</span><span id="line-2480"></span><span class="hs-comment">-- | Like 'modifyMVar' but pure.</span><span>
</span><span id="line-2481"></span><span class="hs-comment">--</span><span>
</span><span id="line-2482"></span><span id="local-6989586621679257179"><span id="local-6989586621679257180"><span id="local-6989586621679257181"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarPure"><span class="hs-identifier hs-type">modifyTMVarPure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257181"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2483"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679257181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257180"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-2484"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257180"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679257180"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679257179"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2485"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679257181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679257179"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-2486"></span><span id="modifyTMVarPure"><span class="annot"><span class="annottext">modifyTMVarPure :: StrictTMVar m a -&gt; (a -&gt; (a, b)) -&gt; STM m b
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#modifyTMVarPure"><span class="hs-identifier hs-var hs-var">modifyTMVarPure</span></a></span></span><span> </span><span id="local-6989586621679256135"><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256135"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679256134"><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679256134"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2487"></span><span>    </span><span id="local-6989586621679256133"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256133"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTMVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256135"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2488"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679256132"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256132"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679256131"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256131"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679256134"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256133"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-2489"></span><span>    </span><span class="annot"><span class="annottext">StrictTMVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m a
</span><a href="#local-6989586621679256135"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679256132"><span class="hs-identifier hs-var">a'</span></a></span><span>
</span><span id="line-2490"></span><span>    </span><span class="annot"><span class="annottext">b -&gt; STM m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679256131"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2491"></span><span>
</span><span id="line-2492"></span><span class="hs-comment">--</span><span>
</span><span id="line-2493"></span><span class="hs-comment">-- Exceptions</span><span>
</span><span id="line-2494"></span><span class="hs-comment">--</span><span>
</span><span id="line-2495"></span><span>
</span><span id="line-2496"></span><span class="hs-comment">-- | Useful to attach 'CallStack' to 'ConnectionManagerError'.</span><span>
</span><span id="line-2497"></span><span class="hs-comment">--</span><span>
</span><span id="line-2498"></span><span id="local-6989586621679257111"><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-type">withCallStack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">CallStack</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679257111"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-2499"></span><span id="withCallStack"><span class="annot"><span class="annottext">withCallStack :: (CallStack -&gt; a) -&gt; a
</span><a href="Ouroboros.Network.ConnectionManager.Core.html#withCallStack"><span class="hs-identifier hs-var hs-var">withCallStack</span></a></span></span><span> </span><span id="local-6989586621679256130"><span class="annot"><span class="annottext">CallStack -&gt; a
</span><a href="#local-6989586621679256130"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallStack -&gt; a
</span><a href="#local-6989586621679256130"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">CallStack
HasCallStack =&gt; CallStack
</span><a href="../file:///usr/local/.ghcup/ghc/8.10.7/share/doc/ghc-8.10.7/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">callStack</span></a></span><span>
</span><span id="line-2500"></span></pre></body></html>